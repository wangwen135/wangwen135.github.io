<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 7.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" integrity="sha256-XOqroi11tY4EFQMR9ZYwZWKj5ZXiftSx36RRuC3anlA=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"wangwen135.github.io","root":"/","images":"/images","scheme":"Pisces","darkmode":false,"version":"8.20.0","exturl":false,"sidebar":{"position":"left","width_expanded":320,"width_dual_column":240,"display":"post","padding":18,"offset":12},"copycode":{"enable":false,"style":null},"fold":{"enable":false,"height":500},"bookmark":{"enable":true,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"}}</script><script src="/js/config.js"></script>

    <meta name="description" content="这是一个使用 Hexo 构建的博客，用于分享我的编程经验和学习笔记。">
<meta property="og:type" content="website">
<meta property="og:title" content="王某某的笔记">
<meta property="og:url" content="https://wangwen135.github.io/page/9/index.html">
<meta property="og:site_name" content="王某某的笔记">
<meta property="og:description" content="这是一个使用 Hexo 构建的博客，用于分享我的编程经验和学习笔记。">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="王某某">
<meta property="article:tag" content="java">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="https://wangwen135.github.io/page/9/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":true,"isPost":false,"lang":"zh-CN","comments":"","permalink":"","path":"page/9/index.html","title":""}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>王某某的笔记</title>
  








  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">王某某的笔记</h1>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">记录我的编程之路</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="搜索" role="button">
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a></li>
  </ul>
</nav>




</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="王某某"
      src="/images/avatar.jpg">
  <p class="site-author-name" itemprop="name">王某某</p>
  <div class="site-description" itemprop="description">这是一个使用 Hexo 构建的博客，用于分享我的编程经验和学习笔记。</div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">158</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">51</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">121</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author animated">
      <span class="links-of-author-item">
        <a href="https://github.com/wangwen135" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;wangwen135" rel="noopener me" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://www.jianshu.com/u/66c41e72644b" title="简  书 → https:&#x2F;&#x2F;www.jianshu.com&#x2F;u&#x2F;66c41e72644b" rel="noopener me" target="_blank"><i class="fa fa-link fa-fw"></i>简  书</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:wangwen135@gmail.com" title="E-Mail → mailto:wangwen135@gmail.com" rel="noopener me" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://twitter.com/wangwen135" title="Twitter → https:&#x2F;&#x2F;twitter.com&#x2F;wangwen135" rel="noopener me" target="_blank"><i class="fab fa-twitter fa-fw"></i>Twitter</a>
      </span>
  </div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner index posts-expand">

    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://wangwen135.github.io/MySQL/Mysql-%E5%8D%87%E7%BA%A7/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="王某某">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="王某某的笔记">
      <meta itemprop="description" content="这是一个使用 Hexo 构建的博客，用于分享我的编程经验和学习笔记。">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 王某某的笔记">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/MySQL/Mysql-%E5%8D%87%E7%BA%A7/" class="post-title-link" itemprop="url">Mysql-升级</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2020-06-25 23:41:00" itemprop="dateCreated datePublished" datetime="2020-06-25T23:41:00+08:00">2020-06-25</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/MySQL/" itemprop="url" rel="index"><span itemprop="name">MySQL</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>596</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>2 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p><em>2017年8月</em></p>
<hr>
<h1 id="升级之前请备份数据"><a href="#升级之前请备份数据" class="headerlink" title="升级之前请备份数据"></a>升级之前请备份数据</h1><hr>
<p><a target="_blank" rel="noopener" href="https://dev.mysql.com/downloads/repo/yum/">https://dev.mysql.com/downloads/repo/yum/</a></p>
<p><a target="_blank" rel="noopener" href="https://dev.mysql.com/doc/refman/5.7/en/upgrading.html">https://dev.mysql.com/doc/refman/5.7/en/upgrading.html</a></p>
<p><a target="_blank" rel="noopener" href="https://dev.mysql.com/doc/refman/5.7/en/mysql-upgrade.html">https://dev.mysql.com/doc/refman/5.7/en/mysql-upgrade.html</a></p>
<h2 id="更新程序"><a href="#更新程序" class="headerlink" title="更新程序"></a>更新程序</h2><h3 id="使用MySQL-Yum-Repository升级MySQL"><a href="#使用MySQL-Yum-Repository升级MySQL" class="headerlink" title="使用MySQL Yum Repository升级MySQL"></a>使用MySQL Yum Repository升级MySQL</h3><p><a target="_blank" rel="noopener" href="https://dev.mysql.com/doc/refman/5.7/en/updating-yum-repo.html">https://dev.mysql.com/doc/refman/5.7/en/updating-yum-repo.html</a></p>
<h2 id="通过yum升级"><a href="#通过yum升级" class="headerlink" title="通过yum升级"></a>通过yum升级</h2><ol>
<li><p>更换新的yum 资源库，或者禁用旧版本系列 启用新版本系列。</p>
</li>
<li><p>通过以下命令升级MySQL及其组件</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">shell&gt; sudo yum update mysql-server</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>或者，通过Yum更新系统上的所有内容来更新MySQL</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">shell&gt; sudo yum update</span><br><span class="line"></span><br></pre></td></tr></table></figure>
</li>
<li><p>查看已经安装了的</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">shell&gt; sudo yum list installed | grep &quot;^mysql&quot;</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
</ol>
<h2 id="关闭旧的服务器"><a href="#关闭旧的服务器" class="headerlink" title="关闭旧的服务器"></a>关闭旧的服务器</h2><ol>
<li><p>配置MySQL通过设置innodb_fast_shutdown来 执行缓慢的关闭 0。例如：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql -u root -p --execute=&quot;SET GLOBAL innodb_fast_shutdown=0&quot;</span><br></pre></td></tr></table></figure>
<p>缓慢关闭时，InnoDB执行完全清除并在关闭之前更改缓冲区合并，从而确保数据文件在发布之间的文件格式不同的情况下完全准备好。</p>
</li>
<li><p>关闭旧的MySQL服务器。例如：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysqladmin -u root -p shutdown</span><br></pre></td></tr></table></figure></li>
</ol>
<h2 id="升级数据"><a href="#升级数据" class="headerlink" title="升级数据"></a>升级数据</h2><h2 id="mysql-upgrade-检查和升级MySQL表"><a href="#mysql-upgrade-检查和升级MySQL表" class="headerlink" title="mysql_upgrade - 检查和升级MySQL表"></a>mysql_upgrade - 检查和升级MySQL表</h2><p>mysql_upgrade检查所有数据库中的所有表与当前版本的MySQL Server的不兼容性。mysql_upgrade还升级系统表，以便您可以利用可能已添加的新特权或功能。</p>
<p>如果mysql_upgrade发现表有可能的不兼容性，它会执行表检查，如果发现问题，则尝试进行表修复。如果表不能修复，请参见第2.11.3节“重建或修复表或索引”以获取手动表修复策略。</p>
<p>每次升级MySQL时，都 应该执行mysql_upgrade。</p>
<p>从MySQL 5.7.5开始，mysql_upgrade与MySQL服务器直接通信，发送执行升级所需的SQL语句。5.7.5之前， mysql_upgrade调用 mysql和mysqlcheck 客户端程序来执行所需的操作。对于较旧的实现，如果在Linux上从RPM软件包安装MySQL，则必须安装服务器和客户机RPM。 mysql_upgrade包含在服务器RPM中，但需要客户端RPM，因为后者包括 mysqlcheck。（请参见 第2.5.5节“使用Oracle的RPM软件包在Linux上安装MySQL”。）</p>
<p>要使用mysql_upgrade，请确保服务器正在运行。然后像这样调用它来检查和修复表并升级系统表：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">shell&gt; mysql_upgrade [options]</span><br><span class="line"></span><br><span class="line"># 例如：</span><br><span class="line">shell&gt; mysql_upgrade -u root -p</span><br></pre></td></tr></table></figure>
<p>运行mysql_upgrade后，停止服务器并重新启动，以便对系统表进行的任何更改生效。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mysqladmin -u root -p shutdown</span><br><span class="line"></span><br></pre></td></tr></table></figure>


      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://wangwen135.github.io/%E7%BD%91%E7%BB%9C%E4%B8%8E%E5%AE%89%E5%85%A8/%E7%BD%91%E7%BB%9C/ARP%20%E4%B8%8E%20RARP%20%E5%8D%8F%E8%AE%AE/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="王某某">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="王某某的笔记">
      <meta itemprop="description" content="这是一个使用 Hexo 构建的博客，用于分享我的编程经验和学习笔记。">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 王某某的笔记">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/%E7%BD%91%E7%BB%9C%E4%B8%8E%E5%AE%89%E5%85%A8/%E7%BD%91%E7%BB%9C/ARP%20%E4%B8%8E%20RARP%20%E5%8D%8F%E8%AE%AE/" class="post-title-link" itemprop="url">ARP 与 RARP 协议</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2020-06-03 00:00:00" itemprop="dateCreated datePublished" datetime="2020-06-03T00:00:00+08:00">2020-06-03</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E7%BD%91%E7%BB%9C%E4%B8%8E%E5%AE%89%E5%85%A8/" itemprop="url" rel="index"><span itemprop="name">网络与安全</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E7%BD%91%E7%BB%9C%E4%B8%8E%E5%AE%89%E5%85%A8/%E7%BD%91%E7%BB%9C/" itemprop="url" rel="index"><span itemprop="name">网络</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>2.7k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>10 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="ARP协议"><a href="#ARP协议" class="headerlink" title="ARP协议"></a>ARP协议</h2><p>地址解析协议，即ARP（Address Resolution Protocol），是根据IP地址获取物理地址的一个TCP&#x2F;IP协议。<br>主机发送信息时将包含目标IP地址的ARP请求广播到局域网络上的所有主机，并接收返回消息，以此确定目标的物理地址；收到返回消息后将该IP地址和物理地址存入本机ARP缓存中并保留一定时间，下次请求时直接查询ARP缓存以节约资源。</p>
<h2 id="RARP协议"><a href="#RARP协议" class="headerlink" title="RARP协议"></a>RARP协议</h2><p>反向地址转换协议（RARP）是局域网的物理机器从网关服务器的ARP表或者缓存上根据MAC地址请求IP地址的协议，其功能与地址解析协议相反。与ARP相比，RARP的工作流程也相反。首先是查询主机向网路送出一个RARP Request广播封包，向别的主机查询自己的IP地址。这时候网络上的RARP服务器就会将发送端的IP地址用RARP Reply封包回应给查询者，这样查询主机就获得自己的IP地址了。</p>
<h2 id="为什么需要这个"><a href="#为什么需要这个" class="headerlink" title="为什么需要这个"></a>为什么需要这个</h2><p>数据包在物理链路上传输 以太网帧 需要目的地的物理地址（MAC）<br>通过ARP协议来获取同一个网络内的机器的IP地址和Mac的对应关系，为上层协议提供支持，因为上层协议使用IP地址进行通信。</p>
<ul>
<li>局域网内的IP地址（通过子网掩码计算）之间的通信，就可以理解为设备（MAC）对设备（MAC）之间的通信</li>
<li>跨局域网的通信就是设备(MAC)对 网关（MAC）之间的通信</li>
</ul>
<h2 id="ARP-数据包"><a href="#ARP-数据包" class="headerlink" title="ARP 数据包"></a>ARP 数据包</h2><p><strong>Wireshark 抓包</strong> </p>
<p>ARP 广播请求 （由192.168.1.88 发起的广播请求，询问谁的IP是192.168.1.1）</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">4595	296.111634	Giga-Byt_18:04:4a	Broadcast	ARP	42	Who has 192.168.1.1? Tell 192.168.1.88</span><br></pre></td></tr></table></figure>
<blockquote>
<p>内容如下：</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">Frame 4595: 42 bytes on wire (336 bits), 42 bytes captured (336 bits) on interface 0</span><br><span class="line">Ethernet II, Src: Giga-Byt_18:04:4a (e0:d5:5e:18:04:4a), Dst: Broadcast (ff:ff:ff:ff:ff:ff)</span><br><span class="line">    Destination: Broadcast (ff:ff:ff:ff:ff:ff)</span><br><span class="line">    Source: Giga-Byt_18:04:4a (e0:d5:5e:18:04:4a)</span><br><span class="line">    Type: ARP (0x0806)</span><br><span class="line">Address Resolution Protocol (request)</span><br><span class="line">    Hardware type: Ethernet (1)</span><br><span class="line">    Protocol type: IPv4 (0x0800)</span><br><span class="line">    Hardware size: 6</span><br><span class="line">    Protocol size: 4</span><br><span class="line">    Opcode: request (1)</span><br><span class="line">    Sender MAC address: Giga-Byt_18:04:4a (e0:d5:5e:18:04:4a)</span><br><span class="line">    Sender IP address: 192.168.1.88</span><br><span class="line">    Target MAC address: 00:00:00_00:00:00 (00:00:00:00:00:00)</span><br><span class="line">    Target IP address: 192.168.1.1</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>ARP 应答 （192.168.1.1 直接应答 192.168.1.88，告知其Mac地址）</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">4596	296.111872	NewH3CTe_95:65:a9	Giga-Byt_18:04:4a	ARP	60	192.168.1.1 is at 04:40:a9:95:65:a9</span><br></pre></td></tr></table></figure>
<blockquote>
<p>内容如下：</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">Frame 4596: 60 bytes on wire (480 bits), 60 bytes captured (480 bits) on interface 0</span><br><span class="line">Ethernet II, Src: NewH3CTe_95:65:a9 (04:40:a9:95:65:a9), Dst: Giga-Byt_18:04:4a (e0:d5:5e:18:04:4a)</span><br><span class="line">    Destination: Giga-Byt_18:04:4a (e0:d5:5e:18:04:4a)</span><br><span class="line">    Source: NewH3CTe_95:65:a9 (04:40:a9:95:65:a9)</span><br><span class="line">    Type: ARP (0x0806)</span><br><span class="line">    Padding: 000000000000000000000000000000000000</span><br><span class="line">Address Resolution Protocol (reply)</span><br><span class="line">    Hardware type: Ethernet (1)</span><br><span class="line">    Protocol type: IPv4 (0x0800)</span><br><span class="line">    Hardware size: 6</span><br><span class="line">    Protocol size: 4</span><br><span class="line">    Opcode: reply (2)</span><br><span class="line">    Sender MAC address: NewH3CTe_95:65:a9 (04:40:a9:95:65:a9)</span><br><span class="line">    Sender IP address: 192.168.1.1</span><br><span class="line">    Target MAC address: Giga-Byt_18:04:4a (e0:d5:5e:18:04:4a)</span><br><span class="line">    Target IP address: 192.168.1.88</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>其他收到该广播的机器判断【192.168.1.1】不是自己的IP，直接丢弃</p>
<h2 id="ARP-命令说明"><a href="#ARP-命令说明" class="headerlink" title="ARP 命令说明"></a>ARP 命令说明</h2><h4 id="windows"><a href="#windows" class="headerlink" title="windows"></a>windows</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">显示和修改地址解析协议(ARP)使用的“IP 到物理”地址转换表。</span><br><span class="line"></span><br><span class="line">ARP -s inet_addr eth_addr [if_addr]</span><br><span class="line">ARP -d inet_addr [if_addr]</span><br><span class="line">ARP -a [inet_addr] [-N if_addr] [-v]</span><br><span class="line"></span><br><span class="line">  -a            通过询问当前协议数据，显示当前 ARP 项。</span><br><span class="line">                如果指定 inet_addr，则只显示指定计算机</span><br><span class="line">                的 IP 地址和物理地址。如果不止一个网络</span><br><span class="line">                接口使用 ARP，则显示每个 ARP 表的项。</span><br><span class="line">  -g            与 -a 相同。</span><br><span class="line">  -v            在详细模式下显示当前 ARP 项。所有无效项</span><br><span class="line">                和环回接口上的项都将显示。</span><br><span class="line">  inet_addr     指定 Internet 地址。</span><br><span class="line">  -N if_addr    显示 if_addr 指定的网络接口的 ARP 项。</span><br><span class="line">  -d            删除 inet_addr 指定的主机。inet_addr 可</span><br><span class="line">                以是通配符 *，以删除所有主机。</span><br><span class="line">  -s            添加主机并且将 Internet 地址 inet_addr</span><br><span class="line">                与物理地址 eth_addr 相关联。物理地址是用</span><br><span class="line">                连字符分隔的 6 个十六进制字节。该项是永久的。</span><br><span class="line">  eth_addr      指定物理地址。</span><br><span class="line">  if_addr       如果存在，此项指定地址转换表应修改的接口</span><br><span class="line">                的 Internet 地址。如果不存在，则使用第一</span><br><span class="line">                个适用的接口。</span><br><span class="line">示例:</span><br><span class="line">  &gt; arp -s 157.55.85.212   00-aa-00-62-c6-09.... 添加静态项。</span><br><span class="line">  &gt; arp -a                                  .... 显示 ARP 表。</span><br></pre></td></tr></table></figure>

<h4 id="linux"><a href="#linux" class="headerlink" title="linux"></a>linux</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"># man arp</span><br><span class="line">ARP(8)                     Linux Programmer’s Manual                    ARP(8)</span><br><span class="line">NAME</span><br><span class="line">       arp - manipulate the system ARP cache</span><br><span class="line">SYNOPSIS</span><br><span class="line">       arp [-evn] [-H type] [-i if] -a [hostname]</span><br><span class="line">       arp [-v] [-i if] -d hostname [pub]</span><br><span class="line">       arp [-v] [-H type] [-i if] -s hostname hw_addr [temp]</span><br><span class="line">       arp [-v] [-H type] [-i if] -s hostname hw_addr [netmask nm] pub</span><br><span class="line">       arp [-v] [-H type] [-i if] -Ds hostname ifa [netmask nm] pub</span><br><span class="line">       arp [-vnD] [-H type] [-i if] -f [filename]</span><br><span class="line">NOTE</span><br><span class="line">       This program is obsolete. For replacement check ip neighbor.</span><br><span class="line">DESCRIPTION</span><br><span class="line">       Arp  manipulates the kernel’s ARP cache in various ways.  The primary options are clearing an address mapping entry and manually setting up one.  For debugging purposes, the arp pro-</span><br><span class="line">       gram also allows a complete dump of the ARP cache.</span><br><span class="line">......</span><br><span class="line">......</span><br></pre></td></tr></table></figure>




<h2 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h2><h3 id="ping不存在的局域网机器"><a href="#ping不存在的局域网机器" class="headerlink" title="ping不存在的局域网机器"></a>ping不存在的局域网机器</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"># cmd</span><br><span class="line">C:\Users\Administrator&gt;ping 192.168.1.111</span><br><span class="line"></span><br><span class="line">正在 Ping 192.168.1.111 具有 32 字节的数据:</span><br><span class="line">来自 192.168.1.88 的回复: 无法访问目标主机。</span><br><span class="line">来自 192.168.1.88 的回复: 无法访问目标主机。</span><br><span class="line">来自 192.168.1.88 的回复: 无法访问目标主机。</span><br><span class="line">来自 192.168.1.88 的回复: 无法访问目标主机。</span><br><span class="line"></span><br><span class="line">192.168.1.111 的 Ping 统计信息:</span><br><span class="line">    数据包: 已发送 = 4，已接收 = 4，丢失 = 0 (0% 丢失)，</span><br></pre></td></tr></table></figure>
<h4 id="wireshark-抓包"><a href="#wireshark-抓包" class="headerlink" title="wireshark 抓包"></a>wireshark 抓包</h4><blockquote>
<p>过滤条件：arp.dst.proto_ipv4&#x3D;&#x3D;192.168.1.111 or icmp</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">2910	206.611909	Giga-Byt_18:04:4a	Broadcast	ARP	42	Who has 192.168.1.111? Tell 192.168.1.88</span><br><span class="line">2917	207.570302	Giga-Byt_18:04:4a	Broadcast	ARP	42	Who has 192.168.1.111? Tell 192.168.1.88</span><br><span class="line">2924	208.570334	Giga-Byt_18:04:4a	Broadcast	ARP	42	Who has 192.168.1.111? Tell 192.168.1.88</span><br><span class="line">......</span><br></pre></td></tr></table></figure>
<p>只有arp请求</p>
<h4 id="结论"><a href="#结论" class="headerlink" title="结论"></a>结论</h4><p>可以看到只会发送ARP请求，且ARP请求没有获得响应，此时无法获取ping的目的地，故不会发送ping（ICMP）请求<br>且错误显示为：<strong>“无法访问目标主机”</strong></p>
<h3 id="添加静态arp映射后再ping"><a href="#添加静态arp映射后再ping" class="headerlink" title="添加静态arp映射后再ping"></a>添加静态arp映射后再ping</h3><p>先添加IP对MAC的映射关系</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">arp -s 192.168.1.111 00-2b-3c-f0-ff-ff</span><br></pre></td></tr></table></figure>
<p>用 arp -a 查看结果</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">C:\Users\Administrator&gt;arp -a</span><br><span class="line"></span><br><span class="line">接口: 192.168.1.88 --- 0xb</span><br><span class="line">  Internet 地址         物理地址              类型</span><br><span class="line">  192.168.1.1           04-40-a9-95-65-a9     动态</span><br><span class="line">  192.168.1.111          00-2b-3c-f0-ff-ff     静态</span><br><span class="line">......</span><br></pre></td></tr></table></figure>

<p>ping 测试 </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">C:\Users\Administrator&gt;ping 192.168.1.111</span><br><span class="line"></span><br><span class="line">正在 Ping 192.168.1.111 具有 32 字节的数据:</span><br><span class="line">请求超时。</span><br><span class="line">请求超时。</span><br><span class="line">请求超时。</span><br><span class="line">请求超时。</span><br><span class="line"></span><br><span class="line">192.168.1.111 的 Ping 统计信息:</span><br><span class="line">    数据包: 已发送 = 4，已接收 = 0，丢失 = 4 (100% 丢失)，</span><br></pre></td></tr></table></figure>

<h4 id="wireshark-抓包-1"><a href="#wireshark-抓包-1" class="headerlink" title="wireshark 抓包"></a>wireshark 抓包</h4><blockquote>
<p>过滤条件：arp.dst.proto_ipv4&#x3D;&#x3D;192.168.1.111 or icmp</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">275	19.179418	192.168.1.88	192.168.1.111	ICMP	74	Echo (ping) request  id=0x0001, seq=26/6656, ttl=64 (no response found!)</span><br><span class="line">315	23.681918	192.168.1.88	192.168.1.111	ICMP	74	Echo (ping) request  id=0x0001, seq=27/6912, ttl=64 (no response found!)</span><br><span class="line">......</span><br></pre></td></tr></table></figure>
<p>只有ping</p>
<p><strong>数据报详情：</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">Frame 315: 74 bytes on wire (592 bits), 74 bytes captured (592 bits) on interface 0</span><br><span class="line">Ethernet II, Src: Giga-Byt_18:04:4a (e0:d5:5e:18:04:4a), Dst: 00:2b:3c:f0:ff:ff (00:2b:3c:f0:ff:ff)</span><br><span class="line">    Destination: 00:2b:3c:f0:ff:ff (00:2b:3c:f0:ff:ff)</span><br><span class="line">    Source: Giga-Byt_18:04:4a (e0:d5:5e:18:04:4a)</span><br><span class="line">    Type: IPv4 (0x0800)</span><br><span class="line">Internet Protocol Version 4, Src: 192.168.1.88, Dst: 192.168.1.111</span><br><span class="line">Internet Control Message Protocol</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h4 id="结论："><a href="#结论：" class="headerlink" title="结论："></a>结论：</h4><p>当本地的Arp缓存中有IP地址和Mac地址的对应关系时，会直接往目标地址发送数据报，从以太网帧中可以看到目的地Mac就是我们设置的Mac。<br>此时不会再发送ARP请求，直接发送了Ping请求，且错误显示为：<strong>“请求超时”</strong></p>
<h3 id="修改网关Mac，让本机无法上网"><a href="#修改网关Mac，让本机无法上网" class="headerlink" title="修改网关Mac，让本机无法上网"></a>修改网关Mac，让本机无法上网</h3><h4 id="找网关地址"><a href="#找网关地址" class="headerlink" title="找网关地址"></a>找网关地址</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&gt;ipconfig</span><br><span class="line"></span><br><span class="line">以太网适配器 本地连接:</span><br><span class="line"></span><br><span class="line">   连接特定的 DNS 后缀 . . . . . . . :</span><br><span class="line">   IPv4 地址 . . . . . . . . . . . . : 192.168.1.88</span><br><span class="line">   子网掩码  . . . . . . . . . . . . : 255.255.255.0</span><br><span class="line">   默认网关. . . . . . . . . . . . . : 192.168.1.1</span><br></pre></td></tr></table></figure>

<h4 id="查网关真实的Mac地址"><a href="#查网关真实的Mac地址" class="headerlink" title="查网关真实的Mac地址"></a>查网关真实的Mac地址</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">C:\Users\Administrator&gt;arp -a | findstr 192.168.1.1</span><br><span class="line">  192.168.1.1           04-40-a9-95-66-a9     动态</span><br><span class="line">  192.168.1.111         00-2b-3c-f0-ff-ff     静态</span><br></pre></td></tr></table></figure>

<h4 id="修改本地arp缓存中的网关Mac地址"><a href="#修改本地arp缓存中的网关Mac地址" class="headerlink" title="修改本地arp缓存中的网关Mac地址"></a>修改本地arp缓存中的网关Mac地址</h4><p>这里修改 192.168.1.1 的Mac地址<br><strong>arp 命令修改失败：拒绝访问</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">arp -d 192.168.1.1</span><br><span class="line">arp -s 192.168.1.1 00-2b-3c-f0-ff-f1 192.168.1.88</span><br><span class="line">ARP 项添加失败: 拒绝访问。</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>改用netsh命令修改 </p>
<ol>
<li>先找本地网卡的 Idx，这里是：11<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">netsh i i show in</span><br><span class="line"></span><br><span class="line">Idx     Met         MTU          状态                名称</span><br><span class="line">---  ----------  ----------  ------------  ---------------------------</span><br><span class="line">  1          50  4294967295  connected     Loopback Pseudo-Interface 1</span><br><span class="line"> 11          10        1500  connected     本地连接</span><br><span class="line"> 16          30        1500  connected     Npcap Loopback Adapter</span><br></pre></td></tr></table></figure></li>
<li>使用如下命令修改本地Mac地址缓存<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">netsh -c &quot;i i&quot; add neighbors 11 &quot;网关IP&quot; &quot;Mac地址&quot;  -- 这里11是idx号。</span><br><span class="line"></span><br><span class="line">netsh -c &quot;i i&quot; add neighbors 11 &quot;192.168.1.1&quot; &quot;00-2b-3c-f0-ff-f1&quot;</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li>验证修改结果<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">arp -a</span><br><span class="line"></span><br><span class="line">C:\Users\Administrator&gt;arp -a</span><br><span class="line"></span><br><span class="line">接口: 192.168.1.88 --- 0xb</span><br><span class="line">  Internet 地址         物理地址              类型</span><br><span class="line">  192.168.1.1           00-2b-3c-f0-ff-f1     静态</span><br><span class="line">  192.168.1.171         d4-5d-df-01-32-f0     动态</span><br><span class="line">......</span><br><span class="line">......</span><br></pre></td></tr></table></figure></li>
</ol>
<h4 id="导致的结果是本机不能再上网了，但局域网访问正常"><a href="#导致的结果是本机不能再上网了，但局域网访问正常" class="headerlink" title="导致的结果是本机不能再上网了，但局域网访问正常"></a>导致的结果是本机不能再上网了，但局域网访问正常</h4><p>比如在浏览器中访问百度</p>
<p>使用wireshar 抓包</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"># 这里先进行DNS解析</span><br><span class="line"></span><br><span class="line">6	0.783394	192.168.1.88	114.114.114.114	DNS	73	Standard query 0x341b A www.baidu.com</span><br><span class="line"></span><br><span class="line"># 可以看到直接将数据包发送到了我们上面配置的假Mac地址： 00-2b-3c-f0-ff-f1 </span><br><span class="line"></span><br><span class="line">Frame 6: 73 bytes on wire (584 bits), 73 bytes captured (584 bits) on interface 0</span><br><span class="line">Ethernet II, Src: Giga-Byt_18:04:4a (e0:d5:5e:18:04:4a), Dst: 00:2b:3c:f0:ff:f1 (00:2b:3c:f0:ff:f1)</span><br><span class="line">    Destination: 00:2b:3c:f0:ff:f1 (00:2b:3c:f0:ff:f1)</span><br><span class="line">    Source: Giga-Byt_18:04:4a (e0:d5:5e:18:04:4a)</span><br><span class="line">    Type: IPv4 (0x0800)</span><br><span class="line">Internet Protocol Version 4, Src: 192.168.1.88, Dst: 114.114.114.114</span><br><span class="line">User Datagram Protocol, Src Port: 64752, Dst Port: 53</span><br><span class="line">Domain Name System (query)</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<h4 id="还原网关对应的mac地址"><a href="#还原网关对应的mac地址" class="headerlink" title="还原网关对应的mac地址"></a>还原网关对应的mac地址</h4><p>使用netsh 命令设置之后，再用 <code>arp -d 192.168.1.1</code>命令删除，在重启之前是可以上网的，下次重启网关的mac地址还将是错误的</p>
<h5 id="查看："><a href="#查看：" class="headerlink" title="查看："></a>查看：</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">netsh -c &quot;i i&quot; show neighbors 11</span><br><span class="line"></span><br><span class="line">C:\Users\Administrator&gt;netsh -c &quot;i i&quot; show neighbors 11</span><br><span class="line"></span><br><span class="line">接口 11: 本地连接</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Internet 地址                                 物理地址           类型</span><br><span class="line">--------------------------------------------  -----------------  -----------</span><br><span class="line">192.168.1.1                                   00-2b-3c-f0-ff-f1  永久</span><br><span class="line">192.168.1.11                                  00-0c-29-47-fd-8d  停滞</span><br><span class="line">192.168.1.63                                  00-00-00-00-00-00  无法访问</span><br><span class="line">192.168.1.92                                  00-00-00-00-00-00  无法访问</span><br><span class="line">......</span><br></pre></td></tr></table></figure>
<h5 id="删除："><a href="#删除：" class="headerlink" title="删除："></a>删除：</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">netsh -c &quot;i i&quot; delete neighbors 11</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>需要使用上面的命令删除，完了之后就会变成 “可以访问”</p>
<hr>
<h2 id="ARP欺骗"><a href="#ARP欺骗" class="headerlink" title="ARP欺骗"></a>ARP欺骗</h2><p>ARP欺骗可以分成两种情况：</p>
<h3 id="一、欺骗路由器"><a href="#一、欺骗路由器" class="headerlink" title="一、欺骗路由器"></a>一、欺骗路由器</h3><p>发送一系列错误的内网MAC地址给路由器，并按照一定的频率不断进行，使真实的地址信息无法通过更新保存在路由器中，结果路由器的所有数据只能发送给错误的MAC地址，造成正常PC无法收到信息。</p>
<h3 id="二、欺骗局域网内的机器"><a href="#二、欺骗局域网内的机器" class="headerlink" title="二、欺骗局域网内的机器"></a>二、欺骗局域网内的机器</h3><p>不停发送错误的网关Mac到局域网的机器中，让局域网内的机器建立错误的绑定关系，让局域网内的机器不能正确的将数据包发送到网关设备，导致PC不能上网。</p>
<h2 id="ARP欺骗测试"><a href="#ARP欺骗测试" class="headerlink" title="ARP欺骗测试"></a>ARP欺骗测试</h2><h3 id="使用发包工具"><a href="#使用发包工具" class="headerlink" title="使用发包工具"></a>使用发包工具</h3><p>……<br>有时间再试试<br>……</p>
<h2 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h2><h3 id="获取局域网某IP对应的Mac"><a href="#获取局域网某IP对应的Mac" class="headerlink" title="获取局域网某IP对应的Mac"></a>获取局域网某IP对应的Mac</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&gt; arping 192.168.1.88</span><br><span class="line">ARPING 192.168.1.88 from 192.168.1.216 eth0</span><br><span class="line">Unicast reply from 192.168.1.88 [E0:D5:5E:18:04:4A]  1.767ms</span><br><span class="line">Unicast reply from 192.168.1.88 [E0:D5:5E:18:04:4A]  1.312ms</span><br><span class="line">Unicast reply from 192.168.1.88 [E0:D5:5E:18:04:4A]  1.635ms</span><br></pre></td></tr></table></figure>

<h3 id="测试局域网个中某个IP是否被占用"><a href="#测试局域网个中某个IP是否被占用" class="headerlink" title="测试局域网个中某个IP是否被占用"></a>测试局域网个中某个IP是否被占用</h3><p>返回值为1表示已被使用，0表示没有被使用</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@RD-WEBSERVER-03 ~]# arping -D 192.168.1.163 -w 5  </span><br><span class="line">ARPING 192.168.1.163 from 0.0.0.0 eth0</span><br><span class="line">Sent 6 probes (6 broadcast(s))</span><br><span class="line">Received 0 response(s)</span><br><span class="line"></span><br><span class="line">[root@RD-WEBSERVER-03 ~]# arping -D 192.168.1.88 -w 5   </span><br><span class="line">ARPING 192.168.1.88 from 0.0.0.0 eth0</span><br><span class="line">Unicast reply from 192.168.1.88 [E0:D5:5E:18:04:4A]  1.848ms</span><br><span class="line">Sent 1 probes (1 broadcast(s))</span><br><span class="line">Received 1 response(s)</span><br></pre></td></tr></table></figure>


<h3 id="wireshark"><a href="#wireshark" class="headerlink" title="wireshark"></a>wireshark</h3><p>过滤目的地址<br>arp.dst.proto_ipv4&#x3D;&#x3D;192.168.1.214</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://wangwen135.github.io/%E7%A1%AC%E4%BB%B6%E4%B8%8E%E7%89%A9%E8%81%94%E7%BD%91/%E8%B7%AF%E7%94%B1%E5%99%A8&%E5%85%89%E7%8C%AB/%E5%85%89%E7%8C%AB%E5%92%8C%E8%B7%AF%E7%94%B1%E5%99%A8%E9%85%8D%E7%BD%AEVLAN%E7%9C%8BIPTV/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="王某某">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="王某某的笔记">
      <meta itemprop="description" content="这是一个使用 Hexo 构建的博客，用于分享我的编程经验和学习笔记。">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 王某某的笔记">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/%E7%A1%AC%E4%BB%B6%E4%B8%8E%E7%89%A9%E8%81%94%E7%BD%91/%E8%B7%AF%E7%94%B1%E5%99%A8&%E5%85%89%E7%8C%AB/%E5%85%89%E7%8C%AB%E5%92%8C%E8%B7%AF%E7%94%B1%E5%99%A8%E9%85%8D%E7%BD%AEVLAN%E7%9C%8BIPTV/" class="post-title-link" itemprop="url">光猫和路由器配置VLAN看IPTV</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2020-05-25 23:41:00" itemprop="dateCreated datePublished" datetime="2020-05-25T23:41:00+08:00">2020-05-25</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E7%A1%AC%E4%BB%B6%E4%B8%8E%E7%89%A9%E8%81%94%E7%BD%91/" itemprop="url" rel="index"><span itemprop="name">硬件与物联网</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E7%A1%AC%E4%BB%B6%E4%B8%8E%E7%89%A9%E8%81%94%E7%BD%91/%E8%B7%AF%E7%94%B1%E5%99%A8-%E5%85%89%E7%8C%AB/" itemprop="url" rel="index"><span itemprop="name">路由器&光猫</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>1.2k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>4 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p><strong>路由器型号 小米R2D</strong></p>
<h3 id="路由器端口"><a href="#路由器端口" class="headerlink" title="路由器端口"></a>路由器端口</h3><p>wan 口 编号：4<br>lan 口 编号：0 2 3<br>CPU端口： 5 </p>
<hr>
<h3 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h3><p><a target="_blank" rel="noopener" href="https://openwrt.org/zh-cn/doc/uci/network">https://openwrt.org/zh-cn/doc/uci/network</a><br><a target="_blank" rel="noopener" href="https://openwrt.org/docs/guide-user/network/vlan/switch">https://openwrt.org/docs/guide-user/network/vlan/switch</a><br><a target="_blank" rel="noopener" href="https://openwrt.org/zh/docs/guide-user/network/vlan/switch_configuration">https://openwrt.org/zh/docs/guide-user/network/vlan/switch_configuration</a></p>
<h3 id="相关资料"><a href="#相关资料" class="headerlink" title="相关资料"></a>相关资料</h3><p>一般来说，0、1、2、3是路由器LAN口，4是路由器WAN口，5表示CPU，而5*表示这个接口是trunk</p>
<p>使用“ *”和“ u”分别表示PVID和未标记的端口（因为它们具有隐式标记的CPU端口，因此需要使用“ u”来取消标记） ）。</p>
<p>在端口上收到的未标记的数据包将被定向到默认端口VLAN（通常称为PVID）。需要一个单独的config switch_port部分来设置默认端口VLAN<br>虚拟局域网。</p>
<p>小米是定制的openwrt系统，采用的是博通闭源驱动，因此vlan设置不能采用openwrt的设定方式，必须采用类似于dd-wr闭源驱动nvram set方式才能使vlan生效。具体是修改&#x2F;etc&#x2F;config&#x2F;misc，将相应的vlanXports参数修改成&#x2F;etc&#x2F;config&#x2F;network里面的port端口号，甚至需要修改&#x2F;etc&#x2F;init.d&#x2F;boot里面的nvram vlan配置参数，然后reboot，重启，新的vlan端口充当wan才能生效</p>
<hr>
<h4 id="原来的"><a href="#原来的" class="headerlink" title="原来的"></a>原来的</h4><table>
<thead>
<tr>
<th>端口编号</th>
<th>5</th>
<th>0</th>
<th>2</th>
<th>3</th>
<th>4</th>
</tr>
</thead>
<tbody><tr>
<td>物理接口</td>
<td>CPU (eth0)</td>
<td>LAN 1</td>
<td>LAN 2</td>
<td>LAN 3</td>
<td>WAN</td>
</tr>
<tr>
<td>VLAN ID 1 (eth0_1)</td>
<td>已标记</td>
<td>未标记</td>
<td>未标记</td>
<td>未标记</td>
<td>禁用</td>
</tr>
<tr>
<td>VLAN ID 2 (eth0_2)</td>
<td>已标记</td>
<td>禁用</td>
<td>禁用</td>
<td>禁用</td>
<td>未标记</td>
</tr>
</tbody></table>
<h4 id="修改后"><a href="#修改后" class="headerlink" title="修改后"></a>修改后</h4><table>
<thead>
<tr>
<th>端口编号</th>
<th>5</th>
<th>0</th>
<th>2</th>
<th>3</th>
<th>4</th>
</tr>
</thead>
<tbody><tr>
<td>物理接口</td>
<td>CPU (eth0)</td>
<td>LAN 1</td>
<td>LAN 2</td>
<td>LAN 3</td>
<td>WAN</td>
</tr>
<tr>
<td>VLAN ID 1 (eth0_1)</td>
<td>已标记</td>
<td>未标记</td>
<td>未标记</td>
<td>禁用</td>
<td>禁用</td>
</tr>
<tr>
<td>VLAN ID 2 (eth0_2)</td>
<td>已标记</td>
<td>禁用</td>
<td>禁用</td>
<td>禁用</td>
<td>已标记（Internet）</td>
</tr>
<tr>
<td>VLAN ID 3 (eth0_3)</td>
<td>已标记</td>
<td>禁用</td>
<td>禁用</td>
<td>未标记</td>
<td>已标记 （IPTV）</td>
</tr>
</tbody></table>
<p><strong>LAN3口直接连接机顶盒</strong></p>
<blockquote>
<p>这个没有测试，因为下面这个更简单</p>
</blockquote>
<hr>
<hr>
<hr>
<hr>
<hr>
<hr>
<h2 id="使用robocfg-配置VLAN"><a href="#使用robocfg-配置VLAN" class="headerlink" title="使用robocfg 配置VLAN"></a>使用robocfg 配置VLAN</h2><blockquote>
<p>上面配置比较麻烦，还是下载一个 robocfg工具，通过工具来进行配置</p>
</blockquote>
<p>下载地址：<br><a target="_blank" rel="noopener" href="https://www.right.com.cn/forum/forum.php?mod=viewthread&tid=334441&page=1">https://www.right.com.cn/forum/forum.php?mod=viewthread&amp;tid=334441&amp;page=1</a></p>
<blockquote>
<p>就是按照这个弄的</p>
</blockquote>
<h3 id="工具说明"><a href="#工具说明" class="headerlink" title="工具说明"></a>工具说明</h3><p>Broadcom BCM5325&#x2F;535x&#x2F;536x&#x2F;5311x switch configuration utility</p>
<p>其实这个CPU是 CPU BCM4709C</p>
<h3 id="复制文件"><a href="#复制文件" class="headerlink" title="复制文件"></a>复制文件</h3><p>先弄到路由器的硬盘上</p>
<p>为了之后使用方便，再复制文件到&#x2F;usr&#x2F;bin目录</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cp /userdisk/data/ftp/robocfg /usr/bin/</span><br><span class="line">cp: can&#x27;t create &#x27;/usr/bin/robocfg&#x27;: Read-only file system</span><br></pre></td></tr></table></figure>
<p>报错，提示是只读的</p>
<p>以读写方式重新挂载根目录</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mount -o remount rw /</span><br></pre></td></tr></table></figure>

<p>然后再复制就可以了</p>
<p>加上执行权限</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">chmod +x robocfg</span><br></pre></td></tr></table></figure>


<h3 id="查看现有VLAN配置"><a href="#查看现有VLAN配置" class="headerlink" title="查看现有VLAN配置"></a>查看现有VLAN配置</h3><p>robocfg show</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"># ./robocfg show</span><br><span class="line">Switch: enabled </span><br><span class="line">Port 0:   DOWN enabled stp: none vlan: 1 jumbo: off mac: 00:00:00:00:00:00</span><br><span class="line">Port 1:   DOWN enabled stp: none vlan: 1 jumbo: off mac: 00:00:00:00:00:00</span><br><span class="line">Port 2: 1000FD enabled stp: none vlan: 1 jumbo: off mac: ec:00:00:d4:00:xx</span><br><span class="line">Port 3:   DOWN enabled stp: none vlan: 1 jumbo: off mac: d4:00:00:c1:00:xx</span><br><span class="line">Port 4: 1000FD enabled stp: none vlan: 2 jumbo: off mac: 00:00:01:00:00:xx</span><br><span class="line">Port 8:   DOWN enabled stp: none vlan: 1 jumbo: off mac: 00:00:00:00:00:00</span><br><span class="line">VLANs: BCM5301x enabled mac_check mac_hash</span><br><span class="line">   1: vlan1: 0 2 3 5t</span><br><span class="line">   2: vlan2: 4 5t</span><br></pre></td></tr></table></figure>

<h3 id="重新配置VLAN"><a href="#重新配置VLAN" class="headerlink" title="重新配置VLAN"></a>重新配置VLAN</h3><p>多插拔两次就可以确定 物理网卡 与 port 0 1 2 3 4 的对应关系了</p>
<table>
<thead>
<tr>
<th>Port</th>
<th>物理端口</th>
</tr>
</thead>
<tbody><tr>
<td>Port 0</td>
<td>LAN 口 1</td>
</tr>
<tr>
<td>Port 2</td>
<td>LAN 口 2</td>
</tr>
<tr>
<td>Port 3</td>
<td>LAN 口 3</td>
</tr>
<tr>
<td>Port 4</td>
<td>WAN 口</td>
</tr>
<tr>
<td>Port 5</td>
<td>CPU端口</td>
</tr>
</tbody></table>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">robocfg vlan 3 ports &quot;3 4t&quot;</span><br></pre></td></tr></table></figure>

<p>配置之后</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">root@XiaoQiang:~# robocfg vlan 3 ports &quot;3 4t&quot;</span><br><span class="line">root@XiaoQiang:~# robocfg show</span><br><span class="line">Switch: enabled </span><br><span class="line">Port 0: 1000FD enabled stp: none vlan: 1 jumbo: off mac: xx:xx:xx:xx:40:75</span><br><span class="line">Port 1:   DOWN enabled stp: none vlan: 1 jumbo: off mac: 00:00:00:00:00:00</span><br><span class="line">Port 2:   DOWN enabled stp: none vlan: 1 jumbo: off mac: xx:xx:xx:xx:40:75</span><br><span class="line">Port 3:   DOWN enabled stp: none vlan: 3 jumbo: off mac: xx:xx:xx:xx:d0:4f</span><br><span class="line">Port 4: 1000FD enabled stp: none vlan: 2 jumbo: off mac: 00:xx:xx:xx:xx:58</span><br><span class="line">Port 8:   DOWN enabled stp: none vlan: 1 jumbo: off mac: 00:00:00:00:00:00</span><br><span class="line">VLANs: BCM5301x enabled mac_check mac_hash</span><br><span class="line">   1: vlan1: 0 2 3 5t</span><br><span class="line">   2: vlan2: 4 5t</span><br><span class="line">   3: vlan3: 3 4t</span><br></pre></td></tr></table></figure>


<h3 id="光猫配置"><a href="#光猫配置" class="headerlink" title="光猫配置"></a>光猫配置</h3><p>取消 Internet 和 IPTV 连接的端口绑定，使用VLAN绑定</p>
<p>默认的 Internet 是没有VLAN的，IPTV默认有两个VLAN：45 和 47 </p>
<h4 id="配置VLAN绑定"><a href="#配置VLAN绑定" class="headerlink" title="配置VLAN绑定"></a>配置VLAN绑定</h4><p>用户侧Vlan ID 为上面定义的 3，Wan口Vlan ID 就填写IPTV的Vlan ID</p>
<blockquote>
<p>选千兆口</p>
</blockquote>
<table>
<thead>
<tr>
<th>类型</th>
<th>用户侧Vlan</th>
<th>WAN侧Vlan</th>
</tr>
</thead>
<tbody><tr>
<td>IPTV 单播</td>
<td>3</td>
<td>45</td>
</tr>
<tr>
<td>IPTV 组播</td>
<td>3</td>
<td>47</td>
</tr>
</tbody></table>
<h3 id="开机自动执行"><a href="#开机自动执行" class="headerlink" title="开机自动执行"></a>开机自动执行</h3><p>将上面的命令写入 &#x2F;etc&#x2F;rc.local 文件中</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">......</span><br><span class="line">robocfg vlan 3 ports &quot;3 4t&quot;</span><br><span class="line">exit 0</span><br></pre></td></tr></table></figure>


<h3 id="路由器连接光猫"><a href="#路由器连接光猫" class="headerlink" title="路由器连接光猫"></a>路由器连接光猫</h3><p>将路由器的3号lan口与机顶盒用网线连接即可</p>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>看4K 高清不卡顿，比wifi稳定，wifi卡是因为干扰太多，弱电箱的位置不好，弱电箱有金属屏蔽了信号，导致看4K高清时偶尔会卡顿，wifi的带宽其实是足够了，机顶盒的网口也是百兆的，wifi还有300兆</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://wangwen135.github.io/%E7%BD%91%E7%BB%9C%E4%B8%8E%E5%AE%89%E5%85%A8/%E7%BD%91%E7%BB%9C/%E7%BD%91%E7%BB%9C%E9%80%9A%E4%BF%A1%E8%BF%87%E7%A8%8B%E4%B8%AD%E7%9A%84%E6%95%B0%E6%8D%AE%E5%8C%85%E6%B5%81%E8%BD%AC/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="王某某">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="王某某的笔记">
      <meta itemprop="description" content="这是一个使用 Hexo 构建的博客，用于分享我的编程经验和学习笔记。">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 王某某的笔记">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/%E7%BD%91%E7%BB%9C%E4%B8%8E%E5%AE%89%E5%85%A8/%E7%BD%91%E7%BB%9C/%E7%BD%91%E7%BB%9C%E9%80%9A%E4%BF%A1%E8%BF%87%E7%A8%8B%E4%B8%AD%E7%9A%84%E6%95%B0%E6%8D%AE%E5%8C%85%E6%B5%81%E8%BD%AC/" class="post-title-link" itemprop="url">网络通信过程中的数据包流转</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2020-05-24 00:00:00" itemprop="dateCreated datePublished" datetime="2020-05-24T00:00:00+08:00">2020-05-24</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E7%BD%91%E7%BB%9C%E4%B8%8E%E5%AE%89%E5%85%A8/" itemprop="url" rel="index"><span itemprop="name">网络与安全</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E7%BD%91%E7%BB%9C%E4%B8%8E%E5%AE%89%E5%85%A8/%E7%BD%91%E7%BB%9C/" itemprop="url" rel="index"><span itemprop="name">网络</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>6.4k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>23 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="网络通信过程中的数据包流转"><a href="#网络通信过程中的数据包流转" class="headerlink" title="网络通信过程中的数据包流转"></a>网络通信过程中的数据包流转</h2><blockquote>
<p>资料整理自网络的各个地方</p>
</blockquote>
<p>首先 我碰到了一个问题，一个数据包从我们的电脑上，经过层层的交换机、路由器到达目标服务器的过程中，数据包会有哪些改动，是如何一步步传递过去又是如何返回回来的？</p>
<p><img src="https://img.wangwen135.top:23456/2023/06/202306211729064.png"></p>
<p>先需要了解一些基本的概念</p>
<h3 id="网络模型"><a href="#网络模型" class="headerlink" title="网络模型"></a>网络模型</h3><h4 id="OSI七层协议模型"><a href="#OSI七层协议模型" class="headerlink" title="OSI七层协议模型"></a>OSI七层协议模型</h4><p>OSI（Open System Interconnection）开放系统互连参考模型是国际标准化组织（ISO）制定的一个用于计算机或通信系统间互联的标准体系。</p>
<p><img src="https://img.wangwen135.top:23456/2023/06/202306211729432.png"></p>
<h4 id="应用层"><a href="#应用层" class="headerlink" title="应用层"></a>应用层</h4><p>DHCP · DNS · FTP · Gopher ·GTP · HTTP · IMAP4 · IRC · NNTP · NTP · POP3 · RPC · RTCP · RTP ·RTSP · SIP · SMTP ·SNMP · SSH · SDP · SOAP .STUN. SSDP · TELNET · XMPP<br>表示层<br>HTTP&#x2F;HTML · FTP · Telnet · ASN.1（具有表示层功能）</p>
<h5 id="会话层"><a href="#会话层" class="headerlink" title="会话层"></a>会话层</h5><p>ADSP ·ASP ·H.245·ISO-SP ·iSNS ·NetBIOS ·PAP ·RPC·<br>RTCP ·SMPP ·SCP ·SSH ·ZIP ·SDP（具有会话层功能）</p>
<h5 id="传输层"><a href="#传输层" class="headerlink" title="传输层"></a>传输层</h5><p>TCP · UDP · TLS · DCCP · SCTP ·RSVP · PPTP</p>
<h5 id="网络层"><a href="#网络层" class="headerlink" title="网络层"></a>网络层</h5><p>IP (IPv4 · IPv6) · ICMP · ICMPv6 · IGMP ·IS-IS · IPsec · BGP · RIP · OSPF ·ARP · RARP</p>
<h5 id="数据链路层"><a href="#数据链路层" class="headerlink" title="数据链路层"></a>数据链路层</h5><p>Wi-Fi(IEEE 802.11) · WiMAX(IEEE 802.16) ·ATM · DTM · 令牌环 · 以太网路 ·<br>FDDI · 帧中继 · GPRS · EVDO · HSPA · HDLC · PPP · L2TP · ISDN ·STP</p>
<h5 id="物理层"><a href="#物理层" class="headerlink" title="物理层"></a>物理层</h5><p>以太网路卡 · 调制解调器 · 电力线通信(PLC) · SONET&#x2F;SDH（光同步数字传输网）<br>G.709（光传输网络） · 光导纤维 · 同轴电缆 · 双绞线</p>
<h4 id="TCP-IP四层模型"><a href="#TCP-IP四层模型" class="headerlink" title="TCP&#x2F;IP四层模型"></a>TCP&#x2F;IP四层模型</h4><p>TCP&#x2F;IP协议栈是美国国防部高级研究计划局计算机网（ARPANET）和其后继因特网使用的参考模型。ARPANET是由美国国防部赞助的研究网络。最初，它只连接了美国境内的四所大学。随后的几年中，它通过租用的电话线连接了数百所大学和政府部门。最终ARPANET发展成为全球规模最大的互连网络-因特网。最初的ARPANET于1990年永久性地关闭。　　</p>
<p>ISO制定的OSI参考模型的过于庞大、复杂招致了许多批评。与此对照，由技术人员自己开发的TCP&#x2F;IP协议栈获得了更为广泛的应用。</p>
<p><img src="https://img.wangwen135.top:23456/2023/06/202306211731251.png"></p>
<h5 id="应用层-1"><a href="#应用层-1" class="headerlink" title="应用层"></a>应用层</h5><ul>
<li>· DHCP(动态主机分配协议)</li>
<li>· DNS (域名解析）</li>
<li>· FTP（File Transfer Protocol）文件传输协议</li>
<li>· Gopher （英文原义：The Internet Gopher Protocol 中文释义：（RFC-1436）网际Gopher协议）</li>
<li>· HTTP （Hypertext Transfer Protocol）超文本传输协议</li>
<li>· IMAP4 (Internet Message Access Protocol 4) 即 Internet信息访问协议的第4版本</li>
<li>· IRC （Internet Relay Chat ）网络聊天协议</li>
<li>· NNTP （Network News Transport Protocol）RFC-977）网络新闻传输协议</li>
<li>· XMPP 可扩展消息处理现场协议</li>
<li>· POP3 (Post Office Protocol 3)即邮局协议的第3个版本</li>
<li>· SIP 信令控制协议</li>
<li>· SMTP （Simple Mail Transfer Protocol）即简单邮件传输协议</li>
<li>· SNMP (Simple Network Management Protocol,简单网络管理协议)</li>
<li>· SSH （Secure Shell）安全外壳协议</li>
<li>. SSL: 安全套接字层协议；</li>
<li>· TELNET 远程登录协议</li>
<li>· RPC （Remote Procedure Call Protocol）（RFC-1831）远程过程调用协议</li>
<li>· RTCP （RTP Control Protocol）RTP 控制协议</li>
<li>· RTSP （Real Time Streaming Protocol）实时流传输协议</li>
<li>· TLS （Transport Layer Security Protocol）传输层安全协议</li>
<li>· SDP( Session Description Protocol）会话描述协议</li>
<li>· SOAP （Simple Object Access Protocol）简单对象访问协议</li>
<li>· GTP 通用数据传输平台</li>
<li>· STUN （Simple Traversal of UDP over NATs，NAT 的UDP简单穿越）是一种网络协议</li>
<li>· NTP （Network Time Protocol）网络校时协议</li>
</ul>
<h5 id="传输层-1"><a href="#传输层-1" class="headerlink" title="传输层"></a>传输层</h5><ul>
<li>·TCP（Transmission Control Protocol）传输控制协议</li>
<li>· UDP (User Datagram Protocol）用户数据报协议</li>
<li>· DCCP （Datagram Congestion Control Protocol）数据报拥塞控制协议</li>
<li>· SCTP（STREAM CONTROL TRANSMISSION PROTOCOL）流控制传输协议</li>
<li>· RTP(Real-time Transport Protocol或简写RTP）实时传送协议</li>
<li>· RSVP （Resource ReSer Vation Protocol）资源预留协议</li>
<li>· PPTP ( Point to Point Tunneling Protocol）点对点隧道协议</li>
</ul>
<h5 id="网络层-1"><a href="#网络层-1" class="headerlink" title="网络层"></a>网络层</h5><ul>
<li>·IP(IPv4 · IPv6) Internet Protocol（网络之间互连的协议）</li>
<li>·ARP : Address Resolution Protocol即地址解析协议，实现通过IP地址得知其物理地址。</li>
<li>·RARP :Reverse Address Resolution Protocol - 反向地址转换协议允许局域网的物理机器从网关服务器的 ARP 表或者缓存上请求其 IP 地址。</li>
<li>·ICMP :（Internet Control Message - Protocol）Internet控制报文协议。它是TCP&#x2F;IP协议族的一个子协议，用于在IP主机、路由器- 之间传递控制消息。</li>
<li>·ICMPv6:</li>
<li>·IGMP :Internet 组管理协议（IGMP）是因特网协议家族中的一个组播协议，用于IP - 主机向任一个直接相邻的路由器报告他们的组成员情况。</li>
<li>·RIP : 路由信息协议（RIP）是一种在网关与主机之间交换路由选择信息的标准。</li>
<li>·OSPF : (Open Shortest Path First开放式最短路径优先).</li>
<li>·BGP :（Border Gateway Protocol - ）边界网关协议，用来连接Internet上独立系统的路由选择协议</li>
<li>·IS-IS:（Intermediate System to Intermediate System Routing - Protocol）中间系统到中间系统的路由选择协议.</li>
<li>·IPsec:“Internet 协议安全性”是一种开放标准的框架结构，通过使用加密的安全服务以确保- 在Internet 协议 (IP) 网络上进行保密而安全的通讯。</li>
</ul>
<h5 id="数据链路层-1"><a href="#数据链路层-1" class="headerlink" title="数据链路层"></a>数据链路层</h5><p>802.11 · 802.16 · Wi-Fi · WiMAX · ATM · DTM · 令牌环 · 以太网 · FDDI · 帧中继 · GPRS · EVDO · HSPA · HDLC · PPP · L2TP · ISDN
　　</p>
<h5 id="物理层-1"><a href="#物理层-1" class="headerlink" title="物理层"></a>物理层</h5><p>以太网物理层 · 调制解调器 · PLC · SONET&#x2F;SDH · G.709 · 光导纤维 · 同轴电缆 · 双绞线</p>
<h3 id="OSI七层和TCP-IP四层的关系"><a href="#OSI七层和TCP-IP四层的关系" class="headerlink" title="OSI七层和TCP&#x2F;IP四层的关系"></a>OSI七层和TCP&#x2F;IP四层的关系</h3><ol>
<li>OSI引进了服务、接口、协议、分层的概念，TCP&#x2F;IP借鉴了OSI的这些概念建立TCP&#x2F;IP模型。</li>
<li>OSI先有模型，后有协议，先有标准，后进行实践；而TCP&#x2F;IP则相反，先有协议和应用，再提出了模型，且是参照OSI模型。</li>
<li>OSI是一种理论下的模型，而TCP&#x2F;IP已经被广泛应用，称为网络互联实施上的标准。</li>
</ol>
<h3 id="数据包的封装与解析"><a href="#数据包的封装与解析" class="headerlink" title="数据包的封装与解析"></a>数据包的封装与解析</h3><h4 id="封包"><a href="#封包" class="headerlink" title="封包"></a>封包</h4><p>应用程序产生并发送数据，数据经过层层包装，最后数据将封装成以太网帧，再从链路中发送出去。<br>通信过程中，每层协议都要加上一个数据首部（header），称为封装（Encapsulation）</p>
<p><img src="https://img.wangwen135.top:23456/2023/06/202306211736437.png"></p>
<h4 id="解包"><a href="#解包" class="headerlink" title="解包"></a>解包</h4><p>数据包到达目标机器后经过相反的过程，最终被目标程序接收</p>
<p><img src="https://img.wangwen135.top:23456/2023/06/202306211736805.png"></p>
<h3 id="各层的数据报文结构"><a href="#各层的数据报文结构" class="headerlink" title="各层的数据报文结构"></a>各层的数据报文结构</h3><h4 id="TCP数据报"><a href="#TCP数据报" class="headerlink" title="TCP数据报"></a>TCP数据报</h4><p><img src="https://img.wangwen135.top:23456/2023/06/202306211737955.png"></p>
<p><img src="https://img.wangwen135.top:23456/2023/06/202306211737508.png"></p>
<p><img src="https://img.wangwen135.top:23456/2023/06/202306211737511.png"></p>
<h4 id="IP数据报"><a href="#IP数据报" class="headerlink" title="IP数据报"></a>IP数据报</h4><p><img src="https://img.wangwen135.top:23456/2023/06/202306211737666.png"></p>
<p><img src="https://img.wangwen135.top:23456/2023/06/202306211737711.png"></p>
<p><img src="https://img.wangwen135.top:23456/2023/06/202306211738219.png"></p>
<h4 id="以太网数据帧"><a href="#以太网数据帧" class="headerlink" title="以太网数据帧"></a>以太网数据帧</h4><p><img src="https://img.wangwen135.top:23456/2023/06/202306211738312.png"></p>
<ul>
<li><strong>Preamble</strong>：前导码，序言：7byte或56bits的长度，为交替的0和1，来进行时钟同步。</li>
<li><strong>SFD</strong>：Start frame delimiter (SFD)帧开始符号. 该符号 (1 byte: 10101011)表示了下面就是数据了，不能继续用来时钟同步了。10101011与preamble的1结尾相连接，形成2个1作为标志。</li>
<li><strong>Destination address</strong> 和 <strong>source address</strong> 就是源mac和目的mac地址</li>
<li><strong>Type</strong> ：类型. 此字段定义包封装在其中的上层协议的框架。该协议可以是IP、ARP、OSPF等。</li>
<li><strong>Data</strong>：数据来源于上一层，大小应在46到1500byte之间，如果小于46，则会自动补0，反之需要分割</li>
<li><strong>CRC</strong>：错误检测：检测源和目的mac地址与数据的和，如果发现错误，则该帧丢弃。</li>
</ul>
<p><img src="https://img.wangwen135.top:23456/2023/06/202306211742666.png"></p>
<h5 id="Wireshark-抓包数据"><a href="#Wireshark-抓包数据" class="headerlink" title="Wireshark 抓包数据"></a>Wireshark 抓包数据</h5><p><img src="https://img.wangwen135.top:23456/2023/06/202306211743928.png"></p>
<h3 id="数据包的传输"><a href="#数据包的传输" class="headerlink" title="数据包的传输"></a>数据包的传输</h3><p><strong>传输示意图</strong></p>
<p><img src="https://img.wangwen135.top:23456/2023/06/202306211752486.png"></p>
<h4 id="以太网帧在数据链路层传输"><a href="#以太网帧在数据链路层传输" class="headerlink" title="以太网帧在数据链路层传输"></a>以太网帧在数据链路层传输</h4><p><img src="https://img.wangwen135.top:23456/2023/06/202306211752366.png"></p>
<h4 id="TCP数据传输过程"><a href="#TCP数据传输过程" class="headerlink" title="TCP数据传输过程"></a>TCP数据传输过程</h4><p><img src="https://img.wangwen135.top:23456/2023/06/202306211753773.png"></p>
<h4 id="TCP的三次握手和四次挥手"><a href="#TCP的三次握手和四次挥手" class="headerlink" title="TCP的三次握手和四次挥手"></a>TCP的三次握手和四次挥手</h4><p><img src="https://img.wangwen135.top:23456/2023/06/202306211753049.png"></p>
<h5 id="建立连接"><a href="#建立连接" class="headerlink" title="建立连接"></a>建立连接</h5><p><img src="https://img.wangwen135.top:23456/2023/06/202306211754196.png"></p>
<ul>
<li>第一次握手：客户端发送一个TCP的SYN标志位置1的包指明客户打算连接的服务器的端口，以及初始序号X,保存在包头的序列号(Sequence Number)字段里。</li>
<li>第二次握手：服务器发回确认包(ACK)应答。即SYN标志位和ACK标志位均为1同时，将确认序号(Acknowledgement Number)设置为客户的ISN加1以.即X+1。</li>
<li>第三次握手：客户端再次发送确认包(ACK) SYN标志位为0,ACK标志位为1.并且把服务器发来ACK的序号字段+1,放在确定字段中发送给对方.并且在数据段放写ISN的+1。</li>
</ul>
<h5 id="断开连接"><a href="#断开连接" class="headerlink" title="断开连接"></a>断开连接</h5><p><img src="https://img.wangwen135.top:23456/2023/06/202306211755492.png"></p>
<ul>
<li>第一次挥手：客户端发送一个FIN，用来关闭服务端到Server的数据传送，客户端进入FIN_WAIT_1状态。</li>
<li>第二次挥手：服务端 收到FIN后，发送一个ACK给Client，确认序号为收到序号+1（与SYN相同，一个FIN占用一个序号），服务端进入CLOSE_WAIT状态</li>
<li>第三次挥手：服务端发送一个FIN，用来关闭Server到Client的数据传送，服务端进入LAST_ACK状态。</li>
<li>第四次挥手：客服端收到FIN后，服务端进入TIME_WAIT状态，接着发送一个ACK给服务端，确认序号为收到序号+1，Server进入CLOSED状态，完成四次挥手</li>
</ul>
<h3 id="网络设备与网络结构"><a href="#网络设备与网络结构" class="headerlink" title="网络设备与网络结构"></a>网络设备与网络结构</h3><p>首先大概知道什么是交换机、路由器和网关设备等，以及常见的网络结构</p>
<h4 id="交换机"><a href="#交换机" class="headerlink" title="交换机"></a>交换机</h4><p>这里指以太网交换机，以太网交换机的结构是每个端口都直接与主机相连，并且一般都工作在全双工方式。交换机能同时连通许多对端口，使每一对相互通信的主机都能像独占通信媒体那样，进行无冲突地传输数据。</p>
<p>以太网交换机工作于OSI网络参考模型的第二层（即数据链路层），是一种基于MAC（Media Access Control，介质访问控制）地址识别、完成以太网数据帧转发的网络设备。</p>
<p>交换机在端口上接受计算机发送过来的数据帧，根据帧头的目的MAC地址查找MAC地址表然后将该数据帧从对应端口上转发出去，从而实现数据交换。</p>
<h4 id="路由器"><a href="#路由器" class="headerlink" title="路由器"></a>路由器</h4><p>路由器是连接两个或多个网络的硬件设备，在网络间起网关的作用，是读取每一个数据包中的地址然后决定如何传送的专用智能性的网络设备。</p>
<p>路由器又可以称之为网关设备。工作于OSI网络参考模型的第三层（即网络层），对不同的网络之间的数据包进行存储、分组转发处理，而数据在一个子网中传输到另一个子网中，可以通过路由器的路由功能进行处理。在网络通信中，路由器具有判断网络地址以及选择IP路径的作用，可以在多个网络环境中，构建灵活的链接系统，通过不同的数据分组以及介质访问方式对各个子网进行链接。路由器在操作中仅接受源站或者其他相关路由器传递的信息，是一种基于网络层的互联设备。</p>
<p>路由器只能根据具体的IP地址来转发数据，IP地址由网络地址和主机地址两部分组成。计算机之间的通信只能在具有相同网络地址的IP地址之间进行，如果想要与其他网段的计算机进行通信，则必须经过路由器转发出去。</p>
<p>路由器的多个端口可以连接多个网段，每个端口的IP地址的网络地址都必须与所连接的网段的网络地址一致。不同的端口它的网络地址是不同的，所对应的网段也是不同的，这样才能使各个网段中的主机通过自己网段的IP地址把数据发送到路由器上。</p>
<p>对于每一个接收到的数据包，路由器都会重新计算其校验值，并写入新的物理地址。</p>
<p>路由器的主要工作就是为经过路由器的每个数据帧寻找一条最佳传输路径，并将该数据有效地传送到目的站点。</p>
<h4 id="网关"><a href="#网关" class="headerlink" title="网关"></a>网关</h4><p>网关(Gateway)又称网间连接器、协议转换器。默认网关在【网络层】上以实现网络互连，是最复杂的网络互连设备，仅用于两个高层协议不同的网络互连。网关的结构也和路由器类似，不同的是互连层。网关既可以用于广域网互连，也可以用于局域网互连。</p>
<p>【说明：由于历史的原因，许多有关TCP&#x2F;IP的文献曾经把网络层使用的路由器称为网关，在今天很多局域网采用都是路由来接入网络，因此通常指的网关就是路由器的IP！】</p>
<p>那么网关到底是什么呢？网关实质上是一个网络通向其他网络的IP地址。比如有网络A和网络B，网络A的IP地址范围为“192.168.1.1<del>192. 168.1.254”，子网掩码为255.255.255.0；网络B的IP地址范围为“192.168.2.1</del>192.168.2.254”，子网掩码为255.255.255.0。在没有路由器的情况下，两个网络之间是不能进行TCP&#x2F;IP通信的，即使是两个网络连接在同一台交换机（或集线器）上，TCP&#x2F;IP协议也会根据子网掩码（255.255.255.0）判定两个网络中的主机处在不同的网络里。而要实现这两个网络之间的通信，则必须通过网关。如果网络A中的主机发现数据包的目的主机不在本地网络中，就把数据包转发给它自己的网关，再由网关转发给网络B的网关，网络B的网关再转发给网络B的某个主机</p>
<p>只有设置好网关的IP地址，TCP&#x2F;IP协议才能实现不同网络之间的相互通信。那么这个IP地址是哪台机器的IP地址呢？网关的IP地址是具有路由功能的设备的IP地址，具有路由功能的设备有路由器、启用了路由协议的服务器（实质上相当于一台路由器）、代理服务器（也相当于一台路由器）。</p>
<h4 id="网关和路由器的区别"><a href="#网关和路由器的区别" class="headerlink" title="网关和路由器的区别"></a>网关和路由器的区别</h4><p>首先‘网关’一个大概念，不具体特指一类产品，只要连接两个不同的网络的设备都可以叫网关；而‘路由器’么一般特指能够实现路由寻找和转发的特定类产品，路由器很显然能够实现网关的功能。</p>
<p>我们在PC上设置的默认网关是什么，默认网关事实上不是一个产品而是一个网络层的概念，PC本身不具备路由寻址能力，所以PC要把所有的IP包发送到一个默认的中转地址上面进行转发，也就是默认网关。这个网关可以在路由器上，可以在三层交换机上，可以在防火墙上，可以在服务器上，所以和物理的设备无关。</p>
<h4 id="家用路由器"><a href="#家用路由器" class="headerlink" title="家用路由器"></a>家用路由器</h4><p><strong>家用路由器 &#x3D; 路由器 + 防火墙 + 交换机  &#x3D; 防火墙 + 交换机 + NAT</strong></p>
<p><strong>防火墙</strong>：路由器在许多方面扮演着基本防火墙的角色，包括自动拒绝不属于网络内的计算机与外部世界之间正在进行的交换的一部分的传入数据。另一方面，如果来自未知地址的端口探测突然出现，你的路由器就会充当保镖，拒绝请求，有效地隐藏你的计算机。</p>
<p><strong>网关</strong>：家庭路由器还充当网络交换机。网络交换机是一种硬件，它可以促进内部网络上计算机之间的通信。如果没有交换功能，这些设备可以通过路由器与更大的互联网通信，但不能相互通信。</p>
<p><strong>NAT</strong>：我们都知道，一台家用路由器可以允许多台设备同时连接上网，那么当设备通过家用路由器向网络发送请求后，返回的响应到达路由器时，路由器必须要知道该响应对应的是哪台设备发送的请求。我们向网络供应商（ISP）申请网络访问权限时，ISP会给路由器分配一个公网ip，路由器内部的设备只能使用内网ip。NAT的作用就是实现公网&#x2F;内网ip以及端口的转换。为此，需要一张表，用于记录内外ip和端口的映射关系。<br>假设内网中有两台设备A和B，同时访问同一个外网ip的相同端口。那么在路由器处就会记录如下映射关系：</p>
<blockquote>
<p>（remote ip_r : port_r)–(local ip_a : a_port)<br>（remote ip_r : port_r)–(local ip_b : b_port)</p>
</blockquote>
<p>假设恰好a_port和b_port的值相同，那么来自远端的响应数据到达路由器时，路由器就无法确定该请求应该给A还是给B。对于这种情况，NAT采用一个三元组来进行区分：（remote ip_r : port_r)(nat port)(local ip_a : a_port)，即通过增加nat port来进行区分。当A和B请求到来时，为两个请求生成两个尚未使用的端口：a_port和b_port，并记录如下关系：</p>
<blockquote>
<p>（remote ip_r : port_r)(nat a_port)(local ip_a : same_port)<br>（remote ip_r : port_r)(nat b_port)(local ip_b : same_port)</p>
</blockquote>
<p>即当A请求到达路由器时，路由器将请求的源ip换成ISP分配的公网ip，并将源端口换成a_port；而当请求B到达路由器时，路由器将请求的源ip换成ISP分配的公网ip，并将源端口换成b_port。当A和B的请求返回时，根据返回的目的端口（返回的目的端口就是请求的源端口）是a_port还是b_port即可确定该将响应给A还是B。</p>
<h4 id="Modem"><a href="#Modem" class="headerlink" title="Modem"></a>Modem</h4><p>通过电话线上网的时代，我们通过猫来连接互联网。现在运营商都升级成了光纤了，所以原来的猫换成光猫。</p>
<h5 id="猫"><a href="#猫" class="headerlink" title="猫"></a>猫</h5><p>调制解调器（英文名Modem），俗称“猫”，是一种计算机硬件。</p>
<p>它能把计算机的数字信号翻译成可沿普通电话线传送的脉冲信号，而这些脉冲信号又可被线路另一端的另一个调制解调器接收，并译成计算机可懂的语言。<br>计算机内的信息是由“0”和“1”组成数字信号，而在电话线上传递的却只能是模拟电信号。于是，当两台计算机要通过电话线进行数据传输时，就需要一个设备负责数模的转换。</p>
<h5 id="光猫"><a href="#光猫" class="headerlink" title="光猫"></a>光猫</h5><p>光猫和上面说的猫也是一样的，只是将传输脉冲信号变成了传输光信号。</p>
<p>现在一般的光猫外形都是和无线路由器相似，并且光猫上的天线也是可以发射无线信号的，这种能够自带路由器功能的，并且还能内置wifi功能的光猫，是一种集合光猫和路由一体的机器。</p>
<p>目前，家庭上网基本上都实现了FTTH，也就是光纤入户。 宽带上网、IPTV、电话均通过一根光纤接入，实现了“三网融合”。</p>
<p>生活中，我们使用手电筒时，可以通过明暗的变化传递信息，光纤传输信息跟这个差不多。 </p>
<p>在网络世界里，只有0和1，数字信号不能直接变成光信号，需要将数字信号转换成电信号，比如1用高压表示，0用低压表示。将这些电信号输入到激光、二极管等光源，光源根据信号电压变化而发光，比如高电压发光亮，低电压发光暗。 光信号到达对端时，通过光敏元件根据光的亮度产生不同的电压，转换成电信号，最后将电信号转换成数字信号，这样我们就收到信号了。</p>
<p><img src="https://img.wangwen135.top:23456/2023/06/202306211803884.png"></p>
<h4 id="常见的网络结构"><a href="#常见的网络结构" class="headerlink" title="常见的网络结构"></a>常见的网络结构</h4><p>只是在网上随便找的示例</p>
<h5 id="家庭"><a href="#家庭" class="headerlink" title="家庭"></a>家庭</h5><p><img src="https://img.wangwen135.top:23456/note/2023/06/649bfc2b4cf1f.png" alt="1687944231217.png"></p>
<h5 id="学校"><a href="#学校" class="headerlink" title="学校"></a>学校</h5><p><img src="https://img.wangwen135.top:23456/note/2023/06/649bfc579689d.png" alt="1687944275543.png"></p>
<h5 id="公司"><a href="#公司" class="headerlink" title="公司"></a>公司</h5><p><img src="https://img.wangwen135.top:23456/note/2023/06/649bfc7e8c92a.png" alt="1687944314510.png"></p>
<h3 id="最终结论"><a href="#最终结论" class="headerlink" title="最终结论"></a>最终结论</h3><p>1、当发送的目的地在局域网时，通过IP和子网掩码可以判断，然后根据本地的（IP地址 - 物理地址）映射表（arp协议），就能找到目标的mac直接发送数据包了。</p>
<p>2、当发送的目标地不在局域网中时，数据包会发送到网关（一般就是路由器）</p>
<pre><code>1. 从内网发到公网的数据包，在经过网关后，利用NAT，会被转换成网关的MAC，IP层地址被替换成公网真实IP。网关处会有一个映射关系表，这样返回的数据就会根据此映射关系做相应数据转发。
2. 数据包在经过交换机时不会修改数据，直接转发。
3. 数据包在经过中间路由器之后 源mac 和 目标mac 都是要改变，源mac改成路由器出网卡的mac，目标mac改成下一跳的mac，当然还会重新计算以太网帧的CRC等
</code></pre>
<h4 id="NAT（网络地址转换）"><a href="#NAT（网络地址转换）" class="headerlink" title="NAT（网络地址转换）"></a>NAT（网络地址转换）</h4><p>NAT（Network Address Translation，网络地址转换）是1994年提出的。当在专用网内部的一些主机本来已经分配到了本地IP地址（即仅在本专用网内使用的专用地址），但现在又想和因特网上的主机通信（并不需要加密）时，可使用NAT方法。</p>
<p>这种方法需要在专用网连接到因特网的路由器上安装NAT软件。装有NAT软件的路由器叫做NAT路由器，它至少有一个有效的外部全球IP地址。这样，所有使用本地地址的主机在和外界通信时，都要在NAT路由器上将其本地地址转换成全球IP地址，才能和因特网连接。</p>
<h4 id="NAT的几种实现方式"><a href="#NAT的几种实现方式" class="headerlink" title="NAT的几种实现方式"></a>NAT的几种实现方式</h4><p><strong>静态转换</strong>：是指将内部网络的私有IP地址转换为公有IP地址，IP地址对是一对一的，是一成不变的，某个私有IP地址只转换为某个公有IP地址。借助于静态转换，可以实现外部网络对内部网络中某些特定设备（如服务器）的访问。</p>
<p><strong>动态转换</strong>：是指将内部网络的私有IP地址转换为公用IP地址时，IP地址是不确定的，是随机的，所有被授权访问上Internet的私有IP地址可随机转换为任何指定的合法IP地址。也就是说，只要指定哪些内部地址可以进行转换，以及用哪些合法地址作为外部地址时，就可以进行动态转换。动态转换可以使用多个合法外部地址集。当ISP提供的合法IP地址略少于网络内部的计算机数量时。可以采用动态转换的方式。</p>
<p>**端口多路复用（Port address Translation,PAT)**：是指改变外出数据包的源端口并进行端口转换，即端口地址转换（PAT，Port Address Translation).采用端口多路复用方式。内部网络的所有主机均可共享一个合法外部IP地址实现对Internet的访问，从而可以最大限度地节约IP地址资源。同时，又可隐藏网络内部的所有主机，有效避免来自internet的攻击。因此，目前网络中应用最多的就是端口多路复用方式。</p>
<p><strong>ALG（Application Level Gateway）</strong>：即应用程序级网关技术：传统的NAT技术只对IP层和传输层头部进行转换处理，但是一些应用层协议，在协议数据报文中包含了地址信息。为了使得这些应用也能透明地完成NAT转换，NAT使用一种称作ALG的技术，它能对这些应用程序在通信时所包含的地址信息也进行相应的NAT转换。例如：对于FTP协议的PORT&#x2F;PASV命令、DNS协议的 “A” 和 “PTR” queries命令和部分ICMP消息类型等都需要相应的ALG来支持。</p>
<h4 id="NAPT"><a href="#NAPT" class="headerlink" title="NAPT"></a>NAPT</h4><p><strong>NAPT（Network Address Port Translation）</strong>，即网络地址端口转换，可将多个内部地址映射为一个合法公网地址，但以不同的协议端口号与不同的内部地址相对应，也就是&lt;内部地址+内部端口&gt;与&lt;外部地址+外部端口&gt;之间的转换。NAPT普遍用于接入设备中，它可以将中小型的网络隐藏在一个合法的IP地址后面。NAPT也被称为“多对一”的NAT，或者叫PAT（Port Address Translations，端口地址转换）、地址超载（address overloading）。</p>
<p>NAPT与动态地址NAT不同，它将内部连接映射到外部网络中的一个单独的IP地址上，同时在该地址上加上一个由NAT设备选定的TCP端口号。NAPT算得上是一种较流行的NAT变体，通过转换TCP或UDP协议端口号以及地址来提供并发性。除了一对源和目的IP地址以外，这个表还包括一对源和目的协议端口号，以及NAT盒使用的一个协议端口号。</p>
<p>NAPT的主要优势在于，能够使用一个全球有效IP地址获得通用性。主要缺点在于其通信仅限于TCP或UDP。当所有通信都采用TCP或UDP，NAPT允许一台内部计算机访问多台外部计算机，并允许多台内部主机访问同一台外部计算机，相互之间不会发生冲突。</p>
<h4 id="内网上网方案"><a href="#内网上网方案" class="headerlink" title="内网上网方案"></a>内网上网方案</h4><p>内网实现上网的方案一般就是Nat 和 Proxy</p>
<hr>
<h3 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h3><p>查看地址解析协议(ARP)使用的“IP 到物理”地址转换表</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">c:\&gt;arp -a</span><br></pre></td></tr></table></figure>
<p>查路由表</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">c:\&gt;route print</span><br></pre></td></tr></table></figure>
<p>追踪路由</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">c:\&gt;tracert baidu.com</span><br></pre></td></tr></table></figure>

<p>抓包<br>Wireshark</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://wangwen135.github.io/%E7%89%88%E6%9C%AC%E6%8E%A7%E5%88%B6/git/centos7%20%E5%AE%89%E8%A3%85%E6%9C%80%E6%96%B0%E7%89%88%E6%9C%AC%E7%9A%84git/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="王某某">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="王某某的笔记">
      <meta itemprop="description" content="这是一个使用 Hexo 构建的博客，用于分享我的编程经验和学习笔记。">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 王某某的笔记">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/%E7%89%88%E6%9C%AC%E6%8E%A7%E5%88%B6/git/centos7%20%E5%AE%89%E8%A3%85%E6%9C%80%E6%96%B0%E7%89%88%E6%9C%AC%E7%9A%84git/" class="post-title-link" itemprop="url">centos7 安装最新版本的git</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2020-05-21 16:10:00" itemprop="dateCreated datePublished" datetime="2020-05-21T16:10:00+08:00">2020-05-21</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E7%89%88%E6%9C%AC%E6%8E%A7%E5%88%B6/" itemprop="url" rel="index"><span itemprop="name">版本控制</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E7%89%88%E6%9C%AC%E6%8E%A7%E5%88%B6/git/" itemprop="url" rel="index"><span itemprop="name">git</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>254</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>1 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h3 id="1-最新git源码下载地址："><a href="#1-最新git源码下载地址：" class="headerlink" title="1 最新git源码下载地址："></a>1 最新git源码下载地址：</h3><p><a target="_blank" rel="noopener" href="https://github.com/git/git/releases">https://github.com/git/git/releases</a><br><a target="_blank" rel="noopener" href="https://www.kernel.org/pub/software/scm/git/">https://www.kernel.org/pub/software/scm/git/</a><br>可以手动下载下来在上传到服务器上面</p>
<h3 id="2-移除旧版本git"><a href="#2-移除旧版本git" class="headerlink" title="2 移除旧版本git"></a>2 移除旧版本git</h3><p>centos自带Git，7.x版本自带git 1.8.3.1（应该是，也可能不是），<br>安装新版本之前需要使用yun remove git卸载（安装后卸载也可以）。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@Git ~]# git --version    ## 查看自带的版本</span><br><span class="line">git version 1.8.3.1</span><br><span class="line">[root@Git ~]# yum remove git   ## 移除原来的版本</span><br></pre></td></tr></table></figure>

<h3 id="3-安装所需软件包"><a href="#3-安装所需软件包" class="headerlink" title="3 安装所需软件包"></a>3 安装所需软件包</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@Git ~]# yum install curl-devel expat-devel gettext-devel openssl-devel zlib-devel </span><br><span class="line">[root@Git ~]# yum install gcc-c++ perl-ExtUtils-MakeMaker</span><br></pre></td></tr></table></figure>
<h3 id="4-下载-安装"><a href="#4-下载-安装" class="headerlink" title="4 下载&amp;安装"></a>4 下载&amp;安装</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@Git ~]# cd /usr/src</span><br><span class="line">[root@Git ~]# wget https://www.kernel.org/pub/software/scm/git/git-2.7.3.tar.gz</span><br></pre></td></tr></table></figure>

<h3 id="5-解压"><a href="#5-解压" class="headerlink" title="5 解压"></a>5 解压</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@Git ~]# tar xf git-2.7.3.tar.gz</span><br></pre></td></tr></table></figure>

<h3 id="6-配置编译安装"><a href="#6-配置编译安装" class="headerlink" title="6 配置编译安装"></a>6 配置编译安装</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@Git ~]# cd git-2.7.3</span><br><span class="line">[root@Git ~]# make configure</span><br><span class="line">[root@Git ~]# ./configure --prefix=/usr/local/git ##配置目录</span><br><span class="line">[root@Git ~]# make profix=/usr/local/git</span><br><span class="line">[root@Git ~]# make install</span><br></pre></td></tr></table></figure>

<h3 id="7-加入环境变量"><a href="#7-加入环境变量" class="headerlink" title="7 加入环境变量"></a>7 加入环境变量</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@Git ~]# echo &quot;export PATH=$PATH:/usr/local/git/bin&quot; &gt;&gt; /etc/profile</span><br><span class="line">[root@Git ~]# source /etc/profile</span><br></pre></td></tr></table></figure>

<h3 id="8-检查版本"><a href="#8-检查版本" class="headerlink" title="8 检查版本"></a>8 检查版本</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@Git git-2.7.3]# git --version </span><br><span class="line">git version 2.7.3</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://wangwen135.github.io/MySQL/mysql%E8%AE%BE%E8%AE%A1%E8%A7%84%E8%8C%83/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="王某某">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="王某某的笔记">
      <meta itemprop="description" content="这是一个使用 Hexo 构建的博客，用于分享我的编程经验和学习笔记。">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 王某某的笔记">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/MySQL/mysql%E8%AE%BE%E8%AE%A1%E8%A7%84%E8%8C%83/" class="post-title-link" itemprop="url">mysql设计规范</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2020-05-14 23:41:00" itemprop="dateCreated datePublished" datetime="2020-05-14T23:41:00+08:00">2020-05-14</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/MySQL/" itemprop="url" rel="index"><span itemprop="name">MySQL</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>1.4k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>5 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>占位置</p>
<p>没有好好整理的！！</p>
<h3 id="基本的运维方面"><a href="#基本的运维方面" class="headerlink" title="基本的运维方面"></a>基本的运维方面</h3><p>装数据库的机器用固态硬盘 !</p>
<p>每天备份数据</p>
<p>主从做好</p>
<p>权限控制好，开发不要给生产环境的权限</p>
<h4 id="运维在手动操作数据库时需要注意："><a href="#运维在手动操作数据库时需要注意：" class="headerlink" title="运维在手动操作数据库时需要注意："></a>运维在手动操作数据库时需要注意：</h4><p>超过100万的批量写操作，要分批多次进行操作</p>
<ol>
<li>主从复制中：大批量操作可能会造成严重的主从延迟，因为当主库执行完成后，才会在从库执行</li>
<li>binlog日志为row格式时会产生大量的日志</li>
<li>注意事物，避免拥堵业务系统</li>
</ol>
<p>对大表数据结构的修改一定要谨慎</p>
<ol>
<li>可能会造成严重的锁表操作</li>
<li>会导致严重的主从延时</li>
<li>执行的时间非常不可控，修改失败导致的事物回滚同样不可控</li>
<li>修改表结构是表级锁，在修改表结构时，影响业务系统对表的写入操作</li>
<li>可以考虑使用pt-online-schema-change</li>
</ol>
<h3 id="命名"><a href="#命名" class="headerlink" title="命名"></a>命名</h3><ol>
<li>小写字母 + 下划线（“_”）  （mysql 对大小写敏感）</li>
<li>除非是备份表或者分表，才可以使用数字命名</li>
<li>使用相同的前缀将关联表显示在一起 如：”user_”</li>
<li>所有数据库对象名称禁止使用mysql保留关键字</li>
<li>临时表用 tmp_为前缀，备份表用bak_ 为前缀</li>
</ol>
<h3 id="注意"><a href="#注意" class="headerlink" title="注意"></a>注意</h3><ol>
<li><p>数据库和表的字符集统一使用UTF8mb4，这个编码支持imog字符表情（但是目前用的多的还是UTF-8）</p>
</li>
<li><p>单表数据量的大小，建议控制在500万以内，不要超过1000万</p>
</li>
<li><p>一般不建议在建立表时使用预留字段，后面要用再加，不然导致系统难以维护</p>
</li>
<li><p>禁止在数据库中存储图片，文件等大的二进制数据，避免使用TEXT、BLOB</p>
</li>
<li><p>表的所有列定义为NOT NULL，并设置默认值。（这个不强制，但是尽量有默认值，NULL字段的查询不好优化，数据量的变化会导致执行计划不一致，NULL字段的索引需要额外空间，NULL字段的复合索引无效，NULL值可能导致索引失效）</p>
</li>
<li><p>金额类数据必须使用decimal类型，double和float 有精度问题</p>
</li>
<li><p>每张表上的索引数量最好不超过6个<br>（控制索引的数量，好像从5.7版本开始：<br>一个表的最大索引数量（非主键索引）为64个，复合索引最多可以包括16个列<br>）</p>
</li>
<li><p>每张表必须有主键，建议使用自增列，主键最好不要用int，免得超过21亿了不够用，使用bigint类型，代码中用long，对分布式ID算法也友好点 （特殊的情况除外，如动态统计表，通过定时任务维护的表）</p>
</li>
<li><p>避免使用数据库约束，主外键，由程序来控制，现在多少分布式的程序，很多时候都会有异步延时处理等，或者最终一致性等</p>
</li>
<li><p>尽量不用视图，自定义函数，存储过程。考虑移植性如之后转成TIDB，和分库分表等。</p>
</li>
<li><p>join操作尽量控制在5个表以内，尽量用程序多次查询组装数据  （控制join表的数量，注意看执行计划，避免全表扫描）</p>
</li>
<li><p>不要再数据库中做运算，将相关逻辑全部放到代码层面</p>
</li>
<li><p>in 的值最好不要超过500（in是会走索引的），尽量使用left join或not exists来优化not in操作  </p>
</li>
<li><p>不要随意使用子查询。子查询的结果会被存储到临时表中，不管是内存还是磁盘都会对性能有一定的影响  ，  嵌套子查询时多出的loop更加致命。</p>
</li>
<li><p>所有表必须使用Innodb存储引擎，Innodb 支持事务，支持行级锁，更好的恢复性，高并发下性能更好，不用Innodb就可以考虑用别的存储了</p>
</li>
<li><p>所有表和字段都需要添加注释</p>
</li>
</ol>
<h3 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h3><h4 id="InnoDB限制"><a href="#InnoDB限制" class="headerlink" title="InnoDB限制"></a>InnoDB限制</h4><ul>
<li>一个表最多可以包含1017列（在MySQL 5.6.9中从1000的限制中提高）。虚拟生成的列包含在此限制中。</li>
<li>一个表最多可以包含64个 二级索引。</li>
<li>InnoDB日志文件的 最大总大小为512GB。</li>
<li></li>
</ul>
<h3 id="数据库三范式"><a href="#数据库三范式" class="headerlink" title="数据库三范式"></a>数据库三范式</h3><ol>
<li>第一范式(1NF)：字段值具有原子性,不能再分(所有关系型数据库系统都满足第一范式);<br>例如：姓名字段,其中姓和名是一个整体,如果区分姓和名那么必须设立两个独立字段;</li>
<li>第二范式(2NF)：一个表必须有主键,即每行数据都能被唯一的区分;<br> 备注：必须先满足第一范式;</li>
<li>第三范式(3NF)：一个表中不能包涵其他相关表中非关键字段的信息,即数据表不能有沉余字段;<br>备注：必须先满足第二范式;</li>
</ol>
<p>一般不会完全按照这个来，比如常使用的冗余字段，如果业务上支持，则能在很大程度上提高效率</p>
<h3 id="监控"><a href="#监控" class="headerlink" title="监控"></a>监控</h3><p>慢日志</p>
<p>show slow log;</p>
<h3 id="安全方面"><a href="#安全方面" class="headerlink" title="安全方面"></a>安全方面</h3><p>预编译语句(prepareStatment)进行数据库操作，可以有效避免动态sql带来的SQL注入的问题</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://wangwen135.github.io/%E7%A1%AC%E4%BB%B6%E4%B8%8E%E7%89%A9%E8%81%94%E7%BD%91/GPS/%E5%88%A4%E6%96%AD%E7%82%B9%E6%98%AF%E5%90%A6%E5%9C%A8%E5%A4%9A%E8%BE%B9%E5%BD%A2%E7%9A%84%E5%9B%B4%E6%A0%8F%E5%86%85/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="王某某">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="王某某的笔记">
      <meta itemprop="description" content="这是一个使用 Hexo 构建的博客，用于分享我的编程经验和学习笔记。">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 王某某的笔记">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/%E7%A1%AC%E4%BB%B6%E4%B8%8E%E7%89%A9%E8%81%94%E7%BD%91/GPS/%E5%88%A4%E6%96%AD%E7%82%B9%E6%98%AF%E5%90%A6%E5%9C%A8%E5%A4%9A%E8%BE%B9%E5%BD%A2%E7%9A%84%E5%9B%B4%E6%A0%8F%E5%86%85/" class="post-title-link" itemprop="url">判断点是否在多边形的围栏内</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2020-05-13 00:00:00" itemprop="dateCreated datePublished" datetime="2020-05-13T00:00:00+08:00">2020-05-13</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E7%A1%AC%E4%BB%B6%E4%B8%8E%E7%89%A9%E8%81%94%E7%BD%91/" itemprop="url" rel="index"><span itemprop="name">硬件与物联网</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E7%A1%AC%E4%BB%B6%E4%B8%8E%E7%89%A9%E8%81%94%E7%BD%91/GPS/" itemprop="url" rel="index"><span itemprop="name">GPS</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>253</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>1 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>从这个点做一条射线，任意方向都行，计算它跟多边形边界的交点个数，如果交点个数为奇数，那么点在多边形内部，否则点在多边形外。</p>
<h3 id="奇数个交点"><a href="#奇数个交点" class="headerlink" title="奇数个交点"></a>奇数个交点</h3><p>该点在多边形内</p>
<p><img src="https://img.wangwen135.top:23456/image/2024/07/66aa540405608.png" alt="1722438652525.png"></p>
<h3 id="偶数个交点"><a href="#偶数个交点" class="headerlink" title="偶数个交点"></a>偶数个交点</h3><p>该点在多边形外</p>
<p><img src="https://img.wangwen135.top:23456/image/2024/07/66aa5418278b1.png" alt="1722438672846.png"></p>
<h3 id="射线与顶点相交的情况"><a href="#射线与顶点相交的情况" class="headerlink" title="射线与顶点相交的情况"></a>射线与顶点相交的情况</h3><h4 id="情况1"><a href="#情况1" class="headerlink" title="情况1"></a>情况1</h4><p>相交的顶点相连的两条边分别在射线的两侧，这种情况算 <strong>相交</strong></p>
<p><img src="https://img.wangwen135.top:23456/image/2024/07/66aa5436ef8a1.png" alt="1722438703868.png"></p>
<p>射线经过顶点D，与顶点D相连的两个点是A和C，A点在射线的上面，C点在射线的下面，这种算相交</p>
<h4 id="情况2"><a href="#情况2" class="headerlink" title="情况2"></a>情况2</h4><p>相交的顶点相连的两条边都在射线的同一侧，这种情况认为 <strong>不相交</strong></p>
<p><img src="https://img.wangwen135.top:23456/image/2024/07/66aa545e85539.png" alt="1722438743099.png"></p>
<p>射线经过顶点D，与顶点D相连的两个点事A和C，A和C都在射线的下面（同一侧），这种不算相交</p>
<h2 id="java代码实现"><a href="#java代码实现" class="headerlink" title="java代码实现"></a>java代码实现</h2><p>算了去找别人写的吧。。。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"></span><br></pre></td></tr></table></figure>


      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://wangwen135.github.io/Maven/Maven%E4%B8%8B%E8%BD%BD%E6%9E%84%E5%BB%BA%E6%B5%8B%E8%AF%95/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="王某某">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="王某某的笔记">
      <meta itemprop="description" content="这是一个使用 Hexo 构建的博客，用于分享我的编程经验和学习笔记。">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 王某某的笔记">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/Maven/Maven%E4%B8%8B%E8%BD%BD%E6%9E%84%E5%BB%BA%E6%B5%8B%E8%AF%95/" class="post-title-link" itemprop="url">Maven下载构建测试</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2020-05-11 10:45:00" itemprop="dateCreated datePublished" datetime="2020-05-11T10:45:00+08:00">2020-05-11</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Maven/" itemprop="url" rel="index"><span itemprop="name">Maven</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>1.1k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>4 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>随意写一个Maven项目，依赖一个<strong>不存在</strong>的构建时的测试记录</p>
<p>使用 mvn compile 命令测试</p>
<hr>
<h2 id="没有配置镜像的测试"><a href="#没有配置镜像的测试" class="headerlink" title="没有配置镜像的测试"></a>没有配置镜像的测试</h2><p>Maven 的 settings.xml 中没有配置<mirror></p>
<h3 id="一、没有配置repository"><a href="#一、没有配置repository" class="headerlink" title="一、没有配置repository"></a>一、没有配置repository</h3><p>使用默认的中央仓库</p>
<h4 id="依赖snapshot版本的构建"><a href="#依赖snapshot版本的构建" class="headerlink" title="依赖snapshot版本的构建"></a>依赖snapshot版本的构建</h4><p>直接拒绝，因为中央仓库不支持snapshot，不会连到中央仓库</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[ERROR] Failed to execute goal on project csv2excel: Could not resolve dependencies for project com.wwh.csv2excel:csv2excel:jar:0.1-SNAPSHOT: Could not find artifact com.wwh.csv2excel:csv2excel:jar:0.7-SNAPSHOT -&gt; [Help 1]</span><br></pre></td></tr></table></figure>
<h4 id="依赖非snapshot版本的构建"><a href="#依赖非snapshot版本的构建" class="headerlink" title="依赖非snapshot版本的构建"></a>依赖非snapshot版本的构建</h4><p>尝试去中央服务器下载，然后提示不存在</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[ERROR] Failed to execute goal on project csv2excel: Could not resolve dependencies for project com.wwh.csv2excel:csv2excel:jar:0.1-SNAPSHOT: Could not find artifact com.wwh.csv2excel:csv2excel:jar:0.8 in central (https://repo.maven.apache.org/maven2) -&gt; [Help 1]</span><br></pre></td></tr></table></figure>

<h3 id="二、-配置了一个repository，且支持snapshot"><a href="#二、-配置了一个repository，且支持snapshot" class="headerlink" title="二、 配置了一个repository，且支持snapshot"></a>二、 配置了一个repository，且支持snapshot</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&lt;repositories&gt;</span><br><span class="line">	&lt;repository&gt;</span><br><span class="line">		&lt;id&gt;nexusRep&lt;/id&gt;</span><br><span class="line">		&lt;url&gt;http://nexus.vvsmart.com:8081/nexus/content/groups/public&lt;/url&gt;</span><br><span class="line">		&lt;releases&gt;</span><br><span class="line">			&lt;enabled&gt;true&lt;/enabled&gt;</span><br><span class="line">		&lt;/releases&gt;</span><br><span class="line">		&lt;snapshots&gt;</span><br><span class="line">			&lt;enabled&gt;true&lt;/enabled&gt;</span><br><span class="line">		&lt;/snapshots&gt;</span><br><span class="line">	&lt;/repository&gt;</span><br><span class="line">&lt;/repositories&gt;</span><br></pre></td></tr></table></figure>

<h4 id="依赖snapshot版本的构建-1"><a href="#依赖snapshot版本的构建-1" class="headerlink" title="依赖snapshot版本的构建"></a>依赖snapshot版本的构建</h4><p>尝试去配置的仓库下载，然后提示不存在</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[ERROR] Failed to execute goal on project csv2excel: Could not resolve dependencies for project com.wwh.csv2excel:csv2excel:jar:0.1-SNAPSHOT: Could not find artifact com.wwh.csv2excel:csv2excel:jar:1.2-SNAPSHOT in nexusRep (http://nexus.vvsmart.com:8081/nexus/content/groups/public) -&gt; [Help 1]</span><br></pre></td></tr></table></figure>

<h4 id="依赖非snapshot版本的构建-1"><a href="#依赖非snapshot版本的构建-1" class="headerlink" title="依赖非snapshot版本的构建"></a>依赖非snapshot版本的构建</h4><p>先从配置的仓库下载，再尝试去中央仓库下载，然后提示无法解析</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">Downloading from nexusRep: http://nexus.vvsmart.com:8081/nexus/content/groups/public/com/wwh/csv2excel/csv2excel/1.4/csv2excel-1.4.pom</span><br><span class="line">Downloading from central: https://repo.maven.apache.org/maven2/com/wwh/csv2excel/csv2excel/1.4/csv2excel-1.4.pom</span><br><span class="line">[WARNING] The POM for com.wwh.csv2excel:csv2excel:jar:1.4 is missing, no dependency information available</span><br><span class="line">Downloading from nexusRep: http://nexus.vvsmart.com:8081/nexus/content/groups/public/com/wwh/csv2excel/csv2excel/1.4/csv2excel-1.4.jar</span><br><span class="line">Downloading from central: https://repo.maven.apache.org/maven2/com/wwh/csv2excel/csv2excel/1.4/csv2excel-1.4.jar</span><br><span class="line">[INFO] ------------------------------------------------------------------------</span><br><span class="line">[INFO] BUILD FAILURE</span><br><span class="line">[INFO] ------------------------------------------------------------------------</span><br><span class="line">[INFO] Total time: 11.304 s</span><br><span class="line">[INFO] Finished at: 2020-05-09T21:02:10+08:00</span><br><span class="line">[INFO] ------------------------------------------------------------------------</span><br><span class="line">[ERROR] Failed to execute goal on project csv2excel: Could not resolve dependencies for project com.wwh.csv2excel:csv2excel:jar:0.1-SNAPSHOT: Could not find artifact com.wwh.csv2excel:csv2excel:jar:1.4 in nexusRep (http://nexus.vvsmart.com:8081/nexus/content/groups/public) -&gt; [Help 1]</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="三、-配置了多个repository，且支持snapshot"><a href="#三、-配置了多个repository，且支持snapshot" class="headerlink" title="三、 配置了多个repository，且支持snapshot"></a>三、 配置了多个repository，且支持snapshot</h3><p>配置三个repository，地址实际上是不存在的，这里只验证下载构建的顺序</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[INFO] --------------------------------[ jar ]---------------------------------</span><br><span class="line">Downloading from nexusRep: http://nexus.vvsmart.com:8081/nexus/content/groups/public/com/wwh/csv2excel/csv2excel/1.5/csv2excel-1.5.pom</span><br><span class="line">Downloading from aaa: http://192.168.0.11:8081/nexus/content/groups/public/com/wwh/csv2excel/csv2excel/1.5/csv2excel-1.5.pom</span><br><span class="line">Downloading from bbb: http://192.168.0.12:8081/nexus/content/groups/public/com/wwh/csv2excel/csv2excel/1.5/csv2excel-1.5.pom</span><br><span class="line">Downloading from central: https://repo.maven.apache.org/maven2/com/wwh/csv2excel/csv2excel/1.5/csv2excel-1.5.pom</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<h3 id="结论"><a href="#结论" class="headerlink" title="结论"></a>结论</h3><p>如果repository不支持snapshot的构建，则不会去这个仓库下载<br>优先使用配置的repository，按照配置的顺序进行下载，最后再用mavne的中央仓库  </p>
<hr>
<h2 id="配置了镜像的测试"><a href="#配置了镜像的测试" class="headerlink" title="配置了镜像的测试"></a>配置了镜像的测试</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;mirror&gt;</span><br><span class="line">    &lt;id&gt;nexus&lt;/id&gt;</span><br><span class="line">    &lt;mirrorOf&gt;*&lt;/mirrorOf&gt;</span><br><span class="line">    &lt;url&gt;http://nexus.vvsmart.com:8081/nexus/content/groups/public&lt;/url&gt;</span><br><span class="line">&lt;/mirror&gt;</span><br></pre></td></tr></table></figure>
<p>一个地址镜像全部仓库</p>
<h3 id="一、没有配置repository-1"><a href="#一、没有配置repository-1" class="headerlink" title="一、没有配置repository"></a>一、没有配置repository</h3><h4 id="依赖snapshot版本的构建-2"><a href="#依赖snapshot版本的构建-2" class="headerlink" title="依赖snapshot版本的构建"></a>依赖snapshot版本的构建</h4><p>默认走到了中央仓库，这个直接被拒绝了，因为没有开启snapshot，提示无法解析，不会连接到镜像服务器</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[ERROR] Failed to execute goal on project csv2excel: Could not resolve dependencies for project com.wwh.csv2excel:csv2excel:jar:0.1-SNAPSHOT: Could not find artifact com.wwh.csv2excel:csv2excel:jar:0.4-SNAPSHOT -&gt; [Help 1]</span><br></pre></td></tr></table></figure>
<h4 id="依赖非snapshot版本的构建-2"><a href="#依赖非snapshot版本的构建-2" class="headerlink" title="依赖非snapshot版本的构建"></a>依赖非snapshot版本的构建</h4><p>会尝试去镜像地址下载，然后提示不存在</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[ERROR] Failed to execute goal on project csv2excel: Could not resolve dependencies for project com.wwh.csv2excel:csv2excel:jar:0.1-SNAPSHOT: Could not find artifact com.wwh.csv2excel:csv2excel:jar:0.3 in nexus (http://nexus.vvsmart.com:8081/nexus/content/groups/public) -&gt; [Help 1]</span><br></pre></td></tr></table></figure>

<h3 id="二、-配置了一个repository，且支持snapshot-1"><a href="#二、-配置了一个repository，且支持snapshot-1" class="headerlink" title="二、 配置了一个repository，且支持snapshot"></a>二、 配置了一个repository，且支持snapshot</h3><p>都会连接到镜像地址，然后提示不存在</p>
<h4 id="repository的id的影响"><a href="#repository的id的影响" class="headerlink" title="repository的id的影响"></a>repository的id的影响</h4><h5 id="repository的id为central时"><a href="#repository的id为central时" class="headerlink" title="repository的id为central时"></a>repository的id为central时</h5><p>依赖一个不存在的snapshot版本的构建时，尝试去镜像地址下载</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[ERROR] Failed to execute goal on project csv2excel: Could not resolve dependencies for project com.wwh.csv2excel:csv2excel:jar:0.1-SNAPSHOT: Could not find artifact com.wwh.csv2excel:csv2excel:jar:0.5-SNAPSHOT in nexus (http://nexus.vvsmart.com:8081/nexus/content/groups/public) -&gt; [Help 1]</span><br></pre></td></tr></table></figure>

<h5 id="repository的id为test时"><a href="#repository的id为test时" class="headerlink" title="repository的id为test时"></a>repository的id为test时</h5><p>依赖一个不存在的snapshot版本的构建时，尝试去镜像地址下载</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[ERROR] Failed to execute goal on project csv2excel: Could not resolve dependencies for project com.wwh.csv2excel:csv2excel:jar:0.1-SNAPSHOT: Could not find artifact com.wwh.csv2excel:csv2excel:jar:0.6-SNAPSHOT in nexus (http://nexus.vvsmart.com:8081/nexus/content/groups/public) -&gt; [Help 1]</span><br></pre></td></tr></table></figure>

<h3 id="结论-1"><a href="#结论-1" class="headerlink" title="结论"></a>结论</h3><p>Maven也会先判断本地的repository是否支持snapshot，再决定是否需要去该仓库下载，再连到镜像服务器  </p>
<p>是否需要将repository的id设置为central（ 为了覆盖超级POM中央仓库的配置）并不重要，反正都会走的镜像服务器中，只要有任意一个仓库支持snapshot就可以了</p>
<p>且配置了镜像之后，repository的Url并不重要，反正不会用到</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://wangwen135.github.io/%E5%A4%A7%E6%95%B0%E6%8D%AE/Kafka/Kafka%202.11-0.10.1.0%20%E6%95%85%E9%9A%9C%E5%88%86%E6%9E%90%E4%B8%8E%E5%A4%84%E7%90%86/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="王某某">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="王某某的笔记">
      <meta itemprop="description" content="这是一个使用 Hexo 构建的博客，用于分享我的编程经验和学习笔记。">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 王某某的笔记">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/%E5%A4%A7%E6%95%B0%E6%8D%AE/Kafka/Kafka%202.11-0.10.1.0%20%E6%95%85%E9%9A%9C%E5%88%86%E6%9E%90%E4%B8%8E%E5%A4%84%E7%90%86/" class="post-title-link" itemprop="url">Kafka 2.11-0.10.1.0 故障分析与处理</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2020-04-24 10:43:36" itemprop="dateCreated datePublished" datetime="2020-04-24T10:43:36+08:00">2020-04-24</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%A4%A7%E6%95%B0%E6%8D%AE/" itemprop="url" rel="index"><span itemprop="name">大数据</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%A4%A7%E6%95%B0%E6%8D%AE/Kafka/" itemprop="url" rel="index"><span itemprop="name">Kafka</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>5.3k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>19 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="问题描述"><a href="#问题描述" class="headerlink" title="问题描述"></a>问题描述</h2><p>线上环境每过一段时间（一个月左右） kafka就会故障无法访问，三个服务器都正常，kafka进程正常，但是会出现一个节点和其他两个节点断开的情况，表现形式上类似脑裂，日志中显示正常节点无法连接到故障的节点</p>
<p>出现问题 就不会再自动恢复了</p>
<p>重启故障节点即可解决这个问题</p>
<h2 id="环境信息"><a href="#环境信息" class="headerlink" title="环境信息"></a>环境信息</h2><h3 id="集群"><a href="#集群" class="headerlink" title="集群"></a>集群</h3><p>三台机器组成的kafka集群  </p>
<ul>
<li>192.168.1.217 RD-MQ-01</li>
<li>192.168.1.218 RD-MQ-02</li>
<li>192.168.1.219 RD-MQ-03</li>
</ul>
<h3 id="kafka-版本"><a href="#kafka-版本" class="headerlink" title="kafka 版本"></a>kafka 版本</h3><p>kafka_2.11-0.10.1.0</p>
<h3 id="zookeeper-版本"><a href="#zookeeper-版本" class="headerlink" title="zookeeper 版本"></a>zookeeper 版本</h3><p>3.4.10-4181</p>
<blockquote>
<p>ZK独立部署，不与其他程序共用</p>
</blockquote>
<h3 id="java-版本"><a href="#java-版本" class="headerlink" title="java 版本"></a>java 版本</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@RD-MQ-01 ~]# java -version</span><br><span class="line">java version &quot;1.8.0_162&quot;</span><br><span class="line">Java(TM) SE Runtime Environment (build 1.8.0_162-b12)</span><br><span class="line">Java HotSpot(TM) 64-Bit Server VM (build 25.162-b12, mixed mode)</span><br></pre></td></tr></table></figure>

<h3 id="操作系统版本"><a href="#操作系统版本" class="headerlink" title="操作系统版本"></a>操作系统版本</h3><p>CentOS 6.8</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@RD-MQ-02 bin]# uname -a</span><br><span class="line">Linux RD-MQ-02 2.6.32-642.el6.x86_64 #1 SMP Tue May 10 17:27:01 UTC 2016 x86_64 x86_64 x86_64 GNU/Linux</span><br><span class="line"></span><br><span class="line">[root@RD-MQ-02 bin]# cat /etc/redhat-release </span><br><span class="line">CentOS release 6.8 (Final)</span><br></pre></td></tr></table></figure>

<h2 id="相关配置"><a href="#相关配置" class="headerlink" title="相关配置"></a>相关配置</h2><h3 id="kafka"><a href="#kafka" class="headerlink" title="kafka"></a>kafka</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line">############################# Server Basics #############################</span><br><span class="line">broker.id=218</span><br><span class="line">delete.topic.enable=true</span><br><span class="line"></span><br><span class="line">############################# Socket Server Settings #############################</span><br><span class="line">host.name=192.168.1.218</span><br><span class="line">listeners=PLAINTEXT://192.168.1.218:9092</span><br><span class="line">num.network.threads=4</span><br><span class="line">num.io.threads=4</span><br><span class="line">socket.send.buffer.bytes=102400</span><br><span class="line">socket.receive.buffer.bytes=102400</span><br><span class="line">socket.request.max.bytes=104857600</span><br><span class="line"></span><br><span class="line">############################# Log Basics #############################</span><br><span class="line">log.dirs=/opt/data/kafka</span><br><span class="line">num.partitions=32</span><br><span class="line"></span><br><span class="line">############################# Internal Topic Settings  #############################</span><br><span class="line">offsets.topic.replication.factor=3</span><br><span class="line">transaction.state.log.replication.factor=3</span><br><span class="line">transaction.state.log.min.isr=3</span><br><span class="line"></span><br><span class="line">############################# Log Flush Policy #############################</span><br><span class="line"># 每当producer写入10000条消息时，刷数据到磁盘</span><br><span class="line">log.flush.interval.messages=2000</span><br><span class="line"># 每间隔1秒钟时间，刷数据到磁盘</span><br><span class="line">log.flush.interval.ms=1000</span><br><span class="line"></span><br><span class="line">############################# Log Retention Policy #############################</span><br><span class="line"># 日志保留的时长与大小，二者满足其一即生效，此处大小为200GB</span><br><span class="line">log.retention.hours=72</span><br><span class="line">log.retention.bytes=214748364800</span><br><span class="line"># 消息体大小</span><br><span class="line">message.max.byte=1</span><br><span class="line"># 副本数,Replica过少会影响数据的可用性，太多则会白白浪费存储资源，一般建议在2~3为宜。</span><br><span class="line">default.replication.factor=3</span><br><span class="line"># Producer用于压缩数据的压缩类型</span><br><span class="line">compression.type=gzip</span><br><span class="line"># replicas每次获取数据的最大字节数</span><br><span class="line">replica.fetch.max.bytes=5242880</span><br><span class="line"></span><br><span class="line"># 在Replica上会启动若干Fetch线程把对应的数据同步到本地，而num.replica.fetchers这个参数是用来控制Fetch线程的数量。</span><br><span class="line"># 每个Partition启动的多个Fetcher，通过共享offset既保证了同一时间内Consumer和Partition之间的一对一关系，又允许我们通过增多Fetch线程来提高效率。</span><br><span class="line">num.replica.fetchers=4</span><br><span class="line"></span><br><span class="line"># 段文件配置1GB，有利于快速回收磁盘空间，重启kafka加载也会加快(如果文件过小，则文件数量比较多，kafka启动时是单线程扫描目录(log.dir)下所有数据文件),此处为1G</span><br><span class="line">log.segment.bytes=1073741824</span><br><span class="line"></span><br><span class="line">log.retention.check.interval.ms=300000</span><br><span class="line"></span><br><span class="line">############################# Zookeeper #############################</span><br><span class="line">zookeeper.connect=192.168.1.217:5181,192.168.1.218:5181,192.168.1.219:5181</span><br><span class="line"></span><br><span class="line"># Timeout in ms for connecting to zookeeper</span><br><span class="line">zookeeper.connection.timeout.ms=6000</span><br><span class="line">rebalance.backoff.ms=2000</span><br><span class="line">rebalance.max.retries=10</span><br></pre></td></tr></table></figure>

<h2 id="错误日志"><a href="#错误日志" class="headerlink" title="错误日志"></a>错误日志</h2><p>开发环境下出现了该问题时相关日志信息</p>
<h3 id="217上的kafka日志"><a href="#217上的kafka日志" class="headerlink" title="217上的kafka日志"></a>217上的kafka日志</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[2020-04-22 10:43:36,369] WARN [ReplicaFetcherThread-1-219], Error in fetch kafka.server.ReplicaFetcherThread$FetchRequest@5641fe72 (kafka.server.ReplicaFetcherThread)</span><br><span class="line">java.io.IOException: Connection to 219 was disconnected before the response was read</span><br><span class="line">        at kafka.utils.NetworkClientBlockingOps$$anonfun$blockingSendAndReceive$extension$1$$anonfun$apply$1.apply(NetworkClientBlockingOps.scala:115)</span><br><span class="line">        at kafka.utils.NetworkClientBlockingOps$$anonfun$blockingSendAndReceive$extension$1$$anonfun$apply$1.apply(NetworkClientBlockingOps.scala:112)</span><br><span class="line">        at scala.Option.foreach(Option.scala:257)</span><br><span class="line">        at kafka.utils.NetworkClientBlockingOps$$anonfun$blockingSendAndReceive$extension$1.apply(NetworkClientBlockingOps.scala:112)</span><br><span class="line">        at kafka.utils.NetworkClientBlockingOps$$anonfun$blockingSendAndReceive$extension$1.apply(NetworkClientBlockingOps.scala:108)</span><br><span class="line">        at kafka.utils.NetworkClientBlockingOps$.recursivePoll$1(NetworkClientBlockingOps.scala:137)</span><br><span class="line">        at kafka.utils.NetworkClientBlockingOps$.kafka$utils$NetworkClientBlockingOps$$pollContinuously$extension(NetworkClientBlockingOps.scala:143)</span><br><span class="line">        at kafka.utils.NetworkClientBlockingOps$.blockingSendAndReceive$extension(NetworkClientBlockingOps.scala:108)</span><br><span class="line">        at kafka.server.ReplicaFetcherThread.sendRequest(ReplicaFetcherThread.scala:253)</span><br><span class="line">        at kafka.server.ReplicaFetcherThread.fetch(ReplicaFetcherThread.scala:238)</span><br><span class="line">        at kafka.server.ReplicaFetcherThread.fetch(ReplicaFetcherThread.scala:42)</span><br><span class="line">        at kafka.server.AbstractFetcherThread.processFetchRequest(AbstractFetcherThread.scala:118)</span><br><span class="line">        at kafka.server.AbstractFetcherThread.doWork(AbstractFetcherThread.scala:103)</span><br><span class="line">        at kafka.utils.ShutdownableThread.run(ShutdownableThread.scala:63)</span><br></pre></td></tr></table></figure>

<h3 id="218上的kafka日志"><a href="#218上的kafka日志" class="headerlink" title="218上的kafka日志"></a>218上的kafka日志</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[2020-04-22 10:59:42,687] WARN [ReplicaFetcherThread-1-219], Error in fetch kafka.server.ReplicaFetcherThread$FetchRequest@1722c608 (kafka.server.ReplicaFetcherThread)</span><br><span class="line">java.io.IOException: Connection to 219 was disconnected before the response was read</span><br><span class="line">        at kafka.utils.NetworkClientBlockingOps$$anonfun$blockingSendAndReceive$extension$1$$anonfun$apply$1.apply(NetworkClientBlockingOps.scala:115)</span><br><span class="line">        at kafka.utils.NetworkClientBlockingOps$$anonfun$blockingSendAndReceive$extension$1$$anonfun$apply$1.apply(NetworkClientBlockingOps.scala:112)</span><br><span class="line">        at scala.Option.foreach(Option.scala:257)</span><br><span class="line">        at kafka.utils.NetworkClientBlockingOps$$anonfun$blockingSendAndReceive$extension$1.apply(NetworkClientBlockingOps.scala:112)</span><br><span class="line">        at kafka.utils.NetworkClientBlockingOps$$anonfun$blockingSendAndReceive$extension$1.apply(NetworkClientBlockingOps.scala:108)</span><br><span class="line">        at kafka.utils.NetworkClientBlockingOps$.recursivePoll$1(NetworkClientBlockingOps.scala:137)</span><br><span class="line">        at kafka.utils.NetworkClientBlockingOps$.kafka$utils$NetworkClientBlockingOps$$pollContinuously$extension(NetworkClientBlockingOps.scala:143)</span><br><span class="line">        at kafka.utils.NetworkClientBlockingOps$.blockingSendAndReceive$extension(NetworkClientBlockingOps.scala:108)</span><br><span class="line">        at kafka.server.ReplicaFetcherThread.sendRequest(ReplicaFetcherThread.scala:253)</span><br><span class="line">        at kafka.server.ReplicaFetcherThread.fetch(ReplicaFetcherThread.scala:238)</span><br><span class="line">        at kafka.server.ReplicaFetcherThread.fetch(ReplicaFetcherThread.scala:42)</span><br><span class="line">        at kafka.server.AbstractFetcherThread.processFetchRequest(AbstractFetcherThread.scala:118)</span><br><span class="line">        at kafka.server.AbstractFetcherThread.doWork(AbstractFetcherThread.scala:103)</span><br><span class="line">        at kafka.utils.ShutdownableThread.run(ShutdownableThread.scala:63)</span><br></pre></td></tr></table></figure>

<h3 id="219上的kafka日志"><a href="#219上的kafka日志" class="headerlink" title="219上的kafka日志"></a>219上的kafka日志</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[root@RD-MQ-03 logs]# tail -f server.log</span><br><span class="line">[2020-04-22 10:12:50,317] INFO Rolled new log segment for &#x27;__consumer_offsets-3&#x27; in 26 ms. (kafka.log.Log)</span><br><span class="line">[2020-04-22 10:14:00,179] INFO Deleting segment 485381953 from log __consumer_offsets-3. (kafka.log.Log)</span><br><span class="line">[2020-04-22 10:14:00,179] INFO Deleting segment 0 from log __consumer_offsets-3. (kafka.log.Log)</span><br><span class="line">[2020-04-22 10:14:00,181] INFO Deleting index /opt/data/kafka/__consumer_offsets-3/00000000000485381953.index.deleted (kafka.log.OffsetIndex)</span><br><span class="line">[2020-04-22 10:14:00,181] INFO Deleting index /opt/data/kafka/__consumer_offsets-3/00000000000000000000.index.deleted (kafka.log.OffsetIndex)</span><br><span class="line">[2020-04-22 10:14:00,181] INFO Deleting index /opt/data/kafka/__consumer_offsets-3/00000000000485381953.timeindex.deleted (kafka.log.TimeIndex)</span><br><span class="line">[2020-04-22 10:14:00,181] INFO Deleting index /opt/data/kafka/__consumer_offsets-3/00000000000000000000.timeindex.deleted (kafka.log.TimeIndex)</span><br><span class="line">[2020-04-22 10:14:01,478] INFO Deleting segment 486188481 from log __consumer_offsets-3. (kafka.log.Log)</span><br><span class="line">[2020-04-22 10:14:01,517] INFO Deleting index /opt/data/kafka/__consumer_offsets-3/00000000000486188481.index.deleted (kafka.log.OffsetIndex)</span><br><span class="line">[2020-04-22 10:14:01,517] INFO Deleting index /opt/data/kafka/__consumer_offsets-3/00000000000486188481.timeindex.deleted (kafka.log.TimeIndex)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="ZK-日志"><a href="#ZK-日志" class="headerlink" title="ZK 日志"></a>ZK 日志</h3><p>zk日志正常，zk数据文件正常（大小正常，有定期清理）</p>
<h2 id="问题排查记录"><a href="#问题排查记录" class="headerlink" title="问题排查记录"></a>问题排查记录</h2><h3 id="检查网络"><a href="#检查网络" class="headerlink" title="检查网络"></a>检查网络</h3><p>实际上这三个机器都是互通的</p>
<h4 id="ping"><a href="#ping" class="headerlink" title="ping"></a>ping</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"># 217</span><br><span class="line"></span><br><span class="line">[root@RD-MQ-01 ~]# ping 192.168.1.219</span><br><span class="line">PING 192.168.1.219 (192.168.1.219) 56(84) bytes of data.</span><br><span class="line">64 bytes from 192.168.1.219: icmp_seq=1 ttl=64 time=1.23 ms</span><br><span class="line">64 bytes from 192.168.1.219: icmp_seq=2 ttl=64 time=1.79 ms</span><br><span class="line"></span><br><span class="line"># 218</span><br><span class="line"></span><br><span class="line">[root@RD-MQ-02 ~]# ping 192.168.1.219</span><br><span class="line">PING 192.168.1.219 (192.168.1.219) 56(84) bytes of data.</span><br><span class="line">64 bytes from 192.168.1.219: icmp_seq=1 ttl=64 time=1.76 ms</span><br><span class="line">64 bytes from 192.168.1.219: icmp_seq=2 ttl=64 time=1.28 ms</span><br><span class="line"></span><br><span class="line"># 219</span><br><span class="line"></span><br><span class="line">[root@RD-MQ-03 ~]# ping 192.168.1.218</span><br><span class="line">PING 192.168.1.218 (192.168.1.218) 56(84) bytes of data.</span><br><span class="line">64 bytes from 192.168.1.218: icmp_seq=1 ttl=64 time=0.987 ms</span><br><span class="line">64 bytes from 192.168.1.218: icmp_seq=2 ttl=64 time=1.18 ms</span><br></pre></td></tr></table></figure>

<h4 id="telnet"><a href="#telnet" class="headerlink" title="telnet"></a>telnet</h4><p>telnet 也是通的</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@RD-MQ-02 ~]# telnet 192.168.1.219 9092</span><br><span class="line">Trying 192.168.1.219...</span><br><span class="line">Connected to 192.168.1.219.</span><br><span class="line">Escape character is &#x27;^]&#x27;.</span><br><span class="line"></span><br><span class="line">aa</span><br><span class="line">^]</span><br><span class="line">telnet&gt; q</span><br><span class="line">Connection closed.</span><br></pre></td></tr></table></figure>

<h4 id="netstat"><a href="#netstat" class="headerlink" title="netstat"></a>netstat</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@RD-MQ-02 ~]# netstat -an | grep 219:9092</span><br><span class="line">tcp        0      0 ::ffff:192.168.1.218:36841  ::ffff:192.168.1.219:9092   FIN_WAIT2   </span><br><span class="line">tcp        0      0 ::ffff:192.168.1.218:36840  ::ffff:192.168.1.219:9092   FIN_WAIT2   </span><br><span class="line">tcp        0      0 ::ffff:192.168.1.218:36842  ::ffff:192.168.1.219:9092   ESTABLISHED </span><br><span class="line">tcp        0      0 ::ffff:192.168.1.218:36839  ::ffff:192.168.1.219:9092   FIN_WAIT2   </span><br><span class="line">tcp        0      0 ::ffff:192.168.1.218:36837  ::ffff:192.168.1.219:9092   FIN_WAIT2   </span><br><span class="line">tcp        0      0 ::ffff:192.168.1.218:36844  ::ffff:192.168.1.219:9092   ESTABLISHED </span><br><span class="line">tcp        0      0 ::ffff:192.168.1.218:36838  ::ffff:192.168.1.219:9092   FIN_WAIT2   </span><br><span class="line">tcp        0      0 ::ffff:192.168.1.218:36843  ::ffff:192.168.1.219:9092   ESTABLISHED </span><br></pre></td></tr></table></figure>
<p>连接一直在建立，然后关闭</p>
<h3 id="检查Zookeeper"><a href="#检查Zookeeper" class="headerlink" title="检查Zookeeper"></a>检查Zookeeper</h3><p>ZK 能正常操作读写数据</p>
<p>在ZK中能看到3个kafka的brokers</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[zk: 192.168.1.218:5181(CONNECTED) 4] ls /brokers/ids</span><br><span class="line">[217, 218, 219]</span><br></pre></td></tr></table></figure>

<h3 id="检查kafka-manager"><a href="#检查kafka-manager" class="headerlink" title="检查kafka manager"></a>检查kafka manager</h3><p>只能查询到 Brokers 信息</p>
<p>无法查看topic 和 Consumers</p>
<h3 id="使用kafka命令查看"><a href="#使用kafka命令查看" class="headerlink" title="使用kafka命令查看"></a>使用kafka命令查看</h3><h4 id="topic-list"><a href="#topic-list" class="headerlink" title="topic list"></a>topic list</h4><p>分别在三个机器上查看topic信息，都能列出</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./kafka-topics.sh --list --zookeeper 192.168.1.217:5181</span><br></pre></td></tr></table></figure>
<h4 id="topic-describe"><a href="#topic-describe" class="headerlink" title="topic describe"></a>topic describe</h4><p>挑选一个测试队列【st.topic.yery.test】 查看详情：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">[root@RD-MQ-01 bin]#  ./kafka-topics.sh --zookeeper 192.168.1.217:5181 --topic st.topic.yery.test --describe</span><br><span class="line">Topic:st.topic.yery.test        PartitionCount:32       ReplicationFactor:3     Configs:</span><br><span class="line">        Topic: st.topic.yery.test       Partition: 0    Leader: 218     Replicas: 218,217,219   Isr: 217,218,219</span><br><span class="line">        Topic: st.topic.yery.test       Partition: 1    Leader: 219     Replicas: 219,218,217   Isr: 219</span><br><span class="line">        Topic: st.topic.yery.test       Partition: 2    Leader: 217     Replicas: 217,219,218   Isr: 217,218,219</span><br><span class="line">        Topic: st.topic.yery.test       Partition: 3    Leader: 218     Replicas: 218,219,217   Isr: 217,218,219</span><br><span class="line">        Topic: st.topic.yery.test       Partition: 4    Leader: 219     Replicas: 219,217,218   Isr: 219,217,218</span><br><span class="line">        Topic: st.topic.yery.test       Partition: 5    Leader: 217     Replicas: 217,218,219   Isr: 217,218,219</span><br><span class="line">        Topic: st.topic.yery.test       Partition: 6    Leader: 218     Replicas: 218,217,219   Isr: 217,218,219</span><br><span class="line">        Topic: st.topic.yery.test       Partition: 7    Leader: 219     Replicas: 219,218,217   Isr: 219</span><br><span class="line">        Topic: st.topic.yery.test       Partition: 8    Leader: 217     Replicas: 217,219,218   Isr: 217,218,219</span><br><span class="line">        Topic: st.topic.yery.test       Partition: 9    Leader: 218     Replicas: 218,219,217   Isr: 218,217,219</span><br><span class="line">        Topic: st.topic.yery.test       Partition: 10   Leader: 219     Replicas: 219,217,218   Isr: 219</span><br><span class="line">        Topic: st.topic.yery.test       Partition: 11   Leader: 217     Replicas: 217,218,219   Isr: 217,218,219</span><br><span class="line">        Topic: st.topic.yery.test       Partition: 12   Leader: 218     Replicas: 218,217,219   Isr: 218,217,219</span><br><span class="line">        Topic: st.topic.yery.test       Partition: 13   Leader: 219     Replicas: 219,218,217   Isr: 219,217,218</span><br><span class="line">        Topic: st.topic.yery.test       Partition: 14   Leader: 217     Replicas: 217,219,218   Isr: 217,218,219</span><br><span class="line">        Topic: st.topic.yery.test       Partition: 15   Leader: 218     Replicas: 218,219,217   Isr: 218,217,219</span><br><span class="line">        Topic: st.topic.yery.test       Partition: 16   Leader: 219     Replicas: 219,217,218   Isr: 219,217,218</span><br><span class="line">        Topic: st.topic.yery.test       Partition: 17   Leader: 217     Replicas: 217,218,219   Isr: 217,218,219</span><br><span class="line">        Topic: st.topic.yery.test       Partition: 18   Leader: 218     Replicas: 218,217,219   Isr: 217,218,219</span><br><span class="line">        Topic: st.topic.yery.test       Partition: 19   Leader: 219     Replicas: 219,218,217   Isr: 219,217,218</span><br><span class="line">        Topic: st.topic.yery.test       Partition: 20   Leader: 217     Replicas: 217,219,218   Isr: 217,218,219</span><br><span class="line">        Topic: st.topic.yery.test       Partition: 21   Leader: 218     Replicas: 218,219,217   Isr: 218,217,219</span><br><span class="line">        Topic: st.topic.yery.test       Partition: 22   Leader: 219     Replicas: 219,217,218   Isr: 219,217,218</span><br><span class="line">        Topic: st.topic.yery.test       Partition: 23   Leader: 217     Replicas: 217,218,219   Isr: 217,218,219</span><br><span class="line">        Topic: st.topic.yery.test       Partition: 24   Leader: 218     Replicas: 218,217,219   Isr: 218,217,219</span><br><span class="line">        Topic: st.topic.yery.test       Partition: 25   Leader: 219     Replicas: 219,218,217   Isr: 219</span><br><span class="line">        Topic: st.topic.yery.test       Partition: 26   Leader: 217     Replicas: 217,219,218   Isr: 217,218,219</span><br><span class="line">        Topic: st.topic.yery.test       Partition: 27   Leader: 218     Replicas: 218,219,217   Isr: 218,217,219</span><br><span class="line">        Topic: st.topic.yery.test       Partition: 28   Leader: 219     Replicas: 219,217,218   Isr: 219,217,218</span><br><span class="line">        Topic: st.topic.yery.test       Partition: 29   Leader: 217     Replicas: 217,218,219   Isr: 217,218,219</span><br><span class="line">        Topic: st.topic.yery.test       Partition: 30   Leader: 218     Replicas: 218,217,219   Isr: 218,217,219</span><br><span class="line">        Topic: st.topic.yery.test       Partition: 31   Leader: 219     Replicas: 219,218,217   Isr: 219,217,218</span><br></pre></td></tr></table></figure>

<h4 id="consumer-groups-list"><a href="#consumer-groups-list" class="headerlink" title="consumer-groups list"></a>consumer-groups list</h4><p>查看消费者</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@RD-MQ-02 bin]# ./kafka-consumer-groups.sh --bootstrap-server 192.168.1.217:9092 --list</span><br><span class="line">by.consumer.online.storage</span><br><span class="line">dev.consumer.binlog.analysis</span><br><span class="line">by.consumer.alarm.platform</span><br><span class="line">dp.command.consumer</span><br><span class="line">qa.consumer.binlog.install</span><br><span class="line">qa.consumer.binlog.zone</span><br><span class="line">dp.device.consumer</span><br><span class="line">by.consumer.alarm.zone.normal</span><br><span class="line">qa.consumer.binlog.business</span><br></pre></td></tr></table></figure>

<h4 id="consumer-groups-describe"><a href="#consumer-groups-describe" class="headerlink" title="consumer-groups describe"></a>consumer-groups describe</h4><p>僵死，无法列出消费者的相关信息</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@RD-MQ-02 bin]# ./kafka-consumer-groups.sh --bootstrap-server 192.168.1.217:9092 --group dp.device.consumer --describe</span><br><span class="line">GROUP                          TOPIC                          PARTITION  CURRENT-OFFSET  LOG-END-OFFSET  LAG             OWNER</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>换一个消费者组<br>能看到两个分区的消费信息，实际上应该是32个分区</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@RD-MQ-01 bin]# ./kafka-consumer-groups.sh --bootstrap-server 192.168.1.217:9092,192.168.1.218:9092,192.168.1.219:9092 --group by.consumer.online.storage --describe</span><br><span class="line">GROUP                          TOPIC                          PARTITION  CURRENT-OFFSET  LOG-END-OFFSET  LAG             OWNER</span><br><span class="line">by.consumer.online.storage     by.topic.dp.online.device.message.info 0          515             515             0               consumer-1_/192.168.1.216</span><br><span class="line">by.consumer.online.storage     by.topic.dp.online.device.message.info 1          11              11              0               consumer-1_/192.168.1.216</span><br></pre></td></tr></table></figure>

<h3 id="使用Kafka命令行工具测试"><a href="#使用Kafka命令行工具测试" class="headerlink" title="使用Kafka命令行工具测试"></a>使用Kafka命令行工具测试</h3><p>用命令行生产者 和 消费者 进行测试</p>
<h4 id="消费者"><a href="#消费者" class="headerlink" title="消费者"></a>消费者</h4><p>无法消费到数据任何，没有错误</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./kafka-console-consumer.sh --bootstrap-server 192.168.1.217:9092,192.168.1.218:9092,192.168.1.219:9092 --topic by.topic.install.car.device --from-beginning</span><br></pre></td></tr></table></figure>
<h4 id="生产者"><a href="#生产者" class="headerlink" title="生产者"></a>生产者</h4><p>发送数据报错</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">[root@RD-MQ-02 bin]# ./kafka-console-producer.sh --broker-list 192.168.1.217:9092,192.168.1.218:9092 --topic by.topic.install.car.device</span><br><span class="line">111111</span><br><span class="line">2222</span><br><span class="line">3333</span><br><span class="line">[2020-04-22 17:09:45,589] WARN Got error produce response with correlation id 2 on topic-partition by.topic.install.car.device-19, retrying (2 attempts left). Error: NETWORK_EXCEPTION (org.apache.kafka.clients.producer.internals.Sender)</span><br><span class="line">[2020-04-22 17:09:45,592] WARN Got error produce response with correlation id 2 on topic-partition by.topic.install.car.device-1, retrying (2 attempts left). Error: NETWORK_EXCEPTION (org.apache.kafka.clients.producer.internals.Sender)</span><br><span class="line">[2020-04-22 17:09:45,592] WARN Got error produce response with correlation id 1 on topic-partition by.topic.install.car.device-10, retrying (2 attempts left). Error: NETWORK_EXCEPTION (org.apache.kafka.clients.producer.internals.Sender)</span><br><span class="line">5</span><br><span class="line">[2020-04-22 17:09:48,368] WARN Got error produce response with correlation id 6 on topic-partition by.topic.install.car.device-28, retrying (2 attempts left). Error: NETWORK_EXCEPTION (org.apache.kafka.clients.producer.internals.Sender)</span><br><span class="line">[2020-04-22 17:09:48,369] WARN Got error produce response with correlation id 5 on topic-partition by.topic.install.car.device-10, retrying (1 attempts left). Error: NETWORK_EXCEPTION (org.apache.kafka.clients.producer.internals.Sender)</span><br><span class="line">[2020-04-22 17:09:48,369] WARN Got error produce response with correlation id 4 on topic-partition by.topic.install.car.device-19, retrying (1 attempts left). Error: NETWORK_EXCEPTION (org.apache.kafka.clients.producer.internals.Sender)</span><br><span class="line">[2020-04-22 17:09:48,369] WARN Got error produce response with correlation id 4 on topic-partition by.topic.install.car.device-1, retrying (1 attempts left). Error: NETWORK_EXCEPTION (org.apache.kafka.clients.producer.internals.Sender)</span><br><span class="line">[2020-04-22 17:09:49,978] WARN Got error produce response with correlation id 8 on topic-partition by.topic.install.car.device-1, retrying (0 attempts left). Error: NETWORK_EXCEPTION (org.apache.kafka.clients.producer.internals.Sender)</span><br><span class="line">[2020-04-22 17:09:49,978] WARN Got error produce response with correlation id 8 on topic-partition by.topic.install.car.device-10, retrying (0 attempts left). Error: NETWORK_EXCEPTION (org.apache.kafka.clients.producer.internals.Sender)</span><br><span class="line">[2020-04-22 17:09:49,979] WARN Got error produce response with correlation id 8 on topic-partition by.topic.install.car.device-19, retrying (0 attempts left). Error: NETWORK_EXCEPTION (org.apache.kafka.clients.producer.internals.Sender)</span><br><span class="line">[2020-04-22 17:09:49,979] WARN Got error produce response with correlation id 8 on topic-partition by.topic.install.car.device-28, retrying (1 attempts left). Error: NETWORK_EXCEPTION (org.apache.kafka.clients.producer.internals.Sender)</span><br><span class="line">[2020-04-22 17:09:51,587] ERROR Error when sending message to topic by.topic.install.car.device with key: null, value: 4 bytes with error: (org.apache.kafka.clients.producer.internals.ErrorLoggingCallback)</span><br><span class="line">org.apache.kafka.common.errors.NetworkException: The server disconnected before a response was received.</span><br><span class="line">[2020-04-22 17:09:51,593] ERROR Error when sending message to topic by.topic.install.car.device with key: null, value: 6 bytes with error: (org.apache.kafka.clients.producer.internals.ErrorLoggingCallback)</span><br><span class="line">org.apache.kafka.common.errors.NetworkException: The server disconnected before a response was received.</span><br><span class="line">[2020-04-22 17:09:51,593] ERROR Error when sending message to topic by.topic.install.car.device with key: null, value: 4 bytes with error: (org.apache.kafka.clients.producer.internals.ErrorLoggingCallback)</span><br><span class="line">org.apache.kafka.common.errors.NetworkException: The server disconnected before a response was received.</span><br><span class="line">[2020-04-22 17:09:51,594] WARN Got error produce response with correlation id 10 on topic-partition by.topic.install.car.device-28, retrying (0 attempts left). Error: NETWORK_EXCEPTION (org.apache.kafka.clients.producer.internals.Sender)</span><br><span class="line">[2020-04-22 17:09:53,192] ERROR Error when sending message to topic by.topic.install.car.device with key: null, value: 1 bytes with error: (org.apache.kafka.clients.producer.internals.ErrorLoggingCallback)</span><br><span class="line">org.apache.kafka.common.errors.NetworkException: The server disconnected before a response was received.</span><br></pre></td></tr></table></figure>

<h3 id="查进程信息"><a href="#查进程信息" class="headerlink" title="查进程信息"></a>查进程信息</h3><h4 id="进程占用的文件句柄数"><a href="#进程占用的文件句柄数" class="headerlink" title="进程占用的文件句柄数"></a>进程占用的文件句柄数</h4><h5 id="217"><a href="#217" class="headerlink" title="217"></a>217</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@RD-MQ-01 opt]# lsof -p 13517 | wc -l</span><br><span class="line">12824</span><br></pre></td></tr></table></figure>
<h5 id="218"><a href="#218" class="headerlink" title="218"></a>218</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@RD-MQ-02 ~]# lsof -p 13557 | wc -l</span><br><span class="line">12819</span><br></pre></td></tr></table></figure>
<h5 id="219"><a href="#219" class="headerlink" title="219"></a>219</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@RD-MQ-03 ~]# lsof -p 81068 | wc -l</span><br><span class="line">326639</span><br></pre></td></tr></table></figure>
<p><strong>可以看到219占用了非常多的文件句柄数</strong></p>
<h4 id="网络端口9092查看"><a href="#网络端口9092查看" class="headerlink" title="网络端口9092查看"></a>网络端口9092查看</h4><h5 id="217-1"><a href="#217-1" class="headerlink" title="217"></a>217</h5><p>存在很多 time_wait 状态的连接</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">tcp        0      0 ::ffff:192.168.1.217:9092   ::ffff:192.168.1.215:47810  ESTABLISHED 13517/java          </span><br><span class="line">tcp        0      0 ::ffff:192.168.1.217:54504  ::ffff:192.168.1.218:9092   TIME_WAIT   -                   </span><br><span class="line">tcp        0  53321 ::ffff:192.168.1.217:33408  ::ffff:192.168.1.219:9092   FIN_WAIT1   -                   </span><br><span class="line">tcp        0      0 ::ffff:192.168.1.217:9092   ::ffff:192.168.1.218:55812  ESTABLISHED 13517/java          </span><br><span class="line">tcp        0  64905 ::ffff:192.168.1.217:39404  ::ffff:192.168.1.219:9092   FIN_WAIT1   -                   </span><br><span class="line">tcp        0  54769 ::ffff:192.168.1.217:33158  ::ffff:192.168.1.219:9092   FIN_WAIT1   -                   </span><br><span class="line">tcp        0      0 ::ffff:192.168.1.217:9092   ::ffff:192.168.1.216:35251  ESTABLISHED 13517/java          </span><br><span class="line">tcp        0      0 ::ffff:192.168.1.217:39720  ::ffff:192.168.1.217:9092   TIME_WAIT   -                   </span><br><span class="line">tcp        0      0 ::ffff:192.168.1.217:54466  ::ffff:192.168.1.218:9092   TIME_WAIT   -                   </span><br><span class="line">tcp        0  48081 ::ffff:192.168.1.217:33639  ::ffff:192.168.1.219:9092   FIN_WAIT1   -                   </span><br><span class="line">tcp        0  46505 ::ffff:192.168.1.217:39272  ::ffff:192.168.1.219:9092   FIN_WAIT1   -                   </span><br><span class="line">tcp        0      0 ::ffff:192.168.1.217:39646  ::ffff:192.168.1.217:9092   TIME_WAIT   -                   </span><br><span class="line">tcp        0  47953 ::ffff:192.168.1.217:33365  ::ffff:192.168.1.219:9092   FIN_WAIT1   -                   </span><br><span class="line">tcp        0      0 ::ffff:192.168.1.217:54494  ::ffff:192.168.1.218:9092   TIME_WAIT   -                   </span><br><span class="line">tcp        0  53449 ::ffff:192.168.1.217:33037  ::ffff:192.168.1.219:9092   FIN_WAIT1   -                   </span><br><span class="line">tcp        0      0 ::ffff:192.168.1.217:40217  ::ffff:192.168.1.219:9092   FIN_WAIT2   -  </span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@RD-MQ-01 ~]# netstat -antp | grep 9092 | wc -l</span><br><span class="line">324</span><br></pre></td></tr></table></figure>

<h5 id="218-1"><a href="#218-1" class="headerlink" title="218"></a>218</h5><p>基本正常</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">tcp        0      0 ::ffff:192.168.1.218:9092   ::ffff:192.168.1.216:48369  ESTABLISHED 13557/java          </span><br><span class="line">tcp        0      0 ::ffff:192.168.1.218:9092   ::ffff:192.168.1.214:42207  ESTABLISHED 13557/java          </span><br><span class="line">tcp        0      0 ::ffff:192.168.1.218:9092   ::ffff:192.168.1.216:47984  ESTABLISHED 13557/java          </span><br><span class="line">tcp        0      0 ::ffff:192.168.1.218:9092   ::ffff:192.168.1.216:44771  ESTABLISHED 13557/java          </span><br><span class="line">tcp        0      0 ::ffff:192.168.1.218:9092   ::ffff:192.168.1.215:42045  ESTABLISHED 13557/java          </span><br><span class="line">tcp        0      0 ::ffff:192.168.1.218:9092   ::ffff:192.168.1.215:51056  ESTABLISHED 13557/java          </span><br><span class="line">tcp        0      0 ::ffff:192.168.1.218:9092   ::ffff:192.168.1.214:37368  ESTABLISHED 13557/java          </span><br><span class="line">tcp        0      0 ::ffff:192.168.1.218:9092   ::ffff:192.168.1.217:59185  ESTABLISHED 13557/java          </span><br><span class="line">tcp        0      0 ::ffff:192.168.1.218:9092   ::ffff:192.168.1.216:58880  ESTABLISHED 13557/java          </span><br><span class="line">tcp        0      0 ::ffff:192.168.1.218:9092   ::ffff:192.168.1.216:44758  ESTABLISHED 13557/java          </span><br><span class="line">tcp        0      0 ::ffff:192.168.1.218:9092   ::ffff:192.168.1.219:55019  ESTABLISHED 13557/java          </span><br><span class="line">tcp        0      0 ::ffff:192.168.1.218:9092   ::ffff:192.168.1.215:35721  ESTABLISHED 13557/java          </span><br><span class="line">tcp        0      0 ::ffff:192.168.1.218:9092   ::ffff:192.168.1.219:55014  ESTABLISHED 13557/java  </span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@RD-MQ-02 ~]# netstat -antp | grep 9092 | wc -l</span><br><span class="line">77</span><br></pre></td></tr></table></figure>

<h5 id="219-1"><a href="#219-1" class="headerlink" title="219"></a>219</h5><p>存在大量 CLOSE_WAIT 状态的连接</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">tcp      247      0 ::ffff:192.168.1.219:9092   ::ffff:192.168.1.217:58837  CLOSE_WAIT  81068/java          </span><br><span class="line">tcp   178232      0 ::ffff:192.168.1.219:9092   ::ffff:192.168.1.217:34750  ESTABLISHED 81068/java          </span><br><span class="line">tcp       55      0 ::ffff:192.168.1.219:9092   ::ffff:192.168.1.213:55954  CLOSE_WAIT  81068/java          </span><br><span class="line">tcp      238      0 ::ffff:192.168.1.219:9092   ::ffff:192.168.1.217:40862  CLOSE_WAIT  81068/java          </span><br><span class="line">tcp      226      0 ::ffff:192.168.1.219:9092   ::ffff:192.168.1.217:58967  CLOSE_WAIT  81068/java          </span><br><span class="line">tcp    14535      0 ::ffff:192.168.1.219:9092   ::ffff:192.168.1.218:49425  CLOSE_WAIT  81068/java          </span><br><span class="line">tcp    14986      0 ::ffff:192.168.1.219:9092   ::ffff:192.168.1.218:49330  CLOSE_WAIT  81068/java          </span><br><span class="line">tcp      221      0 ::ffff:192.168.1.219:9092   ::ffff:192.168.1.217:37406  CLOSE_WAIT  81068/java          </span><br><span class="line">tcp      223      0 ::ffff:192.168.1.219:9092   ::ffff:192.168.1.217:36455  CLOSE_WAIT  81068/java          </span><br><span class="line">tcp    14620      0 ::ffff:192.168.1.219:9092   ::ffff:192.168.1.217:59460  CLOSE_WAIT  81068/java          </span><br><span class="line">tcp      247      0 ::ffff:192.168.1.219:9092   ::ffff:192.168.1.217:59087  CLOSE_WAIT  81068/java  </span><br></pre></td></tr></table></figure>
<p>数量远多于其他两台</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@RD-MQ-03 opt]# netstat -antp | grep 9092 | wc -l</span><br><span class="line">5589</span><br></pre></td></tr></table></figure>


<h3 id="查线程堆栈内存信息"><a href="#查线程堆栈内存信息" class="headerlink" title="查线程堆栈内存信息"></a>查线程堆栈内存信息</h3><h4 id="使用内存"><a href="#使用内存" class="headerlink" title="使用内存"></a>使用内存</h4><p>基本正常</p>
<h5 id="217-2"><a href="#217-2" class="headerlink" title="217"></a>217</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ps aux|grep java|grep &quot;kafka&quot;|awk &#x27;&#123;print $6&#125;&#x27;     </span><br><span class="line">2625240</span><br></pre></td></tr></table></figure>
<h5 id="218-2"><a href="#218-2" class="headerlink" title="218"></a>218</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ps aux|grep java|grep &quot;kafka&quot;|awk &#x27;&#123;print $6&#125;&#x27;  </span><br><span class="line">2071136</span><br></pre></td></tr></table></figure>
<h5 id="219-2"><a href="#219-2" class="headerlink" title="219"></a>219</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ps aux|grep java|grep &quot;kafka&quot;|awk &#x27;&#123;print $6&#125;&#x27;  </span><br><span class="line">1901924</span><br></pre></td></tr></table></figure>

<h4 id="jstack"><a href="#jstack" class="headerlink" title="jstack"></a>jstack</h4><p>在219上找到死锁</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line">Found one Java-level deadlock:</span><br><span class="line">=============================</span><br><span class="line">&quot;executor-Heartbeat&quot;:</span><br><span class="line">  waiting to lock monitor 0x00007f972c03db78 (object 0x000000070dbce4c8, a kafka.coordinator.GroupMetadata),</span><br><span class="line">  which is held by &quot;group-metadata-manager-0&quot;</span><br><span class="line">&quot;group-metadata-manager-0&quot;:</span><br><span class="line">  waiting to lock monitor 0x00007f979420e438 (object 0x0000000715a00000, a java.util.LinkedList),</span><br><span class="line">  which is held by &quot;kafka-request-handler-3&quot;</span><br><span class="line">&quot;kafka-request-handler-3&quot;:</span><br><span class="line">  waiting to lock monitor 0x00007f972c03db78 (object 0x000000070dbce4c8, a kafka.coordinator.GroupMetadata),</span><br><span class="line">  which is held by &quot;group-metadata-manager-0&quot;</span><br><span class="line"></span><br><span class="line">Java stack information for the threads listed above:</span><br><span class="line">===================================================</span><br><span class="line">&quot;executor-Heartbeat&quot;:</span><br><span class="line">	at kafka.coordinator.GroupCoordinator.onExpireHeartbeat(GroupCoordinator.scala:739)</span><br><span class="line">	- waiting to lock &lt;0x000000070dbce4c8&gt; (a kafka.coordinator.GroupMetadata)</span><br><span class="line">	at kafka.coordinator.DelayedHeartbeat.onExpiration(DelayedHeartbeat.scala:33)</span><br><span class="line">	at kafka.server.DelayedOperation.run(DelayedOperation.scala:107)</span><br><span class="line">	at java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:511)</span><br><span class="line">	at java.util.concurrent.FutureTask.run(FutureTask.java:266)</span><br><span class="line">	at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1149)</span><br><span class="line">	at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:624)</span><br><span class="line">	at java.lang.Thread.run(Thread.java:748)</span><br><span class="line">&quot;group-metadata-manager-0&quot;:</span><br><span class="line">	at kafka.server.DelayedOperationPurgatory$Watchers.tryCompleteWatched(DelayedOperation.scala:308)</span><br><span class="line">	- waiting to lock &lt;0x0000000715a00000&gt; (a java.util.LinkedList)</span><br><span class="line">	at kafka.server.DelayedOperationPurgatory.checkAndComplete(DelayedOperation.scala:234)</span><br><span class="line">	at kafka.server.ReplicaManager.tryCompleteDelayedProduce(ReplicaManager.scala:199)</span><br><span class="line">	at kafka.cluster.Partition.tryCompleteDelayedRequests(Partition.scala:374)</span><br><span class="line">	at kafka.cluster.Partition.appendMessagesToLeader(Partition.scala:457)</span><br><span class="line">	at kafka.coordinator.GroupMetadataManager$$anonfun$cleanupGroupMetadata$1$$anonfun$apply$10.apply(GroupMetadataManager.scala:600)</span><br><span class="line">	at kafka.coordinator.GroupMetadataManager$$anonfun$cleanupGroupMetadata$1$$anonfun$apply$10.apply(GroupMetadataManager.scala:593)</span><br><span class="line">	at scala.Option.foreach(Option.scala:257)</span><br><span class="line">	at kafka.coordinator.GroupMetadataManager$$anonfun$cleanupGroupMetadata$1.apply(GroupMetadataManager.scala:593)</span><br><span class="line">	- locked &lt;0x000000070dbce4c8&gt; (a kafka.coordinator.GroupMetadata)</span><br><span class="line">	at kafka.coordinator.GroupMetadataManager$$anonfun$cleanupGroupMetadata$1.apply(GroupMetadataManager.scala:579)</span><br><span class="line">	at scala.collection.Iterator$class.foreach(Iterator.scala:893)</span><br><span class="line">	at kafka.utils.Pool$$anon$1.foreach(Pool.scala:89)</span><br><span class="line">	at scala.collection.IterableLike$class.foreach(IterableLike.scala:72)</span><br><span class="line">	at kafka.utils.Pool.foreach(Pool.scala:26)</span><br><span class="line">	at kafka.coordinator.GroupMetadataManager.cleanupGroupMetadata(GroupMetadataManager.scala:579)</span><br><span class="line">	at kafka.coordinator.GroupMetadataManager$$anonfun$1.apply$mcV$sp(GroupMetadataManager.scala:101)</span><br><span class="line">	at kafka.utils.KafkaScheduler$$anonfun$1.apply$mcV$sp(KafkaScheduler.scala:110)</span><br><span class="line">	at kafka.utils.CoreUtils$$anon$1.run(CoreUtils.scala:58)</span><br><span class="line">	at java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:511)</span><br><span class="line">	at java.util.concurrent.FutureTask.runAndReset(FutureTask.java:308)</span><br><span class="line">	at java.util.concurrent.ScheduledThreadPoolExecutor$ScheduledFutureTask.access$301(ScheduledThreadPoolExecutor.java:180)</span><br><span class="line">	at java.util.concurrent.ScheduledThreadPoolExecutor$ScheduledFutureTask.run(ScheduledThreadPoolExecutor.java:294)</span><br><span class="line">	at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1149)</span><br><span class="line">	at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:624)</span><br><span class="line">	at java.lang.Thread.run(Thread.java:748)</span><br><span class="line">&quot;kafka-request-handler-3&quot;:</span><br><span class="line">	at kafka.coordinator.GroupMetadataManager.kafka$coordinator$GroupMetadataManager$$putCacheCallback$2(GroupMetadataManager.scala:301)</span><br><span class="line">	- waiting to lock &lt;0x000000070dbce4c8&gt; (a kafka.coordinator.GroupMetadata)</span><br><span class="line">	at kafka.coordinator.GroupMetadataManager$$anonfun$prepareStoreOffsets$1.apply(GroupMetadataManager.scala:357)</span><br><span class="line">	at kafka.coordinator.GroupMetadataManager$$anonfun$prepareStoreOffsets$1.apply(GroupMetadataManager.scala:357)</span><br><span class="line">	at kafka.server.DelayedProduce.onComplete(DelayedProduce.scala:123)</span><br><span class="line">	at kafka.server.DelayedOperation.forceComplete(DelayedOperation.scala:70)</span><br><span class="line">	at kafka.server.DelayedProduce.tryComplete(DelayedProduce.scala:105)</span><br><span class="line">	at kafka.server.DelayedOperationPurgatory$Watchers.tryCompleteWatched(DelayedOperation.scala:315)</span><br><span class="line">	- locked &lt;0x0000000715a4d358&gt; (a kafka.server.DelayedProduce)</span><br><span class="line">	- locked &lt;0x0000000715a00000&gt; (a java.util.LinkedList)</span><br><span class="line">	at kafka.server.DelayedOperationPurgatory.checkAndComplete(DelayedOperation.scala:234)</span><br><span class="line">	at kafka.server.ReplicaManager.tryCompleteDelayedProduce(ReplicaManager.scala:199)</span><br><span class="line">	at kafka.server.ReplicaManager$$anonfun$updateFollowerLogReadResults$2.apply(ReplicaManager.scala:909)</span><br><span class="line">	at kafka.server.ReplicaManager$$anonfun$updateFollowerLogReadResults$2.apply(ReplicaManager.scala:902)</span><br><span class="line">	at scala.collection.mutable.ResizableArray$class.foreach(ResizableArray.scala:59)</span><br><span class="line">	at scala.collection.mutable.ArrayBuffer.foreach(ArrayBuffer.scala:48)</span><br><span class="line">	at kafka.server.ReplicaManager.updateFollowerLogReadResults(ReplicaManager.scala:902)</span><br><span class="line">	at kafka.server.ReplicaManager.fetchMessages(ReplicaManager.scala:475)</span><br><span class="line">	at kafka.server.KafkaApis.handleFetchRequest(KafkaApis.scala:523)</span><br><span class="line">	at kafka.server.KafkaApis.handle(KafkaApis.scala:79)</span><br><span class="line">	at kafka.server.KafkaRequestHandler.run(KafkaRequestHandler.scala:60)</span><br><span class="line">	at java.lang.Thread.run(Thread.java:748)</span><br><span class="line"></span><br><span class="line">Found 1 deadlock.</span><br></pre></td></tr></table></figure>

<h4 id="jmap"><a href="#jmap" class="headerlink" title="jmap"></a>jmap</h4><p>dump 219 上的堆内存信息</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">jmap -dump:format=b,file=kafka-219-jmap.dump 81068</span><br></pre></td></tr></table></figure>
<p>先保留现场，必要时再进行分析，文件大小：665M</p>
<h2 id="相关资料"><a href="#相关资料" class="headerlink" title="相关资料"></a>相关资料</h2><h3 id="匹配度高的"><a href="#匹配度高的" class="headerlink" title="匹配度高的"></a>匹配度高的</h3><h4 id="KAFKA-3994"><a href="#KAFKA-3994" class="headerlink" title="KAFKA-3994"></a>KAFKA-3994</h4><p><a target="_blank" rel="noopener" href="https://issues.apache.org/jira/browse/KAFKA-3994">https://issues.apache.org/jira/browse/KAFKA-3994</a><br>executor-Heartbeat线程 与 kafka-request-handler线程 互锁<br>死锁信息与我们发现的有一点差异，没有group-metadata-manager线程   </p>
<p>版本比我们用低一个版本</p>
<blockquote>
<p>影响版本：0.10.0.0<br>修复版本：0.10.1.1, 0.10.2.0</p>
</blockquote>
<h4 id="KAFKA-4399"><a href="#KAFKA-4399" class="headerlink" title="KAFKA-4399"></a>KAFKA-4399</h4><p><a target="_blank" rel="noopener" href="https://issues.apache.org/jira/browse/KAFKA-4399">https://issues.apache.org/jira/browse/KAFKA-4399</a><br>死锁信息与我们发现的有一个差异，没有executor-Heartbeat线程  </p>
<blockquote>
<p>影响版本：0.10.1.0<br>修复版本：0.10.1.1，0.10.2.0</p>
</blockquote>
<h4 id="KAFKA-4478"><a href="#KAFKA-4478" class="headerlink" title="KAFKA-4478"></a>KAFKA-4478</h4><p><a target="_blank" rel="noopener" href="https://issues.apache.org/jira/browse/KAFKA-4478">https://issues.apache.org/jira/browse/KAFKA-4478</a><br>心跳执行器、组元数据管理器、请求处理器 相互锁死了<br>这个的死锁堆栈信息与我们碰到的一致  </p>
<blockquote>
<p>影响版本：0.10.1.0<br>修复版本：无 （在bug 3994中被解决了）</p>
</blockquote>
<h4 id="KAFKA-4562"><a href="#KAFKA-4562" class="headerlink" title="KAFKA-4562"></a>KAFKA-4562</h4><p><a target="_blank" rel="noopener" href="https://issues.apache.org/jira/browse/KAFKA-4562">https://issues.apache.org/jira/browse/KAFKA-4562</a></p>
<p>死锁情况与我们的一样</p>
<blockquote>
<p>影响版本：0.10.1.0<br>修复版本：无 （在bug 3994中被解决了）</p>
</blockquote>
<hr>
<h3 id="相关性高的"><a href="#相关性高的" class="headerlink" title="相关性高的"></a>相关性高的</h3><h4 id="邮件列表一"><a href="#邮件列表一" class="headerlink" title="邮件列表一"></a>邮件列表一</h4><p><a target="_blank" rel="noopener" href="https://users.kafka.apache.narkive.com/7ekMKZSX/deadlock-using-latest-0-10-1-kafka-release">https://users.kafka.apache.narkive.com/7ekMKZSX/deadlock-using-latest-0-10-1-kafka-release</a>  </p>
<p>3个线程的死锁堆栈信息，和我们的一样，文件句柄耗尽  </p>
<p>作者已经很肯定 KAFKA-3994中的补丁可以很好地解决该问题。</p>
<blockquote>
<p>关联：KAFKA-3994</p>
</blockquote>
<h4 id="邮件列表二"><a href="#邮件列表二" class="headerlink" title="邮件列表二"></a>邮件列表二</h4><p><a target="_blank" rel="noopener" href="https://users.kafka.apache.narkive.com/mP9QlK2j/connectivity-problem-with-controller-breaks-cluster">https://users.kafka.apache.narkive.com/mP9QlK2j/connectivity-problem-with-controller-breaks-cluster</a></p>
<p>从描述的问题来看，我们的一致</p>
<blockquote>
<p>关联：KAFKA-4477</p>
</blockquote>
<h4 id="KAFKA-4477"><a href="#KAFKA-4477" class="headerlink" title="KAFKA-4477"></a>KAFKA-4477</h4><p><a target="_blank" rel="noopener" href="https://issues.apache.org/jira/browse/KAFKA-4477">https://issues.apache.org/jira/browse/KAFKA-4477</a></p>
<p>我们的故障节点 ISR 也减少了，也有文件句柄数和死锁相关的描述</p>
<blockquote>
<p>影响版本：0.10.1.0<br>修复版本：0.10.1.1</p>
</blockquote>
<h2 id="结论"><a href="#结论" class="headerlink" title="结论"></a>结论</h2><p>Kafka程序内部死锁导致了集群的故障问题<br>根据官方文档这个问题在issues [KAFKA-4399] 中被解决了<br>可以通过将现有的kafka升级至 kafka 0.10.1.1 来解决该问题</p>
<p><strong>kafka 0.10.1.1 发版说明</strong><br><a target="_blank" rel="noopener" href="https://archive.apache.org/dist/kafka/0.10.1.1/RELEASE_NOTES.html">https://archive.apache.org/dist/kafka/0.10.1.1/RELEASE_NOTES.html</a>.</p>
<p>官方发版说明中已经记录解决了bug [KAFKA-4399]  </p>
<ul>
<li>[KAFKA-3994] - Deadlock between consumer heartbeat expiration and offset commit.</li>
<li>[KAFKA-4399] - Deadlock between cleanupGroupMetadata and offset commit</li>
</ul>
<hr>
<h2 id="升级"><a href="#升级" class="headerlink" title="升级"></a>升级</h2><h3 id="kafka服务端"><a href="#kafka服务端" class="headerlink" title="kafka服务端"></a>kafka服务端</h3><p>服务器端升级一个小版本到 0.10.1.1<br><a target="_blank" rel="noopener" href="https://archive.apache.org/dist/kafka/0.10.1.1/RELEASE_NOTES.html">https://archive.apache.org/dist/kafka/0.10.1.1/RELEASE_NOTES.html</a>.<br>这个版本主要是修复bug，没有什么新的改变，这样我们的数据应该是完全兼容的，只需要更换服务端的包，复制配置文件，之后逐个重启kafka服务即可。</p>
<h4 id="官方升级说明文档"><a href="#官方升级说明文档" class="headerlink" title="官方升级说明文档"></a>官方升级说明文档</h4><p><a target="_blank" rel="noopener" href="http://kafka.apache.org/0101/documentation.html#upgrade">http://kafka.apache.org/0101/documentation.html#upgrade</a></p>
<h3 id="程序的客户端"><a href="#程序的客户端" class="headerlink" title="程序的客户端"></a>程序的客户端</h3><p>全部的 <strong>生产者</strong> 和 <strong>消费者</strong> 都升级一个小版本到 0.10.1.1</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;!-- https://mvnrepository.com/artifact/org.apache.kafka/kafka-clients --&gt;</span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;org.apache.kafka&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;kafka-clients&lt;/artifactId&gt;</span><br><span class="line">    &lt;version&gt;0.10.1.1&lt;/version&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure>
<p>这样相关的代码应该都无需修改，Api不会有什么改动，只需要升级依赖包即可</p>
<p>修改父项目的pom文件依赖，子项目梳理一下，重新打包部署即可</p>
<h3 id="其他问题"><a href="#其他问题" class="headerlink" title="其他问题"></a>其他问题</h3><p>可能存在一些项目使用的是更老版本的API 和 连接方式等，如不是直连kafka而是老的连接zk的，这部分的项目需要修改代码</p>
<h2 id="升级步骤记录"><a href="#升级步骤记录" class="headerlink" title="升级步骤记录"></a>升级步骤记录</h2><h3 id="下载文件"><a href="#下载文件" class="headerlink" title="下载文件"></a>下载文件</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget https://archive.apache.org/dist/kafka/0.10.1.1/kafka_2.11-0.10.1.1.tgz</span><br></pre></td></tr></table></figure>
<blockquote>
<p>这里选择的scala 版本是 2.11，之前装的也是2.11的</p>
</blockquote>
<p>解压到新目录<br>使用原来的配置位置<br>注意：数据文件（log）的位置  </p>
<h3 id="准备生产者和消费者"><a href="#准备生产者和消费者" class="headerlink" title="准备生产者和消费者"></a>准备生产者和消费者</h3><p>先准备一个生产者，产生数据</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./kafka-console-producer.sh --broker-list 192.168.1.217:9092,192.168.1.218:9092,192.168.1.219:9092 --topic st.topic.yery.test</span><br></pre></td></tr></table></figure>
<p>在准备一个消费者，消费数据</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./kafka-console-consumer.sh --bootstrap-server 192.168.1.217:9092,192.168.1.218:9092,192.168.1.219:9092 --topic st.topic.yery.test --from-beginning</span><br></pre></td></tr></table></figure>
<p>升级过程保持不变</p>
<h3 id="停止节点219"><a href="#停止节点219" class="headerlink" title="停止节点219"></a>停止节点219</h3><p>先关闭节点219，观察集群状态：<br>217 218 报错了，但是集群整体运行正常  </p>
<h3 id="测试验证"><a href="#测试验证" class="headerlink" title="测试验证"></a>测试验证</h3><p>生产者能正常产生数据</p>
<p>消费者能正常消费数据</p>
<p>消费者会打印一个警告</p>
<p>进入kafka manager 可以查看到只有两个 Broker（217、218）<br>查看topic st.topic.yery.test 的信息<br>所有Partition 的leader都分到217 和 218 上<br>In Sync Replicas 只有(217,218)  </p>
<h3 id="修改配置文件"><a href="#修改配置文件" class="headerlink" title="修改配置文件"></a>修改配置文件</h3><p>复制原配置文件到kafka_2.11-0.10.1.1 </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">cd kafka_2.11-0.10.1.0</span><br><span class="line"></span><br><span class="line"># 复制启动脚本（自己写的）</span><br><span class="line">cp start.sh ../kafka_2.11-0.10.1.1/</span><br><span class="line"></span><br><span class="line"># 复制配置文件</span><br><span class="line">cd config</span><br><span class="line"></span><br><span class="line">cp server.properties ../../kafka_2.11-0.10.1.1/config/</span><br><span class="line">cp log4j.properties ../../kafka_2.11-0.10.1.1/config/</span><br></pre></td></tr></table></figure>

<h3 id="在219启动新版本的kafka"><a href="#在219启动新版本的kafka" class="headerlink" title="在219启动新版本的kafka"></a>在219启动新版本的kafka</h3><p>直接启动219 （0.10.1.1版本的）</p>
<p>查看219日志，可以看到在恢复数据</p>
<p>数据恢复完成之后 会加入集群</p>
<p>加入集群后，217 和 218 会打印日志，将分区ISR从[217,218] 扩大到 [217,218,219]</p>
<p>在kafka manager 上可以看到Broker 219 加入了集群<br>查看topic [st.topic.yery.test] 的信息<br>Partition 的leader分到217，218 和 219 三台上了<br>In Sync Replicas 有(217,218,219)  </p>
<h3 id="再次验证测试"><a href="#再次验证测试" class="headerlink" title="再次验证测试"></a>再次验证测试</h3><p>此时命令行 生产数据 消费数据都是正常的</p>
<h3 id="应用程序测试"><a href="#应用程序测试" class="headerlink" title="应用程序测试"></a>应用程序测试</h3><p><strong>直接验证binlog程序</strong><br>程序在不升级kafka客户端包版本的情况下测试</p>
<p>在数据库中修改 by_device 表的记录x，将记录x的remark修改为‘kafka update’<br>可以在缓存管理中看到记录x的remark改成了‘kafka update’</p>
<p>对应的队列 qa.topic.binlog.base-by_device<br>Sum of partition offsets	也加了1，表明消息发送消费正常</p>
<p>程序在不升级kafka-clients 包的情况下，也没有问题  </p>
<h3 id="再升级217-和-218"><a href="#再升级217-和-218" class="headerlink" title="再升级217 和 218"></a>再升级217 和 218</h3><p>用同样的步骤更换 217 和 218 上的kafka程序，配置文件就用原来的对应的配置文件</p>
<p>逐个关闭kafka程序再启动，等待数据库恢复，集群恢复到正常状态</p>
<h3 id="验证老数据"><a href="#验证老数据" class="headerlink" title="验证老数据"></a>验证老数据</h3><p>升级完成之后再从头开始消费队列[st.topic.yery.test]的数据</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./kafka-console-consumer.sh --bootstrap-server 192.168.1.217:9092,192.168.1.218:9092,192.168.1.219:9092 --topic st.topic.yery.test --from-beginning</span><br></pre></td></tr></table></figure>

<p><strong>数据正常，升级完成</strong></p>
<hr>
<h2 id="补充"><a href="#补充" class="headerlink" title="补充"></a>补充</h2><h3 id="升级说明"><a href="#升级说明" class="headerlink" title="升级说明"></a>升级说明</h3><h4 id="从0-8-x，0-9-x，0-10-0-x，0-10-1-x或0-10-2-x升级到0-11-0-0"><a href="#从0-8-x，0-9-x，0-10-0-x，0-10-1-x或0-10-2-x升级到0-11-0-0" class="headerlink" title="从0.8.x，0.9.x，0.10.0.x，0.10.1.x或0.10.2.x升级到0.11.0.0"></a>从0.8.x，0.9.x，0.10.0.x，0.10.1.x或0.10.2.x升级到0.11.0.0</h4><p><a target="_blank" rel="noopener" href="http://kafka.apache.org/0102/documentation.html#upgrade">http://kafka.apache.org/0102/documentation.html#upgrade</a></p>
<p>Kafka 0.11.0.0引入了新的消息格式版本以及有线协议更改。通过遵循以下建议的滚动升级计划，可以保证升级期间不会停机。但是，请在升级之前查看0.11.0.0中的显着更改。</p>
<p>从版本0.10.2开始，Java客户端（生产者和消费者）已经具有与较早的代理进行通信的能力。版本0.11.0的客户可以与版本0.10.0或更高版本的代理通信。但是，如果您的代理早于0.10.0，则必须先升级Kafka群集中的所有代理，然后再升级客户端。版本0.11.0代理支持0.8.x和更高版本的客户端。</p>
<hr>
<p>###################################</p>
<hr>
<h2 id="升级之后的问题"><a href="#升级之后的问题" class="headerlink" title="升级之后的问题"></a>升级之后的问题</h2><p><strong>这是一个坑，升级之后还是有死锁问题，一个新的死锁</strong></p>
<p>由于 DelayedProduce  和 GroupMetadata 导致的死锁</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">Found one Java-level deadlock:</span><br><span class="line">=============================</span><br><span class="line">&quot;executor-Heartbeat&quot;:</span><br><span class="line">  waiting to lock monitor 0x00007f113c00b678 (object 0x00000000c8ab9028, a kafka.server.DelayedProduce),</span><br><span class="line">  which is held by &quot;kafka-scheduler-5&quot;</span><br><span class="line">&quot;kafka-scheduler-5&quot;:</span><br><span class="line">  waiting to lock monitor 0x00007f1918013848 (object 0x00000000ea18c4d8, a kafka.coordinator.GroupMetadata),</span><br><span class="line">  which is held by &quot;executor-Heartbeat&quot;</span><br><span class="line"></span><br><span class="line">Java stack information for the threads listed above:</span><br></pre></td></tr></table></figure>

<p>bug:<br><a target="_blank" rel="noopener" href="https://issues.apache.org/jira/browse/KAFKA-5970">https://issues.apache.org/jira/browse/KAFKA-5970</a></p>
<p>修复版本：<br>0.11.0.2， 1.0.0</p>
<p>在 0.10.X 版本中没有看到有修复该问题，且在0.11.x版本中又看到有内存泄漏问题，~~~</p>
<p><strong>好在这个问题出现的概率非常低，只在测试环境出现过1次</strong></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://wangwen135.github.io/%E7%BD%91%E7%BB%9C%E4%B8%8E%E5%AE%89%E5%85%A8/%E7%BD%91%E7%BB%9C/IPv4%E5%9C%B0%E5%9D%80%E5%88%86%E7%B1%BB%20ABC%E7%B1%BBIP%E5%88%92%E5%88%86/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="王某某">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="王某某的笔记">
      <meta itemprop="description" content="这是一个使用 Hexo 构建的博客，用于分享我的编程经验和学习笔记。">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 王某某的笔记">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/%E7%BD%91%E7%BB%9C%E4%B8%8E%E5%AE%89%E5%85%A8/%E7%BD%91%E7%BB%9C/IPv4%E5%9C%B0%E5%9D%80%E5%88%86%E7%B1%BB%20ABC%E7%B1%BBIP%E5%88%92%E5%88%86/" class="post-title-link" itemprop="url">IPv4地址分类 ABC类IP划分</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2020-04-17 00:00:00" itemprop="dateCreated datePublished" datetime="2020-04-17T00:00:00+08:00">2020-04-17</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E7%BD%91%E7%BB%9C%E4%B8%8E%E5%AE%89%E5%85%A8/" itemprop="url" rel="index"><span itemprop="name">网络与安全</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E7%BD%91%E7%BB%9C%E4%B8%8E%E5%AE%89%E5%85%A8/%E7%BD%91%E7%BB%9C/" itemprop="url" rel="index"><span itemprop="name">网络</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>947</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>3 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h3 id="IP地址"><a href="#IP地址" class="headerlink" title="IP地址"></a>IP地址</h3><p>IPv4网络使用32位地址，即32个bit位（表示0和1），每8位分成1个部分，共4个部分，再将二进制的数转成10进制，以点分十进制表示<br>如：192.168.1.1  &#x3D; 11000000.10101000.00000001.00000001</p>
<p>从数字的角度来说，一个8位的2进制数字最大为255，故IP地址最大为：255.255.255.255<br>IPv4地址的总是为 2的32次方 &#x3D; 4294967296 ，只有40多亿，其中还有部分要挪作他用，所以后来又出了IPv6（<br>IPv6 地址为 128 位长度， 是 IPv4 地址的 4 倍）</p>
<h3 id="IP地址-1"><a href="#IP地址-1" class="headerlink" title="IP地址"></a>IP地址</h3><p>地址格式为：IP地址&#x3D;网络地址＋主机地址 或 IP地址&#x3D;网络地址＋子网地址</p>
<p>网络地址 + 主机地址 &#x3D; 32位 构成一个完整的IP地址</p>
<p>最初设计互联网络时，为了便于寻址以及层次化构造网络，每个IP地址包括两个标识码（ID），即网络ID和主机ID。同一个物理网络上的所有主机都使用同一个网络ID，网络上的一个主机（包括网络上工作站，服务器和路由器等）有一个主机ID与其对应。IP地址根据网络ID的不同分为5种类型，A类地址、B类地址、C类地址、D类地址和E类地址。</p>
<h4 id="子网掩码"><a href="#子网掩码" class="headerlink" title="子网掩码"></a>子网掩码</h4><p>简单的说就说分隔 网络地址 和 子网地址用的<br>如果子网的bit位为1则表示这一位被掩盖住了，是网络地址<br>书写形式有：255.255.255.0  或者 24 这两个是一个意思，表示这个ip地址的前面24位被淹盖住了，比如地址：192.168.1.1&#x2F;24 ，其网络地址是：192.168.1，主机地址只能是 1~254</p>
<table>
<thead>
<tr>
<th>分类</th>
<th>前缀</th>
<th>范围</th>
<th>私有地址</th>
<th>默认掩码</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>A类地址</td>
<td>0</td>
<td>0.0.0.0 ~ 126.255.255.255</td>
<td>10.0.0.0 ~ 10.255.255.255</td>
<td>255.0.0.0</td>
<td></td>
</tr>
<tr>
<td>B类地址</td>
<td>10</td>
<td>128.0.0.0 ~ 191.255.255.255</td>
<td>172.16.0.0 ~ 172.31.255.255</td>
<td>255.255.0.0</td>
<td></td>
</tr>
<tr>
<td>C类地址</td>
<td>110</td>
<td>192.0.0.0 ~ 223.255.255.255</td>
<td>192.168.0.0 ~ 192.168.255.255</td>
<td>255.255.255.0</td>
<td></td>
</tr>
<tr>
<td>D类地址</td>
<td>1110</td>
<td>224.0.0.0 ~ 239.255.255.255</td>
<td>239.0.0.0 ~ 239.255.255.255 (本地管理组)</td>
<td></td>
<td>组播地址</td>
</tr>
<tr>
<td>E类地址</td>
<td>11110</td>
<td>240.0.0.0 ~ 247.255.255.255</td>
<td></td>
<td></td>
<td>保留</td>
</tr>
</tbody></table>
<h4 id="1．A类IP地址"><a href="#1．A类IP地址" class="headerlink" title="1．A类IP地址"></a>1．A类IP地址</h4><p>一个A类IP地址由1字节的网络地址和3字节主机地址组成，网络地址的最高位必须是“0”， 地址范围从1.0.0.0 到126.0.0.0。可用的A类网络有126个，每个网络能容纳1亿多个主机。</p>
<blockquote>
<p>【十进制】 126 &#x3D; 【二进制】01111110<br>127 是保留地址，127.0.0.1 给内部回送函数，而数字0则表示该地址是本地宿主机，不能传送</p>
</blockquote>
<h4 id="2．B类IP地址"><a href="#2．B类IP地址" class="headerlink" title="2．B类IP地址"></a>2．B类IP地址</h4><p>一个B类IP地址由2个字节的网络地址和2个字节的主机地址组成，网络地址的最高位必须是“10”，地址范围从128.0.0.0到191.255.255.255。可用的B类网络有16382个，每个网络能容纳6万多个主机 。</p>
<blockquote>
<p>【十进制】 128 &#x3D; 【二进制】10000000<br>【十进制】 191 &#x3D; 【二进制】10111111</p>
</blockquote>
<h4 id="3．C类IP地址"><a href="#3．C类IP地址" class="headerlink" title="3．C类IP地址"></a>3．C类IP地址</h4><p>一个C类IP地址由3字节的网络地址和1字节的主机地址组成，网络地址的最高位必须是“110”。范围从192.0.0.0到223.255.255.255。C类网络可达209万余个，每个网络能容纳254个主机。</p>
<blockquote>
<p>【十进制】 192 &#x3D; 【二进制】11000000<br>【十进制】 223 &#x3D; 【二进制】11011111</p>
</blockquote>
<h4 id="4．D类地址用于多点广播"><a href="#4．D类地址用于多点广播" class="headerlink" title="4．D类地址用于多点广播"></a>4．D类地址用于多点广播</h4><p>D类IP地址第一个字节以“1110”开始，它是一个专门保留的地址。它并不指向特定的网络，目前这一类地址被用在多点广播（Multicast）中。多点广播地址用来一次寻址一组计算机，它标识共享同一协议的一组计算机。</p>
<h4 id="5．E类IP地址"><a href="#5．E类IP地址" class="headerlink" title="5．E类IP地址"></a>5．E类IP地址</h4><p>以“11110”开始，为将来使用保留。</p>
<p>全零（“0．0．0．0”）地址对应于当前主机。全“1”的IP地址（“255．255．255．255”）是当前子网的广播地址。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




  <nav class="pagination">
    <a class="extend prev" rel="prev" title="上一页" aria-label="上一页" href="/page/8/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/8/">8</a><span class="page-number current">9</span><a class="page-number" href="/page/10/">10</a><span class="space">&hellip;</span><a class="page-number" href="/page/16/">16</a><a class="extend next" rel="next" title="下一页" aria-label="下一页" href="/page/10/"><i class="fa fa-angle-right"></i></a>
  </nav>

</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 
    <span itemprop="copyrightYear">2024</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">王某某</span>
  </div>
<div class="wordcount">
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-line"></i>
    </span>
    <span title="站点总字数">138k</span>
  </span>
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="站点阅读时长">8:20</span>
  </span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/pisces/" rel="noopener" target="_blank">NexT.Pisces</a> 强力驱动
  </div>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>
  <div class="reading-progress-bar"></div>
  <a role="button" class="book-mark-link book-mark-link-fixed"></a>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/sidebar.js"></script><script src="/js/next-boot.js"></script><script src="/js/bookmark.js"></script>

  






  





</body>
</html>
