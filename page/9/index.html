<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 7.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" integrity="sha256-XOqroi11tY4EFQMR9ZYwZWKj5ZXiftSx36RRuC3anlA=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"wangwen135.github.io","root":"/","images":"/images","scheme":"Pisces","darkmode":false,"version":"8.20.0","exturl":false,"sidebar":{"position":"left","width_expanded":320,"width_dual_column":240,"display":"post","padding":18,"offset":12},"copycode":{"enable":false,"style":null},"fold":{"enable":false,"height":500},"bookmark":{"enable":true,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"}}</script><script src="/js/config.js"></script>

    <meta name="description" content="这是一个使用 Hexo 构建的博客，用于分享我的编程经验和学习笔记。">
<meta property="og:type" content="website">
<meta property="og:title" content="王某某的笔记">
<meta property="og:url" content="https://wangwen135.github.io/page/9/index.html">
<meta property="og:site_name" content="王某某的笔记">
<meta property="og:description" content="这是一个使用 Hexo 构建的博客，用于分享我的编程经验和学习笔记。">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="王某某">
<meta property="article:tag" content="java">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="https://wangwen135.github.io/page/9/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":true,"isPost":false,"lang":"zh-CN","comments":"","permalink":"","path":"page/9/index.html","title":""}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>王某某的笔记</title>
  
  <script class="next-config" data-name="google_analytics" type="application/json">{"tracking_id":"G-MBG120GJ9P","only_pageview":true,"measure_protocol_api_secret":null}</script>
  <script src="/js/third-party/analytics/google-analytics.js"></script>








  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">王某某的笔记</h1>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">记录我的编程之路</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="搜索" role="button">
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a></li>
  </ul>
</nav>




</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="王某某"
      src="/images/avatar.jpg">
  <p class="site-author-name" itemprop="name">王某某</p>
  <div class="site-description" itemprop="description">这是一个使用 Hexo 构建的博客，用于分享我的编程经验和学习笔记。</div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">169</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">55</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">146</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author animated">
      <span class="links-of-author-item">
        <a href="https://github.com/wangwen135" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;wangwen135" rel="noopener me" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://www.jianshu.com/u/66c41e72644b" title="简  书 → https:&#x2F;&#x2F;www.jianshu.com&#x2F;u&#x2F;66c41e72644b" rel="noopener me" target="_blank"><i class="fa fa-link fa-fw"></i>简  书</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:wangwen135@gmail.com" title="E-Mail → mailto:wangwen135@gmail.com" rel="noopener me" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://twitter.com/wangwen135" title="Twitter → https:&#x2F;&#x2F;twitter.com&#x2F;wangwen135" rel="noopener me" target="_blank"><i class="fab fa-twitter fa-fw"></i>Twitter</a>
      </span>
  </div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner index posts-expand">

    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://wangwen135.github.io/java/sun.misc.Unsafe/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="王某某">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="王某某的笔记">
      <meta itemprop="description" content="这是一个使用 Hexo 构建的博客，用于分享我的编程经验和学习笔记。">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 王某某的笔记">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/java/sun.misc.Unsafe/" class="post-title-link" itemprop="url">sun.misc.Unsafe</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2019-08-24 23:41:00" itemprop="dateCreated datePublished" datetime="2019-08-24T23:41:00+08:00">2019-08-24</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Java/" itemprop="url" rel="index"><span itemprop="name">Java</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>1.5k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>5 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="sun-misc-Unsafe-简介"><a href="#sun-misc-Unsafe-简介" class="headerlink" title="sun.misc.Unsafe 简介"></a><code>sun.misc.Unsafe</code> 简介</h1><p><code>sun.misc.Unsafe</code> 是 Java 中的一个类，位于 <code>sun.misc</code> 包下。它提供了一组低级别的、不安全的操作，允许开发人员绕过 Java 的安全机制和内存管理，直接操作内存、对象、线程等。这使得它在某些高性能、低级别的编程中非常有用，但也非常危险。</p>
<h2 id="主要功能"><a href="#主要功能" class="headerlink" title="主要功能"></a>主要功能</h2><h3 id="1-直接内存访问："><a href="#1-直接内存访问：" class="headerlink" title="1. 直接内存访问："></a>1. 直接内存访问：</h3><ul>
<li>可以分配、释放和访问本机内存，类似于 C&#x2F;C++ 中的指针操作。<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">long</span> <span class="variable">memoryAddress</span> <span class="operator">=</span> unsafe.allocateMemory(size);</span><br><span class="line">unsafe.putInt(memoryAddress, <span class="number">42</span>);</span><br><span class="line"><span class="type">int</span> <span class="variable">value</span> <span class="operator">=</span> unsafe.getInt(memoryAddress);</span><br><span class="line">unsafe.freeMemory(memoryAddress);</span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="2-对象操作："><a href="#2-对象操作：" class="headerlink" title="2. 对象操作："></a>2. 对象操作：</h3><ul>
<li>可以在不调用构造函数的情况下创建对象。<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">SomeClass</span> <span class="variable">instance</span> <span class="operator">=</span> (SomeClass) unsafe.allocateInstance(SomeClass.class);</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="3-字段操作："><a href="#3-字段操作：" class="headerlink" title="3. 字段操作："></a>3. 字段操作：</h3><ul>
<li>可以直接修改对象的字段值，绕过 Java 的访问控制。<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> SomeClass.class.getDeclaredField(<span class="string">&quot;someField&quot;</span>);</span><br><span class="line"><span class="type">long</span> <span class="variable">offset</span> <span class="operator">=</span> unsafe.objectFieldOffset(field);</span><br><span class="line">unsafe.putInt(instance, offset, <span class="number">42</span>);</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="4-CAS-操作："><a href="#4-CAS-操作：" class="headerlink" title="4. CAS 操作："></a>4. CAS 操作：</h3><ul>
<li>提供了 compare-and-swap（比较并交换）操作，用于实现无锁编程。<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">boolean success = unsafe.compareAndSwapInt(someObject, offset, expectedValue, newValue);</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="5-内存屏障："><a href="#5-内存屏障：" class="headerlink" title="5. 内存屏障："></a>5. 内存屏障：</h3><ul>
<li>提供了内存屏障操作，确保指令顺序不会因为 CPU 优化而打乱。<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">unsafe.fullFence();</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="使用注意事项"><a href="#使用注意事项" class="headerlink" title="使用注意事项"></a>使用注意事项</h2><ul>
<li><strong>不安全性</strong>：由于它可以绕过 Java 的安全机制，错误使用可能导致程序崩溃、内存泄漏、数据损坏等问题。</li>
<li><strong>可移植性差</strong>：sun.misc.Unsafe 是 JDK 内部实现的一部分，不属于标准 Java API，因此不同的 JVM 实现中可能不兼容。</li>
<li><strong>受限访问</strong>：在 Java 9 及之后的版本中，直接访问 sun.misc.Unsafe 类变得更加困难，建议通过反射或者使用替代的 API（如 VarHandle）。</li>
</ul>
<h2 id="示例"><a href="#示例" class="headerlink" title="示例"></a>示例</h2><p>以下是一个简单示例，展示如何使用 sun.misc.Unsafe 来分配和访问本机内存：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> sun.misc.Unsafe;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UnsafeExample</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Unsafe unsafe;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> Unsafe.class.getDeclaredField(<span class="string">&quot;theUnsafe&quot;</span>);</span><br><span class="line">            field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">            unsafe = (Unsafe) field.get(<span class="literal">null</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">long</span> <span class="variable">size</span> <span class="operator">=</span> <span class="number">4</span>; <span class="comment">// 4 bytes</span></span><br><span class="line">        <span class="type">long</span> <span class="variable">memoryAddress</span> <span class="operator">=</span> unsafe.allocateMemory(size);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            unsafe.putInt(memoryAddress, <span class="number">42</span>);</span><br><span class="line">            <span class="type">int</span> <span class="variable">value</span> <span class="operator">=</span> unsafe.getInt(memoryAddress);</span><br><span class="line">            System.out.println(<span class="string">&quot;Value: &quot;</span> + value); <span class="comment">// Output: Value: 42</span></span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            unsafe.freeMemory(memoryAddress);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>


<p>使用 <code>sun.misc.Unsafe</code> 是危险的，因为它绕过了 Java 的类型安全检查和内存管理机制。如果使用不当，可能会导致严重的错误，如内存泄漏、数据损坏或程序崩溃。并且，由于它不是 Java 标准 API 的一部分，在不同的 Java 版本和运行环境中可能会有不同的表现，甚至可能不被支持。</p>
<hr>
<hr>
<p><a target="_blank" rel="noopener" href="http://mishadoff.com/blog/java-magic-part-4-sun-dot-misc-dot-unsafe/">http://mishadoff.com/blog/java-magic-part-4-sun-dot-misc-dot-unsafe/</a></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">//重新分配内存</span><br><span class="line">public native long reallocateMemory(long address, long bytes);  </span><br><span class="line">  </span><br><span class="line">//分配内存  </span><br><span class="line">public native long allocateMemory(long bytes);  </span><br><span class="line">  </span><br><span class="line">//释放内存  </span><br><span class="line">public native void freeMemory(long address);  </span><br><span class="line">  </span><br><span class="line">//在给定的内存块中设置值  </span><br><span class="line">public native void setMemory(Object o, long offset, long bytes, byte value);  </span><br><span class="line">  </span><br><span class="line">//从一个内存块拷贝到另一个内存块  </span><br><span class="line">public native void copyMemory(Object srcBase, long srcOffset, Object destBase, long destOffset, long bytes);  </span><br><span class="line">  </span><br><span class="line">//获取值，不管java的访问限制，其他有类似的getInt，getDouble，getLong，getChar等等  </span><br><span class="line">public native Object getObject(Object o, long offset);  </span><br><span class="line">  </span><br><span class="line">//设置值，不管java的访问限制，其他有类似的putInt,putDouble，putLong，putChar等等  </span><br><span class="line">public native void putObject(Object o, long offset);  </span><br><span class="line">  </span><br><span class="line">//从一个给定的内存地址获取本地指针，如果不是allocateMemory方法的，结果将不确定  </span><br><span class="line">public native long getAddress(long address);  </span><br><span class="line">  </span><br><span class="line">//存储一个本地指针到一个给定的内存地址,如果地址不是allocateMemory方法的，结果将不确定  </span><br><span class="line">public native void putAddress(long address, long x);  </span><br><span class="line">  </span><br><span class="line">//该方法返回给定field的内存地址偏移量，这个值对于给定的filed是唯一的且是固定不变的  </span><br><span class="line">public native long staticFieldOffset(Field f);  </span><br><span class="line">  </span><br><span class="line">//报告一个给定的字段的位置，不管这个字段是private，public还是保护类型，和staticFieldBase结合使用  </span><br><span class="line">public native long objectFieldOffset(Field f);  </span><br><span class="line">  </span><br><span class="line">//获取一个给定字段的位置  </span><br><span class="line">public native Object staticFieldBase(Field f);  </span><br><span class="line">  </span><br><span class="line">//确保给定class被初始化，这往往需要结合基类的静态域（field）  </span><br><span class="line">public native void ensureClassInitialized(Class c);  </span><br><span class="line">  </span><br><span class="line">//可以获取数组第一个元素的偏移地址  </span><br><span class="line">public native int arrayBaseOffset(Class arrayClass);  </span><br><span class="line">  </span><br><span class="line">//可以获取数组的转换因子，也就是数组中元素的增量地址。将arrayBaseOffset与arrayIndexScale配合使用， 可以定位数组中每个元素在内存中的位置  </span><br><span class="line">public native int arrayIndexScale(Class arrayClass);  </span><br><span class="line">  </span><br><span class="line">//获取本机内存的页数，这个值永远都是2的幂次方  </span><br><span class="line">public native int pageSize();  </span><br><span class="line">  </span><br><span class="line">//告诉虚拟机定义了一个没有安全检查的类，默认情况下这个类加载器和保护域来着调用者类  </span><br><span class="line">public native Class defineClass(String name, byte[] b, int off, int len, ClassLoader loader, ProtectionDomain protectionDomain);  </span><br><span class="line">  </span><br><span class="line">//定义一个类，但是不让它知道类加载器和系统字典  </span><br><span class="line">public native Class defineAnonymousClass(Class hostClass, byte[] data, Object[] cpPatches);  </span><br><span class="line">  </span><br><span class="line">//锁定对象，必须是没有被锁的</span><br><span class="line">public native void monitorEnter(Object o);  </span><br><span class="line">  </span><br><span class="line">//解锁对象  </span><br><span class="line">public native void monitorExit(Object o);  </span><br><span class="line">  </span><br><span class="line">//试图锁定对象，返回true或false是否锁定成功，如果锁定，必须用monitorExit解锁  </span><br><span class="line">public native boolean tryMonitorEnter(Object o);  </span><br><span class="line">  </span><br><span class="line">//引发异常，没有通知  </span><br><span class="line">public native void throwException(Throwable ee);  </span><br><span class="line">  </span><br><span class="line">//CAS，如果对象偏移量上的值=期待值，更新为x,返回true.否则false.类似的有compareAndSwapInt,compareAndSwapLong,compareAndSwapBoolean,compareAndSwapChar等等。  </span><br><span class="line">public final native boolean compareAndSwapObject(Object o, long offset,  Object expected, Object x);  </span><br><span class="line">  </span><br><span class="line">// 该方法获取对象中offset偏移地址对应的整型field的值,支持volatile load语义。类似的方法有getIntVolatile，getBooleanVolatile等等  </span><br><span class="line">public native Object getObjectVolatile(Object o, long offset);   </span><br><span class="line">  </span><br><span class="line">//线程调用该方法，线程将一直阻塞直到超时，或者是中断条件出现。  </span><br><span class="line">public native void park(boolean isAbsolute, long time);  </span><br><span class="line">  </span><br><span class="line">//终止挂起的线程，恢复正常.java.util.concurrent包中挂起操作都是在LockSupport类实现的，也正是使用这两个方法</span><br><span class="line">public native void unpark(Object thread);  </span><br><span class="line">  </span><br><span class="line">//获取系统在不同时间系统的负载情况  </span><br><span class="line">public native int getLoadAverage(double[] loadavg, int nelems);  </span><br><span class="line">  </span><br><span class="line">//创建一个类的实例，不需要调用它的构造函数、初使化代码、各种JVM安全检查以及其它的一些底层的东西。即使构造函数是私有，我们也可以通过这个方法创建它的实例,对于单例模式，简直是噩梦。 </span><br><span class="line">public native Object allocateInstance(Class cls) throws InstantiationException;  </span><br></pre></td></tr></table></figure>
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://wangwen135.github.io/Netty/Netty%204.0.30%20%E8%BF%9E%E6%8E%A5%E6%B1%A0bug%E5%88%86%E6%9E%90%E8%AE%B0%E5%BD%95/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="王某某">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="王某某的笔记">
      <meta itemprop="description" content="这是一个使用 Hexo 构建的博客，用于分享我的编程经验和学习笔记。">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 王某某的笔记">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/Netty/Netty%204.0.30%20%E8%BF%9E%E6%8E%A5%E6%B1%A0bug%E5%88%86%E6%9E%90%E8%AE%B0%E5%BD%95/" class="post-title-link" itemprop="url">Netty 4.0.30 连接池bug分析记录</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2019-06-14 23:41:00" itemprop="dateCreated datePublished" datetime="2019-06-14T23:41:00+08:00">2019-06-14</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Netty/" itemprop="url" rel="index"><span itemprop="name">Netty</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>846</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>3 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>Fastdfs 问题分析记录</p>
<h2 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h2><p>生产上存在上传文件到fastdfs中时一直卡死的问题</p>
<p>大概半个月出现一次，重启就能恢复<br>日志中没有任何错误</p>
<h2 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h2><p>线程堆栈：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">&quot;taskExecutor-5&quot; #638 prio=5 os_prio=0 tid=0x00007f970800b000 nid=0x1be3 waiting on condition [0x00007f9632008000]</span><br><span class="line">   java.lang.Thread.State: WAITING (parking)</span><br><span class="line">	at sun.misc.Unsafe.park(Native Method)</span><br><span class="line">	- parking to wait for  &lt;0x00000000e134e670&gt; (a java.util.concurrent.CompletableFuture$Signaller)</span><br><span class="line">	at java.util.concurrent.locks.LockSupport.park(LockSupport.java:175)</span><br><span class="line">	at java.util.concurrent.CompletableFuture$Signaller.block(CompletableFuture.java:1693)</span><br><span class="line">	at java.util.concurrent.ForkJoinPool.managedBlock(ForkJoinPool.java:3323)</span><br><span class="line">	at java.util.concurrent.CompletableFuture.waitingGet(CompletableFuture.java:1729)</span><br><span class="line">	at java.util.concurrent.CompletableFuture.get(CompletableFuture.java:1895)</span><br><span class="line">	at com.appleframework.file.provider.fdfs.FdfsProvider.upload(FdfsProvider.java:61)</span><br><span class="line">	at com.appleframework.file.spring.AbstractFSProviderSpringFacade.upload(AbstractFSProviderSpringFacade.java:70)</span><br><span class="line">	at com.chedaia.biz.renew.provider.service.impl.CustomerShoppingServiceImpl$1.run(CustomerShoppingServiceImpl.java:956)</span><br><span class="line">	at java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:511)</span><br><span class="line">	at java.util.concurrent.FutureTask.run(FutureTask.java:266)</span><br><span class="line">	at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1149)</span><br><span class="line">	at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:624)</span><br><span class="line">	at java.lang.Thread.run(Thread.java:748)</span><br></pre></td></tr></table></figure>
<p>只知道是在等一个CompletableFuture异步计算的返回结果，可能是再等待获取存储服务器地址，也可能是再等待上传结果</p>
<p>检查代码并进行测试，没有发现问题<br>猜测可能是获取不到连接导致的，连接没有归还到连接池中等，也可能是fastdfs一直没有响应，或者网络出现了什么问题等。</p>
<p>直到生产上再次出现该问题<br>将生产上的程序堆栈dump出来查看对比之前看的代码，发现是获取的连接数达到了最大值</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">jmap -dump:format=b,file=文件名 [pid]</span><br></pre></td></tr></table></figure>
<p><img src="https://img.wangwen135.top:23456/image/2024/08/66ba2dc9af4f4.png" alt="图片1.png"></p>
<p>而连接池中并没连接</p>
<p><img src="https://img.wangwen135.top:23456/image/2024/08/66ba2e2f65550.png" alt="图片2.png"></p>
<p>OQL</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select x.deque from io.netty.channel.pool.FixedChannelPool x</span><br></pre></td></tr></table></figure>


<h3 id="总结问题："><a href="#总结问题：" class="headerlink" title="总结问题："></a>总结问题：</h3><p><code>FixedChannelPool</code> 类的 <code>acquiredChannelCount</code> 字段<br>一直增加到了最大的限制（100）导致的<br>获取到的连接一直没有释放</p>
<h3 id="检查原因："><a href="#检查原因：" class="headerlink" title="检查原因："></a>检查原因：</h3><p>查代码，并且重点测试这个变量，一直无法重现该问题（怀疑人生<del>_</del>）</p>
<p>导出测试程序的dump文件和线上的进行比较<br>对比了一下测试版本和线上版本的dump文件，发现类不一致</p>
<p><img src="https://img.wangwen135.top:23456/image/2024/08/66ba2ea3cc665.png" alt="图片3.png"></p>
<p>线上版本没有这个变量</p>
<p><img src="https://img.wangwen135.top:23456/image/2024/08/66ba2ec28d5b5.png" alt="图片4.png"></p>
<p>检查发现 调试版本 和 线上的版本 不一致</p>
<ul>
<li><p>调试版本：<strong>netty-all-4.0.34.Final.jar</strong></p>
</li>
<li><p>线上版本：<strong>netty-all-4.0.30.Final.jar</strong></p>
</li>
</ul>
<p>再次查看netty-all-4.0.30的代码，发现netty的连接池存在问题</p>
<h2 id="问题重现"><a href="#问题重现" class="headerlink" title="问题重现"></a>问题重现</h2><p>检查代码发现连接归还到连接池中再次获取时存在问题<br>当连接用完之后，归还到连接池中，过了一段时间之后连接变成了 TIME_WAIT 状态（或断开），再去获取连接（此时将获取到一个异常的连接）</p>
<p><img src="https://img.wangwen135.top:23456/image/2024/08/66ba2f20ad8fc.png" alt="图片5.png"></p>
<p>获取到连接之后会对连接的有效性进行检查</p>
<p><img src="https://img.wangwen135.top:23456/image/2024/08/66ba2f3c04e77.png" alt="图片6.png"></p>
<p>检查到连接异常之后会关掉这个连接并再次获取连接</p>
<p><img src="https://img.wangwen135.top:23456/image/2024/08/66ba2f6623b14.png" alt="图片7.png"></p>
<p>此时会再调用<strong>FixedChannelPool</strong>类的<code>acquire0</code>方法获取连接，这将导致<strong>acquiredChannelCount</strong> 变量再次 +1，这次获取连接将会+2，而在释放时只会-1，这将导致这个值一直增大，直到达到maxConnections 的限制，之后就再也获取不到连接了</p>
<p><img src="https://img.wangwen135.top:23456/image/2024/08/66ba2fbd6e512.png" alt="图片8.png"></p>
<p>释放连接时只会-1</p>
<p><img src="https://img.wangwen135.top:23456/image/2024/08/66ba2fdaa5906.png" alt="图片9.png"></p>
<h2 id="修复方案"><a href="#修复方案" class="headerlink" title="修复方案"></a>修复方案</h2><p>升级netty的包到更高的版本</p>
<p><strong><code>netty-all-4.0.30.Final.jar 包存在这个问题</code></strong></p>
<p><strong>netty-all-4.0.34.Final.jar 已经修复了这个问题</strong></p>
<blockquote>
<p>PS：<br>这个4.0.34版本还是可能会有问题<br>private int acquiredChannelCount;<br>这个变量是int类型，存在并发问题，可能多个线程同时修改这个变量，应该用AtomicInteger，但是以目前系统的并发量来看，完全可以忽略。</p>
</blockquote>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://wangwen135.github.io/java/java%E7%A8%8B%E5%BA%8FClassLoad%E5%8A%A0%E5%AF%86%E7%9A%84%E9%80%9A%E7%94%A8%E7%A0%B4%E8%A7%A3%E6%96%B9%E6%B3%95/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="王某某">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="王某某的笔记">
      <meta itemprop="description" content="这是一个使用 Hexo 构建的博客，用于分享我的编程经验和学习笔记。">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 王某某的笔记">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/java/java%E7%A8%8B%E5%BA%8FClassLoad%E5%8A%A0%E5%AF%86%E7%9A%84%E9%80%9A%E7%94%A8%E7%A0%B4%E8%A7%A3%E6%96%B9%E6%B3%95/" class="post-title-link" itemprop="url">java程序ClassLoad加密的通用破解方法</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2019-05-15 12:01:00" itemprop="dateCreated datePublished" datetime="2019-05-15T12:01:00+08:00">2019-05-15</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Java/" itemprop="url" rel="index"><span itemprop="name">Java</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>743</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>3 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>想要加密java程序是比较困难的，一般的做法就是代码混淆，增加代码阅读的难度，另外就是修改Class文件的字节码，然后再虚拟机加载类的时候进行解密。修改字节码的解密方法一般是修改JDK中的ClassLoad或者自定义一个ClassLoad来解密Class。有些为了不让别人看到解密算法有些还会用C来写解密程序，再用jni来调用。</p>
<p>一般用改ClassLoader来加密的这种方法都可以用 javaagent 获取到解密后class。</p>
<blockquote>
<p>使用 Instrumentation，开发者可以构建一个独立于应用程序的代理程序（Agent），用来监测和协助运行在 JVM 上的程序，甚至能够替换和修改某些类的定义。有了这样的功能，开发者就可以实现更为灵活的运行时虚拟机监控和 Java 类操作了，这样的特性实际上提供了一种虚拟机级别支持的 AOP 实现方式，使得开发者无需对 JDK 做任何升级和改动，就可以实现某些 AOP 的功能了。<br><em>介绍地址：</em><br><a target="_blank" rel="noopener" href="https://www.ibm.com/developerworks/cn/java/j-lo-jse61/">https://www.ibm.com/developerworks/cn/java/j-lo-jse61/</a></p>
</blockquote>
<h3 id="输出Class文件到指定目录的代码"><a href="#输出Class文件到指定目录的代码" class="headerlink" title="输出Class文件到指定目录的代码"></a>输出Class文件到指定目录的代码</h3><h4 id="1、新建一个maven项目"><a href="#1、新建一个maven项目" class="headerlink" title="1、新建一个maven项目"></a>1、新建一个maven项目</h4><p>如：class-agent</p>
<h4 id="2、写两个类"><a href="#2、写两个类" class="headerlink" title="2、写两个类"></a>2、写两个类</h4><p><strong>PreMainExecutor.java</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">package com.wwh.agent;</span><br><span class="line"></span><br><span class="line">import java.lang.instrument.Instrumentation;</span><br><span class="line"></span><br><span class="line">public class PreMainExecutor &#123;</span><br><span class="line"></span><br><span class="line">    public static void premain(String agentOps, Instrumentation inst) &#123;</span><br><span class="line">        System.out.println(&quot;premain execute..........&quot;);</span><br><span class="line">        System.out.println(&quot;参数：&quot; + agentOps);</span><br><span class="line">        // 添加Transformer</span><br><span class="line">        inst.addTransformer(new PrintClassFileAgent(agentOps));</span><br><span class="line"></span><br><span class="line">        // 可以用这个来加载jar包</span><br><span class="line">        // inst.appendToSystemClassLoaderSearch(jarfile);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p><strong>PrintClassFileAgent.java</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">package com.wwh.agent;</span><br><span class="line"></span><br><span class="line">import java.io.File;</span><br><span class="line">import java.io.FileOutputStream;</span><br><span class="line">import java.io.IOException;</span><br><span class="line">import java.lang.instrument.ClassFileTransformer;</span><br><span class="line">import java.lang.instrument.IllegalClassFormatException;</span><br><span class="line">import java.security.ProtectionDomain;</span><br><span class="line"></span><br><span class="line">public class PrintClassFileAgent implements ClassFileTransformer &#123;</span><br><span class="line"></span><br><span class="line">    public static final String OUT_FILE_DIR = &quot;/opt/logs/wwh/classFile/&quot;;</span><br><span class="line"></span><br><span class="line">    private File outFileDir;</span><br><span class="line"></span><br><span class="line">    public PrintClassFileAgent()&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public PrintClassFileAgent(String fileDir)&#123;</span><br><span class="line">        String fileOutDir = OUT_FILE_DIR;</span><br><span class="line">        if (fileDir != null &amp;&amp; !&quot;&quot;.equals(fileDir)) &#123;</span><br><span class="line">            fileOutDir = fileDir;</span><br><span class="line">        &#125;</span><br><span class="line">        outFileDir = new File(fileOutDir);</span><br><span class="line">        outFileDir.mkdirs();</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public byte[] transform(ClassLoader loader, String className, Class&lt;?&gt; classBeingRedefined,</span><br><span class="line">                            ProtectionDomain protectionDomain,</span><br><span class="line">                            byte[] classfileBuffer) throws IllegalClassFormatException &#123;</span><br><span class="line">        System.out.println(&quot;类加载器：&quot; + loader);</span><br><span class="line">        System.out.println(&quot;类名称：&quot; + className);</span><br><span class="line"></span><br><span class="line">        String pathName = className.replaceAll(&quot;[.]&quot;, &quot;/&quot;);</span><br><span class="line">        pathName = pathName + &quot;.class&quot;;</span><br><span class="line"></span><br><span class="line">        File f = new File(OUT_FILE_DIR + pathName);</span><br><span class="line"></span><br><span class="line">        f.getParentFile().mkdirs();</span><br><span class="line">        try &#123;</span><br><span class="line">            f.createNewFile();</span><br><span class="line">            FileOutputStream fos = new FileOutputStream(f);</span><br><span class="line">            fos.write(classfileBuffer);</span><br><span class="line">            fos.close();</span><br><span class="line">        &#125; catch (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        return null;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="3、-修改pom文件"><a href="#3、-修改pom文件" class="headerlink" title="3、 修改pom文件"></a>3、 修改pom文件</h4><p>用于指定：Premain-Class</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">&lt;project xmlns=&quot;http://maven.apache.org/POM/4.0.0&quot;</span><br><span class="line">	xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span><br><span class="line">	xsi:schemaLocation=&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;&gt;</span><br><span class="line">	&lt;modelVersion&gt;4.0.0&lt;/modelVersion&gt;</span><br><span class="line">	&lt;groupId&gt;com.wwh.agent&lt;/groupId&gt;</span><br><span class="line">	&lt;artifactId&gt;class-agent&lt;/artifactId&gt;</span><br><span class="line">	&lt;version&gt;0.0.1-SNAPSHOT&lt;/version&gt;</span><br><span class="line"></span><br><span class="line">	&lt;properties&gt;</span><br><span class="line">		&lt;maven.compiler.target&gt;1.8&lt;/maven.compiler.target&gt;</span><br><span class="line">		&lt;maven.compiler.source&gt;1.8&lt;/maven.compiler.source&gt;</span><br><span class="line">	&lt;/properties&gt;</span><br><span class="line"></span><br><span class="line">	&lt;build&gt;</span><br><span class="line">		&lt;plugins&gt;</span><br><span class="line">			&lt;plugin&gt;</span><br><span class="line">				&lt;groupId&gt;org.apache.maven.plugins&lt;/groupId&gt;</span><br><span class="line">				&lt;artifactId&gt;maven-jar-plugin&lt;/artifactId&gt;</span><br><span class="line">				&lt;configuration&gt;</span><br><span class="line">					&lt;archive&gt;</span><br><span class="line">						&lt;manifest&gt;</span><br><span class="line">							&lt;addClasspath&gt;true&lt;/addClasspath&gt;</span><br><span class="line">						&lt;/manifest&gt;</span><br><span class="line">						&lt;manifestEntries&gt;</span><br><span class="line">							&lt;Premain-Class&gt;</span><br><span class="line">								com.wwh.agent.PreMainExecutor</span><br><span class="line">							&lt;/Premain-Class&gt;</span><br><span class="line">						&lt;/manifestEntries&gt;</span><br><span class="line">					&lt;/archive&gt;</span><br><span class="line">				&lt;/configuration&gt;</span><br><span class="line">			&lt;/plugin&gt;</span><br><span class="line">		&lt;/plugins&gt;</span><br><span class="line">	&lt;/build&gt;</span><br><span class="line"></span><br><span class="line">&lt;/project&gt;</span><br></pre></td></tr></table></figure>

<h3 id="用法"><a href="#用法" class="headerlink" title="用法"></a>用法</h3><p>将上面的maven项目编译打包，将 class-agent-0.0.1-SNAPSHOT.jar 复制到目标位置。</p>
<p>用如下命令启动想要破解的程序：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">java -javaagent:class-agent-0.0.1-SNAPSHOT.jar -cp runner-0.0.1-SNAPSHOT.jar com.wwh.runner.EmptyRunner</span><br><span class="line"></span><br><span class="line">//指定输出Class文件目录的</span><br><span class="line">java -javaagent:class-agent-0.0.1-SNAPSHOT.jar=/opt/xxx/out -cp runner-0.0.1-SNAPSHOT.jar com.wwh.runner.EmptyRunner</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>如果需要破解的程序本身就有使用javaagent，需要将上面的agent放到调用链的最后面。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">java -javaagent:agentA.jar -javaagent:class-agent-0.0.1-SNAPSHOT.jar XXProgram</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="效果"><a href="#效果" class="headerlink" title="效果"></a>效果</h3><p>将在目录下保存所有加载的类的class文件</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">E:\opt\logs\wwh\classFile&gt;tree</span><br><span class="line">......</span><br><span class="line">......</span><br><span class="line">    ├─nio</span><br><span class="line">    │  ├─ch</span><br><span class="line">    │  ├─cs</span><br><span class="line">    │  └─fs</span><br><span class="line">    ├─reflect</span><br><span class="line">    │  ├─annotation</span><br><span class="line">    │  └─generics</span><br><span class="line">    │      ├─factory</span><br><span class="line">    │      ├─parser</span><br><span class="line">    │      ├─reflectiveObjects</span><br><span class="line">    │      ├─repository</span><br><span class="line">    │      ├─scope</span><br><span class="line">    │      ├─tree</span><br><span class="line">    │      └─visitor</span><br><span class="line">    ├─security</span><br><span class="line">    │  ├─action</span><br><span class="line">    │  ├─jca</span><br><span class="line">    │  ├─provider</span><br><span class="line">    │  └─util</span><br><span class="line">    ├─text</span><br><span class="line">    │  └─resources</span><br><span class="line">    │      └─zh</span><br><span class="line">    ├─usagetracker</span><br><span class="line">    └─util</span><br><span class="line">        ├─calendar</span><br><span class="line">        ├─locale</span><br><span class="line">        │  └─provider</span><br><span class="line">        ├─logging</span><br><span class="line">        ├─resources</span><br><span class="line">        │  ├─en</span><br><span class="line">        │  └─zh</span><br><span class="line">        └─spi</span><br><span class="line">......        </span><br><span class="line">......</span><br><span class="line"></span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://wangwen135.github.io/java/%E5%85%B3%E4%BA%8E%20java%20Agent/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="王某某">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="王某某的笔记">
      <meta itemprop="description" content="这是一个使用 Hexo 构建的博客，用于分享我的编程经验和学习笔记。">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 王某某的笔记">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/java/%E5%85%B3%E4%BA%8E%20java%20Agent/" class="post-title-link" itemprop="url">关于 java Agent</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2019-05-15 12:01:00" itemprop="dateCreated datePublished" datetime="2019-05-15T12:01:00+08:00">2019-05-15</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Java/" itemprop="url" rel="index"><span itemprop="name">Java</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>2.7k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>10 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h3 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h3><p><strong>instrument 规范</strong></p>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://docs.oracle.com/javase/8/docs/api/java/lang/instrument/package-summary.html?is-external=true">https://docs.oracle.com/javase/8/docs/api/java/lang/instrument/package-summary.html?is-external=true</a></p>
</blockquote>
<p><strong>Class VirtualMachine</strong></p>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://docs.oracle.com/javase/8/docs/jdk/api/attach/spec/com/sun/tools/attach/VirtualMachine.html#loadAgent-java.lang.String-">https://docs.oracle.com/javase/8/docs/jdk/api/attach/spec/com/sun/tools/attach/VirtualMachine.html#loadAgent-java.lang.String-</a></p>
</blockquote>
<p><strong>Interface ClassFileTransformer</strong></p>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://docs.oracle.com/javase/8/docs/api/java/lang/instrument/ClassFileTransformer.html">https://docs.oracle.com/javase/8/docs/api/java/lang/instrument/ClassFileTransformer.html</a></p>
</blockquote>
<hr>
<h3 id="java-agent-实现"><a href="#java-agent-实现" class="headerlink" title="java agent 实现"></a>java agent 实现</h3><p>代理需要编译成jar包的方式来运行，JAR文件manifest中的属性指定将加载哪个代理类来启动代理。</p>
<p>有下面两种方式可以启动一个agent</p>
<h4 id="一：命令行接口"><a href="#一：命令行接口" class="headerlink" title="一：命令行接口"></a>一：命令行接口</h4><p>程序没有启动时可以通过在命令行上指定javaagent的方式来启动代理</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">-javaagent:jarpath[=options]</span><br><span class="line"></span><br><span class="line">#如：</span><br><span class="line">java -javaagent:xxx-agent.jar -cp xxx.jar com.wwh.xxxx</span><br></pre></td></tr></table></figure>

<p>通过命令行的方式可以指定<strong>多个</strong>代理，并且支持参数。初始化Java虚拟机(JVM)之后，将按照指定代理的顺序调用每个premain方法，然后调用真正的应用程序main方法。每个premain方法必须返回，以便继续启动程序。</p>
<p>agent Jar包中的manifest文件必须包含Premain-Class， 指向代理的入口类，这个类中包含了一个公共静态的premain方法</p>
<p>premain 方法有两种签名，虚拟机会尝试先运行下面这个</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">public static void premain(String agentArgs, Instrumentation inst);</span><br></pre></td></tr></table></figure>
<p>如果没有会尝试调用下面这个</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">public static void premain(String agentArgs);</span><br></pre></td></tr></table></figure>
<p>当使用命令行选项启动代理时，不会调用agentmain方法。</p>
<p>代理类将由系统类加载器加载(参见ClassLoader.getSystemClassLoader)。这是类加载器，它通常加载包含应用程序主方法的类。premain方法将在与应用程序main方法相同的安全性和类加载器规则下运行。对于代理premain方法可以做什么，没有建模限制。application main可以做的任何事情，包括创建线程，都是合法的。</p>
<p>每个代理都通过agentArgs参数传递其代理选项。代理选项作为单个字符串传递，任何额外的解析都应该由代理本身执行。</p>
<h4 id="二：在虚拟机启动之后再启动代理"><a href="#二：在虚拟机启动之后再启动代理" class="headerlink" title="二：在虚拟机启动之后再启动代理"></a>二：在虚拟机启动之后再启动代理</h4><p>程序已经启动后可以通过VirtualMachine 来加载启动代理，如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">VirtualMachine vm = VirtualMachine.attach(&quot;2177&quot;);</span><br><span class="line">vm.loadAgent(jar);</span><br><span class="line">vm.detach();</span><br></pre></td></tr></table></figure>

<p>注意：  </p>
<ol>
<li>代理JAR的manifest中必须包含属性 Agent-Class。此属性的值是代理类的名称。  </li>
<li>代理类必须实现一个公共静态的 agentmain  方法，如下所示。</li>
</ol>
<p>启动代理时先尝试运行</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">public static void agentmain(String agentArgs, Instrumentation inst);</span><br></pre></td></tr></table></figure>
<p>找不到再尝试运行</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">public static void agentmain(String agentArgs);</span><br></pre></td></tr></table></figure>

<p>agentmain方法不能阻塞，这个类同用可以拥有 premain  方法，不过并不会被调用</p>
<p>参数通过如下方式指定：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vm.loadAgent(jar, options);</span><br></pre></td></tr></table></figure>


<h4 id="Manifest-属性说明"><a href="#Manifest-属性说明" class="headerlink" title="Manifest 属性说明"></a>Manifest 属性说明</h4><p>代理JAR文件定义了以下清单属性:</p>
<ol>
<li><strong>Premain-Class</strong>  此属性指定代理类，也就是包含premain方法的类。如果该属性不存在，JVM将中止。注意这是一个类名，而不是文件名或路径。</li>
<li><strong>Agent-Class</strong>  指定代理类，支持在VM启动后启动代理的机制，包含了agentmain 方法的类，如果该属性不存在，则代理将不会启动。注意这是一个类名，而不是文件名或路径。</li>
<li><strong>Boot-Class-Path</strong> 引导类装入器要搜索的路径列表</li>
<li><strong>Can-Redefine-Classes</strong> 布尔值( true 或 false ，不区分大小写)。代理是否可以重新定义类。此属性是可选的，默认为false。</li>
<li><strong>Can-Retransform-Classes</strong> 布尔值( true 或 false ，不区分大小写)。代理是否可以重新转换类。此属性是可选的，默认为false。</li>
<li><strong>Can-Set-Native-Method-Prefix</strong> 布尔值( true 或 false ，不区分大小写)。代理是否可以设置本地方法前缀。此属性是可选的，默认为false。</li>
</ol>
<p>代理JAR文件可同时具有清单中的Premain-Class和Agent-Class属性。当使用-javaagent选项在命令行上启动代理时，执行Premain-Class属性指定的<br>代理类，而Agent-Class属性将被忽略。类似地，如果代理在VM启动之后再启动，则执行Agent-Class属性指定的代理类，而忽略Premain-Class属性的值。</p>
<hr>
<h3 id="相关类说明"><a href="#相关类说明" class="headerlink" title="相关类说明"></a>相关类说明</h3><p>几个关键类和接口</p>
<h4 id="VirtualMachine"><a href="#VirtualMachine" class="headerlink" title="VirtualMachine"></a>VirtualMachine</h4><p>表示一个java虚拟机<br>VirtualMachine表示已附加到的Java虚拟机。它所附加的Java虚拟机有时称为目标虚拟机或目标VM。应用程序(通常是managemet控制台或分析器之类的工具)使用虚拟机将代理加载到目标VM中。例如，用Java语言编写的分析器工具可能附加到正在运行的应用程序，并加载其分析器代理来分析正在运行的应用程序。</p>
<p>通过调用带有标识目标虚拟机的标识符的attach方法来获得虚拟机。标识符依赖于实现，但在每个Java虚拟机都在自己的操作系统进程中运行的环境中，标识符通常是进程标识符(或pid)。另外，通过使用从list方法返回的虚拟机描述符列表中获得的VirtualMachineDescriptor调用attach方法来获得虚拟机实例。一旦获得对虚拟机的引用，就使用loadAgent、loadAgentLibrary和loadAgentPath方法将代理加载到目标虚拟机中。loadAgent方法用于加载用Java语言编写并部署在JAR文件中的代理。loadAgentLibrary和loadAgentPath方法用于加载部署在动态库或静态链接到VM并使用JVM工具接口的代理。</p>
<p>除了加载代理之外，虚拟机还提供对目标VM中的系统属性的读访问。这在某些环境中非常有用，比如java。home、os.name或os。arch用于构造将加载到目标VM的代理的路径。</p>
<p>一个启动jmx的例子</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">// attach to target VM</span><br><span class="line">VirtualMachine vm = VirtualMachine.attach(&quot;2177&quot;);</span><br><span class="line"></span><br><span class="line">// start management agent</span><br><span class="line">Properties props = new Properties();</span><br><span class="line">props.put(&quot;com.sun.management.jmxremote.port&quot;, &quot;5000&quot;);</span><br><span class="line">vm.startManagementAgent(props);</span><br><span class="line"></span><br><span class="line">// detach</span><br><span class="line">vm.detach();</span><br></pre></td></tr></table></figure>
<p>虚拟机对于多个并发线程的使用是安全的。</p>
<h4 id="ClassFileTransformer"><a href="#ClassFileTransformer" class="headerlink" title="ClassFileTransformer"></a>ClassFileTransformer</h4><p>代理提供此接口的实现，以便转换类文件。转换发生在JVM定义类之前。</p>
<p>一个代理提供者需要实现：ClassFileTransformer 接口，来转变class文件，这个接口有一个方法</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">byte[]</span><br><span class="line">transform(  ClassLoader         loader,</span><br><span class="line">            String              className,</span><br><span class="line">            Class&lt;?&gt;            classBeingRedefined,</span><br><span class="line">            ProtectionDomain    protectionDomain,</span><br><span class="line">            byte[]              classfileBuffer)</span><br><span class="line">    throws IllegalClassFormatException;</span><br></pre></td></tr></table></figure>

<p>此方法的实现可以转换提供的类文件并返回一个新的替换类文件</p>
<p>一旦向addTransformer注册了一个transformer，每个新的类定义和每个类重定义都会调用这个transformer。每个类重新转换时也将调用具有重新转换能力的转换器。<br>对新类定义的请求是用  ClassLoader.defineClass 或本地调用触发的。<br>对类的重定义请求是通过 Instrumentation.redefineClasses 或本地调用触发的。<br>对类重新转换的请求是通过 Instrumentation.retransformClasses 或本地调用触发的。<br>在处理请求期间，在类文件字节被验证或应用之前调用转换器。<br>当有多个转换器时，转换由链接转换调用组成。也就是说，一个转换调用返回的字节数组将成为下一个调用的输入(通过classfileBuffer参数)。</p>
<p>关于transform输入的classfileBuffer参数：<br>如果实现方法确定不需要转换，则返回null。否则，它应该创建一个新的byte[]数组，将输入classfileBuffer连同所有所需的转换复制到其中，并返回新数组。不能修改输入classfileBuffer。</p>
<p>在重新转换和重新定义的情况下，转换器必须支持重新定义语义:如果转换器在初始定义期间更改的类稍后被重新转换或重新定义，转换器必须确保第二个类输出类文件是第一个输出类文件的合法重新定义。</p>
<p>如果transformer抛出异常(它没有捕获异常)，后续的transformer仍然会被调用，并且负载、重新定义或重新转换仍然会被尝试。因此，抛出异常的效果与返回null相同。为了防止在transformer代码中生成未检查异常时出现意外行为，transformer可以捕获Throwable。如果转换器认为classFileBuffer不代表一个有效格式化的类文件，它应该抛出一个IllegalClassFormatException;而这与返回null具有相同的效果。它有助于记录或调试格式错误。</p>
<p><strong>参数说明：</strong>  </p>
<ol>
<li>loader   要转换的类的定义类加载器，如果是bootstrap loader则为空</li>
<li>className  类名的内部形式为Java虚拟机规范中定义的完全限定类名和接口名。例如：”java&#x2F;util&#x2F;List”。</li>
<li>classBeingRedefined  如果这是由重新定义或重新转换触发的，则这个类存在重新定义或重新转换，否则为null。</li>
<li>protectionDomain 正在定义或重新定义的类的保护域</li>
<li>classfileBuffer 类文件格式的输入字节缓冲区-<strong>不能修改</strong></li>
</ol>
<p><strong>返回：</strong><br>格式良好的类文件缓冲区(转换的结果)，如果没有执行转换，则为null。</p>
<h4 id="Instrumentation"><a href="#Instrumentation" class="headerlink" title="Instrumentation"></a>Instrumentation</h4><p>该类提供测试Java编程语言代码所需的服务。插装是将字节码添加到方法中，以便收集工具使用的数据。由于这些更改纯粹是附加的，所以这些工具不会修改应用程序状态或行为。此类良性工具的例子包括监视代理、分析器、覆盖率分析器和事件日志记录器。</p>
<p>获取Instrumentation  接口实例有两种方法:  </p>
<ol>
<li>当JVM以指示代理类的方式启动时。在这种情况下，将一个插装实例传递给代理类的premain方法。</li>
<li>当JVM在启动后的某个时候提供启动代理的机制时。在这种情况下，将一个插装实例传递给代理代码的agentmain方法。</li>
</ol>
<p>一旦代理获得一个Instrumentation 实例，代理可以在任何时候调用该实例上的方法。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Instrumentation.addTransformer(new Transformer(), true);  </span><br></pre></td></tr></table></figure>
<p>第二个参数表示是否可以重新转换已经定义好了的类<br>对于启动后再附加agent的方式，如果想要改变已经加载了的类，需要设置为true</p>
<p>并且注意修改manifest文件中的</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Can-Retransform-Classes: true</span><br></pre></td></tr></table></figure>

<p>否则会报错：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">adding retransformable transformers is not supported in this environment</span><br></pre></td></tr></table></figure>


<hr>
<h4 id="示例"><a href="#示例" class="headerlink" title="示例"></a>示例</h4><h5 id="pom-文件示例："><a href="#pom-文件示例：" class="headerlink" title="pom 文件示例："></a>pom 文件示例：</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependencies&gt;</span><br><span class="line">	&lt;dependency&gt;</span><br><span class="line">		&lt;groupId&gt;jdk.tools&lt;/groupId&gt;</span><br><span class="line">		&lt;artifactId&gt;jdk.tools&lt;/artifactId&gt;</span><br><span class="line">		&lt;version&gt;1.8&lt;/version&gt;</span><br><span class="line">		&lt;scope&gt;system&lt;/scope&gt;</span><br><span class="line">		&lt;systemPath&gt;$&#123;JAVA_HOME&#125;/lib/tools.jar&lt;/systemPath&gt;</span><br><span class="line">	&lt;/dependency&gt;</span><br><span class="line">&lt;/dependencies&gt;</span><br><span class="line"></span><br><span class="line">&lt;build&gt;</span><br><span class="line">	&lt;plugins&gt;</span><br><span class="line">		&lt;plugin&gt;</span><br><span class="line">			&lt;groupId&gt;org.apache.maven.plugins&lt;/groupId&gt;</span><br><span class="line">			&lt;artifactId&gt;maven-jar-plugin&lt;/artifactId&gt;</span><br><span class="line">			&lt;configuration&gt;</span><br><span class="line">				&lt;archive&gt;</span><br><span class="line">					&lt;manifest&gt;</span><br><span class="line">						&lt;addClasspath&gt;true&lt;/addClasspath&gt;</span><br><span class="line">					&lt;/manifest&gt;</span><br><span class="line">					&lt;manifestEntries&gt;</span><br><span class="line">						&lt;!-- 参数方式启动agent需要这个 --&gt;</span><br><span class="line">						&lt;Premain-Class&gt;</span><br><span class="line">							com.wwh.agentmain.AgentMain</span><br><span class="line">						&lt;/Premain-Class&gt;</span><br><span class="line"></span><br><span class="line">						&lt;!-- 启动后附加启动agent需要这个 --&gt;</span><br><span class="line">						&lt;Agent-Class&gt;</span><br><span class="line">							com.wwh.agentmain.AgentMain</span><br><span class="line">						&lt;/Agent-Class&gt;</span><br><span class="line"></span><br><span class="line">						&lt;!-- 是否可以重新转换类 --&gt;</span><br><span class="line">						&lt;Can-Retransform-Classes&gt;</span><br><span class="line">							true</span><br><span class="line">						&lt;/Can-Retransform-Classes&gt;</span><br><span class="line"></span><br><span class="line">						&lt;!-- 是否可以重新定义类 --&gt;</span><br><span class="line">						&lt;Can-Redefine-Classes&gt;</span><br><span class="line">							true</span><br><span class="line">						&lt;/Can-Redefine-Classes&gt;</span><br><span class="line"></span><br><span class="line">					&lt;/manifestEntries&gt;</span><br><span class="line">				&lt;/archive&gt;</span><br><span class="line">			&lt;/configuration&gt;</span><br><span class="line">		&lt;/plugin&gt;</span><br><span class="line">	&lt;/plugins&gt;</span><br><span class="line">&lt;/build&gt;</span><br></pre></td></tr></table></figure>

<h5 id="manifest文件示例："><a href="#manifest文件示例：" class="headerlink" title="manifest文件示例："></a>manifest文件示例：</h5><p>META-INF&#x2F;MANIFEST.MF</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">Manifest-Version: 1.0</span><br><span class="line">Premain-Class: com.wwh.agentmain.AgentMain</span><br><span class="line">Archiver-Version: Plexus Archiver</span><br><span class="line">Built-By: Administrator</span><br><span class="line">Agent-Class: com.wwh.agentmain.AgentMain</span><br><span class="line">Can-Redefine-Classes: true</span><br><span class="line">Can-Retransform-Classes: true</span><br><span class="line">Created-By: Apache Maven 3.5.3</span><br><span class="line">Build-Jdk: 1.8.0_151</span><br></pre></td></tr></table></figure>


<hr>
<h3 id="代码例子"><a href="#代码例子" class="headerlink" title="代码例子"></a>代码例子</h3><p><a target="_blank" rel="noopener" href="https://github.com/wangwen135/java-agent-test">https://github.com/wangwen135/java-agent-test</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://wangwen135.github.io/Maven/maven%20%E6%89%93%E5%8C%85%20cannot%20access%20%E9%97%AE%E9%A2%98/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="王某某">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="王某某的笔记">
      <meta itemprop="description" content="这是一个使用 Hexo 构建的博客，用于分享我的编程经验和学习笔记。">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 王某某的笔记">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/Maven/maven%20%E6%89%93%E5%8C%85%20cannot%20access%20%E9%97%AE%E9%A2%98/" class="post-title-link" itemprop="url">maven 打包 cannot access 问题</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2019-04-16 23:41:00" itemprop="dateCreated datePublished" datetime="2019-04-16T23:41:00+08:00">2019-04-16</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Maven/" itemprop="url" rel="index"><span itemprop="name">Maven</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>455</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>2 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h3 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h3><p>一个项目在开发环境，本地都能打包通过</p>
<p>在测试环境打包过不去</p>
<p>提示 error: cannot access xxxxxxx</p>
<h3 id="原因"><a href="#原因" class="headerlink" title="原因"></a>原因</h3><p>开发和测试环境用了两套私服</p>
<p>测试环境有人手动上传了jar包，该jar包对应的pom文件，由nexus生成【&gt;POM was created by Sonatype Nexus】，没有dependencies 节点</p>
<h3 id="处理"><a href="#处理" class="headerlink" title="处理"></a>处理</h3><p>在nexus的 3rd party 中删除该jar，重新上传即可</p>
<h4 id="注意："><a href="#注意：" class="headerlink" title="注意："></a>注意：</h4><p>如果通过手动上传的方式 GAV Definition 不能选择 GAV Parameters<br>应该选择：<br><strong>GAV Definition： from pom</strong></p>
<h3 id="排查问题"><a href="#排查问题" class="headerlink" title="排查问题"></a>排查问题</h3><p>检查环境、检查配置，对比jar包等都没有问题</p>
<p>使用 mvn dependency:tree 命令，发现测试环境比开发环境少依赖了几个jar包</p>
<p>然后找的mavne 的 【localRepository】 目录中，按照路径找到对应jar包【根据提示缺少的类和依赖关系】的路径</p>
<p>如：</p>
<blockquote>
<p>&#x2F;data&#x2F;repo&#x2F;com&#x2F;xxx&#x2F;xxx&#x2F;xxxxxxx&#x2F;0.1.9.RELEASE</p>
</blockquote>
<p>这个目录下有xxxx-version.jar和一个对应的xxxx-version.pom文件，问题就是这个pom文件没有dependencies信息</p>
<p>有问题pom文件如：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&lt;project xmlns=&quot;http://maven.apache.org/POM/4.0.0&quot; xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot; xsi:schemaLocation=&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;&gt;</span><br><span class="line">    &lt;modelVersion&gt;4.0.0&lt;/modelVersion&gt;</span><br><span class="line">    &lt;groupId&gt;com.appleframework.jms&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;apple-jms-kafka&lt;/artifactId&gt;</span><br><span class="line">    &lt;version&gt;0.1.9.RELEASE&lt;/version&gt;</span><br><span class="line">    &lt;description&gt;POM was created by Sonatype Nexus&lt;/description&gt;</span><br><span class="line">&lt;/project&gt;</span><br></pre></td></tr></table></figure>

<p>正常的应该是：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=&quot;1.0&quot;?&gt;</span><br><span class="line">&lt;project</span><br><span class="line">	xsi:schemaLocation=&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span><br><span class="line">	xmlns=&quot;http://maven.apache.org/POM/4.0.0&quot; xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;&gt;</span><br><span class="line">	&lt;modelVersion&gt;4.0.0&lt;/modelVersion&gt;</span><br><span class="line">	&lt;parent&gt;</span><br><span class="line">		&lt;groupId&gt;com.appleframework.jms&lt;/groupId&gt;</span><br><span class="line">		&lt;artifactId&gt;apple-jms&lt;/artifactId&gt;</span><br><span class="line">		&lt;version&gt;0.1.9.RELEASE&lt;/version&gt;</span><br><span class="line">	&lt;/parent&gt;</span><br><span class="line">	&lt;artifactId&gt;apple-jms-kafka&lt;/artifactId&gt;</span><br><span class="line">	&lt;name&gt;apple-jms-kafka&lt;/name&gt;</span><br><span class="line">	&lt;url&gt;http://mvnrepo.appleframework.com&lt;/url&gt;</span><br><span class="line">		</span><br><span class="line">	&lt;dependencies&gt;</span><br><span class="line">	</span><br><span class="line">		&lt;dependency&gt;</span><br><span class="line">			&lt;groupId&gt;com.appleframework.jms&lt;/groupId&gt;</span><br><span class="line">			&lt;artifactId&gt;apple-jms-core&lt;/artifactId&gt;</span><br><span class="line">			&lt;version&gt;$&#123;project.version&#125;&lt;/version&gt;</span><br><span class="line">		&lt;/dependency&gt;</span><br><span class="line"></span><br><span class="line">		&lt;dependency&gt;</span><br><span class="line">			&lt;groupId&gt;org.apache.kafka&lt;/groupId&gt;</span><br><span class="line">			&lt;artifactId&gt;kafka_2.11&lt;/artifactId&gt;</span><br><span class="line">			&lt;version&gt;0.11.0.3&lt;/version&gt;</span><br><span class="line">			&lt;scope&gt;provided&lt;/scope&gt;</span><br><span class="line">		&lt;/dependency&gt;</span><br><span class="line">		</span><br><span class="line">		&lt;dependency&gt;</span><br><span class="line">			&lt;groupId&gt;junit&lt;/groupId&gt;</span><br><span class="line">			&lt;artifactId&gt;junit&lt;/artifactId&gt;</span><br><span class="line">			&lt;scope&gt;test&lt;/scope&gt;</span><br><span class="line">		&lt;/dependency&gt;</span><br><span class="line">		&lt;dependency&gt;</span><br><span class="line">			&lt;groupId&gt;org.springframework&lt;/groupId&gt;</span><br><span class="line">			&lt;artifactId&gt;spring-test&lt;/artifactId&gt;</span><br><span class="line">			&lt;scope&gt;test&lt;/scope&gt;</span><br><span class="line">		&lt;/dependency&gt;</span><br><span class="line">		&lt;dependency&gt;</span><br><span class="line">			&lt;groupId&gt;org.springframework&lt;/groupId&gt;</span><br><span class="line">			&lt;artifactId&gt;spring-context&lt;/artifactId&gt;</span><br><span class="line">			&lt;scope&gt;provided&lt;/scope&gt;</span><br><span class="line">		&lt;/dependency&gt;</span><br><span class="line">		</span><br><span class="line">		&lt;dependency&gt;</span><br><span class="line">  			&lt;groupId&gt;com.google.code.gson&lt;/groupId&gt;</span><br><span class="line">  			&lt;artifactId&gt;gson&lt;/artifactId&gt;</span><br><span class="line">  			&lt;version&gt;2.8.5&lt;/version&gt;</span><br><span class="line">  			&lt;scope&gt;provided&lt;/scope&gt;</span><br><span class="line">		&lt;/dependency&gt;</span><br><span class="line">		</span><br><span class="line">	&lt;/dependencies&gt;</span><br><span class="line">&lt;/project&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure>


      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://wangwen135.github.io/%E8%84%9A%E6%9C%AC/bat/bat%20%E5%91%BD%E4%BB%A4%E8%A1%8C%E4%BF%AE%E6%94%B9%E6%96%87%E4%BB%B6%E6%9D%83%E9%99%90/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="王某某">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="王某某的笔记">
      <meta itemprop="description" content="这是一个使用 Hexo 构建的博客，用于分享我的编程经验和学习笔记。">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 王某某的笔记">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/%E8%84%9A%E6%9C%AC/bat/bat%20%E5%91%BD%E4%BB%A4%E8%A1%8C%E4%BF%AE%E6%94%B9%E6%96%87%E4%BB%B6%E6%9D%83%E9%99%90/" class="post-title-link" itemprop="url">bat 命令行修改文件权限</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2019-03-14 23:41:00" itemprop="dateCreated datePublished" datetime="2019-03-14T23:41:00+08:00">2019-03-14</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%84%9A%E6%9C%AC/" itemprop="url" rel="index"><span itemprop="name">脚本</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%84%9A%E6%9C%AC/bat/" itemprop="url" rel="index"><span itemprop="name">bat</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>328</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>1 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">SET PATH=G:\360WIFI</span><br><span class="line">Takeown /F %PATH% /r /d y</span><br><span class="line">cacls %PATH% /t /e /g Administrators:F</span><br><span class="line">rd /s /q %PATH%</span><br><span class="line">@pause</span><br></pre></td></tr></table></figure>


<p>实际测试情况：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">C:\Windows\SysWOW64\Macromed\Flash&gt;del /F activex.vch</span><br><span class="line">C:\Windows\SysWOW64\Macromed\Flash\activex.vch</span><br><span class="line">拒绝访问。</span><br><span class="line"></span><br><span class="line">C:\Windows\SysWOW64\Macromed\Flash&gt;takeown /F activex.vch</span><br><span class="line"></span><br><span class="line">成功: 此文件(或文件夹): &quot;C:\Windows\SysWOW64\Macromed\Flash\activex.vch&quot; 现在由用户 &quot;WWH\wangw&quot; 所有。</span><br><span class="line"></span><br><span class="line">C:\Windows\SysWOW64\Macromed\Flash&gt;cacls activex.vch /e /g &quot;WWH\wangw&quot;:F</span><br><span class="line">处理的文件: C:\Windows\SysWOW64\Macromed\Flash\activex.vch</span><br><span class="line"></span><br><span class="line">C:\Windows\SysWOW64\Macromed\Flash&gt;del activex.vch</span><br><span class="line"></span><br><span class="line">C:\Windows\SysWOW64\Macromed\Flash&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>删除目录测试：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">C:\Windows\SysWOW64\Macromed&gt;rd /s Flash</span><br><span class="line">Flash, 是否确认(Y/N)? y</span><br><span class="line">Flash\Flash.ocx - 拒绝访问。</span><br><span class="line">Flash\FlashUtil_ActiveX.dll - 拒绝访问。</span><br><span class="line">Flash\FlashUtil_ActiveX.exe - 拒绝访问。</span><br><span class="line"></span><br><span class="line">C:\Windows\SysWOW64\Macromed&gt;takeown /F Flash /r</span><br><span class="line"></span><br><span class="line">成功: 此文件(或文件夹): &quot;C:\Windows\SysWOW64\Macromed\Flash&quot; 现在由用户 &quot;WWH\wangw&quot; 所有。</span><br><span class="line"></span><br><span class="line">成功: 此文件(或文件夹): &quot;C:\Windows\SysWOW64\Macromed\Flash\Flash.ocx&quot; 现在由用户 &quot;WWH\wangw&quot; 所有。</span><br><span class="line"></span><br><span class="line">成功: 此文件(或文件夹): &quot;C:\Windows\SysWOW64\Macromed\Flash\FlashUtil_ActiveX.dll&quot; 现在由用户 &quot;WWH\wangw&quot; 所有。</span><br><span class="line"></span><br><span class="line">成功: 此文件(或文件夹): &quot;C:\Windows\SysWOW64\Macromed\Flash\FlashUtil_ActiveX.exe&quot; 现在由用户 &quot;WWH\wangw&quot; 所有。</span><br><span class="line"></span><br><span class="line">C:\Windows\SysWOW64\Macromed&gt;cacls Flash /t /e /g &quot;WWH\wangw&quot;:F</span><br><span class="line">处理的目录: C:\Windows\SysWOW64\Macromed\Flash</span><br><span class="line">处理的文件: C:\Windows\SysWOW64\Macromed\Flash\Flash.ocx</span><br><span class="line">处理的文件: C:\Windows\SysWOW64\Macromed\Flash\FlashUtil_ActiveX.dll</span><br><span class="line">处理的文件: C:\Windows\SysWOW64\Macromed\Flash\FlashUtil_ActiveX.exe</span><br><span class="line"></span><br><span class="line">C:\Windows\SysWOW64\Macromed&gt;rd /s Flash</span><br><span class="line">Flash, 是否确认(Y/N)? y</span><br><span class="line"></span><br><span class="line">C:\Windows\SysWOW64\Macromed&gt;</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://wangwen135.github.io/Redis/Redis%E4%B8%BB%E4%BB%8E%E9%85%8D%E7%BD%AE%E4%B8%8E%E6%B5%8B%E8%AF%95/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="王某某">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="王某某的笔记">
      <meta itemprop="description" content="这是一个使用 Hexo 构建的博客，用于分享我的编程经验和学习笔记。">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 王某某的笔记">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/Redis/Redis%E4%B8%BB%E4%BB%8E%E9%85%8D%E7%BD%AE%E4%B8%8E%E6%B5%8B%E8%AF%95/" class="post-title-link" itemprop="url">Redis主从配置与测试</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2019-02-19 23:41:00" itemprop="dateCreated datePublished" datetime="2019-02-19T23:41:00+08:00">2019-02-19</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Redis/" itemprop="url" rel="index"><span itemprop="name">Redis</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>802</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>3 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h2><p>先安装redis</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">make</span><br><span class="line">make PREFIX=/usr/local/redis install</span><br></pre></td></tr></table></figure>

<p>找个地方创建两个文件，如：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mkdir d6379</span><br><span class="line">mkdir d6380</span><br></pre></td></tr></table></figure>
<p>把redis.conf文件复制到这两个目录</p>
<p>进入d6379目录中，配置文件就改了</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">daemonize yes</span><br></pre></td></tr></table></figure>
<p>启动第一个redis</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/usr/local/redis/bin/redis-server redis.conf </span><br></pre></td></tr></table></figure>
<p>进入d6380目录中，配置文件修改为</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">port 6380</span><br><span class="line">daemonize yes</span><br><span class="line"></span><br><span class="line"># slaveof &lt;masterip&gt; &lt;masterport&gt;</span><br><span class="line">slaveof 127.0.0.1 6379</span><br></pre></td></tr></table></figure>
<p>启动从节点</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/usr/local/redis/bin/redis-server redis.conf </span><br></pre></td></tr></table></figure>

<p>查看一下进程情况</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ps -ef | grep redis</span><br><span class="line">root      8428     1  0 17:06 ?        00:00:00 /usr/local/redis/bin/redis-server 127.0.0.1:6379</span><br><span class="line">root      8453     1  0 17:16 ?        00:00:00 /usr/local/redis/bin/redis-server 127.0.0.1:6380</span><br></pre></td></tr></table></figure>

<h2 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h2><p>再开一个shell窗口，分别登入两个redis  </p>
<p>登录主的</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ /usr/local/redis/bin/redis-cli </span><br><span class="line">127.0.0.1:6379&gt; </span><br></pre></td></tr></table></figure>

<p>登录从的</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ /usr/local/redis/bin/redis-cli -p 6380</span><br><span class="line">127.0.0.1:6380&gt; </span><br></pre></td></tr></table></figure>

<p>分别查看他们的状态:<br>主的</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; info Replication</span><br><span class="line">role:master</span><br><span class="line">connected_slaves:1</span><br><span class="line">slave0:ip=127.0.0.1,port=6380,state=online,offset=98,lag=0</span><br></pre></td></tr></table></figure>
<p>从的</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6380&gt; info Replication</span><br><span class="line"># Replication</span><br><span class="line">role:slave</span><br><span class="line">master_host:127.0.0.1</span><br><span class="line">master_port:6379</span><br></pre></td></tr></table></figure>

<p>在主的上设置值</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; set key1 vvv1</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; keys *</span><br><span class="line">1) &quot;key1&quot;</span><br></pre></td></tr></table></figure>
<p>在从的上查看</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6380&gt; keys *</span><br><span class="line">1) &quot;key1&quot;</span><br><span class="line">127.0.0.1:6380&gt; get key1</span><br><span class="line">&quot;vvv1&quot;</span><br></pre></td></tr></table></figure>
<p>可以看到从的已经自动从主的上复制了数据</p>
<p>再试一下在从的上写数据</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6380&gt; set key2 vvv2</span><br><span class="line">(error) READONLY You can&#x27;t write against a read only slave.</span><br></pre></td></tr></table></figure>

<h2 id="主从切换"><a href="#主从切换" class="headerlink" title="主从切换"></a>主从切换</h2><p><strong>SLAVEOF host port</strong><br>SLAVEOF 命令用于在 Redis 运行时动态的修改复制(replication)功能的行为。</p>
<p>通过执行 SLAVEOF host port 命令，可以将当前服务器转变为指定服务器的从属服务器(slave server)。</p>
<p>如果当前服务器已经是某个主服务器(master server)的从属服务器，那么执行 SLAVEOF host port 将使当前服务器停止对旧主服务器的同步，丢弃旧数据集，转而开始对新主服务器进行同步。</p>
<p>另外，对一个从属服务器执行命令 SLAVEOF NO ONE 将使得这个从属服务器关闭复制功能，并从从属服务器转变回主服务器，原来同步所得的数据集不会被丢弃。</p>
<p>利用『 SLAVEOF NO ONE 不会丢弃同步所得数据集』这个特性，可以在主服务器失败的时候，将从属服务器用作新的主服务器，从而实现无间断运行。</p>
<hr>
<p>将从服务器升级为主服务器，并且关闭复制功能</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6380&gt; SLAVEOF NO ONE</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6380&gt; info Replication</span><br><span class="line"># Replication</span><br><span class="line">role:master</span><br><span class="line">connected_slaves:0</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>此时可以写入数据</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6380&gt; set k5 &#x27;upgrade to master&#x27;</span><br><span class="line">OK</span><br></pre></td></tr></table></figure>

<p>将6379转成6380的从服务</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; slaveof 127.0.0.1 6380</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; info Replication</span><br><span class="line"># Replication</span><br><span class="line">role:slave</span><br><span class="line">master_host:127.0.0.1</span><br><span class="line">master_port:6380</span><br><span class="line">master_link_status:up</span><br><span class="line">master_last_io_seconds_ago:5</span><br><span class="line">master_sync_in_progress:0</span><br><span class="line">slave_repl_offset:2844</span><br><span class="line">slave_priority:100</span><br><span class="line">slave_read_only:1</span><br><span class="line">connected_slaves:0</span><br><span class="line">master_replid:9c8b0e2e24636212f659b3f8bc17cbae51785db2</span><br><span class="line">master_replid2:6e0c53cc1c7438c88273db17fa654f285026e1ce</span><br><span class="line">master_repl_offset:2844</span><br><span class="line">second_repl_offset:2777</span><br><span class="line">repl_backlog_active:1</span><br><span class="line">repl_backlog_size:1048576</span><br><span class="line">repl_backlog_first_byte_offset:1</span><br><span class="line">repl_backlog_histlen:2844</span><br></pre></td></tr></table></figure>
<p>变成从的后会删除自己已有的数据，并将主服务器的数据复制过来<br>可以看到之前添加的数据也复制过来了</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; keys *</span><br><span class="line">1) &quot;kk2&quot;</span><br><span class="line">2) &quot;k5&quot;</span><br><span class="line">3) &quot;key1&quot;</span><br><span class="line">127.0.0.1:6379&gt; get k5</span><br><span class="line">&quot;upgrade to master&quot;</span><br></pre></td></tr></table></figure>


<hr>
<p>主节点下的从节点的信息都可以通过info命令查看</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6380&gt; info Replication</span><br><span class="line"># Replication</span><br><span class="line">role:master</span><br><span class="line">connected_slaves:3</span><br><span class="line">slave0:ip=192.168.1.215,port=6379,state=online,offset=4768,lag=1</span><br><span class="line">slave1:ip=192.168.1.215,port=6380,state=online,offset=4768,lag=0</span><br><span class="line">slave2:ip=127.0.0.1,port=6379,state=online,offset=4768,lag=0</span><br><span class="line">master_replid:d3ea04b9553a6c20b2bbe836dd35e2311ee1ed06</span><br><span class="line">master_replid2:d7ded5c06b7d723590dd4aa8bee2b7020f3cbc96</span><br><span class="line">master_repl_offset:4768</span><br><span class="line">second_repl_offset:4617</span><br><span class="line">repl_backlog_active:1</span><br><span class="line">repl_backlog_size:1048576</span><br><span class="line">repl_backlog_first_byte_offset:4533</span><br><span class="line">repl_backlog_histlen:236</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://wangwen135.github.io/java/%E6%A0%88%E6%BA%A2%E5%87%BA%20StackOverflowError/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="王某某">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="王某某的笔记">
      <meta itemprop="description" content="这是一个使用 Hexo 构建的博客，用于分享我的编程经验和学习笔记。">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 王某某的笔记">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/java/%E6%A0%88%E6%BA%A2%E5%87%BA%20StackOverflowError/" class="post-title-link" itemprop="url">栈溢出 StackOverflowError</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2019-02-10 09:28:00" itemprop="dateCreated datePublished" datetime="2019-02-10T09:28:00+08:00">2019-02-10</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Java/" itemprop="url" rel="index"><span itemprop="name">Java</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>705</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>3 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h3 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h3><p>生产环境栈溢出</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">3282788         at com.chedaia.task.address.util.ParkingPointUtil.getPreviewGpsPoint(ParkingPointUtil.java:410)</span><br><span class="line">3282789         at com.chedaia.task.address.util.ParkingPointUtil.getPreviewGpsPoint(ParkingPointUtil.java:410)</span><br><span class="line">3282790 Exception in thread &quot;pool-250-thread-43&quot; java.lang.StackOverflowError</span><br><span class="line">3282791         at java.util.AbstractCollection.toArray(AbstractCollection.java:183)</span><br><span class="line">3282792         at java.lang.String.split(String.java:2378)</span><br><span class="line">3282793         at com.chedaia.task.address.util.ParkingPointUtil.isGps(ParkingPointUtil.java:32)</span><br><span class="line">3282794         at com.chedaia.task.address.util.ParkingPointUtil.getPreviewGpsPoint(ParkingPointUtil.java:406)</span><br><span class="line">3282795         at com.chedaia.task.address.util.ParkingPointUtil.getPreviewGpsPoint(ParkingPointUtil.java:410)</span><br><span class="line">3282796         at com.chedaia.task.address.util.ParkingPointUtil.getPreviewGpsPoint(ParkingPointUtil.java:410)</span><br><span class="line">3282797         at com.chedaia.task.address.util.ParkingPointUtil.getPreviewGpsPoint(ParkingPointUtil.java:410)</span><br><span class="line">3282798         at com.chedaia.task.address.util.ParkingPointUtil.getPreviewGpsPoint(ParkingPointUtil.java:410)</span><br><span class="line">3282799         at com.chedaia.task.address.util.ParkingPointUtil.getPreviewGpsPoint(ParkingPointUtil.java:410)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="原因"><a href="#原因" class="headerlink" title="原因"></a>原因</h3><p>递归调用次数太多导致<br>且启动脚本中设置了-Xss</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-XX:PermSize=128m -Xss256k </span><br></pre></td></tr></table></figure>

<h3 id="解决办法"><a href="#解决办法" class="headerlink" title="解决办法"></a>解决办法</h3><h2 id="由于涉及到的代码依赖较多，先不改动代码加大线程栈大小到2m"><a href="#由于涉及到的代码依赖较多，先不改动代码加大线程栈大小到2m" class="headerlink" title="由于涉及到的代码依赖较多，先不改动代码加大线程栈大小到2m"></a>由于涉及到的代码依赖较多，先不改动代码<br>加大线程栈大小到2m<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-XX:PermSize=128m -Xss2m </span><br></pre></td></tr></table></figure></h2><hr>
<h2 id="线程栈大小与递归次数测试"><a href="#线程栈大小与递归次数测试" class="headerlink" title="线程栈大小与递归次数测试"></a>线程栈大小与递归次数测试</h2><h3 id="代码"><a href="#代码" class="headerlink" title="代码"></a>代码</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">public static void main(String[] args) &#123;</span><br><span class="line">    recursion(0);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">public static void recursion(int i) &#123;</span><br><span class="line">    System.out.println(i);</span><br><span class="line">    i++;</span><br><span class="line">    recursion(i);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="执行结果"><a href="#执行结果" class="headerlink" title="执行结果"></a>执行结果</h4><p>结果：966</p>
<blockquote>
<p>此时的栈设置为： -Xss128k</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">963</span><br><span class="line">964</span><br><span class="line">965</span><br><span class="line">966</span><br><span class="line">Exception in thread &quot;main&quot; java.lang.StackOverflowError</span><br><span class="line">	at sun.nio.cs.UTF_8.updatePositions(UTF_8.java:77)</span><br><span class="line">	at sun.nio.cs.UTF_8.access$200(UTF_8.java:57)</span><br><span class="line">	at sun.nio.cs.UTF_8$Encoder.encodeArrayLoop(UTF_8.java:636)</span><br><span class="line">	at sun.nio.cs.UTF_8$Encoder.encodeLoop(UTF_8.java:691)</span><br><span class="line">	at java.nio.charset.CharsetEncoder.encode(CharsetEncoder.java</span><br></pre></td></tr></table></figure>

<h3 id="不同栈大小下的递归次数"><a href="#不同栈大小下的递归次数" class="headerlink" title="不同栈大小下的递归次数"></a>不同栈大小下的递归次数</h3><table>
<thead>
<tr>
<th>线程栈大小</th>
<th>递归次数约为</th>
</tr>
</thead>
<tbody><tr>
<td>-Xss128k</td>
<td>966</td>
</tr>
<tr>
<td>-Xss256k</td>
<td>2467</td>
</tr>
<tr>
<td>-Xss512k</td>
<td>5447</td>
</tr>
<tr>
<td>-Xss1m</td>
<td>11404</td>
</tr>
<tr>
<td>-Xss2m</td>
<td>23323</td>
</tr>
<tr>
<td>-Xss3m</td>
<td>35247</td>
</tr>
<tr>
<td>-Xss4m</td>
<td>41306</td>
</tr>
</tbody></table>
<h3 id="方法中的局部变量会占用栈空间"><a href="#方法中的局部变量会占用栈空间" class="headerlink" title="方法中的局部变量会占用栈空间"></a>方法中的局部变量会占用栈空间</h3><p>当递归的方法中定义了一些局部变量时会占用线程栈的空间，从而影响到递归的次数<br>如将上面的方法稍微修改一下，增加3个局部变量：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">public static void recursion(int i) &#123;</span><br><span class="line">    System.out.println(i);</span><br><span class="line">    long a = 1l;</span><br><span class="line">    long b = 2l;</span><br><span class="line">    long c = a + b;</span><br><span class="line">    i++;</span><br><span class="line">    recursion(i);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在栈大小设置为： -Xss128k 时，结果是：623</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">620</span><br><span class="line">621</span><br><span class="line">622</span><br><span class="line">623</span><br><span class="line">java.lang.StackOverflowError</span><br><span class="line">	at sun.nio.cs.UTF_8.updatePositions(UTF_8.java:77)</span><br><span class="line">	at sun.nio.cs.UTF_8.access$200(UTF_8.java:57)</span><br><span class="line">	at sun.nio.cs.UTF_8$Encoder.encodeArrayLoop(UTF_8.java:636)</span><br><span class="line">	at sun.nio.cs.UTF_8$Encoder.encodeLoop(UTF_8.java:691)</span><br></pre></td></tr></table></figure>


<hr>
<h3 id="官方说明"><a href="#官方说明" class="headerlink" title="官方说明"></a>官方说明</h3><p><a target="_blank" rel="noopener" href="https://www.oracle.com/technetwork/java/hotspotfaq-138619.html#threads_oom">https://www.oracle.com/technetwork/java/hotspotfaq-138619.html#threads_oom</a></p>
<p>您可能遇到线程的默认堆栈大小的问题。在Java SE 6中，Sparc的默认值是32位VM中的512k, 64位VM中的1024k。</p>
<p>在x86 Solaris&#x2F;Linux上，32位虚拟机中是320k, 64位虚拟机中是1024k。</p>
<p>在Windows上，默认的线程堆栈大小是从二进制文件(java.exe)读取的。在Java SE 6中，这个值在32位VM中是320k，在64位VM中是1024k。</p>
<p>您可以通过使用-Xss选项运行来减小堆栈大小。例如:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -server -Xss64k</span><br></pre></td></tr></table></figure>
<p>注意，在某些版本的Windows上，操作系统可能使用非常粗的粒度来计算线程堆栈大小。如果请求的大小小于默认大小1K或更大，则将堆栈大小四舍五入到默认大小;否则，堆栈大小将四舍五入为1 MB的倍数。</p>
<p>64k是每个线程允许的最小堆栈空间量。</p>
<blockquote>
<p>不显式设置-Xss或-XX:ThreadStackSize时，或者把-Xss或者-XX:ThreadStackSize设为0，就是使用“系统默认值”。</p>
</blockquote>
<h3 id="用命令查看"><a href="#用命令查看" class="headerlink" title="用命令查看"></a>用命令查看</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"># java -XX:+PrintFlagsFinal -version | grep ThreadStackSize</span><br><span class="line">     intx CompilerThreadStackSize                   = 0                                   &#123;pd product&#125;</span><br><span class="line">     intx ThreadStackSize                           = 1024                                &#123;pd product&#125;</span><br><span class="line">     intx VMThreadStackSize                         = 1024                                &#123;pd product&#125;</span><br><span class="line">java version &quot;1.8.0_162&quot;</span><br><span class="line">Java(TM) SE Runtime Environment (build 1.8.0_162-b12)</span><br><span class="line">Java HotSpot(TM) 64-Bit Server VM (build 25.162-b12, mixed mode)</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://wangwen135.github.io/MySQL/mysql%20%E4%B8%BB%E4%BB%8E%E5%90%8C%E6%AD%A5%E6%B5%8B%E8%AF%95/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="王某某">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="王某某的笔记">
      <meta itemprop="description" content="这是一个使用 Hexo 构建的博客，用于分享我的编程经验和学习笔记。">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 王某某的笔记">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/MySQL/mysql%20%E4%B8%BB%E4%BB%8E%E5%90%8C%E6%AD%A5%E6%B5%8B%E8%AF%95/" class="post-title-link" itemprop="url">mysql 主从同步测试</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2018-10-10 23:41:00" itemprop="dateCreated datePublished" datetime="2018-10-10T23:41:00+08:00">2018-10-10</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/MySQL/" itemprop="url" rel="index"><span itemprop="name">MySQL</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>697</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>3 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>测试环境</p>
<ul>
<li>系统：WIN 10</li>
<li>MySQL版本：mysql-5.7.23</li>
</ul>
<h3 id="安装配置"><a href="#安装配置" class="headerlink" title="安装配置"></a>安装配置</h3><h4 id="解压文件"><a href="#解压文件" class="headerlink" title="解压文件"></a>解压文件</h4><p>使用mysql-5.7.23-winx64.zip包解压缩安装<br>路径分别为：</p>
<ul>
<li>D:\mysql\mysql-5.7.23-winx64</li>
<li>D:\mysql\mysql-5.7.23-winx64-3307</li>
</ul>
<blockquote>
<p>解压安装路径随意指定，注意需要与my.ini文件中的路径一致</p>
</blockquote>
<h4 id="my-ini配置文件"><a href="#my-ini配置文件" class="headerlink" title="my.ini配置文件"></a>my.ini配置文件</h4><p>分别在两个目录中创建my.ini 文件</p>
<blockquote>
<p>在同一台机器上测试，mysql实例使用不同端口<br>主数据库：3306 (默认)<br>从数据库：3307</p>
</blockquote>
<p>内容如下：</p>
<h5 id="主库my-ini"><a href="#主库my-ini" class="headerlink" title="主库my.ini"></a>主库my.ini</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">[mysqld]</span><br><span class="line"># set basedir to your installation path</span><br><span class="line">basedir=D:/mysql/mysql-5.7.23-winx64</span><br><span class="line"># set datadir to the location of your data directory</span><br><span class="line">datadir=D:/mysql/mysql-5.7.23-winx64/data</span><br><span class="line"></span><br><span class="line"># 唯一标识</span><br><span class="line">server-id=1</span><br><span class="line"></span><br><span class="line"># binlog文件名</span><br><span class="line">log-bin=mysql-binlog</span><br><span class="line"></span><br><span class="line"># 要写binlog的数据库，要同步多个数据库，就多加几个binlog-do-db=数据库名</span><br><span class="line">binlog-do-db=mstest</span><br><span class="line">binlog-do-db=test</span><br><span class="line"></span><br><span class="line"># 要忽略的数据库</span><br><span class="line">binlog-ignore-db=mysql</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h5 id="从库my-ini"><a href="#从库my-ini" class="headerlink" title="从库my.ini"></a>从库my.ini</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">[mysqld]</span><br><span class="line"># 指定端口</span><br><span class="line">port=3307</span><br><span class="line"># set basedir to your installation path</span><br><span class="line">basedir=D:/mysql/mysql-5.7.23-winx64-3307</span><br><span class="line"># set datadir to the location of your data directory</span><br><span class="line">datadir=D:/mysql/mysql-5.7.23-winx64-3307/data</span><br><span class="line"></span><br><span class="line"># 唯一标识</span><br><span class="line">server-id=2</span><br><span class="line"></span><br><span class="line"># 要复制多个数据库，就多加几个replicate-do-db=数据库名</span><br><span class="line">replicate-do-db=mstest</span><br><span class="line">replicate-do-db=test</span><br><span class="line"></span><br><span class="line"># 要忽略的数据库</span><br><span class="line">replicate-ignore-db=mysql</span><br></pre></td></tr></table></figure>

<h4 id="初始化并启动数据库"><a href="#初始化并启动数据库" class="headerlink" title="初始化并启动数据库"></a>初始化并启动数据库</h4><p>分别初始化、启动两个数据库，并修改root密码  </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">mysqld --initialize --console</span><br><span class="line"></span><br><span class="line">mysqld.exe --console</span><br><span class="line"></span><br><span class="line">ALTER USER &#x27;root&#x27;@&#x27;localhost&#x27; IDENTIFIED BY &#x27;root&#x27;;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>具体见安装文档</p>
</blockquote>
<h4 id="数据库配置"><a href="#数据库配置" class="headerlink" title="数据库配置"></a>数据库配置</h4><h5 id="主库配置"><a href="#主库配置" class="headerlink" title="主库配置"></a>主库配置</h5><p>登录主库</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt;mysql -uroot -p</span><br></pre></td></tr></table></figure>

<p>主数据库创建用于同步的用户</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GRANT REPLICATION SLAVE ON *.* TO &#x27;mstest&#x27;@&#x27;%&#x27; IDENTIFIED BY &#x27;123456&#x27;;</span><br></pre></td></tr></table></figure>

<h5 id="从数据库配置"><a href="#从数据库配置" class="headerlink" title="从数据库配置"></a>从数据库配置</h5><p>登录从库，指定端口3307</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt;mysql -uroot -p -P3307</span><br></pre></td></tr></table></figure>

<p>配置从库连接到主库</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">change master to master_host=&#x27;127.0.0.1&#x27;,master_port=3306,</span><br><span class="line">master_user=&#x27;mstest&#x27;,master_password=&#x27;123456&#x27;;</span><br><span class="line"></span><br><span class="line">start slave;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="查看状态"><a href="#查看状态" class="headerlink" title="查看状态"></a>查看状态</h4><h5 id="主库"><a href="#主库" class="headerlink" title="主库"></a>主库</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; show master status;</span><br><span class="line">+---------------------+----------+--------------+------------------+-------------------+</span><br><span class="line">| File                | Position | Binlog_Do_DB | Binlog_Ignore_DB | Executed_Gtid_Set |</span><br><span class="line">+---------------------+----------+--------------+------------------+-------------------+</span><br><span class="line">| mysql-binlog.000002 |      313 | mstest,test  | mysql            |                   |</span><br><span class="line">+---------------------+----------+--------------+------------------+-------------------+</span><br><span class="line">1 row in set (0.00 sec)</span><br></pre></td></tr></table></figure>


<h5 id="从库"><a href="#从库" class="headerlink" title="从库"></a>从库</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">mysql&gt; show slave status\G</span><br><span class="line">*************************** 1. row ***************************</span><br><span class="line">               Slave_IO_State: Waiting for master to send event</span><br><span class="line">                  Master_Host: 127.0.0.1</span><br><span class="line">                  Master_User: mstest</span><br><span class="line">                  Master_Port: 3306</span><br><span class="line">                Connect_Retry: 60</span><br><span class="line">              Master_Log_File: mysql-binlog.000002</span><br><span class="line">          Read_Master_Log_Pos: 1306</span><br><span class="line">               Relay_Log_File: wwh-relay-bin.000005</span><br><span class="line">                Relay_Log_Pos: 323</span><br><span class="line">        Relay_Master_Log_File: mysql-binlog.000002</span><br><span class="line">             Slave_IO_Running: Yes</span><br><span class="line">            Slave_SQL_Running: Yes</span><br><span class="line">              Replicate_Do_DB: mstest,test</span><br><span class="line">          Replicate_Ignore_DB: mysql</span><br><span class="line"> ......</span><br><span class="line"> ......</span><br><span class="line"> ......</span><br><span class="line">             Master_Server_Id: 1</span><br><span class="line">                  Master_UUID: ea65d565-a8a0-11e8-807e-0a002700000a</span><br><span class="line">             Master_Info_File: D:\mysql\mysql-5.7.23-winx64-3307\data\master.info</span><br><span class="line">                    SQL_Delay: 0</span><br><span class="line">          SQL_Remaining_Delay: NULL</span><br><span class="line">      Slave_SQL_Running_State: Slave has read all relay log; waiting for more updates</span><br><span class="line">           Master_Retry_Count: 86400</span><br><span class="line">......</span><br><span class="line">......</span><br><span class="line">1 row in set (0.00 sec)</span><br></pre></td></tr></table></figure>


<h3 id="同步测试"><a href="#同步测试" class="headerlink" title="同步测试"></a>同步测试</h3><h4 id="创建数据库"><a href="#创建数据库" class="headerlink" title="创建数据库"></a>创建数据库</h4><h4 id="主库创建表，从库查看"><a href="#主库创建表，从库查看" class="headerlink" title="主库创建表，从库查看"></a>主库创建表，从库查看</h4><h4 id="主库插入记录，从库查看"><a href="#主库插入记录，从库查看" class="headerlink" title="主库插入记录，从库查看"></a>主库插入记录，从库查看</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; create database test;</span><br><span class="line">Query OK, 1 row affected (0.01 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; show databases;</span><br><span class="line">+--------------------+</span><br><span class="line">| Database           |</span><br><span class="line">+--------------------+</span><br><span class="line">| information_schema |</span><br><span class="line">| mysql              |</span><br><span class="line">| performance_schema |</span><br><span class="line">| sys                |</span><br><span class="line">| test               |</span><br><span class="line">| wwh                |</span><br><span class="line">+--------------------+</span><br><span class="line">6 rows in set (0.00 sec)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">mysql&gt; status;</span><br><span class="line">--------------</span><br><span class="line">mysql  Ver 14.14 Distrib 5.7.23, for Win64 (x86_64)</span><br><span class="line"></span><br><span class="line">Connection id:          2</span><br><span class="line">Current database:</span><br><span class="line">Current user:           root@localhost</span><br><span class="line">SSL:                    Not in use</span><br><span class="line">Using delimiter:        ;</span><br><span class="line">Server version:         5.7.23 MySQL Community Server (GPL)</span><br><span class="line">Protocol version:       10</span><br><span class="line">Connection:             localhost via TCP/IP</span><br><span class="line">Server characterset:    latin1</span><br><span class="line">Db     characterset:    latin1</span><br><span class="line">Client characterset:    gbk</span><br><span class="line">Conn.  characterset:    gbk</span><br><span class="line">TCP port:               3307</span><br><span class="line">Uptime:                 7 min 37 sec</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">show binlog events\G</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">show master status\G</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="查询命令"><a href="#查询命令" class="headerlink" title="查询命令"></a>查询命令</h2><h3 id="在master上查看当前有多少个从节点"><a href="#在master上查看当前有多少个从节点" class="headerlink" title="在master上查看当前有多少个从节点"></a>在master上查看当前有多少个从节点</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">select * from information_schema.processlist as p where p.command = &#x27;Binlog Dump&#x27;; </span><br><span class="line"></span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://wangwen135.github.io/%E8%84%9A%E6%9C%AC/bat/%E4%B8%80%E4%BA%9B%E5%AE%9E%E7%94%A8%E7%9A%84bat%E8%84%9A%E6%9C%AC/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="王某某">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="王某某的笔记">
      <meta itemprop="description" content="这是一个使用 Hexo 构建的博客，用于分享我的编程经验和学习笔记。">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 王某某的笔记">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/%E8%84%9A%E6%9C%AC/bat/%E4%B8%80%E4%BA%9B%E5%AE%9E%E7%94%A8%E7%9A%84bat%E8%84%9A%E6%9C%AC/" class="post-title-link" itemprop="url">一些实用的bat脚本</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2018-09-27 09:31:00" itemprop="dateCreated datePublished" datetime="2018-09-27T09:31:00+08:00">2018-09-27</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%84%9A%E6%9C%AC/" itemprop="url" rel="index"><span itemprop="name">脚本</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%84%9A%E6%9C%AC/bat/" itemprop="url" rel="index"><span itemprop="name">bat</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>289</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>1 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>在windows 和 linux的命令行来回切换，经常敲错命令，如：ls、pwd、grep 等</p>
<p>通过写bat的办法让windows支持这几个常用命令</p>
<p>找一个目录，将其添加到环境变量中，在目录中新建几个bat文件，如下：</p>
<h3 id="ll-bat"><a href="#ll-bat" class="headerlink" title="ll.bat"></a>ll.bat</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">@echo off</span><br><span class="line">REM 显示一个目录中的文件和子目录</span><br><span class="line">dir</span><br></pre></td></tr></table></figure>

<h3 id="pwd-bat"><a href="#pwd-bat" class="headerlink" title="pwd.bat"></a>pwd.bat</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">@echo off</span><br><span class="line">REM 显示当前目录的名称或将其更改。</span><br><span class="line">chdir</span><br></pre></td></tr></table></figure>

<h3 id="ls-bat"><a href="#ls-bat" class="headerlink" title="ls.bat"></a>ls.bat</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">@echo off</span><br><span class="line">REM 显示一个目录中的文件和子目录 /W 用宽列表格式</span><br><span class="line"></span><br><span class="line">dir /W</span><br></pre></td></tr></table></figure>

<h3 id="grep-bat"><a href="#grep-bat" class="headerlink" title="grep.bat"></a>grep.bat</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">@echo off</span><br><span class="line">REM 模拟grep</span><br><span class="line">REM 在文件中搜索字符串。</span><br><span class="line">REM FIND [/V] [/C] [/N] [/I] [/OFF[LINE]] &quot;string&quot; [[drive:][path]filename[ ...]]</span><br><span class="line">REM /I  搜索字符串时忽略大小写。</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">find /I &quot;%1&quot;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="clear-bat"><a href="#clear-bat" class="headerlink" title="clear.bat"></a>clear.bat</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">@echo off</span><br><span class="line">REM 清除屏幕</span><br><span class="line"></span><br><span class="line">cls</span><br></pre></td></tr></table></figure>

<h3 id="checksum-bat"><a href="#checksum-bat" class="headerlink" title="checksum.bat"></a>checksum.bat</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">@echo OFF</span><br><span class="line">:LOOP</span><br><span class="line">    set index=%1</span><br><span class="line">    if %index%! == ! goto END</span><br><span class="line">    echo.</span><br><span class="line">    echo File   : %index%</span><br><span class="line">    echo.</span><br><span class="line">    set /p=&quot;MD5    : &quot;&lt;nul</span><br><span class="line">    certutil -hashfile &quot;%index%&quot; MD5|findstr /V &quot;MD5&quot;|findstr /V &quot;CertUtil&quot;</span><br><span class="line">    set /p=&quot;SHA1   : &quot;&lt;nul</span><br><span class="line">    certutil -hashfile &quot;%index%&quot; SHA1|findstr /V &quot;SHA1&quot;|findstr /V &quot;CertUtil&quot;</span><br><span class="line">    set /p=&quot;SHA256 : &quot;&lt;nul</span><br><span class="line">    certutil -hashfile &quot;%index%&quot; SHA256|findstr /V &quot;SHA256&quot;|findstr /V &quot;CertUtil&quot;</span><br><span class="line">    shift</span><br><span class="line">    goto LOOP</span><br><span class="line">:END</span><br><span class="line">echo.</span><br></pre></td></tr></table></figure>

<h3 id="exp-bat"><a href="#exp-bat" class="headerlink" title="exp.bat"></a>exp.bat</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">@echo off</span><br><span class="line">REM 资源管理器打开当前目录</span><br><span class="line"></span><br><span class="line">explorer /select=%cd%</span><br></pre></td></tr></table></figure>

<h3 id="sp-bat"><a href="#sp-bat" class="headerlink" title="sp.bat"></a>sp.bat</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">@echo off</span><br><span class="line">REM 打开windows截图工具</span><br><span class="line"></span><br><span class="line">start snippingtool</span><br></pre></td></tr></table></figure>
<blockquote>
<p>win10快捷键 win + shift + s</p>
</blockquote>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




  <nav class="pagination">
    <a class="extend prev" rel="prev" title="上一页" aria-label="上一页" href="/page/8/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/8/">8</a><span class="page-number current">9</span><a class="page-number" href="/page/10/">10</a><span class="space">&hellip;</span><a class="page-number" href="/page/17/">17</a><a class="extend next" rel="next" title="下一页" aria-label="下一页" href="/page/10/"><i class="fa fa-angle-right"></i></a>
  </nav>

</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 
    <span itemprop="copyrightYear">2024</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">王某某</span>
  </div>
<div class="wordcount">
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-line"></i>
    </span>
    <span title="站点总字数">150k</span>
  </span>
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="站点阅读时长">9:05</span>
  </span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/pisces/" rel="noopener" target="_blank">NexT.Pisces</a> 强力驱动
  </div>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>
  <div class="reading-progress-bar"></div>
  <a role="button" class="book-mark-link book-mark-link-fixed"></a>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/sidebar.js"></script><script src="/js/next-boot.js"></script><script src="/js/bookmark.js"></script>

  






  





</body>
</html>
