<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 7.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" integrity="sha256-XOqroi11tY4EFQMR9ZYwZWKj5ZXiftSx36RRuC3anlA=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"wangwen135.github.io","root":"/","images":"/images","scheme":"Pisces","darkmode":false,"version":"8.20.0","exturl":false,"sidebar":{"position":"left","width_expanded":320,"width_dual_column":240,"display":"post","padding":18,"offset":12},"copycode":{"enable":false,"style":null},"fold":{"enable":false,"height":500},"bookmark":{"enable":true,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"}}</script><script src="/js/config.js"></script>

    <meta name="description" content="这是一个使用 Hexo 构建的博客，用于分享我的编程经验和学习笔记。">
<meta property="og:type" content="website">
<meta property="og:title" content="王某某的笔记">
<meta property="og:url" content="https://wangwen135.github.io/page/5/index.html">
<meta property="og:site_name" content="王某某的笔记">
<meta property="og:description" content="这是一个使用 Hexo 构建的博客，用于分享我的编程经验和学习笔记。">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="王某某">
<meta property="article:tag" content="java">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="https://wangwen135.github.io/page/5/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":true,"isPost":false,"lang":"zh-CN","comments":"","permalink":"","path":"page/5/index.html","title":""}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>王某某的笔记</title>
  








  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">王某某的笔记</h1>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">记录我的编程之路</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="搜索" role="button">
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a></li>
  </ul>
</nav>




</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="王某某"
      src="/images/avatar.jpg">
  <p class="site-author-name" itemprop="name">王某某</p>
  <div class="site-description" itemprop="description">这是一个使用 Hexo 构建的博客，用于分享我的编程经验和学习笔记。</div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">158</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">51</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">121</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author animated">
      <span class="links-of-author-item">
        <a href="https://github.com/wangwen135" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;wangwen135" rel="noopener me" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://www.jianshu.com/u/66c41e72644b" title="简  书 → https:&#x2F;&#x2F;www.jianshu.com&#x2F;u&#x2F;66c41e72644b" rel="noopener me" target="_blank"><i class="fa fa-link fa-fw"></i>简  书</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:wangwen135@gmail.com" title="E-Mail → mailto:wangwen135@gmail.com" rel="noopener me" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://twitter.com/wangwen135" title="Twitter → https:&#x2F;&#x2F;twitter.com&#x2F;wangwen135" rel="noopener me" target="_blank"><i class="fab fa-twitter fa-fw"></i>Twitter</a>
      </span>
  </div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner index posts-expand">

    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://wangwen135.github.io/%E7%A1%AC%E4%BB%B6%E4%B8%8E%E7%89%A9%E8%81%94%E7%BD%91/%E9%BB%91%E7%BE%A4%E6%99%96/%E7%BE%A4%E6%99%96Photo%20station/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="王某某">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="王某某的笔记">
      <meta itemprop="description" content="这是一个使用 Hexo 构建的博客，用于分享我的编程经验和学习笔记。">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 王某某的笔记">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/%E7%A1%AC%E4%BB%B6%E4%B8%8E%E7%89%A9%E8%81%94%E7%BD%91/%E9%BB%91%E7%BE%A4%E6%99%96/%E7%BE%A4%E6%99%96Photo%20station/" class="post-title-link" itemprop="url">群晖Photo station</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-09-25 00:00:00" itemprop="dateCreated datePublished" datetime="2021-09-25T00:00:00+08:00">2021-09-25</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E7%A1%AC%E4%BB%B6%E4%B8%8E%E7%89%A9%E8%81%94%E7%BD%91/" itemprop="url" rel="index"><span itemprop="name">硬件与物联网</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E7%A1%AC%E4%BB%B6%E4%B8%8E%E7%89%A9%E8%81%94%E7%BD%91/%E9%BB%91%E7%BE%A4%E6%99%96/" itemprop="url" rel="index"><span itemprop="name">黑群晖</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>348</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>1 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <blockquote>
<p>已有公网IP<br>已配置DDNS，IP地址绑定了域名 （阿里云域名）<br>已经设置了ssl证书  （阿里云免费）  </p>
</blockquote>
<h3 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h3><p>用admin账号登录，安装Photo station套件即可</p>
<h3 id="外网无法访问问题"><a href="#外网无法访问问题" class="headerlink" title="外网无法访问问题"></a>外网无法访问问题</h3><p>在外网环境，通过DSM直接跳转到Photo station套件网页版时无法访问，<strong>Photo station使用80 或443 端口</strong>，需要在路由器上做端口映射。  </p>
<p>由于运营商封闭了这两个端口，需要改成别的端口</p>
<h4 id="在路由器上设置端口映射"><a href="#在路由器上设置端口映射" class="headerlink" title="在路由器上设置端口映射"></a>在路由器上设置端口映射</h4><ul>
<li>8066 端口 映射到群晖的 80端口 （示例，http不安全）</li>
<li>44366 端口 映射到群晖的 443端口</li>
</ul>
<p>外网只支持HTTPS方式，这里我们映射443端口即可</p>
<h4 id="在Photo-station-中进行设置"><a href="#在Photo-station-中进行设置" class="headerlink" title="在Photo station 中进行设置"></a>在Photo station 中进行设置</h4><p>设置 &gt; 常规 &gt; 路由器端口</p>
<ul>
<li>主机名称或固定IP：这里输入你的域名，如：xxx123.top</li>
<li>HTTPS: 44366 (上面映射的外网端口)</li>
</ul>
<p>点击保存</p>
<blockquote>
<p>外网只允许https访问，只要映射https端口即可</p>
</blockquote>
<h4 id="效果"><a href="#效果" class="headerlink" title="效果"></a>效果</h4><p>外网通过 <strong>https:&#x2F;&#x2F;域名:端口</strong> 的方式登录DSM，点击Photo station时会自动跳转到 44366端口</p>
<p>如果内网是通过ip地址访问DSM，跳转时则是走的80 或 443 端口</p>
<hr>
<h3 id="Photo-station权限"><a href="#Photo-station权限" class="headerlink" title="Photo station权限"></a>Photo station权限</h3><p>默认创建 “photo” 共享文件夹 无法在控制面板中设置权限</p>
<p>需要进入photo station 进行权限设置</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://wangwen135.github.io/%E7%A1%AC%E4%BB%B6%E4%B8%8E%E7%89%A9%E8%81%94%E7%BD%91/%E9%BB%91%E7%BE%A4%E6%99%96/%E7%BE%A4%E6%99%96DS918%E6%94%AF%E6%8C%81%E5%A4%9A%E7%BD%91%E5%8D%A1/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="王某某">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="王某某的笔记">
      <meta itemprop="description" content="这是一个使用 Hexo 构建的博客，用于分享我的编程经验和学习笔记。">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 王某某的笔记">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/%E7%A1%AC%E4%BB%B6%E4%B8%8E%E7%89%A9%E8%81%94%E7%BD%91/%E9%BB%91%E7%BE%A4%E6%99%96/%E7%BE%A4%E6%99%96DS918%E6%94%AF%E6%8C%81%E5%A4%9A%E7%BD%91%E5%8D%A1/" class="post-title-link" itemprop="url">群晖DS918支持多网卡</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-09-24 00:00:00" itemprop="dateCreated datePublished" datetime="2021-09-24T00:00:00+08:00">2021-09-24</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E7%A1%AC%E4%BB%B6%E4%B8%8E%E7%89%A9%E8%81%94%E7%BD%91/" itemprop="url" rel="index"><span itemprop="name">硬件与物联网</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E7%A1%AC%E4%BB%B6%E4%B8%8E%E7%89%A9%E8%81%94%E7%BD%91/%E9%BB%91%E7%BE%A4%E6%99%96/" itemprop="url" rel="index"><span itemprop="name">黑群晖</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>96</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>1 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>黑群晖DS918 默认只支持2个网卡，为了验证一些问题，需要让其支持更多的网卡</p>
<h3 id="修改说明"><a href="#修改说明" class="headerlink" title="修改说明"></a>修改说明</h3><p>1、 SSH 登录群晖，切换的root用户</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo -i</span><br></pre></td></tr></table></figure>
<p>输入密码</p>
<p>2、修改synoinfo.conf配置文件</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"># vi /etc.defaults/synoinfo.conf </span><br><span class="line"></span><br><span class="line"># 找到</span><br><span class="line"># maxlanport=&quot;2&quot;  # 这个2就表示支持2个网卡，我们这里改成4</span><br><span class="line"></span><br><span class="line"># 保存退出并重启</span><br><span class="line">reboot</span><br></pre></td></tr></table></figure>



      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://wangwen135.github.io/%E7%A1%AC%E4%BB%B6%E4%B8%8E%E7%89%A9%E8%81%94%E7%BD%91/%E9%BB%91%E7%BE%A4%E6%99%96/%E7%BE%A4%E6%99%96%E4%BD%BF%E7%94%A8iperf3%E6%B5%8B%E8%AF%95%E7%BD%91%E9%80%9F/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="王某某">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="王某某的笔记">
      <meta itemprop="description" content="这是一个使用 Hexo 构建的博客，用于分享我的编程经验和学习笔记。">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 王某某的笔记">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/%E7%A1%AC%E4%BB%B6%E4%B8%8E%E7%89%A9%E8%81%94%E7%BD%91/%E9%BB%91%E7%BE%A4%E6%99%96/%E7%BE%A4%E6%99%96%E4%BD%BF%E7%94%A8iperf3%E6%B5%8B%E8%AF%95%E7%BD%91%E9%80%9F/" class="post-title-link" itemprop="url">群晖使用iperf3测试网速</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-09-24 00:00:00" itemprop="dateCreated datePublished" datetime="2021-09-24T00:00:00+08:00">2021-09-24</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E7%A1%AC%E4%BB%B6%E4%B8%8E%E7%89%A9%E8%81%94%E7%BD%91/" itemprop="url" rel="index"><span itemprop="name">硬件与物联网</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E7%A1%AC%E4%BB%B6%E4%B8%8E%E7%89%A9%E8%81%94%E7%BD%91/%E9%BB%91%E7%BE%A4%E6%99%96/" itemprop="url" rel="index"><span itemprop="name">黑群晖</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>177</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>1 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>黑群晖安装后复制文件速度没有达到预期值</p>
<blockquote>
<p>千兆网卡：113MB&#x2F;s<br>2.5G网卡：280MB&#x2F;s</p>
</blockquote>
<h3 id="一、服务端配置"><a href="#一、服务端配置" class="headerlink" title="一、服务端配置"></a>一、服务端配置</h3><p>群晖下安装Docker套件</p>
<p>在docker中安装iperf3</p>
<blockquote>
<p>注册表中搜索，安装星星最多的就行了</p>
</blockquote>
<p>镜像下载好了之后点启动</p>
<p>然后选择高级设置：</p>
<ul>
<li>端口设置：将本地端口配置为5201</li>
<li>环境 -&gt; 执行命令，填写命令-s（设置为服务端）</li>
</ul>
<h3 id="二、客户端配置"><a href="#二、客户端配置" class="headerlink" title="二、客户端配置"></a>二、客户端配置</h3><p>在iperf3官网下载宽带测速软件</p>
<p><a target="_blank" rel="noopener" href="https://iperf.fr/iperf-download.php">https://iperf.fr/iperf-download.php</a></p>
<p>在命令行中：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">.\iperf3.exe -c 192.168.1.66</span><br><span class="line"></span><br><span class="line">.\iperf3.exe -c 192.168.1.66 -t 300</span><br><span class="line"></span><br><span class="line">.\iperf3.exe -c 192.168.1.66 -R -t 300</span><br><span class="line"></span><br><span class="line"># -R 以反向模式运行(服务器发送，客户端接收)  </span><br></pre></td></tr></table></figure>




      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://wangwen135.github.io/Netty/Netty-4-0-30-%E8%BF%9E%E6%8E%A5%E6%B1%A0bug%E5%88%86%E6%9E%90%E8%AE%B0%E5%BD%95/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="王某某">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="王某某的笔记">
      <meta itemprop="description" content="这是一个使用 Hexo 构建的博客，用于分享我的编程经验和学习笔记。">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 王某某的笔记">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/Netty/Netty-4-0-30-%E8%BF%9E%E6%8E%A5%E6%B1%A0bug%E5%88%86%E6%9E%90%E8%AE%B0%E5%BD%95/" class="post-title-link" itemprop="url">Netty-4-0-30-连接池bug分析记录</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-09-22 23:41:00" itemprop="dateCreated datePublished" datetime="2021-09-22T23:41:00+08:00">2021-09-22</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Netty/" itemprop="url" rel="index"><span itemprop="name">Netty</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>821</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>3 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h2><p>生产上存在上传文件到fastdfs中时一直卡死的问题</p>
<p>大概半个月出现一次，重启就能恢复<br>日志中没有任何错误</p>
<h2 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h2><p>线程堆栈：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">&quot;taskExecutor-5&quot; #638 prio=5 os_prio=0 tid=0x00007f970800b000 nid=0x1be3 waiting on condition [0x00007f9632008000]</span><br><span class="line">   java.lang.Thread.State: WAITING (parking)</span><br><span class="line">	at sun.misc.Unsafe.park(Native Method)</span><br><span class="line">	- parking to wait for  &lt;0x00000000e134e670&gt; (a java.util.concurrent.CompletableFuture$Signaller)</span><br><span class="line">	at java.util.concurrent.locks.LockSupport.park(LockSupport.java:175)</span><br><span class="line">	at java.util.concurrent.CompletableFuture$Signaller.block(CompletableFuture.java:1693)</span><br><span class="line">	at java.util.concurrent.ForkJoinPool.managedBlock(ForkJoinPool.java:3323)</span><br><span class="line">	at java.util.concurrent.CompletableFuture.waitingGet(CompletableFuture.java:1729)</span><br><span class="line">	at java.util.concurrent.CompletableFuture.get(CompletableFuture.java:1895)</span><br><span class="line">	at com.appleframework.file.provider.fdfs.FdfsProvider.upload(FdfsProvider.java:61)</span><br><span class="line">	at com.appleframework.file.spring.AbstractFSProviderSpringFacade.upload(AbstractFSProviderSpringFacade.java:70)</span><br><span class="line">	at com.chedaia.biz.renew.provider.service.impl.CustomerShoppingServiceImpl$1.run(CustomerShoppingServiceImpl.java:956)</span><br><span class="line">	at java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:511)</span><br><span class="line">	at java.util.concurrent.FutureTask.run(FutureTask.java:266)</span><br><span class="line">	at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1149)</span><br><span class="line">	at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:624)</span><br><span class="line">	at java.lang.Thread.run(Thread.java:748)</span><br></pre></td></tr></table></figure>
<p>只知道是在等一个CompletableFuture异步计算的返回结果，可能是再等待获取存储服务器地址，也可能是再等待上传结果</p>
<p>检查代码并进行测试，没有发现问题<br>猜测可能是获取不到连接导致的，连接没有归还到连接池中等，也可能是fastdfs一直没有响应，或者网络出现了什么问题等。</p>
<p>直到生产上再次出现该问题<br>将生产上的程序堆栈dump出来查看对比之前看的代码，发现是获取的连接数达到了最大值</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">jmap -dump:format=b,file=文件名 [pid]</span><br></pre></td></tr></table></figure>
<p><img src="https://upload-images.jianshu.io/upload_images/2043910-b66a00048f6cf229.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="image003.png"><br>而连接池中并没连接<br><img src="https://upload-images.jianshu.io/upload_images/2043910-2832090a35afe624.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="image005.png"><br>OQL</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select x.deque from io.netty.channel.pool.FixedChannelPool x</span><br></pre></td></tr></table></figure>
<h3 id="总结问题："><a href="#总结问题：" class="headerlink" title="总结问题："></a>总结问题：</h3><p>FixedChannelPool类的 acquiredChannelCount字段<br>一直增加到了最大的限制（100）导致的<br>获取到的连接一直没有释放</p>
<h3 id="检查原因："><a href="#检查原因：" class="headerlink" title="检查原因："></a>检查原因：</h3><p>查代码，并且重点测试这个变量，一直无法重现该问题（怀疑人生<del>_</del>）</p>
<p>导出测试程序的dump文件和线上的进行比较<br>对比了一下测试版本和线上版本的dump文件，发现类不一致<br><img src="https://upload-images.jianshu.io/upload_images/2043910-8ccd1dadc6085bb6.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="image007.png"></p>
<p>线上版本没有这个变量<br><img src="https://upload-images.jianshu.io/upload_images/2043910-bfb449c1b8292e07.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="image009.png"></p>
<p>检查发现 调试版本 和 线上的版本 不一致<br>调试版本：<strong>netty-all-4.0.34.Final.jar</strong><br>线上版本：<strong>netty-all-4.0.30.Final.jar</strong></p>
<p>再次查看netty-all-4.0.30的代码，发现netty的连接池存在问题</p>
<h2 id="问题重现"><a href="#问题重现" class="headerlink" title="问题重现"></a>问题重现</h2><p>检查代码发现连接归还到连接池中再次获取时存在问题<br>当连接用完之后，归还到连接池中，过了一段时间之后连接变成了 TIME_WAIT 状态（或断开），再去获取连接（此时将获取到一个异常的连接）<br><img src="https://upload-images.jianshu.io/upload_images/2043910-5a07e96289d29b1e.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="image011.png"></p>
<p>获取到连接之后会对连接的有效性进行检查<br><img src="https://upload-images.jianshu.io/upload_images/2043910-8e24e351fbdd2d78.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="image013.png"></p>
<p>检查到连接异常之后会关掉这个连接并再次获取连接<br><img src="https://upload-images.jianshu.io/upload_images/2043910-d5e889d54cc5cab3.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="image015.png"></p>
<p>此时会再调用FixedChannelPool类的acquire0方法获取连接，这将导致acquiredChannelCount 变量再次 +1，这次获取连接将会+2，而在释放时只会-1，这将导致这个值一直增大，直到达到maxConnections 的限制，之后就再也获取不到连接了</p>
<p><img src="https://upload-images.jianshu.io/upload_images/2043910-22e888669614e615.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="image017.png"></p>
<p>释放连接时只会-1</p>
<p><img src="https://upload-images.jianshu.io/upload_images/2043910-cd4833887fbb8e6d.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="image019.png"></p>
<h2 id="修复方案"><a href="#修复方案" class="headerlink" title="修复方案"></a>修复方案</h2><p>升级netty的包到更高的版本</p>
<p><strong><code>netty-all-4.0.30.Final.jar 包存在这个问题</code></strong></p>
<p><strong>netty-all-4.0.34.Final.jar 已经修复了这个问题</strong></p>
<blockquote>
<p>PS：<br>这个4.0.34版本还是可能会有问题<br>private int acquiredChannelCount;<br>这个变量是int类型，存在并发问题，可能多个线程同时修改这个变量，应该用AtomicInteger，但是以目前系统的并发量来看，完全可以忽略。</p>
</blockquote>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://wangwen135.github.io/%E7%A1%AC%E4%BB%B6%E4%B8%8E%E7%89%A9%E8%81%94%E7%BD%91/%E9%BB%91%E7%BE%A4%E6%99%96/%E7%BE%A4%E6%99%96NFS%E5%85%B1%E4%BA%AB%E6%9D%83%E9%99%90%E8%AE%BE%E7%BD%AE/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="王某某">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="王某某的笔记">
      <meta itemprop="description" content="这是一个使用 Hexo 构建的博客，用于分享我的编程经验和学习笔记。">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 王某某的笔记">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/%E7%A1%AC%E4%BB%B6%E4%B8%8E%E7%89%A9%E8%81%94%E7%BD%91/%E9%BB%91%E7%BE%A4%E6%99%96/%E7%BE%A4%E6%99%96NFS%E5%85%B1%E4%BA%AB%E6%9D%83%E9%99%90%E8%AE%BE%E7%BD%AE/" class="post-title-link" itemprop="url">群晖NFS共享权限设置</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-09-22 00:00:00" itemprop="dateCreated datePublished" datetime="2021-09-22T00:00:00+08:00">2021-09-22</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E7%A1%AC%E4%BB%B6%E4%B8%8E%E7%89%A9%E8%81%94%E7%BD%91/" itemprop="url" rel="index"><span itemprop="name">硬件与物联网</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E7%A1%AC%E4%BB%B6%E4%B8%8E%E7%89%A9%E8%81%94%E7%BD%91/%E9%BB%91%E7%BE%A4%E6%99%96/" itemprop="url" rel="index"><span itemprop="name">黑群晖</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>648</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>2 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>参考：<br><a target="_blank" rel="noopener" href="https://kb.synology.cn/zh-cn/DSM/tutorial/What_can_I_do_to_access_mounted_folders_NFS">https://kb.synology.cn/zh-cn/DSM/tutorial/What_can_I_do_to_access_mounted_folders_NFS</a></p>
<h3 id="设置"><a href="#设置" class="headerlink" title="设置"></a>设置</h3><p>1、开启服务<br>控制面板 -&gt; 文件服务 -&gt; SMB&#x2F;AFP&#x2F;NFS -&gt; 勾选 启用NFS服务  </p>
<blockquote>
<p>为保证兼容性，建议勾选‘启用NFS v4.1支持’</p>
</blockquote>
<p>2、设置共享文件的NFS权限<br>控制面板 -&gt; 共享文件夹 -&gt; 选择需要共享的文件 -&gt; 编辑 -&gt; NFS权限 -&gt; 新增  </p>
<ul>
<li>服务器名称或IP地址：* <blockquote>
<ul>
<li>全部IP可以访问，也可以指定IP段等，如：192.168.31.1&#x2F;24</li>
</ul>
</blockquote>
</li>
<li>权限：可读写</li>
<li>Squash：映射所有用户为 admin  （下面说明）</li>
<li>安全性：sys</li>
</ul>
<blockquote>
<p>应用 NFS 权限后，您可在 NFS 权限选项卡的左下角找到共享文件夹的装载路径。装载路径应采用以下格式： &#x2F;[volume name]&#x2F;[shared folder name]</p>
</blockquote>
<h3 id="允许访问所有用户"><a href="#允许访问所有用户" class="headerlink" title="允许访问所有用户"></a>允许访问所有用户</h3><p>如果要向所有用户授予相同权限，请设置<strong>Squash</strong> 选择每个文件&#x2F;文件夹的NFS规则并选择将所有用户映射到admin 。</p>
<p>当使用此Squash选项设置NFS权限时，所有用户将被视为Synology NAS上的“管理员”并有权访问所有文件&#x2F;文件夹。<br>当用户创建文件&#x2F;文件夹时，文件&#x2F;文件夹的创建者被列为“admin”。</p>
<h3 id="向不同的用户提供不同的访问权限"><a href="#向不同的用户提供不同的访问权限" class="headerlink" title="向不同的用户提供不同的访问权限"></a>向不同的用户提供不同的访问权限</h3><p>如果您要为不同的用户提供不同的访问权限，您必须将所有计算机和Synology NAS加入同一个LDAP服务器。为Synology NAS 1上的每个文件&#x2F;文件夹设置LDAP帐户权限，以便不同用户（LDAP帐户）可以通过相应权限访问文件&#x2F;文件夹。然后，参阅本文以为每个文件&#x2F;文件夹设置NFS规则，并为Squash选择<strong>无映射</strong>。</p>
<blockquote>
<p>注：<br>UID编号为0-125之间，仅供Synology NAS中的本地用户使用。若要设置LDAP UID，请使用大于1025的数字。</p>
</blockquote>
<h3 id="访问"><a href="#访问" class="headerlink" title="访问"></a>访问</h3><p>参考：<br><a target="_blank" rel="noopener" href="https://kb.synology.cn/zh-cn/DSM/tutorial/How_to_access_files_on_Synology_NAS_within_the_local_network_NFS">https://kb.synology.cn/zh-cn/DSM/tutorial/How_to_access_files_on_Synology_NAS_within_the_local_network_NFS</a></p>
<h4 id="安装软件"><a href="#安装软件" class="headerlink" title="安装软件"></a>安装软件</h4><h5 id="Ubuntu"><a href="#Ubuntu" class="headerlink" title="Ubuntu"></a>Ubuntu</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo apt update</span><br><span class="line">sudo apt install nfs-common</span><br></pre></td></tr></table></figure>

<h5 id="CentOS-Redhat-Fedora"><a href="#CentOS-Redhat-Fedora" class="headerlink" title="CentOS&#x2F;Redhat&#x2F;Fedora"></a>CentOS&#x2F;Redhat&#x2F;Fedora</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo yum install nfs-utils</span><br></pre></td></tr></table></figure>

<h4 id="挂载目录"><a href="#挂载目录" class="headerlink" title="挂载目录"></a>挂载目录</h4><p>查看挂载目录</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">showmount -e 192.168.31.66</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<p>输入挂载命令以在客户端通过 NFS 装载共享文件夹</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">sudo mount -t nfs [Synology NAS IP address]:[mount path of shared folder] /[mount point on NFS client]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">示例：</span><br><span class="line">sudo mount -t nfs 196.168.x.x:/volumeX/test /mnt</span><br><span class="line">mount -t nfs 192.168.31.66:/volume2/video /mnt/video</span><br></pre></td></tr></table></figure>

<h4 id="查看"><a href="#查看" class="headerlink" title="查看"></a>查看</h4><p>输入disk free命令以确认您已成功装载共享文件夹。文件系统列中的输出应采用以下格式： [Synology NAS IP address]:[mount path of shared folder]</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">df -h</span><br><span class="line"></span><br><span class="line">192.168.31.66:/volume2/video  3.5T   68G  3.5T    2% /mnt/video</span><br></pre></td></tr></table></figure>


<h3 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h3><p>挂载不了时，检查一下命令，地址<br>ping一下ip<br>telnet一下端口： telnet 192.168.31.66 2049</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://wangwen135.github.io/%E7%A1%AC%E4%BB%B6%E4%B8%8E%E7%89%A9%E8%81%94%E7%BD%91/%E9%BB%91%E7%BE%A4%E6%99%96/%E7%BE%A4%E6%99%96%E5%8F%8C%E7%A1%AC%E7%9B%98%E4%BA%92%E5%A4%87/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="王某某">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="王某某的笔记">
      <meta itemprop="description" content="这是一个使用 Hexo 构建的博客，用于分享我的编程经验和学习笔记。">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 王某某的笔记">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/%E7%A1%AC%E4%BB%B6%E4%B8%8E%E7%89%A9%E8%81%94%E7%BD%91/%E9%BB%91%E7%BE%A4%E6%99%96/%E7%BE%A4%E6%99%96%E5%8F%8C%E7%A1%AC%E7%9B%98%E4%BA%92%E5%A4%87/" class="post-title-link" itemprop="url">群晖群晖双硬盘互备</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-09-22 00:00:00" itemprop="dateCreated datePublished" datetime="2021-09-22T00:00:00+08:00">2021-09-22</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E7%A1%AC%E4%BB%B6%E4%B8%8E%E7%89%A9%E8%81%94%E7%BD%91/" itemprop="url" rel="index"><span itemprop="name">硬件与物联网</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E7%A1%AC%E4%BB%B6%E4%B8%8E%E7%89%A9%E8%81%94%E7%BD%91/%E9%BB%91%E7%BE%A4%E6%99%96/" itemprop="url" rel="index"><span itemprop="name">黑群晖</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>502</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>2 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>参考：<a target="_blank" rel="noopener" href="https://www.right.com.cn/forum/thread-4060167-1-1.html">https://www.right.com.cn/forum/thread-4060167-1-1.html</a></p>
<h3 id="方案一"><a href="#方案一" class="headerlink" title="方案一"></a>方案一</h3><p>两块硬盘做Raid1</p>
<h4 id="缺点："><a href="#缺点：" class="headerlink" title="缺点："></a>缺点：</h4><ul>
<li>果硬盘容量不一样，甚至一块是机械硬盘，另一块是SSD，就不好组Raid1</li>
<li>硬盘完全镜像，很浪费硬盘空间。比如我的家庭照片很重要，下载电影不重要，我只想多个硬盘备份照片，不想备份电影，Raid1无法做到</li>
</ul>
<h3 id="方案二"><a href="#方案二" class="headerlink" title="方案二"></a>方案二</h3><p>用群晖自带的备份工具，如HyperBackup</p>
<h4 id="缺点：-1"><a href="#缺点：-1" class="headerlink" title="缺点："></a>缺点：</h4><ul>
<li>不能实时备份，要设置定时备份时间，这个会引起群晖退出休眠</li>
<li>HyperBackup备份出来的是一个特殊的文件，无法直接打开使用，需要加挂</li>
</ul>
<h3 id="方案三"><a href="#方案三" class="headerlink" title="*方案三"></a>*方案三</h3><p>webDAV 和 CloudSync</p>
<ol>
<li>安装webDAV和CloudSync两个套件</li>
<li>设置webDAV，启用HTTP和HTTPS</li>
<li>然后打开CloudSync，添加同步，选webDAV</li>
<li>服务器输入  <a href="http://localhost:5005，并输入管理员账号密码，下一步">http://localhost:5005，并输入管理员账号密码，下一步</a></li>
<li>然后设置本地路径和远程路径，其中<strong>远程路径</strong>就是你这台群晖本机的需要备份的文件夹，<strong>本地路径</strong>就是备份文件夹</li>
<li>当有多个文件夹需要备份时新增多个备份即可</li>
<li>同步方向设置  选择【仅下载远程更改】</li>
</ol>
<h4 id="优点"><a href="#优点" class="headerlink" title="优点"></a>优点</h4><ol>
<li>同步是实时的，只要源文件夹有新文件，立即同步复制到备份文件夹，几乎没有任何延迟。不需要设置备份时间间隔</li>
<li>不影响休眠！如果长时间没有文件上传，群晖仍然可以正常休眠。（这个待验证，现在装了一堆东西，硬盘都已经不休眠了）</li>
<li>备份文件仍然是个普通文件夹，可以任意打开浏览、复制、删除，不像HyperBackup将文件打包</li>
<li>节省空间，你可以只同步重要的数据如照片，忽略电影</li>
<li>不限制硬盘类型，两个硬盘容量不同，类型是机械硬盘还是SSD，都无所谓的</li>
</ol>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://wangwen135.github.io/%E7%A1%AC%E4%BB%B6%E4%B8%8E%E7%89%A9%E8%81%94%E7%BD%91/%E9%BB%91%E7%BE%A4%E6%99%96/%E9%BB%91%E7%BE%A4%E6%99%96%E4%BF%AE%E6%94%B9MAC%E5%9C%B0%E5%9D%80/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="王某某">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="王某某的笔记">
      <meta itemprop="description" content="这是一个使用 Hexo 构建的博客，用于分享我的编程经验和学习笔记。">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 王某某的笔记">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/%E7%A1%AC%E4%BB%B6%E4%B8%8E%E7%89%A9%E8%81%94%E7%BD%91/%E9%BB%91%E7%BE%A4%E6%99%96/%E9%BB%91%E7%BE%A4%E6%99%96%E4%BF%AE%E6%94%B9MAC%E5%9C%B0%E5%9D%80/" class="post-title-link" itemprop="url">黑群晖修改MAC地址</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-09-22 00:00:00" itemprop="dateCreated datePublished" datetime="2021-09-22T00:00:00+08:00">2021-09-22</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E7%A1%AC%E4%BB%B6%E4%B8%8E%E7%89%A9%E8%81%94%E7%BD%91/" itemprop="url" rel="index"><span itemprop="name">硬件与物联网</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E7%A1%AC%E4%BB%B6%E4%B8%8E%E7%89%A9%E8%81%94%E7%BD%91/%E9%BB%91%E7%BE%A4%E6%99%96/" itemprop="url" rel="index"><span itemprop="name">黑群晖</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>124</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>1 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>黑群晖多个虚拟网卡，MAC地址一样</p>
<p>挂载引导分区</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">sudo -i</span><br><span class="line"># 输入密码</span><br><span class="line"></span><br><span class="line">echo 1 &gt; /proc/sys/kernel/syno_install_flag</span><br><span class="line">mkdir -p /tmp/synoboot1</span><br><span class="line">mount /dev/synoboot1 /tmp/synoboot1</span><br><span class="line">cd /tmp/synoboot1</span><br><span class="line">ls -l</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<p>修改引导文件</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">cd grub/</span><br><span class="line"></span><br><span class="line">vi grub.cfg</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>修改内容，在set mac1&#x3D;xxxxx 后面增加set mac2&#x3D;xxx set mac3&#x3D;xxx<br>xxx 就是mac地址，按照格式填写就行了</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">set sn=1780PDN123458</span><br><span class="line">set mac1=008132123456</span><br><span class="line">set mac2=118132123457</span><br><span class="line">set mac3=aa8132123458</span><br><span class="line">set mac4=bb8132123459</span><br></pre></td></tr></table></figure>

<blockquote>
<p>之前已经将黑群晖 DS918+ 改成最多支持4个网卡了</p>
</blockquote>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://wangwen135.github.io/%E7%A1%AC%E4%BB%B6%E4%B8%8E%E7%89%A9%E8%81%94%E7%BD%91/%E9%BB%91%E7%BE%A4%E6%99%96/%E7%BE%A4%E6%99%96%E5%AE%89%E8%A3%85%20Transmission/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="王某某">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="王某某的笔记">
      <meta itemprop="description" content="这是一个使用 Hexo 构建的博客，用于分享我的编程经验和学习笔记。">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 王某某的笔记">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/%E7%A1%AC%E4%BB%B6%E4%B8%8E%E7%89%A9%E8%81%94%E7%BD%91/%E9%BB%91%E7%BE%A4%E6%99%96/%E7%BE%A4%E6%99%96%E5%AE%89%E8%A3%85%20Transmission/" class="post-title-link" itemprop="url">群晖安装 Transmission</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-09-21 00:00:00" itemprop="dateCreated datePublished" datetime="2021-09-21T00:00:00+08:00">2021-09-21</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E7%A1%AC%E4%BB%B6%E4%B8%8E%E7%89%A9%E8%81%94%E7%BD%91/" itemprop="url" rel="index"><span itemprop="name">硬件与物联网</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E7%A1%AC%E4%BB%B6%E4%B8%8E%E7%89%A9%E8%81%94%E7%BD%91/%E9%BB%91%E7%BE%A4%E6%99%96/" itemprop="url" rel="index"><span itemprop="name">黑群晖</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>691</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>3 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>Transmission是一种BitTorrent客户端，特点是一个跨平台的后端和其上的简洁的用户界面。Transmission以MIT许可证和GNU通用公共许可证双许可证授权，因此是一款自由软件。支持包括Linux、Mac OS X等多种操作系统（也有爱好者制作的windows安装包），以及Networked Media Tank、WD MyBook、ReadyNAS、D-Link DNS-323 &amp; CH3SNAS、Synology等多种设备。支持GTK+、命令行、Web等多种界面。</p>
<p>其特点是开源、无广告，硬件资源消耗极少，界面极度精简，支持BT种子和磁力链接下载，支持web界面、远程控制等。</p>
<h4 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h4><ol>
<li>设置默认下载文件夹</li>
<li>添加第三方套件源<br> 之前已经加过了：<a target="_blank" rel="noopener" href="http://packages.synocommunity.com/">http://packages.synocommunity.com/</a></li>
<li>在“套件中心”-“社群”，就可以找到Transmission，点击安装</li>
</ol>
<h4 id="配置："><a href="#配置：" class="headerlink" title="配置："></a>配置：</h4><ol>
<li>配置下载目录</li>
<li>设置登录的用户名和密码</li>
</ol>
<p>默认的访问地址是：<a target="_blank" rel="noopener" href="http://xxxxxx.xxx:9091/">http://xxxxxx.xxx:9091/</a><br>需要在路由器上做端口映射</p>
<blockquote>
<p>想要通过域名访问需要自己配置DDNS</p>
</blockquote>
<h4 id="配置Transmission-Web-Control"><a href="#配置Transmission-Web-Control" class="headerlink" title="配置Transmission Web Control"></a>配置Transmission Web Control</h4><p><a target="_blank" rel="noopener" href="https://github.com/ronggang/transmission-web-control">https://github.com/ronggang/transmission-web-control</a></p>
<blockquote>
<p>汉化与加强Transmission Web的操作能力</p>
</blockquote>
<p>ssh 到群晖上</p>
<p>切换到root</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo -i</span><br></pre></td></tr></table></figure>

<p>下载脚本并执行</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">wget https://github.com/ronggang/transmission-web-control/raw/master/release/install-tr-control.sh</span><br><span class="line"></span><br><span class="line"># 中文版本</span><br><span class="line">wget https://github.com/ronggang/transmission-web-control/raw/master/release/install-tr-control-cn.sh</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">sh install-tr-control.sh</span><br></pre></td></tr></table></figure>

<p>选择1安装最小版本，直到安装完成</p>
<h4 id="权限设置："><a href="#权限设置：" class="headerlink" title="权限设置："></a>权限设置：</h4><p>控制面板 –&gt; 用户群组 –&gt; sc-download </p>
<blockquote>
<p>设置download目录权限为可读写</p>
</blockquote>
<p>控制面板 –&gt; 共享文件夹 –&gt; 编辑download文件夹</p>
<blockquote>
<p>设置权限 –&gt; 系统内部账号 –&gt; sc-transmission –&gt; 可读写</p>
</blockquote>
<p><strong>为了能直接下载到video目录</strong></p>
<p>控制面板 –&gt; 用户群组 –&gt; sc-download </p>
<blockquote>
<p>设置video目录权限为可读写</p>
</blockquote>
<p>控制面板 –&gt; 共享文件夹 –&gt; 编辑video文件夹</p>
<blockquote>
<p>设置权限 –&gt; 系统内部账号 –&gt; sc-transmission –&gt; 可读写</p>
</blockquote>
<h2 id="注意！有些教程上是设置everyone可读写，这样是不安全的"><a href="#注意！有些教程上是设置everyone可读写，这样是不安全的" class="headerlink" title="注意！有些教程上是设置everyone可读写，这样是不安全的"></a><strong>注意！</strong><br><em>有些教程上是设置everyone可读写，这样是不安全的</em></h2><h4 id="外网访问"><a href="#外网访问" class="headerlink" title="外网访问"></a>外网访问</h4><p>路由器做端口映射，默认端口：9091</p>
<hr>
<h3 id="使用https"><a href="#使用https" class="headerlink" title="使用https"></a>使用https</h3><p>进入群晖 –&gt; 控制面板  –&gt; 引用程序门户 –&gt; 反向代理服务<br>新增一个：<br><strong>来源</strong></p>
<blockquote>
<p>协议：https<br>主机名：*<br>端口：19091  </p>
</blockquote>
<blockquote>
<p>启用HSTS<br>启用HTTP&#x2F;2</p>
</blockquote>
<p><strong>目的地</strong>  </p>
<blockquote>
<p>协议：http<br>主机名：192.168.1.66<br>端口：9091</p>
</blockquote>
<p>修改路由器上的端口应用：外网端口改成 19091，内网指向群晖的19091端口</p>
<p>访问：<a target="_blank" rel="noopener" href="https://xxxxx.xxx:19091/transmission/web/">https://xxxxx.xxx:19091/transmission/web/</a></p>
<hr>
<h3 id="端口映射"><a href="#端口映射" class="headerlink" title="端口映射"></a>端口映射</h3><p>进入 Transmission Web Control<br>进入设置–&gt; 网络传输 –&gt; 默认使用固定端口：51413</p>
<p>点击下方的测试端口，显示不可连接</p>
<p>在路由器上配置端口映射，将外网的51413端口映射到群晖（transmission）的51413端口</p>
<p>再次点击测试，显示端口可连接</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://wangwen135.github.io/Zookeeper/curator-%E5%85%A5%E9%97%A8/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="王某某">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="王某某的笔记">
      <meta itemprop="description" content="这是一个使用 Hexo 构建的博客，用于分享我的编程经验和学习笔记。">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 王某某的笔记">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/Zookeeper/curator-%E5%85%A5%E9%97%A8/" class="post-title-link" itemprop="url">curator-入门</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-08-20 23:41:00" itemprop="dateCreated datePublished" datetime="2021-08-20T23:41:00+08:00">2021-08-20</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Zookeeper/" itemprop="url" rel="index"><span itemprop="name">Zookeeper</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>332</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>1 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p><a target="_blank" rel="noopener" href="http://curator.apache.org/getting-started.html">http://curator.apache.org/getting-started.html</a></p>
<blockquote>
<p>学习ZooKeeper<br>http: &#x2F;&#x2F;zookeeper.apache.org&#x2F;doc&#x2F;trunk&#x2F;zookeeperStarted.html</p>
</blockquote>
<h2 id="使用curator"><a href="#使用curator" class="headerlink" title="使用curator"></a>使用curator</h2><p>curator的JAR包可从Maven Central获得。Maven，Gradle，Ant等的用户可以轻松地将curator包含在他们的构建脚本中。</p>
<p>Maven</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line"> &lt;groupId&gt;org.apache.curator&lt;/groupId&gt;</span><br><span class="line"> &lt;artifactId&gt;curator-recipes&lt;/artifactId&gt;</span><br><span class="line"> &lt;version&gt;4.0.0&lt;/version&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure>


<h2 id="获得连接"><a href="#获得连接" class="headerlink" title="获得连接"></a>获得连接</h2><p>curator使用 Fluent Style 风格的API。</p>
<p>curator连接实例（CuratorFramework）由CuratorFrameworkFactory分配。要连接到的ZooKeeper群集只需要 <strong>一个</strong> CuratorFramework对象：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">CuratorFrameworkFactory.newClient(zookeeperConnectionString, retryPolicy)</span><br><span class="line"> ）</span><br></pre></td></tr></table></figure>
<p>使用默认值创建与ZooKeeper群集的连接，唯一需要指定的是重试策略。在大多数情况下，应该使用：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">RetryPolicy retryPolicy = new ExponentialBackoffRetry(1000, 3)</span><br><span class="line">CuratorFramework client = CuratorFrameworkFactory.newClient(zookeeperConnectionString, retryPolicy);</span><br><span class="line">client.start();</span><br></pre></td></tr></table></figure>
<p>必须启动客户端（不再需要时关闭）。</p>
<h2 id="直接使用ZooKeeper"><a href="#直接使用ZooKeeper" class="headerlink" title="直接使用ZooKeeper"></a>直接使用ZooKeeper</h2><p>一旦有一个CuratorFramework实例，就可以直接调用ZooKeeper，方法与使用ZooKeeper发行版中提供的原始ZooKeeper对象类似。例如：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">client.create().forPath(&quot;/my/path&quot;, myData)</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>这里的好处是curator管理ZooKeeper连接，如果有连接问题，将重试操作。</p>
<h2 id="食谱-Recipes"><a href="#食谱-Recipes" class="headerlink" title="食谱 Recipes"></a>食谱 Recipes</h2><h3 id="分布式锁"><a href="#分布式锁" class="headerlink" title="分布式锁"></a>分布式锁</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">InterProcessMutex lock = new InterProcessMutex(client, lockPath);</span><br><span class="line">if ( lock.acquire(maxWait, waitUnit) ) </span><br><span class="line">&#123;</span><br><span class="line">    try </span><br><span class="line">    &#123;</span><br><span class="line">        // do some work inside of the critical section here</span><br><span class="line">    &#125;</span><br><span class="line">    finally</span><br><span class="line">    &#123;</span><br><span class="line">        lock.release();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="领导选举"><a href="#领导选举" class="headerlink" title="领导选举"></a>领导选举</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">LeaderSelectorListener listener = new LeaderSelectorListenerAdapter()</span><br><span class="line">&#123;</span><br><span class="line">    public void takeLeadership(CuratorFramework client) throws Exception</span><br><span class="line">    &#123;</span><br><span class="line">        // this callback will get called when you are the leader</span><br><span class="line">        // do whatever leader work you need to and only exit</span><br><span class="line">        // this method when you want to relinquish leadership</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">LeaderSelector selector = new LeaderSelector(client, path, listener);</span><br><span class="line">selector.autoRequeue();  // not required, but this is behavior that you will probably expect</span><br><span class="line">selector.start();</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://wangwen135.github.io/Netty/I-O%E5%A4%9A%E8%B7%AF%E5%A4%8D%E7%94%A8%EF%BC%88I-O-Multiplexing%EF%BC%89/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="王某某">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="王某某的笔记">
      <meta itemprop="description" content="这是一个使用 Hexo 构建的博客，用于分享我的编程经验和学习笔记。">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 王某某的笔记">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/Netty/I-O%E5%A4%9A%E8%B7%AF%E5%A4%8D%E7%94%A8%EF%BC%88I-O-Multiplexing%EF%BC%89/" class="post-title-link" itemprop="url">I-O多路复用（I-O-Multiplexing）</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-08-16 23:41:00" itemprop="dateCreated datePublished" datetime="2021-08-16T23:41:00+08:00">2021-08-16</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Netty/" itemprop="url" rel="index"><span itemprop="name">Netty</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>2.8k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>10 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>我们希望在一个或多个I&#x2F;O条件就绪（即输入已准备好被读取，或者描述符能够接收更多输出）时得到通知。此功能称为I&#x2F;O复用，由select和poll等函数支持。</p>
<p>通常情况下，I&#x2F;O多路复用通常用于网络应用程序：  </p>
<ul>
<li>当客户端处理多个描述符时（通常是交互式输入和网络套接字）</li>
<li>当客户端同时处理多个套接字时（这是可能的，但很少见）</li>
<li>如果TCP服务器同时处理侦听套接字及其连接的套接字</li>
<li>如果服务器同时处理TCP和UDP</li>
<li>如果服务器处理多种服务，并且可能处理多种协议</li>
</ul>
<p>但是I&#x2F;O复用不限于网络编程。</p>
<blockquote>
<p>Unix&#x2F;Linux系统中的所有内容都是文件。每个进程都有一个文件描述符，该描述符指向文件，套接字，设备和其他操作系统对象。</p>
</blockquote>
<blockquote>
<p>我们告诉内核我们对哪些描述符感兴趣（用于读取，写入或异常情况）以及等待多长时间。我们感兴趣的描述符不限于套接字，还可以是任何的描述符。</p>
</blockquote>
<h2 id="I-O模型"><a href="#I-O模型" class="headerlink" title="I&#x2F;O模型"></a>I&#x2F;O模型</h2><p>Unix&#x2F;Linux 下可供我们使用的五个I&#x2F;O模型</p>
<ol>
<li>blocking I&#x2F;O 【阻塞I&#x2F;O】</li>
<li>nonblocking I&#x2F;O 【非阻塞I&#x2F;O】</li>
<li>I&#x2F;O multiplexing (select and poll) 【多路复用I&#x2F;O】</li>
<li>signal driven I&#x2F;O (SIGIO) 【信号驱动】</li>
<li>asynchronous I&#x2F;O (the POSIX aio_ functions) 【异步I&#x2F;O，由POSIX规范定义的】</li>
</ol>
<p>输入操作通常有两个不同的阶段：</p>
<ol>
<li>等待数据准备就绪。这涉及等待数据到达网络。数据包到达时，它将被复制到内核中的缓冲区中。</li>
<li>将数据从内核复制到进程。这意味着将（就绪）数据从内核缓冲区复制到我们的应用程序缓冲区中</li>
</ol>
<h3 id="同步IO-异步IO"><a href="#同步IO-异步IO" class="headerlink" title="同步IO&amp;异步IO"></a>同步IO&amp;异步IO</h3><p>根据 POSIX 定义:</p>
<ul>
<li>同步I&#x2F;O操作会阻塞请求进程，直到I&#x2F;O操作完成</li>
<li>异步I&#x2F;O操作不会导致阻塞请求进程</li>
</ul>
<p>按照这种分类，上边5种I&#x2F;O模型中，只有AIO一种是异步的，其他都是同步的。<br>因为其中真正的IO操作(recvfrom 调用) 会阻塞进程，recvfrom 会阻塞等待内核将数据从内核空间复制到应用进程空间, 当赋值完成后, recvfrom 才返回。</p>
<p>但是从我们编程的角度来看，「I&#x2F;O多路复用」和「信号驱动I&#x2F;O」都不会导致我们的进程完全被阻塞，因为在多线程下，阻塞一个线程并不会导致整个进程被阻塞。</p>
<h2 id="I-O多路复用实现方式"><a href="#I-O多路复用实现方式" class="headerlink" title="I&#x2F;O多路复用实现方式"></a>I&#x2F;O多路复用实现方式</h2><p>I&#x2F;O多路复用(I&#x2F;O multiplexing) 通过系统调用 select，poll，epoll 支持。</p>
<p>select&#x2F;epoll的好处就在于单个进程就可以同时处理多个网络连接的IO。它的基本原理就是select，poll，epoll这些个函数会不断的轮询所负责的所有socket，当某个socket有数据到达了，就通知用户进程。  </p>
<blockquote>
<p>本质是通过系统函数select、poll、epool（模块）来监听多个文件描述符（套接字描述符）。<br>无论epoll还是select都受限于系统中单个进程能够打开的文件句柄数。</p>
</blockquote>
<p>select&#x2F;poll的优势并不是对于单个连接能处理得更快，而是在于能处理更多的连接。</p>
<h3 id="一、select"><a href="#一、select" class="headerlink" title="一、select"></a>一、select</h3><p>select是个系统调用，提供了一种用于实现同步多路复用I&#x2F;O的机制</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">int select(int nfds, fd_set *readfds, fd_set *writefds, fd_set *exceptfds, struct timeval *timeout);</span><br></pre></td></tr></table></figure>
<p>对select()的调用将一直阻塞，直到给定的文件描述符准备执行I&#x2F;O为止，或者直到经过可选的指定超时为止。</p>
<p>监视的文件描述符类型分为三种：</p>
<ul>
<li>监视readfds集中列出的文件描述符，以查看是否有数据可读取。</li>
<li>监视writefds集中列出的文件描述符，以查看写操作是否将完成而不会阻塞。</li>
<li>监视exceptionfds集中的文件描述符，以查看是否发生了异常或带外数据是否可用（这些状态仅适用于套接字）。</li>
</ul>
<p>执行select()成功返回后，将修改每个集合，以使其仅包含准备好由该集合描述的I&#x2F;O类型的文件描述符。</p>
<h4 id="优缺点"><a href="#优缺点" class="headerlink" title="优缺点"></a>优缺点</h4><h5 id="优点："><a href="#优点：" class="headerlink" title="优点："></a>优点：</h5><p>select的主要优点是它具有很高的可移植性-像OS一样的每个UNIX都具有它</p>
<h5 id="缺点："><a href="#缺点：" class="headerlink" title="缺点："></a>缺点：</h5><ul>
<li>select()使用fd_set来表示文件描述符的集合，而fd_set其实就是一个固定长度的位向量(bit vector)，在Linux上，这个固定长度是FD_SETSIZE，其数值是1024。<br>故select()监听的文件描述符总数必须小于1024。  </li>
<li>我们需要遍历文件描述符以检查它是否存在于select返回的集合中</li>
</ul>
<h5 id="注意事项："><a href="#注意事项：" class="headerlink" title="注意事项："></a>注意事项：</h5><p>每次select之前要重置每个入参集合的值（返回时会被修改）。</p>
<h3 id="二、poll"><a href="#二、poll" class="headerlink" title="二、poll"></a>二、poll</h3><p>poll提供与相似的功能select。<br>与select()不同，因为select()具有效率低下的三个基于位掩码的文件描述符集，poll()使用nfds pollfd结构的单个数组。原型更简单：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">int poll (struct pollfd *fds, unsigned int nfds, int timeout);</span><br></pre></td></tr></table></figure>

<p>pollfd结构的事件和返回事件具有不同的字段，因此我们不必每次都构建它</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">struct pollfd &#123;</span><br><span class="line">      int fd;</span><br><span class="line">      short events; </span><br><span class="line">      short revents;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>对于每个文件描述符，构建一个类型为pollfd的对象，并填充所需的事件。poll返回后，检查revents字段即可</p>
<p>就像我们对select所做的那样，我们需要检查每个pollfd对象以查看其文件描述符是否已准备就绪，但是我们不需要在每次迭代时都构建集合</p>
<h4 id="优缺点-1"><a href="#优缺点-1" class="headerlink" title="优缺点"></a>优缺点</h4><h5 id="优点：-1"><a href="#优点：-1" class="headerlink" title="优点："></a>优点：</h5><p>poll()系统调用将输入（events字段）与输出（revents字段）分开，从而允许入参被重复使用而无需更改。</p>
<h5 id="缺点：-1"><a href="#缺点：-1" class="headerlink" title="缺点："></a>缺点：</h5><p>由于某些Unix系统不支持poll()，因此select()具有更高的可移植性。</p>
<h3 id="select-和-poll-的性能问题"><a href="#select-和-poll-的性能问题" class="headerlink" title="select 和 poll 的性能问题"></a>select 和 poll 的性能问题</h3><p>使用select()或poll()监听大量的文件描述符时，往往会遭遇到性能问题。当用户每次调用select()或poll()时，内核会对传入的所有文件描述符都检查一遍，并记录其中有哪些文件描述符存在I&#x2F;O就绪，这个操作的耗时将随着文件描述符数量的增加而线性增长。</p>
<p>另一个重要因素也会影响select()和poll()的性能，例如用户每次调用poll()时，都需要传递一个pollfd数组，而poll()会将这个数组从用户空间拷贝到内核空间，当内核对这个数组作了修改之后，poll()又会将这个数组从内核空间拷贝到用户空间。随着pollfd数组长度的增加，每次拷贝的时间也会线性增长，一旦poll()需要监听大量的文件描述符，每次调用poll()时，这个拷贝操作将带来不小的开销。这个问题的根源在于select()和poll()的API设计不当，例如，对于应用程序来说，它每次调用poll()所监听的文件描述符集合应该是差不多的，所以我们不禁这样想，如果内核愿意提供一个数据结构，记录程序所要监听的文件描述符集合，这样每次用户调用poll()时，poll()就不需要将pollfd数组拷贝来拷贝去了（没错，epoll 就是这样解决的）。</p>
<h3 id="三、epoll"><a href="#三、epoll" class="headerlink" title="三、epoll"></a>三、epoll</h3><blockquote>
<p>epoll是为了解决select()和poll()中存在的问题</p>
</blockquote>
<p>epoll是个模块，由三个系统调用（epoll_create epoll_ctl epoll_wait）组成，Epoll 系统调用可帮助我们在内核中创建和管理上下文。epoll使用红黑树（RB-tree）数据结构来跟踪当前正在监视的所有文件描述符。</p>
<p>我们将任务分为3个步骤：</p>
<ul>
<li>使用epoll_create在内核中创建上下文</li>
<li>使用epoll_ctl向&#x2F;从上下文中添加和删除文件描述符</li>
<li>使用epoll_wait等待上下文中的事件</li>
</ul>
<p>epoll_ctl()负责增加、删除或修改红黑树上的节点，而epoll_wait()则负责返回双向链表中就绪的文件描述符(及其事件)。</p>
<p>当网卡收到一个 packet 的时候，会触发一个硬件中断，这导致内核调用相应的中断 handler，从网卡中读入数据放到协议栈，当数据量满足一定条件时，内核将回调ep_poll_callback()这个方法，它负责把这个就绪的文件描述符添加到双向链表中。这样当用户调用epoll_wait()时，epoll_wait()所做的就只是检查双向链表是否为空，如果不为空，就把文件描述符和数量返回给用户即可。</p>
<h4 id="触发模式"><a href="#触发模式" class="headerlink" title="触发模式"></a>触发模式</h4><p>epoll提供边沿触发（Edge-Triggered）及状态触发（Level-Triggered）模式。</p>
<blockquote>
<p>Level-Triggered 也翻译成水平触发、条件触发</p>
</blockquote>
<p><strong>边沿触发：</strong><br>监控对象的状态发生改变时触发，此后如果状态一直没有发生变化应用程序将不再收到通知</p>
<p><strong>状态触发：</strong><br>处于某种状态下（如缓冲区可以读）就一直触发</p>
<p><strong>如：</strong><br>socket接收到缓存数据时，调用epoll_wait，上面两种方法都将返回，表明存在要读取的数据。<br>假设读取器仅消耗了缓冲区中的部分数据。<br>在状态触发模式下，epoll_wait只要管道的缓冲区包含要读取的数据，对epoll_wait的调用将立即返回；<br>但是，在边沿触发模式下，epoll_wait仅在将新数据写入缓存区后才返回。</p>
<h4 id="一般编程逻辑"><a href="#一般编程逻辑" class="headerlink" title="一般编程逻辑"></a>一般编程逻辑</h4><ol>
<li><p>【epoll_create】在内核中创建epoll实例并返回一个epoll文件描述符（epfd）。  </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">int epoll_create1(int flags);</span><br></pre></td></tr></table></figure>
</li>
<li><p>【epoll_ctl】向epfd对应的内核epoll实例添加、修改或删除对fd（File descriptor）上事件event的监听。类型可以为EPOLL_CTL_ADD, EPOLL_CTL_MOD, EPOLL_CTL_DEL分别对应的是添加新的事件，修改文件描述符上监听的事件类型。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">int epoll_ctl(int epfd, int op, int fd, struct epoll_event *event);</span><br></pre></td></tr></table></figure>
</li>
<li><p>【epoll_wait】循环执行epoll_wait，当timeout 为0 时，epoll_wait 永远会立即返回。而timeout 为-1 时，epoll_wait 会一直阻塞直到任一已注册的事件变为就绪。当timeout 为一正整数时，epoll 会阻塞直到计时timeout 毫秒终了或已注册的事件变为就绪。因为内核调度延迟，阻塞的时间可能会略微超过timeout 毫秒。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">int epoll_wait(int epfd, struct epoll_event *events, int maxevents, int timeout);</span><br></pre></td></tr></table></figure></li>
</ol>
<h4 id="优缺点-2"><a href="#优缺点-2" class="headerlink" title="优缺点"></a>优缺点</h4><h5 id="优点：-2"><a href="#优点：-2" class="headerlink" title="优点："></a>优点：</h5><ul>
<li>我们可以在等待时添加和删除文件描述符</li>
<li>epoll_wait仅返回具有就绪文件描述符的对象</li>
<li>epoll具有更好的性能-（Epoll时间复杂度为O(1) 代替之前的O(n)）</li>
<li>epoll可以表现为状态触发或边缘触发</li>
</ul>
<h5 id="缺点：-2"><a href="#缺点：-2" class="headerlink" title="缺点："></a>缺点：</h5><p>epoll是特定于Linux的，因此不可移植</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




  <nav class="pagination">
    <a class="extend prev" rel="prev" title="上一页" aria-label="上一页" href="/page/4/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/4/">4</a><span class="page-number current">5</span><a class="page-number" href="/page/6/">6</a><span class="space">&hellip;</span><a class="page-number" href="/page/16/">16</a><a class="extend next" rel="next" title="下一页" aria-label="下一页" href="/page/6/"><i class="fa fa-angle-right"></i></a>
  </nav>

</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 
    <span itemprop="copyrightYear">2024</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">王某某</span>
  </div>
<div class="wordcount">
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-line"></i>
    </span>
    <span title="站点总字数">138k</span>
  </span>
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="站点阅读时长">8:20</span>
  </span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/pisces/" rel="noopener" target="_blank">NexT.Pisces</a> 强力驱动
  </div>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>
  <div class="reading-progress-bar"></div>
  <a role="button" class="book-mark-link book-mark-link-fixed"></a>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/sidebar.js"></script><script src="/js/next-boot.js"></script><script src="/js/bookmark.js"></script>

  






  





</body>
</html>
