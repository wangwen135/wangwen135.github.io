<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 7.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css" integrity="sha256-5eIC48iZUHmSlSUz9XtjRyK2mzQkHScZY1WdMaoz74E=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"wangwen135.github.io","root":"/","images":"/images","scheme":"Pisces","darkmode":false,"version":"8.21.0","exturl":false,"sidebar":{"position":"left","width_expanded":320,"width_dual_column":240,"display":"post","padding":18,"offset":12},"hljswrap":true,"copycode":{"enable":false,"style":null},"fold":{"enable":false,"height":500},"bookmark":{"enable":true,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"}}</script><script src="/js/config.js"></script>

    <meta name="description" content="问题描述线上环境每过一段时间（一个月左右） kafka就会故障无法访问，三个服务器都正常，kafka进程正常，但是会出现一个节点和其他两个节点断开的情况，表现形式上类似脑裂，日志中显示正常节点无法连接到故障的节点 出现问题 就不会再自动恢复了 重启故障节点即可解决这个问题 环境信息集群三台机器组成的kafka集群    192.168.1.217 RD-MQ-01 192.168.1.218 RD">
<meta property="og:type" content="article">
<meta property="og:title" content="Kafka 2.11-0.10.1.0 故障分析与处理">
<meta property="og:url" content="https://wangwen135.github.io/%E5%A4%A7%E6%95%B0%E6%8D%AE/Kafka/Kafka%202.11-0.10.1.0%20%E6%95%85%E9%9A%9C%E5%88%86%E6%9E%90%E4%B8%8E%E5%A4%84%E7%90%86/index.html">
<meta property="og:site_name" content="王某某的笔记">
<meta property="og:description" content="问题描述线上环境每过一段时间（一个月左右） kafka就会故障无法访问，三个服务器都正常，kafka进程正常，但是会出现一个节点和其他两个节点断开的情况，表现形式上类似脑裂，日志中显示正常节点无法连接到故障的节点 出现问题 就不会再自动恢复了 重启故障节点即可解决这个问题 环境信息集群三台机器组成的kafka集群    192.168.1.217 RD-MQ-01 192.168.1.218 RD">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2020-04-24T02:43:36.000Z">
<meta property="article:author" content="王某某">
<meta property="article:tag" content="Kafka">
<meta property="article:tag" content="死锁">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="https://wangwen135.github.io/%E5%A4%A7%E6%95%B0%E6%8D%AE/Kafka/Kafka%202.11-0.10.1.0%20%E6%95%85%E9%9A%9C%E5%88%86%E6%9E%90%E4%B8%8E%E5%A4%84%E7%90%86/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"https://wangwen135.github.io/%E5%A4%A7%E6%95%B0%E6%8D%AE/Kafka/Kafka%202.11-0.10.1.0%20%E6%95%85%E9%9A%9C%E5%88%86%E6%9E%90%E4%B8%8E%E5%A4%84%E7%90%86/","path":"大数据/Kafka/Kafka 2.11-0.10.1.0 故障分析与处理/","title":"Kafka 2.11-0.10.1.0 故障分析与处理"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>Kafka 2.11-0.10.1.0 故障分析与处理 | 王某某的笔记</title>
  







<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-MBG120GJ9P"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-MBG120GJ9P');
</script>
  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">王某某的笔记</p>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">记录我的编程之路</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="搜索" role="button">
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a></li>
  </ul>
</nav>




</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%97%AE%E9%A2%98%E6%8F%8F%E8%BF%B0"><span class="nav-number">1.</span> <span class="nav-text">问题描述</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%8E%AF%E5%A2%83%E4%BF%A1%E6%81%AF"><span class="nav-number">2.</span> <span class="nav-text">环境信息</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%9B%86%E7%BE%A4"><span class="nav-number">2.1.</span> <span class="nav-text">集群</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#kafka-%E7%89%88%E6%9C%AC"><span class="nav-number">2.2.</span> <span class="nav-text">kafka 版本</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#zookeeper-%E7%89%88%E6%9C%AC"><span class="nav-number">2.3.</span> <span class="nav-text">zookeeper 版本</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#java-%E7%89%88%E6%9C%AC"><span class="nav-number">2.4.</span> <span class="nav-text">java 版本</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E7%89%88%E6%9C%AC"><span class="nav-number">2.5.</span> <span class="nav-text">操作系统版本</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%9B%B8%E5%85%B3%E9%85%8D%E7%BD%AE"><span class="nav-number">3.</span> <span class="nav-text">相关配置</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#kafka"><span class="nav-number">3.1.</span> <span class="nav-text">kafka</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%94%99%E8%AF%AF%E6%97%A5%E5%BF%97"><span class="nav-number">4.</span> <span class="nav-text">错误日志</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#217%E4%B8%8A%E7%9A%84kafka%E6%97%A5%E5%BF%97"><span class="nav-number">4.1.</span> <span class="nav-text">217上的kafka日志</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#218%E4%B8%8A%E7%9A%84kafka%E6%97%A5%E5%BF%97"><span class="nav-number">4.2.</span> <span class="nav-text">218上的kafka日志</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#219%E4%B8%8A%E7%9A%84kafka%E6%97%A5%E5%BF%97"><span class="nav-number">4.3.</span> <span class="nav-text">219上的kafka日志</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ZK-%E6%97%A5%E5%BF%97"><span class="nav-number">4.4.</span> <span class="nav-text">ZK 日志</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%97%AE%E9%A2%98%E6%8E%92%E6%9F%A5%E8%AE%B0%E5%BD%95"><span class="nav-number">5.</span> <span class="nav-text">问题排查记录</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%A3%80%E6%9F%A5%E7%BD%91%E7%BB%9C"><span class="nav-number">5.1.</span> <span class="nav-text">检查网络</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#ping"><span class="nav-number">5.1.1.</span> <span class="nav-text">ping</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#telnet"><span class="nav-number">5.1.2.</span> <span class="nav-text">telnet</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#netstat"><span class="nav-number">5.1.3.</span> <span class="nav-text">netstat</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%A3%80%E6%9F%A5Zookeeper"><span class="nav-number">5.2.</span> <span class="nav-text">检查Zookeeper</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%A3%80%E6%9F%A5kafka-manager"><span class="nav-number">5.3.</span> <span class="nav-text">检查kafka manager</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8kafka%E5%91%BD%E4%BB%A4%E6%9F%A5%E7%9C%8B"><span class="nav-number">5.4.</span> <span class="nav-text">使用kafka命令查看</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#topic-list"><span class="nav-number">5.4.1.</span> <span class="nav-text">topic list</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#topic-describe"><span class="nav-number">5.4.2.</span> <span class="nav-text">topic describe</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#consumer-groups-list"><span class="nav-number">5.4.3.</span> <span class="nav-text">consumer-groups list</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#consumer-groups-describe"><span class="nav-number">5.4.4.</span> <span class="nav-text">consumer-groups describe</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8Kafka%E5%91%BD%E4%BB%A4%E8%A1%8C%E5%B7%A5%E5%85%B7%E6%B5%8B%E8%AF%95"><span class="nav-number">5.5.</span> <span class="nav-text">使用Kafka命令行工具测试</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%B6%88%E8%B4%B9%E8%80%85"><span class="nav-number">5.5.1.</span> <span class="nav-text">消费者</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%94%9F%E4%BA%A7%E8%80%85"><span class="nav-number">5.5.2.</span> <span class="nav-text">生产者</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%9F%A5%E8%BF%9B%E7%A8%8B%E4%BF%A1%E6%81%AF"><span class="nav-number">5.6.</span> <span class="nav-text">查进程信息</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%BF%9B%E7%A8%8B%E5%8D%A0%E7%94%A8%E7%9A%84%E6%96%87%E4%BB%B6%E5%8F%A5%E6%9F%84%E6%95%B0"><span class="nav-number">5.6.1.</span> <span class="nav-text">进程占用的文件句柄数</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#217"><span class="nav-number">5.6.1.1.</span> <span class="nav-text">217</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#218"><span class="nav-number">5.6.1.2.</span> <span class="nav-text">218</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#219"><span class="nav-number">5.6.1.3.</span> <span class="nav-text">219</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%BD%91%E7%BB%9C%E7%AB%AF%E5%8F%A39092%E6%9F%A5%E7%9C%8B"><span class="nav-number">5.6.2.</span> <span class="nav-text">网络端口9092查看</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#217-1"><span class="nav-number">5.6.2.1.</span> <span class="nav-text">217</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#218-1"><span class="nav-number">5.6.2.2.</span> <span class="nav-text">218</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#219-1"><span class="nav-number">5.6.2.3.</span> <span class="nav-text">219</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%9F%A5%E7%BA%BF%E7%A8%8B%E5%A0%86%E6%A0%88%E5%86%85%E5%AD%98%E4%BF%A1%E6%81%AF"><span class="nav-number">5.7.</span> <span class="nav-text">查线程堆栈内存信息</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8%E5%86%85%E5%AD%98"><span class="nav-number">5.7.1.</span> <span class="nav-text">使用内存</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#217-2"><span class="nav-number">5.7.1.1.</span> <span class="nav-text">217</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#218-2"><span class="nav-number">5.7.1.2.</span> <span class="nav-text">218</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#219-2"><span class="nav-number">5.7.1.3.</span> <span class="nav-text">219</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#jstack"><span class="nav-number">5.7.2.</span> <span class="nav-text">jstack</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#jmap"><span class="nav-number">5.7.3.</span> <span class="nav-text">jmap</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%9B%B8%E5%85%B3%E8%B5%84%E6%96%99"><span class="nav-number">6.</span> <span class="nav-text">相关资料</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%8C%B9%E9%85%8D%E5%BA%A6%E9%AB%98%E7%9A%84"><span class="nav-number">6.1.</span> <span class="nav-text">匹配度高的</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#KAFKA-3994"><span class="nav-number">6.1.1.</span> <span class="nav-text">KAFKA-3994</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#KAFKA-4399"><span class="nav-number">6.1.2.</span> <span class="nav-text">KAFKA-4399</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#KAFKA-4478"><span class="nav-number">6.1.3.</span> <span class="nav-text">KAFKA-4478</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#KAFKA-4562"><span class="nav-number">6.1.4.</span> <span class="nav-text">KAFKA-4562</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9B%B8%E5%85%B3%E6%80%A7%E9%AB%98%E7%9A%84"><span class="nav-number">6.2.</span> <span class="nav-text">相关性高的</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%82%AE%E4%BB%B6%E5%88%97%E8%A1%A8%E4%B8%80"><span class="nav-number">6.2.1.</span> <span class="nav-text">邮件列表一</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%82%AE%E4%BB%B6%E5%88%97%E8%A1%A8%E4%BA%8C"><span class="nav-number">6.2.2.</span> <span class="nav-text">邮件列表二</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#KAFKA-4477"><span class="nav-number">6.2.3.</span> <span class="nav-text">KAFKA-4477</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%BB%93%E8%AE%BA"><span class="nav-number">7.</span> <span class="nav-text">结论</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8D%87%E7%BA%A7"><span class="nav-number">8.</span> <span class="nav-text">升级</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#kafka%E6%9C%8D%E5%8A%A1%E7%AB%AF"><span class="nav-number">8.1.</span> <span class="nav-text">kafka服务端</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%AE%98%E6%96%B9%E5%8D%87%E7%BA%A7%E8%AF%B4%E6%98%8E%E6%96%87%E6%A1%A3"><span class="nav-number">8.1.1.</span> <span class="nav-text">官方升级说明文档</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%A8%8B%E5%BA%8F%E7%9A%84%E5%AE%A2%E6%88%B7%E7%AB%AF"><span class="nav-number">8.2.</span> <span class="nav-text">程序的客户端</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%85%B6%E4%BB%96%E9%97%AE%E9%A2%98"><span class="nav-number">8.3.</span> <span class="nav-text">其他问题</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8D%87%E7%BA%A7%E6%AD%A5%E9%AA%A4%E8%AE%B0%E5%BD%95"><span class="nav-number">9.</span> <span class="nav-text">升级步骤记录</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%B8%8B%E8%BD%BD%E6%96%87%E4%BB%B6"><span class="nav-number">9.1.</span> <span class="nav-text">下载文件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%87%86%E5%A4%87%E7%94%9F%E4%BA%A7%E8%80%85%E5%92%8C%E6%B6%88%E8%B4%B9%E8%80%85"><span class="nav-number">9.2.</span> <span class="nav-text">准备生产者和消费者</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%81%9C%E6%AD%A2%E8%8A%82%E7%82%B9219"><span class="nav-number">9.3.</span> <span class="nav-text">停止节点219</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%B5%8B%E8%AF%95%E9%AA%8C%E8%AF%81"><span class="nav-number">9.4.</span> <span class="nav-text">测试验证</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BF%AE%E6%94%B9%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="nav-number">9.5.</span> <span class="nav-text">修改配置文件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%9C%A8219%E5%90%AF%E5%8A%A8%E6%96%B0%E7%89%88%E6%9C%AC%E7%9A%84kafka"><span class="nav-number">9.6.</span> <span class="nav-text">在219启动新版本的kafka</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%86%8D%E6%AC%A1%E9%AA%8C%E8%AF%81%E6%B5%8B%E8%AF%95"><span class="nav-number">9.7.</span> <span class="nav-text">再次验证测试</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%BA%94%E7%94%A8%E7%A8%8B%E5%BA%8F%E6%B5%8B%E8%AF%95"><span class="nav-number">9.8.</span> <span class="nav-text">应用程序测试</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%86%8D%E5%8D%87%E7%BA%A7217-%E5%92%8C-218"><span class="nav-number">9.9.</span> <span class="nav-text">再升级217 和 218</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%AA%8C%E8%AF%81%E8%80%81%E6%95%B0%E6%8D%AE"><span class="nav-number">9.10.</span> <span class="nav-text">验证老数据</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%A1%A5%E5%85%85"><span class="nav-number">10.</span> <span class="nav-text">补充</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%8D%87%E7%BA%A7%E8%AF%B4%E6%98%8E"><span class="nav-number">10.1.</span> <span class="nav-text">升级说明</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BB%8E0-8-x%EF%BC%8C0-9-x%EF%BC%8C0-10-0-x%EF%BC%8C0-10-1-x%E6%88%960-10-2-x%E5%8D%87%E7%BA%A7%E5%88%B00-11-0-0"><span class="nav-number">10.1.1.</span> <span class="nav-text">从0.8.x，0.9.x，0.10.0.x，0.10.1.x或0.10.2.x升级到0.11.0.0</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8D%87%E7%BA%A7%E4%B9%8B%E5%90%8E%E7%9A%84%E9%97%AE%E9%A2%98"><span class="nav-number">11.</span> <span class="nav-text">升级之后的问题</span></a></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="王某某"
      src="/images/avatar.jpg">
  <p class="site-author-name" itemprop="name">王某某</p>
  <div class="site-description" itemprop="description">这是一个使用 Hexo 构建的博客，用于分享我的编程经验和学习笔记。</div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">170</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">55</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">147</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author animated">
      <span class="links-of-author-item">
        <a href="https://github.com/wangwen135" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;wangwen135" rel="noopener me" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://www.jianshu.com/u/66c41e72644b" title="简  书 → https:&#x2F;&#x2F;www.jianshu.com&#x2F;u&#x2F;66c41e72644b" rel="noopener me" target="_blank"><i class="fa fa-link fa-fw"></i>简  书</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:wangwen135@gmail.com" title="E-Mail → mailto:wangwen135@gmail.com" rel="noopener me" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://twitter.com/wangwen135" title="Twitter → https:&#x2F;&#x2F;twitter.com&#x2F;wangwen135" rel="noopener me" target="_blank"><i class="fab fa-twitter fa-fw"></i>Twitter</a>
      </span>
  </div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://wangwen135.github.io/%E5%A4%A7%E6%95%B0%E6%8D%AE/Kafka/Kafka%202.11-0.10.1.0%20%E6%95%85%E9%9A%9C%E5%88%86%E6%9E%90%E4%B8%8E%E5%A4%84%E7%90%86/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="王某某">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="王某某的笔记">
      <meta itemprop="description" content="这是一个使用 Hexo 构建的博客，用于分享我的编程经验和学习笔记。">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="Kafka 2.11-0.10.1.0 故障分析与处理 | 王某某的笔记">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Kafka 2.11-0.10.1.0 故障分析与处理
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2020-04-24 10:43:36" itemprop="dateCreated datePublished" datetime="2020-04-24T10:43:36+08:00">2020-04-24</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%A4%A7%E6%95%B0%E6%8D%AE/" itemprop="url" rel="index"><span itemprop="name">大数据</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%A4%A7%E6%95%B0%E6%8D%AE/Kafka/" itemprop="url" rel="index"><span itemprop="name">Kafka</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>5.3k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>19 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody"><h2 id="问题描述"><a href="#问题描述" class="headerlink" title="问题描述"></a>问题描述</h2><p>线上环境每过一段时间（一个月左右） kafka就会故障无法访问，三个服务器都正常，kafka进程正常，但是会出现一个节点和其他两个节点断开的情况，表现形式上类似脑裂，日志中显示正常节点无法连接到故障的节点</p>
<p>出现问题 就不会再自动恢复了</p>
<p>重启故障节点即可解决这个问题</p>
<h2 id="环境信息"><a href="#环境信息" class="headerlink" title="环境信息"></a>环境信息</h2><h3 id="集群"><a href="#集群" class="headerlink" title="集群"></a>集群</h3><p>三台机器组成的kafka集群  </p>
<ul>
<li>192.168.1.217 RD-MQ-01</li>
<li>192.168.1.218 RD-MQ-02</li>
<li>192.168.1.219 RD-MQ-03</li>
</ul>
<h3 id="kafka-版本"><a href="#kafka-版本" class="headerlink" title="kafka 版本"></a>kafka 版本</h3><p>kafka_2.11-0.10.1.0</p>
<h3 id="zookeeper-版本"><a href="#zookeeper-版本" class="headerlink" title="zookeeper 版本"></a>zookeeper 版本</h3><p>3.4.10-4181</p>
<blockquote>
<p>ZK独立部署，不与其他程序共用</p>
</blockquote>
<h3 id="java-版本"><a href="#java-版本" class="headerlink" title="java 版本"></a>java 版本</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@RD-MQ-01 ~]# java -version</span><br><span class="line">java version &quot;1.8.0_162&quot;</span><br><span class="line">Java(TM) SE Runtime Environment (build 1.8.0_162-b12)</span><br><span class="line">Java HotSpot(TM) 64-Bit Server VM (build 25.162-b12, mixed mode)</span><br></pre></td></tr></table></figure>

<h3 id="操作系统版本"><a href="#操作系统版本" class="headerlink" title="操作系统版本"></a>操作系统版本</h3><p>CentOS 6.8</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@RD-MQ-02 bin]# uname -a</span><br><span class="line">Linux RD-MQ-02 2.6.32-642.el6.x86_64 #1 SMP Tue May 10 17:27:01 UTC 2016 x86_64 x86_64 x86_64 GNU/Linux</span><br><span class="line"></span><br><span class="line">[root@RD-MQ-02 bin]# cat /etc/redhat-release </span><br><span class="line">CentOS release 6.8 (Final)</span><br></pre></td></tr></table></figure>

<h2 id="相关配置"><a href="#相关配置" class="headerlink" title="相关配置"></a>相关配置</h2><h3 id="kafka"><a href="#kafka" class="headerlink" title="kafka"></a>kafka</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line">############################# Server Basics #############################</span><br><span class="line">broker.id=218</span><br><span class="line">delete.topic.enable=true</span><br><span class="line"></span><br><span class="line">############################# Socket Server Settings #############################</span><br><span class="line">host.name=192.168.1.218</span><br><span class="line">listeners=PLAINTEXT://192.168.1.218:9092</span><br><span class="line">num.network.threads=4</span><br><span class="line">num.io.threads=4</span><br><span class="line">socket.send.buffer.bytes=102400</span><br><span class="line">socket.receive.buffer.bytes=102400</span><br><span class="line">socket.request.max.bytes=104857600</span><br><span class="line"></span><br><span class="line">############################# Log Basics #############################</span><br><span class="line">log.dirs=/opt/data/kafka</span><br><span class="line">num.partitions=32</span><br><span class="line"></span><br><span class="line">############################# Internal Topic Settings  #############################</span><br><span class="line">offsets.topic.replication.factor=3</span><br><span class="line">transaction.state.log.replication.factor=3</span><br><span class="line">transaction.state.log.min.isr=3</span><br><span class="line"></span><br><span class="line">############################# Log Flush Policy #############################</span><br><span class="line"># 每当producer写入10000条消息时，刷数据到磁盘</span><br><span class="line">log.flush.interval.messages=2000</span><br><span class="line"># 每间隔1秒钟时间，刷数据到磁盘</span><br><span class="line">log.flush.interval.ms=1000</span><br><span class="line"></span><br><span class="line">############################# Log Retention Policy #############################</span><br><span class="line"># 日志保留的时长与大小，二者满足其一即生效，此处大小为200GB</span><br><span class="line">log.retention.hours=72</span><br><span class="line">log.retention.bytes=214748364800</span><br><span class="line"># 消息体大小</span><br><span class="line">message.max.byte=1</span><br><span class="line"># 副本数,Replica过少会影响数据的可用性，太多则会白白浪费存储资源，一般建议在2~3为宜。</span><br><span class="line">default.replication.factor=3</span><br><span class="line"># Producer用于压缩数据的压缩类型</span><br><span class="line">compression.type=gzip</span><br><span class="line"># replicas每次获取数据的最大字节数</span><br><span class="line">replica.fetch.max.bytes=5242880</span><br><span class="line"></span><br><span class="line"># 在Replica上会启动若干Fetch线程把对应的数据同步到本地，而num.replica.fetchers这个参数是用来控制Fetch线程的数量。</span><br><span class="line"># 每个Partition启动的多个Fetcher，通过共享offset既保证了同一时间内Consumer和Partition之间的一对一关系，又允许我们通过增多Fetch线程来提高效率。</span><br><span class="line">num.replica.fetchers=4</span><br><span class="line"></span><br><span class="line"># 段文件配置1GB，有利于快速回收磁盘空间，重启kafka加载也会加快(如果文件过小，则文件数量比较多，kafka启动时是单线程扫描目录(log.dir)下所有数据文件),此处为1G</span><br><span class="line">log.segment.bytes=1073741824</span><br><span class="line"></span><br><span class="line">log.retention.check.interval.ms=300000</span><br><span class="line"></span><br><span class="line">############################# Zookeeper #############################</span><br><span class="line">zookeeper.connect=192.168.1.217:5181,192.168.1.218:5181,192.168.1.219:5181</span><br><span class="line"></span><br><span class="line"># Timeout in ms for connecting to zookeeper</span><br><span class="line">zookeeper.connection.timeout.ms=6000</span><br><span class="line">rebalance.backoff.ms=2000</span><br><span class="line">rebalance.max.retries=10</span><br></pre></td></tr></table></figure>

<h2 id="错误日志"><a href="#错误日志" class="headerlink" title="错误日志"></a>错误日志</h2><p>开发环境下出现了该问题时相关日志信息</p>
<h3 id="217上的kafka日志"><a href="#217上的kafka日志" class="headerlink" title="217上的kafka日志"></a>217上的kafka日志</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[2020-04-22 10:43:36,369] WARN [ReplicaFetcherThread-1-219], Error in fetch kafka.server.ReplicaFetcherThread$FetchRequest@5641fe72 (kafka.server.ReplicaFetcherThread)</span><br><span class="line">java.io.IOException: Connection to 219 was disconnected before the response was read</span><br><span class="line">        at kafka.utils.NetworkClientBlockingOps$$anonfun$blockingSendAndReceive$extension$1$$anonfun$apply$1.apply(NetworkClientBlockingOps.scala:115)</span><br><span class="line">        at kafka.utils.NetworkClientBlockingOps$$anonfun$blockingSendAndReceive$extension$1$$anonfun$apply$1.apply(NetworkClientBlockingOps.scala:112)</span><br><span class="line">        at scala.Option.foreach(Option.scala:257)</span><br><span class="line">        at kafka.utils.NetworkClientBlockingOps$$anonfun$blockingSendAndReceive$extension$1.apply(NetworkClientBlockingOps.scala:112)</span><br><span class="line">        at kafka.utils.NetworkClientBlockingOps$$anonfun$blockingSendAndReceive$extension$1.apply(NetworkClientBlockingOps.scala:108)</span><br><span class="line">        at kafka.utils.NetworkClientBlockingOps$.recursivePoll$1(NetworkClientBlockingOps.scala:137)</span><br><span class="line">        at kafka.utils.NetworkClientBlockingOps$.kafka$utils$NetworkClientBlockingOps$$pollContinuously$extension(NetworkClientBlockingOps.scala:143)</span><br><span class="line">        at kafka.utils.NetworkClientBlockingOps$.blockingSendAndReceive$extension(NetworkClientBlockingOps.scala:108)</span><br><span class="line">        at kafka.server.ReplicaFetcherThread.sendRequest(ReplicaFetcherThread.scala:253)</span><br><span class="line">        at kafka.server.ReplicaFetcherThread.fetch(ReplicaFetcherThread.scala:238)</span><br><span class="line">        at kafka.server.ReplicaFetcherThread.fetch(ReplicaFetcherThread.scala:42)</span><br><span class="line">        at kafka.server.AbstractFetcherThread.processFetchRequest(AbstractFetcherThread.scala:118)</span><br><span class="line">        at kafka.server.AbstractFetcherThread.doWork(AbstractFetcherThread.scala:103)</span><br><span class="line">        at kafka.utils.ShutdownableThread.run(ShutdownableThread.scala:63)</span><br></pre></td></tr></table></figure>

<h3 id="218上的kafka日志"><a href="#218上的kafka日志" class="headerlink" title="218上的kafka日志"></a>218上的kafka日志</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[2020-04-22 10:59:42,687] WARN [ReplicaFetcherThread-1-219], Error in fetch kafka.server.ReplicaFetcherThread$FetchRequest@1722c608 (kafka.server.ReplicaFetcherThread)</span><br><span class="line">java.io.IOException: Connection to 219 was disconnected before the response was read</span><br><span class="line">        at kafka.utils.NetworkClientBlockingOps$$anonfun$blockingSendAndReceive$extension$1$$anonfun$apply$1.apply(NetworkClientBlockingOps.scala:115)</span><br><span class="line">        at kafka.utils.NetworkClientBlockingOps$$anonfun$blockingSendAndReceive$extension$1$$anonfun$apply$1.apply(NetworkClientBlockingOps.scala:112)</span><br><span class="line">        at scala.Option.foreach(Option.scala:257)</span><br><span class="line">        at kafka.utils.NetworkClientBlockingOps$$anonfun$blockingSendAndReceive$extension$1.apply(NetworkClientBlockingOps.scala:112)</span><br><span class="line">        at kafka.utils.NetworkClientBlockingOps$$anonfun$blockingSendAndReceive$extension$1.apply(NetworkClientBlockingOps.scala:108)</span><br><span class="line">        at kafka.utils.NetworkClientBlockingOps$.recursivePoll$1(NetworkClientBlockingOps.scala:137)</span><br><span class="line">        at kafka.utils.NetworkClientBlockingOps$.kafka$utils$NetworkClientBlockingOps$$pollContinuously$extension(NetworkClientBlockingOps.scala:143)</span><br><span class="line">        at kafka.utils.NetworkClientBlockingOps$.blockingSendAndReceive$extension(NetworkClientBlockingOps.scala:108)</span><br><span class="line">        at kafka.server.ReplicaFetcherThread.sendRequest(ReplicaFetcherThread.scala:253)</span><br><span class="line">        at kafka.server.ReplicaFetcherThread.fetch(ReplicaFetcherThread.scala:238)</span><br><span class="line">        at kafka.server.ReplicaFetcherThread.fetch(ReplicaFetcherThread.scala:42)</span><br><span class="line">        at kafka.server.AbstractFetcherThread.processFetchRequest(AbstractFetcherThread.scala:118)</span><br><span class="line">        at kafka.server.AbstractFetcherThread.doWork(AbstractFetcherThread.scala:103)</span><br><span class="line">        at kafka.utils.ShutdownableThread.run(ShutdownableThread.scala:63)</span><br></pre></td></tr></table></figure>

<h3 id="219上的kafka日志"><a href="#219上的kafka日志" class="headerlink" title="219上的kafka日志"></a>219上的kafka日志</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[root@RD-MQ-03 logs]# tail -f server.log</span><br><span class="line">[2020-04-22 10:12:50,317] INFO Rolled new log segment for &#x27;__consumer_offsets-3&#x27; in 26 ms. (kafka.log.Log)</span><br><span class="line">[2020-04-22 10:14:00,179] INFO Deleting segment 485381953 from log __consumer_offsets-3. (kafka.log.Log)</span><br><span class="line">[2020-04-22 10:14:00,179] INFO Deleting segment 0 from log __consumer_offsets-3. (kafka.log.Log)</span><br><span class="line">[2020-04-22 10:14:00,181] INFO Deleting index /opt/data/kafka/__consumer_offsets-3/00000000000485381953.index.deleted (kafka.log.OffsetIndex)</span><br><span class="line">[2020-04-22 10:14:00,181] INFO Deleting index /opt/data/kafka/__consumer_offsets-3/00000000000000000000.index.deleted (kafka.log.OffsetIndex)</span><br><span class="line">[2020-04-22 10:14:00,181] INFO Deleting index /opt/data/kafka/__consumer_offsets-3/00000000000485381953.timeindex.deleted (kafka.log.TimeIndex)</span><br><span class="line">[2020-04-22 10:14:00,181] INFO Deleting index /opt/data/kafka/__consumer_offsets-3/00000000000000000000.timeindex.deleted (kafka.log.TimeIndex)</span><br><span class="line">[2020-04-22 10:14:01,478] INFO Deleting segment 486188481 from log __consumer_offsets-3. (kafka.log.Log)</span><br><span class="line">[2020-04-22 10:14:01,517] INFO Deleting index /opt/data/kafka/__consumer_offsets-3/00000000000486188481.index.deleted (kafka.log.OffsetIndex)</span><br><span class="line">[2020-04-22 10:14:01,517] INFO Deleting index /opt/data/kafka/__consumer_offsets-3/00000000000486188481.timeindex.deleted (kafka.log.TimeIndex)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="ZK-日志"><a href="#ZK-日志" class="headerlink" title="ZK 日志"></a>ZK 日志</h3><p>zk日志正常，zk数据文件正常（大小正常，有定期清理）</p>
<h2 id="问题排查记录"><a href="#问题排查记录" class="headerlink" title="问题排查记录"></a>问题排查记录</h2><h3 id="检查网络"><a href="#检查网络" class="headerlink" title="检查网络"></a>检查网络</h3><p>实际上这三个机器都是互通的</p>
<h4 id="ping"><a href="#ping" class="headerlink" title="ping"></a>ping</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"># 217</span><br><span class="line"></span><br><span class="line">[root@RD-MQ-01 ~]# ping 192.168.1.219</span><br><span class="line">PING 192.168.1.219 (192.168.1.219) 56(84) bytes of data.</span><br><span class="line">64 bytes from 192.168.1.219: icmp_seq=1 ttl=64 time=1.23 ms</span><br><span class="line">64 bytes from 192.168.1.219: icmp_seq=2 ttl=64 time=1.79 ms</span><br><span class="line"></span><br><span class="line"># 218</span><br><span class="line"></span><br><span class="line">[root@RD-MQ-02 ~]# ping 192.168.1.219</span><br><span class="line">PING 192.168.1.219 (192.168.1.219) 56(84) bytes of data.</span><br><span class="line">64 bytes from 192.168.1.219: icmp_seq=1 ttl=64 time=1.76 ms</span><br><span class="line">64 bytes from 192.168.1.219: icmp_seq=2 ttl=64 time=1.28 ms</span><br><span class="line"></span><br><span class="line"># 219</span><br><span class="line"></span><br><span class="line">[root@RD-MQ-03 ~]# ping 192.168.1.218</span><br><span class="line">PING 192.168.1.218 (192.168.1.218) 56(84) bytes of data.</span><br><span class="line">64 bytes from 192.168.1.218: icmp_seq=1 ttl=64 time=0.987 ms</span><br><span class="line">64 bytes from 192.168.1.218: icmp_seq=2 ttl=64 time=1.18 ms</span><br></pre></td></tr></table></figure>

<h4 id="telnet"><a href="#telnet" class="headerlink" title="telnet"></a>telnet</h4><p>telnet 也是通的</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@RD-MQ-02 ~]# telnet 192.168.1.219 9092</span><br><span class="line">Trying 192.168.1.219...</span><br><span class="line">Connected to 192.168.1.219.</span><br><span class="line">Escape character is &#x27;^]&#x27;.</span><br><span class="line"></span><br><span class="line">aa</span><br><span class="line">^]</span><br><span class="line">telnet&gt; q</span><br><span class="line">Connection closed.</span><br></pre></td></tr></table></figure>

<h4 id="netstat"><a href="#netstat" class="headerlink" title="netstat"></a>netstat</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@RD-MQ-02 ~]# netstat -an | grep 219:9092</span><br><span class="line">tcp        0      0 ::ffff:192.168.1.218:36841  ::ffff:192.168.1.219:9092   FIN_WAIT2   </span><br><span class="line">tcp        0      0 ::ffff:192.168.1.218:36840  ::ffff:192.168.1.219:9092   FIN_WAIT2   </span><br><span class="line">tcp        0      0 ::ffff:192.168.1.218:36842  ::ffff:192.168.1.219:9092   ESTABLISHED </span><br><span class="line">tcp        0      0 ::ffff:192.168.1.218:36839  ::ffff:192.168.1.219:9092   FIN_WAIT2   </span><br><span class="line">tcp        0      0 ::ffff:192.168.1.218:36837  ::ffff:192.168.1.219:9092   FIN_WAIT2   </span><br><span class="line">tcp        0      0 ::ffff:192.168.1.218:36844  ::ffff:192.168.1.219:9092   ESTABLISHED </span><br><span class="line">tcp        0      0 ::ffff:192.168.1.218:36838  ::ffff:192.168.1.219:9092   FIN_WAIT2   </span><br><span class="line">tcp        0      0 ::ffff:192.168.1.218:36843  ::ffff:192.168.1.219:9092   ESTABLISHED </span><br></pre></td></tr></table></figure>
<p>连接一直在建立，然后关闭</p>
<h3 id="检查Zookeeper"><a href="#检查Zookeeper" class="headerlink" title="检查Zookeeper"></a>检查Zookeeper</h3><p>ZK 能正常操作读写数据</p>
<p>在ZK中能看到3个kafka的brokers</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[zk: 192.168.1.218:5181(CONNECTED) 4] ls /brokers/ids</span><br><span class="line">[217, 218, 219]</span><br></pre></td></tr></table></figure>

<h3 id="检查kafka-manager"><a href="#检查kafka-manager" class="headerlink" title="检查kafka manager"></a>检查kafka manager</h3><p>只能查询到 Brokers 信息</p>
<p>无法查看topic 和 Consumers</p>
<h3 id="使用kafka命令查看"><a href="#使用kafka命令查看" class="headerlink" title="使用kafka命令查看"></a>使用kafka命令查看</h3><h4 id="topic-list"><a href="#topic-list" class="headerlink" title="topic list"></a>topic list</h4><p>分别在三个机器上查看topic信息，都能列出</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./kafka-topics.sh --list --zookeeper 192.168.1.217:5181</span><br></pre></td></tr></table></figure>
<h4 id="topic-describe"><a href="#topic-describe" class="headerlink" title="topic describe"></a>topic describe</h4><p>挑选一个测试队列【st.topic.yery.test】 查看详情：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">[root@RD-MQ-01 bin]#  ./kafka-topics.sh --zookeeper 192.168.1.217:5181 --topic st.topic.yery.test --describe</span><br><span class="line">Topic:st.topic.yery.test        PartitionCount:32       ReplicationFactor:3     Configs:</span><br><span class="line">        Topic: st.topic.yery.test       Partition: 0    Leader: 218     Replicas: 218,217,219   Isr: 217,218,219</span><br><span class="line">        Topic: st.topic.yery.test       Partition: 1    Leader: 219     Replicas: 219,218,217   Isr: 219</span><br><span class="line">        Topic: st.topic.yery.test       Partition: 2    Leader: 217     Replicas: 217,219,218   Isr: 217,218,219</span><br><span class="line">        Topic: st.topic.yery.test       Partition: 3    Leader: 218     Replicas: 218,219,217   Isr: 217,218,219</span><br><span class="line">        Topic: st.topic.yery.test       Partition: 4    Leader: 219     Replicas: 219,217,218   Isr: 219,217,218</span><br><span class="line">        Topic: st.topic.yery.test       Partition: 5    Leader: 217     Replicas: 217,218,219   Isr: 217,218,219</span><br><span class="line">        Topic: st.topic.yery.test       Partition: 6    Leader: 218     Replicas: 218,217,219   Isr: 217,218,219</span><br><span class="line">        Topic: st.topic.yery.test       Partition: 7    Leader: 219     Replicas: 219,218,217   Isr: 219</span><br><span class="line">        Topic: st.topic.yery.test       Partition: 8    Leader: 217     Replicas: 217,219,218   Isr: 217,218,219</span><br><span class="line">        Topic: st.topic.yery.test       Partition: 9    Leader: 218     Replicas: 218,219,217   Isr: 218,217,219</span><br><span class="line">        Topic: st.topic.yery.test       Partition: 10   Leader: 219     Replicas: 219,217,218   Isr: 219</span><br><span class="line">        Topic: st.topic.yery.test       Partition: 11   Leader: 217     Replicas: 217,218,219   Isr: 217,218,219</span><br><span class="line">        Topic: st.topic.yery.test       Partition: 12   Leader: 218     Replicas: 218,217,219   Isr: 218,217,219</span><br><span class="line">        Topic: st.topic.yery.test       Partition: 13   Leader: 219     Replicas: 219,218,217   Isr: 219,217,218</span><br><span class="line">        Topic: st.topic.yery.test       Partition: 14   Leader: 217     Replicas: 217,219,218   Isr: 217,218,219</span><br><span class="line">        Topic: st.topic.yery.test       Partition: 15   Leader: 218     Replicas: 218,219,217   Isr: 218,217,219</span><br><span class="line">        Topic: st.topic.yery.test       Partition: 16   Leader: 219     Replicas: 219,217,218   Isr: 219,217,218</span><br><span class="line">        Topic: st.topic.yery.test       Partition: 17   Leader: 217     Replicas: 217,218,219   Isr: 217,218,219</span><br><span class="line">        Topic: st.topic.yery.test       Partition: 18   Leader: 218     Replicas: 218,217,219   Isr: 217,218,219</span><br><span class="line">        Topic: st.topic.yery.test       Partition: 19   Leader: 219     Replicas: 219,218,217   Isr: 219,217,218</span><br><span class="line">        Topic: st.topic.yery.test       Partition: 20   Leader: 217     Replicas: 217,219,218   Isr: 217,218,219</span><br><span class="line">        Topic: st.topic.yery.test       Partition: 21   Leader: 218     Replicas: 218,219,217   Isr: 218,217,219</span><br><span class="line">        Topic: st.topic.yery.test       Partition: 22   Leader: 219     Replicas: 219,217,218   Isr: 219,217,218</span><br><span class="line">        Topic: st.topic.yery.test       Partition: 23   Leader: 217     Replicas: 217,218,219   Isr: 217,218,219</span><br><span class="line">        Topic: st.topic.yery.test       Partition: 24   Leader: 218     Replicas: 218,217,219   Isr: 218,217,219</span><br><span class="line">        Topic: st.topic.yery.test       Partition: 25   Leader: 219     Replicas: 219,218,217   Isr: 219</span><br><span class="line">        Topic: st.topic.yery.test       Partition: 26   Leader: 217     Replicas: 217,219,218   Isr: 217,218,219</span><br><span class="line">        Topic: st.topic.yery.test       Partition: 27   Leader: 218     Replicas: 218,219,217   Isr: 218,217,219</span><br><span class="line">        Topic: st.topic.yery.test       Partition: 28   Leader: 219     Replicas: 219,217,218   Isr: 219,217,218</span><br><span class="line">        Topic: st.topic.yery.test       Partition: 29   Leader: 217     Replicas: 217,218,219   Isr: 217,218,219</span><br><span class="line">        Topic: st.topic.yery.test       Partition: 30   Leader: 218     Replicas: 218,217,219   Isr: 218,217,219</span><br><span class="line">        Topic: st.topic.yery.test       Partition: 31   Leader: 219     Replicas: 219,218,217   Isr: 219,217,218</span><br></pre></td></tr></table></figure>

<h4 id="consumer-groups-list"><a href="#consumer-groups-list" class="headerlink" title="consumer-groups list"></a>consumer-groups list</h4><p>查看消费者</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@RD-MQ-02 bin]# ./kafka-consumer-groups.sh --bootstrap-server 192.168.1.217:9092 --list</span><br><span class="line">by.consumer.online.storage</span><br><span class="line">dev.consumer.binlog.analysis</span><br><span class="line">by.consumer.alarm.platform</span><br><span class="line">dp.command.consumer</span><br><span class="line">qa.consumer.binlog.install</span><br><span class="line">qa.consumer.binlog.zone</span><br><span class="line">dp.device.consumer</span><br><span class="line">by.consumer.alarm.zone.normal</span><br><span class="line">qa.consumer.binlog.business</span><br></pre></td></tr></table></figure>

<h4 id="consumer-groups-describe"><a href="#consumer-groups-describe" class="headerlink" title="consumer-groups describe"></a>consumer-groups describe</h4><p>僵死，无法列出消费者的相关信息</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@RD-MQ-02 bin]# ./kafka-consumer-groups.sh --bootstrap-server 192.168.1.217:9092 --group dp.device.consumer --describe</span><br><span class="line">GROUP                          TOPIC                          PARTITION  CURRENT-OFFSET  LOG-END-OFFSET  LAG             OWNER</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>换一个消费者组<br>能看到两个分区的消费信息，实际上应该是32个分区</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@RD-MQ-01 bin]# ./kafka-consumer-groups.sh --bootstrap-server 192.168.1.217:9092,192.168.1.218:9092,192.168.1.219:9092 --group by.consumer.online.storage --describe</span><br><span class="line">GROUP                          TOPIC                          PARTITION  CURRENT-OFFSET  LOG-END-OFFSET  LAG             OWNER</span><br><span class="line">by.consumer.online.storage     by.topic.dp.online.device.message.info 0          515             515             0               consumer-1_/192.168.1.216</span><br><span class="line">by.consumer.online.storage     by.topic.dp.online.device.message.info 1          11              11              0               consumer-1_/192.168.1.216</span><br></pre></td></tr></table></figure>

<h3 id="使用Kafka命令行工具测试"><a href="#使用Kafka命令行工具测试" class="headerlink" title="使用Kafka命令行工具测试"></a>使用Kafka命令行工具测试</h3><p>用命令行生产者 和 消费者 进行测试</p>
<h4 id="消费者"><a href="#消费者" class="headerlink" title="消费者"></a>消费者</h4><p>无法消费到数据任何，没有错误</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./kafka-console-consumer.sh --bootstrap-server 192.168.1.217:9092,192.168.1.218:9092,192.168.1.219:9092 --topic by.topic.install.car.device --from-beginning</span><br></pre></td></tr></table></figure>
<h4 id="生产者"><a href="#生产者" class="headerlink" title="生产者"></a>生产者</h4><p>发送数据报错</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">[root@RD-MQ-02 bin]# ./kafka-console-producer.sh --broker-list 192.168.1.217:9092,192.168.1.218:9092 --topic by.topic.install.car.device</span><br><span class="line">111111</span><br><span class="line">2222</span><br><span class="line">3333</span><br><span class="line">[2020-04-22 17:09:45,589] WARN Got error produce response with correlation id 2 on topic-partition by.topic.install.car.device-19, retrying (2 attempts left). Error: NETWORK_EXCEPTION (org.apache.kafka.clients.producer.internals.Sender)</span><br><span class="line">[2020-04-22 17:09:45,592] WARN Got error produce response with correlation id 2 on topic-partition by.topic.install.car.device-1, retrying (2 attempts left). Error: NETWORK_EXCEPTION (org.apache.kafka.clients.producer.internals.Sender)</span><br><span class="line">[2020-04-22 17:09:45,592] WARN Got error produce response with correlation id 1 on topic-partition by.topic.install.car.device-10, retrying (2 attempts left). Error: NETWORK_EXCEPTION (org.apache.kafka.clients.producer.internals.Sender)</span><br><span class="line">5</span><br><span class="line">[2020-04-22 17:09:48,368] WARN Got error produce response with correlation id 6 on topic-partition by.topic.install.car.device-28, retrying (2 attempts left). Error: NETWORK_EXCEPTION (org.apache.kafka.clients.producer.internals.Sender)</span><br><span class="line">[2020-04-22 17:09:48,369] WARN Got error produce response with correlation id 5 on topic-partition by.topic.install.car.device-10, retrying (1 attempts left). Error: NETWORK_EXCEPTION (org.apache.kafka.clients.producer.internals.Sender)</span><br><span class="line">[2020-04-22 17:09:48,369] WARN Got error produce response with correlation id 4 on topic-partition by.topic.install.car.device-19, retrying (1 attempts left). Error: NETWORK_EXCEPTION (org.apache.kafka.clients.producer.internals.Sender)</span><br><span class="line">[2020-04-22 17:09:48,369] WARN Got error produce response with correlation id 4 on topic-partition by.topic.install.car.device-1, retrying (1 attempts left). Error: NETWORK_EXCEPTION (org.apache.kafka.clients.producer.internals.Sender)</span><br><span class="line">[2020-04-22 17:09:49,978] WARN Got error produce response with correlation id 8 on topic-partition by.topic.install.car.device-1, retrying (0 attempts left). Error: NETWORK_EXCEPTION (org.apache.kafka.clients.producer.internals.Sender)</span><br><span class="line">[2020-04-22 17:09:49,978] WARN Got error produce response with correlation id 8 on topic-partition by.topic.install.car.device-10, retrying (0 attempts left). Error: NETWORK_EXCEPTION (org.apache.kafka.clients.producer.internals.Sender)</span><br><span class="line">[2020-04-22 17:09:49,979] WARN Got error produce response with correlation id 8 on topic-partition by.topic.install.car.device-19, retrying (0 attempts left). Error: NETWORK_EXCEPTION (org.apache.kafka.clients.producer.internals.Sender)</span><br><span class="line">[2020-04-22 17:09:49,979] WARN Got error produce response with correlation id 8 on topic-partition by.topic.install.car.device-28, retrying (1 attempts left). Error: NETWORK_EXCEPTION (org.apache.kafka.clients.producer.internals.Sender)</span><br><span class="line">[2020-04-22 17:09:51,587] ERROR Error when sending message to topic by.topic.install.car.device with key: null, value: 4 bytes with error: (org.apache.kafka.clients.producer.internals.ErrorLoggingCallback)</span><br><span class="line">org.apache.kafka.common.errors.NetworkException: The server disconnected before a response was received.</span><br><span class="line">[2020-04-22 17:09:51,593] ERROR Error when sending message to topic by.topic.install.car.device with key: null, value: 6 bytes with error: (org.apache.kafka.clients.producer.internals.ErrorLoggingCallback)</span><br><span class="line">org.apache.kafka.common.errors.NetworkException: The server disconnected before a response was received.</span><br><span class="line">[2020-04-22 17:09:51,593] ERROR Error when sending message to topic by.topic.install.car.device with key: null, value: 4 bytes with error: (org.apache.kafka.clients.producer.internals.ErrorLoggingCallback)</span><br><span class="line">org.apache.kafka.common.errors.NetworkException: The server disconnected before a response was received.</span><br><span class="line">[2020-04-22 17:09:51,594] WARN Got error produce response with correlation id 10 on topic-partition by.topic.install.car.device-28, retrying (0 attempts left). Error: NETWORK_EXCEPTION (org.apache.kafka.clients.producer.internals.Sender)</span><br><span class="line">[2020-04-22 17:09:53,192] ERROR Error when sending message to topic by.topic.install.car.device with key: null, value: 1 bytes with error: (org.apache.kafka.clients.producer.internals.ErrorLoggingCallback)</span><br><span class="line">org.apache.kafka.common.errors.NetworkException: The server disconnected before a response was received.</span><br></pre></td></tr></table></figure>

<h3 id="查进程信息"><a href="#查进程信息" class="headerlink" title="查进程信息"></a>查进程信息</h3><h4 id="进程占用的文件句柄数"><a href="#进程占用的文件句柄数" class="headerlink" title="进程占用的文件句柄数"></a>进程占用的文件句柄数</h4><h5 id="217"><a href="#217" class="headerlink" title="217"></a>217</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@RD-MQ-01 opt]# lsof -p 13517 | wc -l</span><br><span class="line">12824</span><br></pre></td></tr></table></figure>
<h5 id="218"><a href="#218" class="headerlink" title="218"></a>218</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@RD-MQ-02 ~]# lsof -p 13557 | wc -l</span><br><span class="line">12819</span><br></pre></td></tr></table></figure>
<h5 id="219"><a href="#219" class="headerlink" title="219"></a>219</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@RD-MQ-03 ~]# lsof -p 81068 | wc -l</span><br><span class="line">326639</span><br></pre></td></tr></table></figure>
<p><strong>可以看到219占用了非常多的文件句柄数</strong></p>
<h4 id="网络端口9092查看"><a href="#网络端口9092查看" class="headerlink" title="网络端口9092查看"></a>网络端口9092查看</h4><h5 id="217-1"><a href="#217-1" class="headerlink" title="217"></a>217</h5><p>存在很多 time_wait 状态的连接</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">tcp        0      0 ::ffff:192.168.1.217:9092   ::ffff:192.168.1.215:47810  ESTABLISHED 13517/java          </span><br><span class="line">tcp        0      0 ::ffff:192.168.1.217:54504  ::ffff:192.168.1.218:9092   TIME_WAIT   -                   </span><br><span class="line">tcp        0  53321 ::ffff:192.168.1.217:33408  ::ffff:192.168.1.219:9092   FIN_WAIT1   -                   </span><br><span class="line">tcp        0      0 ::ffff:192.168.1.217:9092   ::ffff:192.168.1.218:55812  ESTABLISHED 13517/java          </span><br><span class="line">tcp        0  64905 ::ffff:192.168.1.217:39404  ::ffff:192.168.1.219:9092   FIN_WAIT1   -                   </span><br><span class="line">tcp        0  54769 ::ffff:192.168.1.217:33158  ::ffff:192.168.1.219:9092   FIN_WAIT1   -                   </span><br><span class="line">tcp        0      0 ::ffff:192.168.1.217:9092   ::ffff:192.168.1.216:35251  ESTABLISHED 13517/java          </span><br><span class="line">tcp        0      0 ::ffff:192.168.1.217:39720  ::ffff:192.168.1.217:9092   TIME_WAIT   -                   </span><br><span class="line">tcp        0      0 ::ffff:192.168.1.217:54466  ::ffff:192.168.1.218:9092   TIME_WAIT   -                   </span><br><span class="line">tcp        0  48081 ::ffff:192.168.1.217:33639  ::ffff:192.168.1.219:9092   FIN_WAIT1   -                   </span><br><span class="line">tcp        0  46505 ::ffff:192.168.1.217:39272  ::ffff:192.168.1.219:9092   FIN_WAIT1   -                   </span><br><span class="line">tcp        0      0 ::ffff:192.168.1.217:39646  ::ffff:192.168.1.217:9092   TIME_WAIT   -                   </span><br><span class="line">tcp        0  47953 ::ffff:192.168.1.217:33365  ::ffff:192.168.1.219:9092   FIN_WAIT1   -                   </span><br><span class="line">tcp        0      0 ::ffff:192.168.1.217:54494  ::ffff:192.168.1.218:9092   TIME_WAIT   -                   </span><br><span class="line">tcp        0  53449 ::ffff:192.168.1.217:33037  ::ffff:192.168.1.219:9092   FIN_WAIT1   -                   </span><br><span class="line">tcp        0      0 ::ffff:192.168.1.217:40217  ::ffff:192.168.1.219:9092   FIN_WAIT2   -  </span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@RD-MQ-01 ~]# netstat -antp | grep 9092 | wc -l</span><br><span class="line">324</span><br></pre></td></tr></table></figure>

<h5 id="218-1"><a href="#218-1" class="headerlink" title="218"></a>218</h5><p>基本正常</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">tcp        0      0 ::ffff:192.168.1.218:9092   ::ffff:192.168.1.216:48369  ESTABLISHED 13557/java          </span><br><span class="line">tcp        0      0 ::ffff:192.168.1.218:9092   ::ffff:192.168.1.214:42207  ESTABLISHED 13557/java          </span><br><span class="line">tcp        0      0 ::ffff:192.168.1.218:9092   ::ffff:192.168.1.216:47984  ESTABLISHED 13557/java          </span><br><span class="line">tcp        0      0 ::ffff:192.168.1.218:9092   ::ffff:192.168.1.216:44771  ESTABLISHED 13557/java          </span><br><span class="line">tcp        0      0 ::ffff:192.168.1.218:9092   ::ffff:192.168.1.215:42045  ESTABLISHED 13557/java          </span><br><span class="line">tcp        0      0 ::ffff:192.168.1.218:9092   ::ffff:192.168.1.215:51056  ESTABLISHED 13557/java          </span><br><span class="line">tcp        0      0 ::ffff:192.168.1.218:9092   ::ffff:192.168.1.214:37368  ESTABLISHED 13557/java          </span><br><span class="line">tcp        0      0 ::ffff:192.168.1.218:9092   ::ffff:192.168.1.217:59185  ESTABLISHED 13557/java          </span><br><span class="line">tcp        0      0 ::ffff:192.168.1.218:9092   ::ffff:192.168.1.216:58880  ESTABLISHED 13557/java          </span><br><span class="line">tcp        0      0 ::ffff:192.168.1.218:9092   ::ffff:192.168.1.216:44758  ESTABLISHED 13557/java          </span><br><span class="line">tcp        0      0 ::ffff:192.168.1.218:9092   ::ffff:192.168.1.219:55019  ESTABLISHED 13557/java          </span><br><span class="line">tcp        0      0 ::ffff:192.168.1.218:9092   ::ffff:192.168.1.215:35721  ESTABLISHED 13557/java          </span><br><span class="line">tcp        0      0 ::ffff:192.168.1.218:9092   ::ffff:192.168.1.219:55014  ESTABLISHED 13557/java  </span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@RD-MQ-02 ~]# netstat -antp | grep 9092 | wc -l</span><br><span class="line">77</span><br></pre></td></tr></table></figure>

<h5 id="219-1"><a href="#219-1" class="headerlink" title="219"></a>219</h5><p>存在大量 CLOSE_WAIT 状态的连接</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">tcp      247      0 ::ffff:192.168.1.219:9092   ::ffff:192.168.1.217:58837  CLOSE_WAIT  81068/java          </span><br><span class="line">tcp   178232      0 ::ffff:192.168.1.219:9092   ::ffff:192.168.1.217:34750  ESTABLISHED 81068/java          </span><br><span class="line">tcp       55      0 ::ffff:192.168.1.219:9092   ::ffff:192.168.1.213:55954  CLOSE_WAIT  81068/java          </span><br><span class="line">tcp      238      0 ::ffff:192.168.1.219:9092   ::ffff:192.168.1.217:40862  CLOSE_WAIT  81068/java          </span><br><span class="line">tcp      226      0 ::ffff:192.168.1.219:9092   ::ffff:192.168.1.217:58967  CLOSE_WAIT  81068/java          </span><br><span class="line">tcp    14535      0 ::ffff:192.168.1.219:9092   ::ffff:192.168.1.218:49425  CLOSE_WAIT  81068/java          </span><br><span class="line">tcp    14986      0 ::ffff:192.168.1.219:9092   ::ffff:192.168.1.218:49330  CLOSE_WAIT  81068/java          </span><br><span class="line">tcp      221      0 ::ffff:192.168.1.219:9092   ::ffff:192.168.1.217:37406  CLOSE_WAIT  81068/java          </span><br><span class="line">tcp      223      0 ::ffff:192.168.1.219:9092   ::ffff:192.168.1.217:36455  CLOSE_WAIT  81068/java          </span><br><span class="line">tcp    14620      0 ::ffff:192.168.1.219:9092   ::ffff:192.168.1.217:59460  CLOSE_WAIT  81068/java          </span><br><span class="line">tcp      247      0 ::ffff:192.168.1.219:9092   ::ffff:192.168.1.217:59087  CLOSE_WAIT  81068/java  </span><br></pre></td></tr></table></figure>
<p>数量远多于其他两台</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@RD-MQ-03 opt]# netstat -antp | grep 9092 | wc -l</span><br><span class="line">5589</span><br></pre></td></tr></table></figure>


<h3 id="查线程堆栈内存信息"><a href="#查线程堆栈内存信息" class="headerlink" title="查线程堆栈内存信息"></a>查线程堆栈内存信息</h3><h4 id="使用内存"><a href="#使用内存" class="headerlink" title="使用内存"></a>使用内存</h4><p>基本正常</p>
<h5 id="217-2"><a href="#217-2" class="headerlink" title="217"></a>217</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ps aux|grep java|grep &quot;kafka&quot;|awk &#x27;&#123;print $6&#125;&#x27;     </span><br><span class="line">2625240</span><br></pre></td></tr></table></figure>
<h5 id="218-2"><a href="#218-2" class="headerlink" title="218"></a>218</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ps aux|grep java|grep &quot;kafka&quot;|awk &#x27;&#123;print $6&#125;&#x27;  </span><br><span class="line">2071136</span><br></pre></td></tr></table></figure>
<h5 id="219-2"><a href="#219-2" class="headerlink" title="219"></a>219</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ps aux|grep java|grep &quot;kafka&quot;|awk &#x27;&#123;print $6&#125;&#x27;  </span><br><span class="line">1901924</span><br></pre></td></tr></table></figure>

<h4 id="jstack"><a href="#jstack" class="headerlink" title="jstack"></a>jstack</h4><p>在219上找到死锁</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line">Found one Java-level deadlock:</span><br><span class="line">=============================</span><br><span class="line">&quot;executor-Heartbeat&quot;:</span><br><span class="line">  waiting to lock monitor 0x00007f972c03db78 (object 0x000000070dbce4c8, a kafka.coordinator.GroupMetadata),</span><br><span class="line">  which is held by &quot;group-metadata-manager-0&quot;</span><br><span class="line">&quot;group-metadata-manager-0&quot;:</span><br><span class="line">  waiting to lock monitor 0x00007f979420e438 (object 0x0000000715a00000, a java.util.LinkedList),</span><br><span class="line">  which is held by &quot;kafka-request-handler-3&quot;</span><br><span class="line">&quot;kafka-request-handler-3&quot;:</span><br><span class="line">  waiting to lock monitor 0x00007f972c03db78 (object 0x000000070dbce4c8, a kafka.coordinator.GroupMetadata),</span><br><span class="line">  which is held by &quot;group-metadata-manager-0&quot;</span><br><span class="line"></span><br><span class="line">Java stack information for the threads listed above:</span><br><span class="line">===================================================</span><br><span class="line">&quot;executor-Heartbeat&quot;:</span><br><span class="line">	at kafka.coordinator.GroupCoordinator.onExpireHeartbeat(GroupCoordinator.scala:739)</span><br><span class="line">	- waiting to lock &lt;0x000000070dbce4c8&gt; (a kafka.coordinator.GroupMetadata)</span><br><span class="line">	at kafka.coordinator.DelayedHeartbeat.onExpiration(DelayedHeartbeat.scala:33)</span><br><span class="line">	at kafka.server.DelayedOperation.run(DelayedOperation.scala:107)</span><br><span class="line">	at java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:511)</span><br><span class="line">	at java.util.concurrent.FutureTask.run(FutureTask.java:266)</span><br><span class="line">	at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1149)</span><br><span class="line">	at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:624)</span><br><span class="line">	at java.lang.Thread.run(Thread.java:748)</span><br><span class="line">&quot;group-metadata-manager-0&quot;:</span><br><span class="line">	at kafka.server.DelayedOperationPurgatory$Watchers.tryCompleteWatched(DelayedOperation.scala:308)</span><br><span class="line">	- waiting to lock &lt;0x0000000715a00000&gt; (a java.util.LinkedList)</span><br><span class="line">	at kafka.server.DelayedOperationPurgatory.checkAndComplete(DelayedOperation.scala:234)</span><br><span class="line">	at kafka.server.ReplicaManager.tryCompleteDelayedProduce(ReplicaManager.scala:199)</span><br><span class="line">	at kafka.cluster.Partition.tryCompleteDelayedRequests(Partition.scala:374)</span><br><span class="line">	at kafka.cluster.Partition.appendMessagesToLeader(Partition.scala:457)</span><br><span class="line">	at kafka.coordinator.GroupMetadataManager$$anonfun$cleanupGroupMetadata$1$$anonfun$apply$10.apply(GroupMetadataManager.scala:600)</span><br><span class="line">	at kafka.coordinator.GroupMetadataManager$$anonfun$cleanupGroupMetadata$1$$anonfun$apply$10.apply(GroupMetadataManager.scala:593)</span><br><span class="line">	at scala.Option.foreach(Option.scala:257)</span><br><span class="line">	at kafka.coordinator.GroupMetadataManager$$anonfun$cleanupGroupMetadata$1.apply(GroupMetadataManager.scala:593)</span><br><span class="line">	- locked &lt;0x000000070dbce4c8&gt; (a kafka.coordinator.GroupMetadata)</span><br><span class="line">	at kafka.coordinator.GroupMetadataManager$$anonfun$cleanupGroupMetadata$1.apply(GroupMetadataManager.scala:579)</span><br><span class="line">	at scala.collection.Iterator$class.foreach(Iterator.scala:893)</span><br><span class="line">	at kafka.utils.Pool$$anon$1.foreach(Pool.scala:89)</span><br><span class="line">	at scala.collection.IterableLike$class.foreach(IterableLike.scala:72)</span><br><span class="line">	at kafka.utils.Pool.foreach(Pool.scala:26)</span><br><span class="line">	at kafka.coordinator.GroupMetadataManager.cleanupGroupMetadata(GroupMetadataManager.scala:579)</span><br><span class="line">	at kafka.coordinator.GroupMetadataManager$$anonfun$1.apply$mcV$sp(GroupMetadataManager.scala:101)</span><br><span class="line">	at kafka.utils.KafkaScheduler$$anonfun$1.apply$mcV$sp(KafkaScheduler.scala:110)</span><br><span class="line">	at kafka.utils.CoreUtils$$anon$1.run(CoreUtils.scala:58)</span><br><span class="line">	at java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:511)</span><br><span class="line">	at java.util.concurrent.FutureTask.runAndReset(FutureTask.java:308)</span><br><span class="line">	at java.util.concurrent.ScheduledThreadPoolExecutor$ScheduledFutureTask.access$301(ScheduledThreadPoolExecutor.java:180)</span><br><span class="line">	at java.util.concurrent.ScheduledThreadPoolExecutor$ScheduledFutureTask.run(ScheduledThreadPoolExecutor.java:294)</span><br><span class="line">	at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1149)</span><br><span class="line">	at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:624)</span><br><span class="line">	at java.lang.Thread.run(Thread.java:748)</span><br><span class="line">&quot;kafka-request-handler-3&quot;:</span><br><span class="line">	at kafka.coordinator.GroupMetadataManager.kafka$coordinator$GroupMetadataManager$$putCacheCallback$2(GroupMetadataManager.scala:301)</span><br><span class="line">	- waiting to lock &lt;0x000000070dbce4c8&gt; (a kafka.coordinator.GroupMetadata)</span><br><span class="line">	at kafka.coordinator.GroupMetadataManager$$anonfun$prepareStoreOffsets$1.apply(GroupMetadataManager.scala:357)</span><br><span class="line">	at kafka.coordinator.GroupMetadataManager$$anonfun$prepareStoreOffsets$1.apply(GroupMetadataManager.scala:357)</span><br><span class="line">	at kafka.server.DelayedProduce.onComplete(DelayedProduce.scala:123)</span><br><span class="line">	at kafka.server.DelayedOperation.forceComplete(DelayedOperation.scala:70)</span><br><span class="line">	at kafka.server.DelayedProduce.tryComplete(DelayedProduce.scala:105)</span><br><span class="line">	at kafka.server.DelayedOperationPurgatory$Watchers.tryCompleteWatched(DelayedOperation.scala:315)</span><br><span class="line">	- locked &lt;0x0000000715a4d358&gt; (a kafka.server.DelayedProduce)</span><br><span class="line">	- locked &lt;0x0000000715a00000&gt; (a java.util.LinkedList)</span><br><span class="line">	at kafka.server.DelayedOperationPurgatory.checkAndComplete(DelayedOperation.scala:234)</span><br><span class="line">	at kafka.server.ReplicaManager.tryCompleteDelayedProduce(ReplicaManager.scala:199)</span><br><span class="line">	at kafka.server.ReplicaManager$$anonfun$updateFollowerLogReadResults$2.apply(ReplicaManager.scala:909)</span><br><span class="line">	at kafka.server.ReplicaManager$$anonfun$updateFollowerLogReadResults$2.apply(ReplicaManager.scala:902)</span><br><span class="line">	at scala.collection.mutable.ResizableArray$class.foreach(ResizableArray.scala:59)</span><br><span class="line">	at scala.collection.mutable.ArrayBuffer.foreach(ArrayBuffer.scala:48)</span><br><span class="line">	at kafka.server.ReplicaManager.updateFollowerLogReadResults(ReplicaManager.scala:902)</span><br><span class="line">	at kafka.server.ReplicaManager.fetchMessages(ReplicaManager.scala:475)</span><br><span class="line">	at kafka.server.KafkaApis.handleFetchRequest(KafkaApis.scala:523)</span><br><span class="line">	at kafka.server.KafkaApis.handle(KafkaApis.scala:79)</span><br><span class="line">	at kafka.server.KafkaRequestHandler.run(KafkaRequestHandler.scala:60)</span><br><span class="line">	at java.lang.Thread.run(Thread.java:748)</span><br><span class="line"></span><br><span class="line">Found 1 deadlock.</span><br></pre></td></tr></table></figure>

<h4 id="jmap"><a href="#jmap" class="headerlink" title="jmap"></a>jmap</h4><p>dump 219 上的堆内存信息</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">jmap -dump:format=b,file=kafka-219-jmap.dump 81068</span><br></pre></td></tr></table></figure>
<p>先保留现场，必要时再进行分析，文件大小：665M</p>
<h2 id="相关资料"><a href="#相关资料" class="headerlink" title="相关资料"></a>相关资料</h2><h3 id="匹配度高的"><a href="#匹配度高的" class="headerlink" title="匹配度高的"></a>匹配度高的</h3><h4 id="KAFKA-3994"><a href="#KAFKA-3994" class="headerlink" title="KAFKA-3994"></a>KAFKA-3994</h4><p><a target="_blank" rel="noopener" href="https://issues.apache.org/jira/browse/KAFKA-3994">https://issues.apache.org/jira/browse/KAFKA-3994</a><br>executor-Heartbeat线程 与 kafka-request-handler线程 互锁<br>死锁信息与我们发现的有一点差异，没有group-metadata-manager线程   </p>
<p>版本比我们用低一个版本</p>
<blockquote>
<p>影响版本：0.10.0.0<br>修复版本：0.10.1.1, 0.10.2.0</p>
</blockquote>
<h4 id="KAFKA-4399"><a href="#KAFKA-4399" class="headerlink" title="KAFKA-4399"></a>KAFKA-4399</h4><p><a target="_blank" rel="noopener" href="https://issues.apache.org/jira/browse/KAFKA-4399">https://issues.apache.org/jira/browse/KAFKA-4399</a><br>死锁信息与我们发现的有一个差异，没有executor-Heartbeat线程  </p>
<blockquote>
<p>影响版本：0.10.1.0<br>修复版本：0.10.1.1，0.10.2.0</p>
</blockquote>
<h4 id="KAFKA-4478"><a href="#KAFKA-4478" class="headerlink" title="KAFKA-4478"></a>KAFKA-4478</h4><p><a target="_blank" rel="noopener" href="https://issues.apache.org/jira/browse/KAFKA-4478">https://issues.apache.org/jira/browse/KAFKA-4478</a><br>心跳执行器、组元数据管理器、请求处理器 相互锁死了<br>这个的死锁堆栈信息与我们碰到的一致  </p>
<blockquote>
<p>影响版本：0.10.1.0<br>修复版本：无 （在bug 3994中被解决了）</p>
</blockquote>
<h4 id="KAFKA-4562"><a href="#KAFKA-4562" class="headerlink" title="KAFKA-4562"></a>KAFKA-4562</h4><p><a target="_blank" rel="noopener" href="https://issues.apache.org/jira/browse/KAFKA-4562">https://issues.apache.org/jira/browse/KAFKA-4562</a></p>
<p>死锁情况与我们的一样</p>
<blockquote>
<p>影响版本：0.10.1.0<br>修复版本：无 （在bug 3994中被解决了）</p>
</blockquote>
<hr>
<h3 id="相关性高的"><a href="#相关性高的" class="headerlink" title="相关性高的"></a>相关性高的</h3><h4 id="邮件列表一"><a href="#邮件列表一" class="headerlink" title="邮件列表一"></a>邮件列表一</h4><p><a target="_blank" rel="noopener" href="https://users.kafka.apache.narkive.com/7ekMKZSX/deadlock-using-latest-0-10-1-kafka-release">https://users.kafka.apache.narkive.com/7ekMKZSX/deadlock-using-latest-0-10-1-kafka-release</a>  </p>
<p>3个线程的死锁堆栈信息，和我们的一样，文件句柄耗尽  </p>
<p>作者已经很肯定 KAFKA-3994中的补丁可以很好地解决该问题。</p>
<blockquote>
<p>关联：KAFKA-3994</p>
</blockquote>
<h4 id="邮件列表二"><a href="#邮件列表二" class="headerlink" title="邮件列表二"></a>邮件列表二</h4><p><a target="_blank" rel="noopener" href="https://users.kafka.apache.narkive.com/mP9QlK2j/connectivity-problem-with-controller-breaks-cluster">https://users.kafka.apache.narkive.com/mP9QlK2j/connectivity-problem-with-controller-breaks-cluster</a></p>
<p>从描述的问题来看，我们的一致</p>
<blockquote>
<p>关联：KAFKA-4477</p>
</blockquote>
<h4 id="KAFKA-4477"><a href="#KAFKA-4477" class="headerlink" title="KAFKA-4477"></a>KAFKA-4477</h4><p><a target="_blank" rel="noopener" href="https://issues.apache.org/jira/browse/KAFKA-4477">https://issues.apache.org/jira/browse/KAFKA-4477</a></p>
<p>我们的故障节点 ISR 也减少了，也有文件句柄数和死锁相关的描述</p>
<blockquote>
<p>影响版本：0.10.1.0<br>修复版本：0.10.1.1</p>
</blockquote>
<h2 id="结论"><a href="#结论" class="headerlink" title="结论"></a>结论</h2><p>Kafka程序内部死锁导致了集群的故障问题<br>根据官方文档这个问题在issues [KAFKA-4399] 中被解决了<br>可以通过将现有的kafka升级至 kafka 0.10.1.1 来解决该问题</p>
<p><strong>kafka 0.10.1.1 发版说明</strong><br><a target="_blank" rel="noopener" href="https://archive.apache.org/dist/kafka/0.10.1.1/RELEASE_NOTES.html">https://archive.apache.org/dist/kafka/0.10.1.1/RELEASE_NOTES.html</a>.</p>
<p>官方发版说明中已经记录解决了bug [KAFKA-4399]  </p>
<ul>
<li>[KAFKA-3994] - Deadlock between consumer heartbeat expiration and offset commit.</li>
<li>[KAFKA-4399] - Deadlock between cleanupGroupMetadata and offset commit</li>
</ul>
<hr>
<h2 id="升级"><a href="#升级" class="headerlink" title="升级"></a>升级</h2><h3 id="kafka服务端"><a href="#kafka服务端" class="headerlink" title="kafka服务端"></a>kafka服务端</h3><p>服务器端升级一个小版本到 0.10.1.1<br><a target="_blank" rel="noopener" href="https://archive.apache.org/dist/kafka/0.10.1.1/RELEASE_NOTES.html">https://archive.apache.org/dist/kafka/0.10.1.1/RELEASE_NOTES.html</a>.<br>这个版本主要是修复bug，没有什么新的改变，这样我们的数据应该是完全兼容的，只需要更换服务端的包，复制配置文件，之后逐个重启kafka服务即可。</p>
<h4 id="官方升级说明文档"><a href="#官方升级说明文档" class="headerlink" title="官方升级说明文档"></a>官方升级说明文档</h4><p><a target="_blank" rel="noopener" href="http://kafka.apache.org/0101/documentation.html#upgrade">http://kafka.apache.org/0101/documentation.html#upgrade</a></p>
<h3 id="程序的客户端"><a href="#程序的客户端" class="headerlink" title="程序的客户端"></a>程序的客户端</h3><p>全部的 <strong>生产者</strong> 和 <strong>消费者</strong> 都升级一个小版本到 0.10.1.1</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;!-- https://mvnrepository.com/artifact/org.apache.kafka/kafka-clients --&gt;</span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;org.apache.kafka&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;kafka-clients&lt;/artifactId&gt;</span><br><span class="line">    &lt;version&gt;0.10.1.1&lt;/version&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure>
<p>这样相关的代码应该都无需修改，Api不会有什么改动，只需要升级依赖包即可</p>
<p>修改父项目的pom文件依赖，子项目梳理一下，重新打包部署即可</p>
<h3 id="其他问题"><a href="#其他问题" class="headerlink" title="其他问题"></a>其他问题</h3><p>可能存在一些项目使用的是更老版本的API 和 连接方式等，如不是直连kafka而是老的连接zk的，这部分的项目需要修改代码</p>
<h2 id="升级步骤记录"><a href="#升级步骤记录" class="headerlink" title="升级步骤记录"></a>升级步骤记录</h2><h3 id="下载文件"><a href="#下载文件" class="headerlink" title="下载文件"></a>下载文件</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget https://archive.apache.org/dist/kafka/0.10.1.1/kafka_2.11-0.10.1.1.tgz</span><br></pre></td></tr></table></figure>
<blockquote>
<p>这里选择的scala 版本是 2.11，之前装的也是2.11的</p>
</blockquote>
<p>解压到新目录<br>使用原来的配置位置<br>注意：数据文件（log）的位置  </p>
<h3 id="准备生产者和消费者"><a href="#准备生产者和消费者" class="headerlink" title="准备生产者和消费者"></a>准备生产者和消费者</h3><p>先准备一个生产者，产生数据</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./kafka-console-producer.sh --broker-list 192.168.1.217:9092,192.168.1.218:9092,192.168.1.219:9092 --topic st.topic.yery.test</span><br></pre></td></tr></table></figure>
<p>在准备一个消费者，消费数据</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./kafka-console-consumer.sh --bootstrap-server 192.168.1.217:9092,192.168.1.218:9092,192.168.1.219:9092 --topic st.topic.yery.test --from-beginning</span><br></pre></td></tr></table></figure>
<p>升级过程保持不变</p>
<h3 id="停止节点219"><a href="#停止节点219" class="headerlink" title="停止节点219"></a>停止节点219</h3><p>先关闭节点219，观察集群状态：<br>217 218 报错了，但是集群整体运行正常  </p>
<h3 id="测试验证"><a href="#测试验证" class="headerlink" title="测试验证"></a>测试验证</h3><p>生产者能正常产生数据</p>
<p>消费者能正常消费数据</p>
<p>消费者会打印一个警告</p>
<p>进入kafka manager 可以查看到只有两个 Broker（217、218）<br>查看topic st.topic.yery.test 的信息<br>所有Partition 的leader都分到217 和 218 上<br>In Sync Replicas 只有(217,218)  </p>
<h3 id="修改配置文件"><a href="#修改配置文件" class="headerlink" title="修改配置文件"></a>修改配置文件</h3><p>复制原配置文件到kafka_2.11-0.10.1.1 </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">cd kafka_2.11-0.10.1.0</span><br><span class="line"></span><br><span class="line"># 复制启动脚本（自己写的）</span><br><span class="line">cp start.sh ../kafka_2.11-0.10.1.1/</span><br><span class="line"></span><br><span class="line"># 复制配置文件</span><br><span class="line">cd config</span><br><span class="line"></span><br><span class="line">cp server.properties ../../kafka_2.11-0.10.1.1/config/</span><br><span class="line">cp log4j.properties ../../kafka_2.11-0.10.1.1/config/</span><br></pre></td></tr></table></figure>

<h3 id="在219启动新版本的kafka"><a href="#在219启动新版本的kafka" class="headerlink" title="在219启动新版本的kafka"></a>在219启动新版本的kafka</h3><p>直接启动219 （0.10.1.1版本的）</p>
<p>查看219日志，可以看到在恢复数据</p>
<p>数据恢复完成之后 会加入集群</p>
<p>加入集群后，217 和 218 会打印日志，将分区ISR从[217,218] 扩大到 [217,218,219]</p>
<p>在kafka manager 上可以看到Broker 219 加入了集群<br>查看topic [st.topic.yery.test] 的信息<br>Partition 的leader分到217，218 和 219 三台上了<br>In Sync Replicas 有(217,218,219)  </p>
<h3 id="再次验证测试"><a href="#再次验证测试" class="headerlink" title="再次验证测试"></a>再次验证测试</h3><p>此时命令行 生产数据 消费数据都是正常的</p>
<h3 id="应用程序测试"><a href="#应用程序测试" class="headerlink" title="应用程序测试"></a>应用程序测试</h3><p><strong>直接验证binlog程序</strong><br>程序在不升级kafka客户端包版本的情况下测试</p>
<p>在数据库中修改 by_device 表的记录x，将记录x的remark修改为‘kafka update’<br>可以在缓存管理中看到记录x的remark改成了‘kafka update’</p>
<p>对应的队列 qa.topic.binlog.base-by_device<br>Sum of partition offsets	也加了1，表明消息发送消费正常</p>
<p>程序在不升级kafka-clients 包的情况下，也没有问题  </p>
<h3 id="再升级217-和-218"><a href="#再升级217-和-218" class="headerlink" title="再升级217 和 218"></a>再升级217 和 218</h3><p>用同样的步骤更换 217 和 218 上的kafka程序，配置文件就用原来的对应的配置文件</p>
<p>逐个关闭kafka程序再启动，等待数据库恢复，集群恢复到正常状态</p>
<h3 id="验证老数据"><a href="#验证老数据" class="headerlink" title="验证老数据"></a>验证老数据</h3><p>升级完成之后再从头开始消费队列[st.topic.yery.test]的数据</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./kafka-console-consumer.sh --bootstrap-server 192.168.1.217:9092,192.168.1.218:9092,192.168.1.219:9092 --topic st.topic.yery.test --from-beginning</span><br></pre></td></tr></table></figure>

<p><strong>数据正常，升级完成</strong></p>
<hr>
<h2 id="补充"><a href="#补充" class="headerlink" title="补充"></a>补充</h2><h3 id="升级说明"><a href="#升级说明" class="headerlink" title="升级说明"></a>升级说明</h3><h4 id="从0-8-x，0-9-x，0-10-0-x，0-10-1-x或0-10-2-x升级到0-11-0-0"><a href="#从0-8-x，0-9-x，0-10-0-x，0-10-1-x或0-10-2-x升级到0-11-0-0" class="headerlink" title="从0.8.x，0.9.x，0.10.0.x，0.10.1.x或0.10.2.x升级到0.11.0.0"></a>从0.8.x，0.9.x，0.10.0.x，0.10.1.x或0.10.2.x升级到0.11.0.0</h4><p><a target="_blank" rel="noopener" href="http://kafka.apache.org/0102/documentation.html#upgrade">http://kafka.apache.org/0102/documentation.html#upgrade</a></p>
<p>Kafka 0.11.0.0引入了新的消息格式版本以及有线协议更改。通过遵循以下建议的滚动升级计划，可以保证升级期间不会停机。但是，请在升级之前查看0.11.0.0中的显着更改。</p>
<p>从版本0.10.2开始，Java客户端（生产者和消费者）已经具有与较早的代理进行通信的能力。版本0.11.0的客户可以与版本0.10.0或更高版本的代理通信。但是，如果您的代理早于0.10.0，则必须先升级Kafka群集中的所有代理，然后再升级客户端。版本0.11.0代理支持0.8.x和更高版本的客户端。</p>
<hr>
<p>###################################</p>
<hr>
<h2 id="升级之后的问题"><a href="#升级之后的问题" class="headerlink" title="升级之后的问题"></a>升级之后的问题</h2><p><strong>这是一个坑，升级之后还是有死锁问题，一个新的死锁</strong></p>
<p>由于 DelayedProduce  和 GroupMetadata 导致的死锁</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">Found one Java-level deadlock:</span><br><span class="line">=============================</span><br><span class="line">&quot;executor-Heartbeat&quot;:</span><br><span class="line">  waiting to lock monitor 0x00007f113c00b678 (object 0x00000000c8ab9028, a kafka.server.DelayedProduce),</span><br><span class="line">  which is held by &quot;kafka-scheduler-5&quot;</span><br><span class="line">&quot;kafka-scheduler-5&quot;:</span><br><span class="line">  waiting to lock monitor 0x00007f1918013848 (object 0x00000000ea18c4d8, a kafka.coordinator.GroupMetadata),</span><br><span class="line">  which is held by &quot;executor-Heartbeat&quot;</span><br><span class="line"></span><br><span class="line">Java stack information for the threads listed above:</span><br></pre></td></tr></table></figure>

<p>bug:<br><a target="_blank" rel="noopener" href="https://issues.apache.org/jira/browse/KAFKA-5970">https://issues.apache.org/jira/browse/KAFKA-5970</a></p>
<p>修复版本：<br>0.11.0.2， 1.0.0</p>
<p>在 0.10.X 版本中没有看到有修复该问题，且在0.11.x版本中又看到有内存泄漏问题，~~~</p>
<p><strong>好在这个问题出现的概率非常低，只在测试环境出现过1次</strong></p>

    </div>

    
    
    

    <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/Kafka/" rel="tag"># Kafka</a>
              <a href="/tags/%E6%AD%BB%E9%94%81/" rel="tag"># 死锁</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/%E7%BD%91%E7%BB%9C%E4%B8%8E%E5%AE%89%E5%85%A8/%E7%BD%91%E7%BB%9C/IPv4%E5%9C%B0%E5%9D%80%E5%88%86%E7%B1%BB%20ABC%E7%B1%BBIP%E5%88%92%E5%88%86/" rel="prev" title="IPv4地址分类 ABC类IP划分">
                  <i class="fa fa-angle-left"></i> IPv4地址分类 ABC类IP划分
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/Maven/Maven%E4%B8%8B%E8%BD%BD%E6%9E%84%E5%BB%BA%E6%B5%8B%E8%AF%95/" rel="next" title="Maven下载构建测试">
                  Maven下载构建测试 <i class="fa fa-angle-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 
    <span itemprop="copyrightYear">2024</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">王某某</span>
  </div>
<div class="wordcount">
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-line"></i>
    </span>
    <span title="站点总字数">150k</span>
  </span>
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="站点阅读时长">9:07</span>
  </span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/pisces/" rel="noopener" target="_blank">NexT.Pisces</a> 强力驱动
  </div>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>
  <div class="reading-progress-bar"></div>
  <a role="button" class="book-mark-link book-mark-link-fixed"></a>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/sidebar.js"></script><script src="/js/next-boot.js"></script><script src="/js/bookmark.js"></script>

  






  





</body>
</html>
